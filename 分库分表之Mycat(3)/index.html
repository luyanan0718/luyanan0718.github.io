<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="分库分表之Mycat官网: http:&#x2F;&#x2F;www.mycat.io&#x2F; Mycat 概要介绍： https:&#x2F;&#x2F;github.com&#x2F;MyCATApache&#x2F;Mycat-Server 入门指南: https:&#x2F;&#x2F;github.com&#x2F;MyCATApache&#x2F;Mycat-doc&#x2F;tree&#x2F;master&#x2F;%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97 1.Mycat介绍和核心概">
<meta property="og:type" content="article">
<meta property="og:title" content="分库分表之Mycat(3)">
<meta property="og:url" content="http://luyanan.com/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BMycat(3)/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="分库分表之Mycat官网: http:&#x2F;&#x2F;www.mycat.io&#x2F; Mycat 概要介绍： https:&#x2F;&#x2F;github.com&#x2F;MyCATApache&#x2F;Mycat-Server 入门指南: https:&#x2F;&#x2F;github.com&#x2F;MyCATApache&#x2F;Mycat-doc&#x2F;tree&#x2F;master&#x2F;%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97 1.Mycat介绍和核心概">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://files.luyanan.com//img/20200404214256.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200404223525.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200404223845.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200404225555.png">
<meta property="og:image" content="c:/Users/luyanan/Downloads/image%20(1).png">
<meta property="og:image" content="http://files.luyanan.com//img/20200406153633.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200406153847.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200406160218.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200406164438.png">
<meta property="article:published_time" content="2021-03-12T02:15:06.286Z">
<meta property="article:modified_time" content="2021-03-12T02:15:06.286Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://files.luyanan.com//img/20200404214256.png">

<link rel="canonical" href="http://luyanan.com/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BMycat(3)/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>分库分表之Mycat(3) | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BMycat(3)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          分库分表之Mycat(3)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-12 10:15:06" itemprop="dateCreated datePublished" datetime="2021-03-12T10:15:06+08:00">2021-03-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="分库分表之Mycat"><a href="#分库分表之Mycat" class="headerlink" title="分库分表之Mycat"></a>分库分表之Mycat</h1><p>官网: <a target="_blank" rel="noopener" href="http://www.mycat.io/">http://www.mycat.io/</a></p>
<p>Mycat 概要介绍： <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Server">https://github.com/MyCATApache/Mycat-Server</a></p>
<p>入门指南: <a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-doc/tree/master/%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97">https://github.com/MyCATApache/Mycat-doc/tree/master/%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97</a></p>
<h2 id="1-Mycat介绍和核心概念"><a href="#1-Mycat介绍和核心概念" class="headerlink" title="1.Mycat介绍和核心概念"></a>1.Mycat介绍和核心概念</h2><h4 id="1-1-基本介绍"><a href="#1-1-基本介绍" class="headerlink" title="1.1 基本介绍"></a>1.1 基本介绍</h4><p>历史:从阿里的<code>cobar</code>升级而来, 由开源组织维护, 2.0 正在开发中. </p>
<p>定位：运行在应用和数据库之间, 可以当作一个mysql 服务器使用,实现对Mysql数据库的分库分表, 也可以通过JDBC 支持其他的数据库. </p>
<p>Mycat 的关键特性: </p>
<ol>
<li>可以当作一个MYSQL 数据库使用</li>
<li>支持Mysql之外的数据库, 通过JDBC实现. </li>
<li>解决了我们提到的很多问题, 多表<code>join</code>、分布式事务、全局序列号、翻页排序等. </li>
<li>支持ZK配置,带监控<code>mycat-web</code></li>
<li>2.0  正在开发中.</li>
</ol>
<h4 id="1-2-核心概念"><a href="#1-2-核心概念" class="headerlink" title="1.2 核心概念"></a>1.2 核心概念</h4><table>
<thead>
<tr>
<th>概念</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>主机</td>
<td>物理主机, 一台服务器、一个数据库、一个3306端口</td>
</tr>
<tr>
<td>物理数据库</td>
<td>真实的数据库</td>
</tr>
<tr>
<td>物理表</td>
<td>真实存在的表</td>
</tr>
<tr>
<td>分片</td>
<td>将原来单个数据库的数据切分后分散在不同的数据库节点</td>
</tr>
<tr>
<td>分片节点</td>
<td>分片以后数据存储的节点</td>
</tr>
<tr>
<td>分片键</td>
<td>分片依据的字段,例如<code>order</code> 表中以id为依据分片, id就是分片键, 通常为主键</td>
</tr>
<tr>
<td>分片算法</td>
<td>分片的规则, 例如随机、取模、范围、哈希、枚举以及各种组合算法</td>
</tr>
<tr>
<td>逻辑表</td>
<td>相当于物理表,是分片表聚合后的结果,对于客户端来说跟真实的表没有区别</td>
</tr>
<tr>
<td>逻辑数据库</td>
<td>相当于物理数据库, 是数据节点聚合后的结果,</td>
</tr>
</tbody></table>
<p>下载, 解压Mycat(有window版本, 可以在本地数据库测试)</p>
<p><a target="_blank" rel="noopener" href="http://dl.mycat.io/">http://dl.mycat.io/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://dl.mycat.io/1.6.7.3/20190927161129/Mycat-server-1.6.7.3-release-20190927161129-linux.tar.gz</span><br><span class="line">tar -xzvf Mycat-server-1.6.7.3-release-20190927161129-linux.tar.gz</span><br></pre></td></tr></table></figure>

<p><code>Mycat</code>解压之后有5个目录, </p>
<table>
<thead>
<tr>
<th>目录</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>bin</code></td>
<td>启动目录</td>
</tr>
<tr>
<td><code>catlet</code></td>
<td>空目录</td>
</tr>
<tr>
<td><code>conf</code></td>
<td>配置目录</td>
</tr>
<tr>
<td><code>lib</code></td>
<td>jar包依赖</td>
</tr>
<tr>
<td><code>logs</code></td>
<td>日志目录</td>
</tr>
</tbody></table>
<h2 id="2-Mycat-配置详解"><a href="#2-Mycat-配置详解" class="headerlink" title="2. Mycat 配置详解"></a>2. <code>Mycat</code> 配置详解</h2><p>主要的配置文件有<code>server.xml</code>、<code>schema.xml</code>、<code>rule.xml</code> 和具体的分片规则文件. </p>
<h3 id="2-1-server-xml"><a href="#2-1-server-xml" class="headerlink" title="2.1 server.xml"></a>2.1 <code>server.xml</code></h3><p>包含系统配置信息, </p>
<p><code>System</code>标签: 例如字符集、线程数、心跳、分布式事务开关等. </p>
<p><code>user</code>标签: 配置登录用户和权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>catmall<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>Mycat</code>对密码加密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp Mycat-server-1.6.7.3-release.jar io.mycat.util.DecryptUtil 0:root:123456</span><br></pre></td></tr></table></figure>



<h3 id="2-2-schema-xml"><a href="#2-2-schema-xml" class="headerlink" title="2.2  schema.xml"></a>2.2  <code>schema.xml</code></h3><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html">https://dev.mysql.com/doc/refman/5.7/en/glossary.html</a></p>
<p><code>schema</code> 在Mysql 里面跟数据库是等价的. </p>
<p><code>schema.xml</code> 里面包含逻辑库、表、分片规则、分片节点和数据源, 可以定义多个<code>schema</code></p>
<p>这里面有三个主要的标签(<code>table</code>、<code>tableNode</code>、<code>dataHost</code>)</p>
<h4 id="lt-table-gt"><a href="#lt-table-gt" class="headerlink" title="&lt;/table&gt;"></a><code>&lt;/table&gt;</code></h4><p>表名和库名最好小写, 定义了逻辑表以及逻辑表分布的节点和分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;catmall&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 范围分片 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;rang-long-cust&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 取模分片 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;order_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long-order&quot;</span> &gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- ER 表 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;order_id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 全局表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;student&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;sid&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>配置</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>primaryKey</code></td>
<td>执行该逻辑表对应的真实表的主键,<code>Mycat</code> 会缓存主键(通过<code>primaryKey</code> 属性配置)与具体的<code>dataNode</code>的信息<br />当分片规则(rule) 使用非主键进行分片时, 那么在使用主键进行查询时,<code>Mycat</code> 就会通过缓存先确定记录在哪个<code>dataNode</code>上, 然后再在该<code>dataNode</code> 上执行查询. <br />如果没有缓存/缓存并没有命中的话,还是会发送所有语句给<code>dataNode</code></td>
</tr>
<tr>
<td><code>dataNode</code></td>
<td>数据分片的节点</td>
</tr>
<tr>
<td><code>autoIncrement</code></td>
<td>自增长(全局序列)、true代表主键使用自增长策略</td>
</tr>
<tr>
<td><code>type</code></td>
<td>全局表:<code>global</code>, 其他： 不配置</td>
</tr>
</tbody></table>
<h4 id="lt-dataNode-gt"><a href="#lt-dataNode-gt" class="headerlink" title="&lt;dataNode&gt;"></a><code>&lt;dataNode&gt;</code></h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;mycat&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数据节点与物理数据库的对应关系.</p>
<h4 id="lt-dataHost-gt"><a href="#lt-dataHost-gt" class="headerlink" title="&lt;dataHost/&gt;"></a><code>&lt;dataHost/&gt;</code></h4><p>配置物理主机的信息， <code>readHost</code>是从属于<code>writeHost</code>的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.8.146:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;xxx&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;localhost:3316&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;writeHost host=&quot;hostM2&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot; password=&quot;123456&quot;/&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>balance</code>: 负载的配置, 决定<code>select</code>语句的负载. </p>
<table>
<thead>
<tr>
<th>值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>不开启读写分离机制,所有读操作都发送到当前可用的<code>writeHost</code> 上</td>
</tr>
<tr>
<td>1</td>
<td>所有的读操作都随机的发送到当前的<code>writeHost</code> 对应的<code>readHost</code>和备用的<code>writeHost</code>上.</td>
</tr>
<tr>
<td>2</td>
<td>所有的读操作都随机发送到所有的<code>writeHost</code>和<code>readHost</code>上.</td>
</tr>
<tr>
<td>3</td>
<td>所有的读操作都只发送到<code>writeHost</code>的<code>readHost</code>上.</td>
</tr>
</tbody></table>
<p><code>writeType</code> : 读写分离的配置, 决定<code>update</code>、<code>delete</code>、<code>insert</code> 语句的负载. </p>
<table>
<thead>
<tr>
<th>值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>所有的写操作都发送到可用的<code>writeHost</code>上(默认第一个,第一个挂了以后发送到第二个)</td>
</tr>
<tr>
<td>1</td>
<td>所有的写操作都随机的发送到<code>writeHost</code>上</td>
</tr>
</tbody></table>
<p><code>switchType</code>: 主从切换的配置</p>
<table>
<thead>
<tr>
<th>值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-1</td>
<td>表示不自动切换</td>
</tr>
<tr>
<td>1</td>
<td>默认值, 表示自动切换</td>
</tr>
<tr>
<td>2</td>
<td>基于Mysql主从切换的状态决定是否切换, 心跳语句<code>show slave status</code></td>
</tr>
<tr>
<td>3</td>
<td>基于<code>Mysql  galary cluster</code> 的切换机制（适合集群）（1.4.1），心跳语句为 <code>show status like &#39;wsrep%&#39;。</code></td>
</tr>
</tbody></table>
<h3 id="2-3-rule-xml"><a href="#2-3-rule-xml" class="headerlink" title="2.3 rule.xml"></a>2.3 <code>rule.xml</code></h3><p>定义了分片规则和算法</p>
<p>分片规则: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rang-long-cust&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>func-rang-long-cust<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;func-rang-long-cust&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>rang-long-cust.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>分片配置:<code>rang-long-cust.txt</code></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10001-20000=1</span><br><span class="line">0-10000=0</span><br><span class="line">20001-100000=2</span><br></pre></td></tr></table></figure>



<h3 id="2-4-ZK配置"><a href="#2-4-ZK配置" class="headerlink" title="2.4 ZK配置"></a>2.4 ZK配置</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/leeSmall/p/9551038.html">https://www.cnblogs.com/leeSmall/p/9551038.html</a></p>
<p><code>Mycat</code> 也支持zk配置(用于管理配置和生成全局ID), 执行<code>bin</code>目录下的<code>init_zk_data.sh</code>, 会自动将<code>zkconf</code>下的所有配置文件上传到zk(先拷贝到这个目录)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/soft/mycat/conf</span><br><span class="line">cp *.txt *.xml *.properties zkconf/</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/soft/mycat/bin</span><br><span class="line">./init_zk_data.sh</span><br></pre></td></tr></table></figure>



<p>启用zk配置</p>
<p><code>mycat/conf/myid.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">loadZk</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">zkURL</span>=<span class="string">127.0.0.1:2181</span></span><br><span class="line"><span class="attr">clusterId</span>=<span class="string">010</span></span><br><span class="line"><span class="attr">myid</span>=<span class="string">01001</span></span><br><span class="line"><span class="attr">clusterSize</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">clusterNodes</span>=<span class="string">mycat_01</span></span><br><span class="line"><span class="comment">#server booster ; booster install on db same server,will reset all minCon to 2</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">server</span></span><br><span class="line"><span class="attr">boosterDataHosts</span>=<span class="string">dataHost1</span></span><br></pre></td></tr></table></figure>

<p>注意如果指定<code>init_zk_data.sh</code> 脚本报错的话, 代表未写入成功, 此时不要启动zk配置并重启,否则本地文件会被覆盖, </p>
<p>启动的时如果<code>oadzk=true</code> 启动时, 会自动从zk下载配置文件并覆盖到本地配置.</p>
<p>在这种情况下如果修改配置, 需要先修改<code>conf</code> 目录的配置, <code>copy</code>到<code>zkconf</code>, 再执行上传. </p>
<p><img src="http://files.luyanan.com//img/20200404214256.png" alt="image-20200404214238782"></p>
<h3 id="2-5-启动停止"><a href="#2-5-启动停止" class="headerlink" title="2.5 启动停止"></a>2.5 启动停止</h3><p>进入<code>mycat/bin</code> 目录(主要要先启动物理数据库)</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody><tr>
<td>启动</td>
<td><code>./mycat start</code></td>
</tr>
<tr>
<td>停止</td>
<td><code>./mycat stop</code></td>
</tr>
<tr>
<td>重启</td>
<td><code>./mycat restart</code></td>
</tr>
<tr>
<td>查看状态</td>
<td><code>./mycat status</code></td>
</tr>
<tr>
<td>前台运行</td>
<td><code>/mycat console</code></td>
</tr>
</tbody></table>
<p>连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456 -h 192.168.8.151 -P8066 catmall</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3-Mycat-分片验证"><a href="#3-Mycat-分片验证" class="headerlink" title="3. Mycat 分片验证"></a>3. Mycat 分片验证</h2><p><code>explain</code> 可以用来看路由结果</p>
<p>在三个数据库中建表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;customer&#96; (</span><br><span class="line">&#96;id&#96; int(11) DEFAULT NULL,</span><br><span class="line"> &#96;name&#96; varchar(255) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;order_info&#96; (</span><br><span class="line">&#96;order_id&#96; int(11) NOT NULL COMMENT &#39;订单 ID&#39;, </span><br><span class="line"> &#96;uid&#96; int(11) DEFAULT NULL COMMENT &#39;用户 ID&#39;,</span><br><span class="line"> &#96;nums&#96; int(11) DEFAULT NULL COMMENT &#39;商品数量&#39;,</span><br><span class="line"> &#96;state&#96; int(2) DEFAULT NULL COMMENT &#39;订单状态&#39;,</span><br><span class="line"> &#96;create_time&#96; datetime DEFAULT NULL ON UPDATE   CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span><br><span class="line"> &#96;update_time&#96; datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;更新时间&#39;,</span><br><span class="line"> PRIMARY KEY (&#96;order_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;order_detail&#96; (</span><br><span class="line"> &#96;order_id&#96; int(11) NOT NULL COMMENT &#39;订单号&#39;,</span><br><span class="line"> &#96;id&#96; int(11) NOT NULL COMMENT &#39;订单详情&#39;,</span><br><span class="line"> &#96;goods_id&#96; int(11) DEFAULT NULL COMMENT &#39;货品 ID&#39;,</span><br><span class="line"> &#96;price&#96; decimal(10,2) DEFAULT NULL COMMENT &#39;价格&#39;,</span><br><span class="line"> &#96;is_pay&#96; int(2) DEFAULT NULL COMMENT &#39;支付状态&#39;,</span><br><span class="line"> &#96;is_ship&#96; int(2) DEFAULT NULL COMMENT &#39;是否发货&#39;,</span><br><span class="line"> &#96;status&#96; int(2) DEFAULT NULL COMMENT &#39;订单详情状态&#39;,</span><br><span class="line"> PRIMARY KEY (&#96;order_id&#96;,&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;student&#96; (</span><br><span class="line">&#96;sid&#96; int(8) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> &#96;name&#96; varchar(255) DEFAULT NULL,</span><br><span class="line"> &#96;qq&#96; varchar(255) DEFAULT NULL,</span><br><span class="line"> PRIMARY KEY (&#96;sid&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p><code>schema.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;rang-long-cust&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;order_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long-order&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;order_detail&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;student&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;sid&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<p>数据节点配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;mycat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;mycat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;mycat&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.8.146:3306&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">name</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.8.150:3306&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">name</span>=<span class="string">&quot;host3&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.8.151:3306&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>schema——rule.xml——分片配置</code></p>
<h4 id="3-1-范围分片"><a href="#3-1-范围分片" class="headerlink" title="3.1 范围分片"></a>3.1 范围分片</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;rang-long-cust&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long-cust<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long-cust&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>rang-long-cust.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>customer</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (6666, &#39;赵先生&#39;);</span><br><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (7777, &#39;钱先生&#39;);</span><br><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (16666, &#39;孙先生&#39;);</span><br><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (17777, &#39;李先生&#39;);</span><br><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (26666, &#39;周先生&#39;);</span><br><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (27777, &#39;吴先生&#39;);</span><br></pre></td></tr></table></figure>



<h4 id="3-2-取模分片-ER表"><a href="#3-2-取模分片-ER表" class="headerlink" title="3.2 取模分片(ER表)"></a>3.2 取模分片(ER表)</h4><p>order_info</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long-order&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>order_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;order_info&#96; (&#96;order_id&#96;, &#96;uid&#96;, &#96;nums&#96;, &#96;state&#96;, &#96;create_time&#96;, &#96;update_time&#96;) VALUES (1, 1000001, 1, 2,</span><br><span class="line">&#39;2019-9-23 14:35:37&#39;, &#39;2019-9-23 14:35:37&#39;);</span><br><span class="line">INSERT INTO &#96;order_info&#96; (&#96;order_id&#96;, &#96;uid&#96;, &#96;nums&#96;, &#96;state&#96;, &#96;create_time&#96;, &#96;update_time&#96;) VALUES (2, 1000002, 1, 2,</span><br><span class="line">&#39;2019-9-24 14:35:37&#39;, &#39;2019-9-24 14:35:37&#39;);</span><br><span class="line">INSERT INTO &#96;order_info&#96; (&#96;order_id&#96;, &#96;uid&#96;, &#96;nums&#96;, &#96;state&#96;, &#96;create_time&#96;, &#96;update_time&#96;) VALUES (3, 1000003, 3, 1,</span><br><span class="line">&#39;2019-9-25 11:35:49&#39;, &#39;2019-9-25 11:35:49&#39;);</span><br></pre></td></tr></table></figure>



<p>order_detail</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (3, 20180001, 85114752, 19.99, 1, 1, 1);</span><br><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (1, 20180002, 25411251, 1280.00, 1, 1, 0);</span><br><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (1, 20180003, 62145412, 288.00, 1, 1, 2);</span><br><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (2, 20180004, 21456985, 399.00, 1, 1, 2);</span><br><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (2, 20180005, 21457452, 1680.00, 1, 1, 2);</span><br><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (2, 20180006, 65214789, 9999.00, 1, 1, 3);</span><br></pre></td></tr></table></figure>



<h4 id="3-3-全局表"><a href="#3-3-全局表" class="headerlink" title="3.3  全局表"></a>3.3  全局表</h4><p>student</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;student&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;sid&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;student&#96; (&#96;sid&#96;, &#96;name&#96;, &#96;qq&#96;) VALUES (1, &#39;黑白&#39;, &#39;166669999&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; (&#96;sid&#96;, &#96;name&#96;, &#96;qq&#96;) VALUES (2, &#39;AV 哥&#39;, &#39;466669999&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; (&#96;sid&#96;, &#96;name&#96;, &#96;qq&#96;) VALUES (3, &#39;最强菜鸟&#39;, &#39;368828888&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; (&#96;sid&#96;, &#96;name&#96;, &#96;qq&#96;) VALUES (4, &#39;加载中&#39;, &#39;655556666&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; (&#96;sid&#96;, &#96;name&#96;, &#96;qq&#96;) VALUES (5, &#39;猫老公&#39;, &#39;265286999&#39;);</span><br><span class="line">INSERT INTO &#96;student&#96; (&#96;sid&#96;, &#96;name&#96;, &#96;qq&#96;) VALUES (6, &#39;一个人的精彩&#39;, &#39;516895555&#39;);</span><br></pre></td></tr></table></figure>



<h4 id="3-4-Mycat全局id"><a href="#3-4-Mycat全局id" class="headerlink" title="3.4 Mycat全局id"></a>3.4 Mycat全局id</h4><p>Mycat 全局序列实现方式主要有4种: 本地文件方式、数据库方式、本地时间戳算法、ZK。 也可以自定义业务序列. </p>
<p>主要获取全局ID的前缀都是<code>MYCATSEQ_</code></p>
<h5 id="3-4-1-本地文件方式"><a href="#3-4-1-本地文件方式" class="headerlink" title="3.4.1 本地文件方式"></a>3.4.1 本地文件方式</h5><p>配置文件<code>件 server.xml</code>  <code>sequnceHandlerType</code>的值:</p>
<p>0:文件、1:数据库、2:本地时间戳、3: ZK</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>文件方式:配置<code>conf/sequence_conf.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">CUSTOMER.HISIDS</span>= <span class="string"></span></span><br><span class="line"><span class="meta">CUSTOMER.MINID</span>=<span class="string">10000001</span></span><br><span class="line"><span class="meta">CUSTOMER.MAXID</span>=<span class="string">20000000</span></span><br><span class="line"><span class="meta">CUSTOMER.CURID</span>=<span class="string">10000001</span></span><br></pre></td></tr></table></figure>

<p>语法: <code>select next value for MYCATSEQ_CUSTOMER</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;customer&#96; (&#96;id&#96;, &#96;name&#96;) VALUES (next value for MYCATSEQ_CUSTOMER, &#39;zhangsan&#39;);</span><br></pre></td></tr></table></figure>

<p>优点: 本地加载, 读取速度快. </p>
<p>缺点: 当Mycat 重新发布后, 配置文件中的<code>sequence</code> 需要替换. Mycat 不能做集群部署. </p>
<h5 id="3-4-2-数据库方式"><a href="#3-4-2-数据库方式" class="headerlink" title="3.4.2  数据库方式"></a>3.4.2  数据库方式</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置:  <code>sequence_db_conf.properties</code></p>
<p>把这张表创建在146上, 所以是db1</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sequence stored in datanode</span></span><br><span class="line"><span class="attr">GLOBAL</span>=<span class="string">dn1</span></span><br><span class="line"><span class="attr">CUSTOMER</span>=<span class="string">dn1</span></span><br></pre></td></tr></table></figure>

<p>在第一个数据库节点上创建<code>MYCAT_SEQUENCE</code> 表:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS MYCAT_SEQUENCE;</span><br><span class="line">CREATE TABLE MYCAT_SEQUENCE (</span><br><span class="line">name VARCHAR(50) NOT NULL,</span><br><span class="line">current_value INT NOT NULL,</span><br><span class="line">increment INT NOT NULL DEFAULT 1,</span><br><span class="line">remark varchar(100),</span><br><span class="line">PRIMARY KEY(name))</span><br><span class="line"> ENGINE&#x3D;InnoDB;</span><br></pre></td></tr></table></figure>

<p>注：可以在<code>schema.xml</code>  配置文件中配置这张表, 供外部访问</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;mycat_sequence&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>创建存储过程, 获取当前的<code>sequence</code>的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DROP FUNCTION IF EXISTS &#96;mycat_seq_currval&#96;;</span><br><span class="line">DELIMITER ;;</span><br><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;%&#96; FUNCTION &#96;mycat_seq_currval&#96;(seq_name VARCHAR(50)) RETURNS varchar(64)</span><br><span class="line">CHARSET latin1</span><br><span class="line">DETERMINISTIC</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE retval VARCHAR(64);</span><br><span class="line">SET retval&#x3D;&quot;-999999999,null&quot;;</span><br><span class="line">SELECT concat(CAST(current_value AS CHAR),&quot;,&quot;,CAST(increment AS CHAR) ) INTO retval FROM</span><br><span class="line">MYCAT_SEQUENCE WHERE name &#x3D; seq_name;</span><br><span class="line">RETURN retval ;</span><br><span class="line">END</span><br><span class="line">;;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>创建存储过程, 获取下一个<code>sequence</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DROP FUNCTION IF EXISTS &#96;mycat_seq_nextval&#96;;</span><br><span class="line">DELIMITER ;;</span><br><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;%&#96; FUNCTION &#96;mycat_seq_nextval&#96;(seq_name VARCHAR(50)) RETURNS varchar(64)</span><br><span class="line">CHARSET latin1</span><br><span class="line">DETERMINISTIC</span><br><span class="line">BEGIN</span><br><span class="line">UPDATE MYCAT_SEQUENCE</span><br><span class="line">SET current_value &#x3D; current_value + increment WHERE name &#x3D; seq_name;</span><br><span class="line">RETURN mycat_seq_currval(seq_name);</span><br><span class="line">END</span><br><span class="line">;;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>创建存储过程, 设置<code>sequence</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DROP FUNCTION IF EXISTS &#96;mycat_seq_setval&#96;;</span><br><span class="line">DELIMITER ;;</span><br><span class="line">CREATE DEFINER&#x3D;&#96;root&#96;@&#96;%&#96; FUNCTION &#96;mycat_seq_setval&#96;(seq_name VARCHAR(50), value INTEGER)</span><br><span class="line">RETURNS varchar(64) CHARSET latin1</span><br><span class="line">DETERMINISTIC</span><br><span class="line">BEGIN</span><br><span class="line">UPDATE MYCAT_SEQUENCE</span><br><span class="line">SET current_value &#x3D; value</span><br><span class="line">WHERE name &#x3D; seq_name;</span><br><span class="line">RETURN mycat_seq_currval(seq_name);</span><br><span class="line">END</span><br><span class="line">;;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p>插入记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO MYCAT_SEQUENCE(name,current_value,increment,remark) VALUES (&#39;GLOBAL&#39;, 1, 100,&#39;&#39;);</span><br><span class="line">INSERT INTO MYCAT_SEQUENCE(name,current_value,increment,remark) VALUES (&#39;ORDERS&#39;, 1, 100,&#39;订单表使</span><br><span class="line">用&#39;);</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select next value for MYCATSEQ_ORDERS</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-4-3-本地时间戳方式"><a href="#3-4-3-本地时间戳方式" class="headerlink" title="3.4.3 本地时间戳方式"></a>3.4.3 本地时间戳方式</h5><p>ID= 64 位二进制 (42(毫秒)+5(机器 ID)+5(业务编码)+12(重复累加) ，长度为 18 位</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置文件<code>sequence_time_conf.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sequence depend on TIME</span></span><br><span class="line"><span class="attr">WORKID</span>=<span class="string">01</span></span><br><span class="line"><span class="attr">DATAACENTERID</span>=<span class="string">01</span></span><br></pre></td></tr></table></figure>

<p>验证: <code>select next value for MYCATSEQ_GLOBAL</code></p>
<p><img src="http://files.luyanan.com//img/20200404223525.png" alt="image-20200404223523720"></p>
<h5 id="3-4-5-ZK方式"><a href="#3-4-5-ZK方式" class="headerlink" title="3.4.5 ZK方式"></a>3.4.5 ZK方式</h5><p>修改<code>conf/myid.properties</code><br>设置<code>loadZk=true</code>（启动时会从zk加载配置, 一定要注意备份配置文件, 并且先用<code>bin/init_zk_data.sh</code>,把配置文件写入到zk）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sequnceHandlerType&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置文件: <code>sequence_distributed_conf.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 代表使用 zk</span></span><br><span class="line"><span class="attr">INSTANCEID</span>=<span class="string">ZK</span></span><br><span class="line"><span class="comment"># 与 myid.properties 中的 CLUSTERID 设置的值相同</span></span><br><span class="line"><span class="attr">CLUSTERID</span>=<span class="string">010</span></span><br></pre></td></tr></table></figure>

<p>复制配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/soft/mycat/conf</span><br><span class="line">cp *.txt *.xml *.properties zkconf/</span><br><span class="line">chown -R zkconf/</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/soft/mycat/bin</span><br><span class="line">./init_zk_data.sh</span><br></pre></td></tr></table></figure>

<p>验证: <code>select next value for MYCATSEQ_GLOBAL</code></p>
<p><img src="http://files.luyanan.com//img/20200404223845.png" alt="image-20200404223843594"></p>
<h4 id="3-5-使用"><a href="#3-5-使用" class="headerlink" title="3.5 使用"></a>3.5 使用</h4><p>在<code>schema.xml</code> 的    <code>table</code>  标签上配置 <code>autoIncrement=&quot;true&quot;</code>,不需要获取和指定序列的情况下, 就可以使用全局ID</p>
<h2 id="4-Mycat-监控和日志监控"><a href="#4-Mycat-监控和日志监控" class="headerlink" title="4. Mycat 监控和日志监控"></a>4. Mycat 监控和日志监控</h2><h3 id="4-1-监控"><a href="#4-1-监控" class="headerlink" title="4.1 监控"></a>4.1 监控</h3><h4 id="4-1-1-命令行监控"><a href="#4-1-1-命令行监控" class="headerlink" title="4.1.1 命令行监控"></a>4.1.1 命令行监控</h4><p>连接到管理端口9066,注意必须带ip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -h127.0.0.1 -p123456 -P9066</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>全部命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;show @@help;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>命令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>show @@server</code></td>
<td>查看服务器状态, 包括占用内存</td>
</tr>
<tr>
<td><code>show @@database</code></td>
<td>查看数据库</td>
</tr>
<tr>
<td><code>show @@datanode</code></td>
<td>查看数据节点</td>
</tr>
<tr>
<td><code>show @@datasource</code></td>
<td>查看数据源</td>
</tr>
<tr>
<td><code>show @@connection</code></td>
<td>该命令用于获取Mycat的前端连接状态, 即应用与mycat 的连接</td>
</tr>
<tr>
<td><code>show @@cache</code></td>
<td>查看缓存使用情况 <br />SQLRouteCache：sql 路由缓存。 <br />TableID2DataNodeCache ： 缓存表主键与分 片对应关系。 <br />ER_SQL2PARENTID ：缓存 ER 分片中子表与 父表关系</td>
</tr>
<tr>
<td><code>reload @@config</code></td>
<td>重新加载配置文件, 使用这个命令时mycat服务不可用</td>
</tr>
<tr>
<td><code>show @@sysparam</code></td>
<td>查看参数</td>
</tr>
<tr>
<td><code>show @@sql.high</code></td>
<td>执行频率高的sql</td>
</tr>
<tr>
<td><code>show @@sql.slow</code></td>
<td>慢SQL<br />设置慢SQL的命令:<code>reload @@sqlslow=5 ;</code></td>
</tr>
<tr>
<td><code>show @@backend</code></td>
<td>查看后端连接状态</td>
</tr>
</tbody></table>
<h4 id="4-1-2-命令行监控-mycatweb-监控"><a href="#4-1-2-命令行监控-mycatweb-监控" class="headerlink" title="4.1.2 命令行监控 mycatweb 监控"></a>4.1.2 命令行监控 <code>mycatweb</code> 监控</h4><p><a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-download/tree/master/mycat-web-1.0">https://github.com/MyCATApache/Mycat-download/tree/master/mycat-web-1.0</a></p>
<p><code>mycat-web</code>是mycat 提供的一个监控工具, 他依赖于zk</p>
<p>本地必须要运行一个zk, 必须先启动zk</p>
<p>下载<code>mycat-web</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/soft</span><br><span class="line">wget http://dl.mycat.io/mycat-web-1.0/Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz</span><br><span class="line">tar -xzvf Mycat-web-1.0-SNAPSHOT-20170102153329-linux.tar.gz</span><br></pre></td></tr></table></figure>

<p>启动<code>mycat-web</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mycat-web</span><br><span class="line">nohup ./start.sh &amp;</span><br></pre></td></tr></table></figure>

<p>停止</p>
<p><code>：kill start.jar</code> 相关的进程</p>
<p>访问端口8082</p>
<p><a target="_blank" rel="noopener" href="http://192.168.8.151:8082/mycat/">http://192.168.8.151:8082/mycat/</a></p>
<p><code>mycat</code> <code> server.xml</code>的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 1 为开启实时统计、0 为关闭 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useSqlStat&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重启<code>mycat</code> 服务生效</p>
<h3 id="4-2-日志"><a href="#4-2-日志" class="headerlink" title="4.2 日志"></a>4.2 日志</h3><p><code>log4j</code>的<code>level</code> 配置要改成<code>debug</code></p>
<h4 id="4-2-1-wrapper-log-日志"><a href="#4-2-1-wrapper-log-日志" class="headerlink" title="4.2.1  wrapper.log 日志"></a>4.2.1  <code>wrapper.log</code> 日志</h4><p><code>wrapper.log</code> 日志: mycat 启动、停止、添加服务等都会被记录到此文件, 如果系统环境配置错误或者缺少配置时, 导致mycat无法启动,可以通过查看<code>wrapper.log</code> 定位具体错误原因. </p>
<h4 id="4-2-2-mycat-log-日志"><a href="#4-2-2-mycat-log-日志" class="headerlink" title="4.2.2  mycat.log 日志"></a>4.2.2  <code>mycat.log</code> 日志</h4><p><code>mycat.log</code> 为mycat的主要日志文件, 记录了启动时分配的相关buffer 信息， 数据源连接信息, 连接池、动态类加载信息等等. </p>
<p>在<code>conf/log4j2.xml</code> 文件中进行相关配置, 如保留个数、大小、字符集、日志文件大小等. </p>
<p>以<code>select</code> 为例</p>
<p><img src="http://files.luyanan.com//img/20200404225555.png" alt="image-20200404225553807"></p>
<h2 id="5-Mycat-高可用"><a href="#5-Mycat-高可用" class="headerlink" title="5. Mycat 高可用"></a>5. Mycat 高可用</h2><p>目前Mycat 没有实现对多<code>Mycat</code> 集群的支持, 可以暂时使用<code>HAProxy</code>来做负载. </p>
<p>思路：<code>HAProxy</code> 对<code>Mycat</code> 进行负载. <code>Keepalived</code>  实现<code>VIP</code></p>
<p><img src="C:/Users/luyanan/Downloads/image%20(1).png" alt="image (http://files.luyanan.com//img/20200406112937.png)"></p>
<h2 id="6-Mycat注解"><a href="#6-Mycat注解" class="headerlink" title="6.Mycat注解"></a>6.Mycat注解</h2><h3 id="6-1-注解的作用"><a href="#6-1-注解的作用" class="headerlink" title="6.1 注解的作用"></a>6.1 注解的作用</h3><p>当关联的数据不再同一个节点的时候, Mycat是无法实现跨库<code>join</code>的. </p>
<p>举例: </p>
<p>如果直接在150节点插入主表数据,151插入明细表数据, 此时关联查询无法查询出来数据. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 150 节点插入</span><br><span class="line">INSERT INTO &#96;order_info&#96; (&#96;order_id&#96;, &#96;uid&#96;, &#96;nums&#96;, &#96;state&#96;, &#96;create_time&#96;, &#96;update_time&#96;) VALUES (9, 1000003, 2673, 1, &#39;2019-9-25 11:35:49&#39;, &#39;2019-9-25 11:35:49&#39;); -- 151 节点插入</span><br><span class="line">INSERT INTO &#96;order_detail&#96; (&#96;order_id&#96;, &#96;id&#96;, &#96;goods_id&#96;, &#96;price&#96;, &#96;is_pay&#96;, &#96;is_ship&#96;, &#96;status&#96;) VALUES (9, 20180001, 2673, 19.99, 1, 1, 1);</span><br></pre></td></tr></table></figure>

<p>在mycat 数据库查询, 直接查询没有查到结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select a.order_id,b.price from order_info a, order_detail b where a.nums &#x3D; b.goods_id;</span><br></pre></td></tr></table></figure>

<p>Mycat 作为一个中间件,有很多自身不支持的SQL语句,比如存储过程,但是这些语句在实际的数据库节点上是可以执行的. 有没有办法让Mycat 做一层透明的代理转发,直接找到目标数据节点去执行这些SQL语句呢?</p>
<p>那我们必须有一种方式来告诉Mycat 应该在那些节点上执行. 这个就是Mycat 的注解, 我们在需要执行的SQL 语句前面加上一段代码, 帮助Mycat 找到我们的目标节点. </p>
<h3 id="6-2-注解的用法"><a href="#6-2-注解的用法" class="headerlink" title="6.2 注解的用法"></a>6.2 注解的用法</h3><p>注解的形式是: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!mycat: sql&#x3D;注解 SQL 语句*&#x2F;</span><br></pre></td></tr></table></figure>

<p>注解的使用方式: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!mycat: sql&#x3D;注解 SQL 语句*&#x2F; 真正执行的 SQL</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用时, 将<code>=</code> 号后面的”注解SQL语句”, 替换为需要的SQL语句即可. </p>
<p>使用注解有一些限制, 或者注意的地方</p>
<table>
<thead>
<tr>
<th>原始SQL</th>
<th>注解SQL</th>
</tr>
</thead>
<tbody><tr>
<td><code>select</code></td>
<td>如果需要分片,则使用能确定分片的注解, 比如<code>/*!mycat: sql=select * from users where user_id=1*/</code><br />如果要在所有的分片上执行则可以不加能确定分片的条件</td>
</tr>
<tr>
<td><code>insert</code></td>
<td>使用<code>insert</code>的表作为注解SQL,必须能确定到某个分片<br />原始SQL插入的字段必须包含分片字段<br />非分片字段(只在某个节点上): 需要能确定到某个分片</td>
</tr>
<tr>
<td><code>delete</code></td>
<td>使用<code>delete</code>的表作为注解SQL</td>
</tr>
<tr>
<td><code>update</code></td>
<td>使用<code>update</code>的表作为注解SQL</td>
</tr>
</tbody></table>
<p>使用注解并不会额外增加Mycat的执行时间,从解析复杂度以及性能考虑, 注解SQL 应该尽量简单,因为它只是用来做路由的. </p>
<p>注解可以帮我们解决什么问题呢?</p>
<h3 id="6-3-注解使用案例"><a href="#6-3-注解使用案例" class="headerlink" title="6.3 注解使用案例"></a>6.3 注解使用案例</h3><h4 id="6-3-1-创建表或存储过程"><a href="#6-3-1-创建表或存储过程" class="headerlink" title="6.3.1 创建表或存储过程"></a>6.3.1 创建表或存储过程</h4><p><code>customer.id=1</code> 全部路由到146</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 存储过程</span><br><span class="line">&#x2F;*!mycat: sql&#x3D;select * from customer where id &#x3D;1 *&#x2F; CREATE PROCEDURE test_proc() BEGIN END ; -- 表</span><br><span class="line">&#x2F;*!mycat: sql&#x3D;select * from customer where id &#x3D;1 *&#x2F; CREATE TABLE test2(id INT);</span><br></pre></td></tr></table></figure>



<h4 id="6-3-2-特殊语句自定义分片"><a href="#6-3-2-特殊语句自定义分片" class="headerlink" title="6.3.2 特殊语句自定义分片"></a>6.3.2 特殊语句自定义分片</h4><p>Mycat 本身不支持<code>insert</code>,<code>select</code>, 通过注解支持</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!mycat: sql&#x3D;select * from customer where id &#x3D;1 *&#x2F; INSERT INTO test2(id) SELECT id FROM order_detail;</span><br></pre></td></tr></table></figure>



<h4 id="6-3-3-多表shareJoin"><a href="#6-3-3-多表shareJoin" class="headerlink" title="6.3.3  多表shareJoin"></a>6.3.3  多表<code>shareJoin</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!mycat:catlet&#x3D;io.mycat.catlets.ShareJoin *&#x2F;</span><br><span class="line">select a.order_id,b.price from order_info a, order_detail b where a.nums </span><br></pre></td></tr></table></figure>



<h4 id="6-3-4-读写分离"><a href="#6-3-4-读写分离" class="headerlink" title="6.3.4 读写分离"></a>6.3.4 读写分离</h4><p>读写分离:配置Mycat读写分离后, 默认查询都会从读节点获取数据, 但是有些场景需要获取实时数据, 如果从读节点获取数据可能因延时而无法实现实时, Mycat 支持通过注解<code>/*balance*/</code> 来强制从写节点(<code>write host</code>) 查询数据.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*balance*&#x2F; select a.* from customer a where a.id&#x3D;6666;</span><br></pre></td></tr></table></figure>



<p>读写分离数据库选择(1.6版本之后)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!mycat: db_type&#x3D;master *&#x2F; select * from customer;</span><br><span class="line">&#x2F;*!mycat: db_type&#x3D;slave *&#x2F; select * from customer;</span><br><span class="line">&#x2F;*#mycat: db_type&#x3D;master *&#x2F; select * from customer;</span><br><span class="line">&#x2F;*#mycat: db_type&#x3D;slave *&#x2F; select * from customer;</span><br></pre></td></tr></table></figure>

<p>支持直接的<code>!</code> 不被mysql 单库兼容</p>
<p>注解支持<code>#</code> 不被Mybatis兼容</p>
<h3 id="6-4-注解原理"><a href="#6-4-注解原理" class="headerlink" title="6.4 注解原理"></a>6.4 注解原理</h3><p>Mycat 在执行SQL 之前会先解析SQL语句, 在获取分片信息后再到对应的物理节点上执行。如果SQL 无法解析,则不能被执行. 如果语句有注解, 则会先会解析注解的内容获取分片信息,再把真正需要执行的SQL语句发送到对应的物理节点上. </p>
<p>所以我们在使用注解的时候, 应该清楚的知道目标SQL 应该在哪个节点上执行, 注解的SQL 也指向这个分片,这样才能使用. 如果注解没有使用正确的条件, 会导致原始SQL 被发送到所有的节点上执行, 造成数据错误. </p>
<h2 id="7-分片策略详解"><a href="#7-分片策略详解" class="headerlink" title="7. 分片策略详解"></a>7. 分片策略详解</h2><p>分片的目标是将大量的数据和访问请求均分分布在多个节点上, 通过这种方式提升数据服务的存储和负载能力. </p>
<p>总体上分为连续分片和离散分片, 还有一种是连续分片和离散分片的结合, 例如先范围后取模. </p>
<p>比如范围分片(id或者时间)就是典型的连续分片, 单个分区的数量和边界是确定的. 离散分片的分区总数量和边界是确定的, 例如对key 进行哈希运算, 或者再取模。 </p>
<p>关键词: 范围查询、热点数据、扩容. </p>
<p>连续分片优点: </p>
<ul>
<li>范围条件查询消耗资源少(不需要汇总数据)</li>
<li>扩容无需迁移数据(分片固定)</li>
</ul>
<p>连续分片缺点:</p>
<ul>
<li>存在热点数据的可能性</li>
<li>并发访问能力受限于单一或者少量<code>DataNode</code>(访问集中)</li>
</ul>
<p>离散分片优点:</p>
<ul>
<li>并发访问能力增强(负载到不同的节点)</li>
<li>范围条件查询能力提升(并行计算)</li>
</ul>
<p>离散分片缺点:</p>
<ul>
<li>数据扩容比较困难,设计到数据迁移问题</li>
<li>数据库连接消耗比较多</li>
</ul>
<h3 id="7-1-连续分片"><a href="#7-1-连续分片" class="headerlink" title="7.1 连续分片"></a>7.1 连续分片</h3><h5 id="范围分片"><a href="#范围分片" class="headerlink" title="范围分片"></a>范围分片</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># range start-end ,data node index</span></span><br><span class="line"><span class="comment"># K=1000,M=10000. 0-500M=0</span></span><br><span class="line"><span class="meta">500M-1000M</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">1000M-1500M</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>

<p>特点: 容易出现冷热数据</p>
<h5 id="按自然月分片"><a href="#按自然月分片" class="headerlink" title="按自然月分片"></a>按自然月分片</h5><p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;sharding_by_month&#96; (</span><br><span class="line">&#96;create_time&#96; timestamp NULL DEFAULT NULL ON UPDATE </span><br><span class="line">    &#96;db_nm&#96; varchar(20) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>逻辑表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;catmall&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_month&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-month&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-month&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>create_time<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>qs-partbymonth<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;qs-partbymonth&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMonth&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2019-10-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2019-12-31<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>columns 标识将要分片的表字段, 字符串类型, 与<code>dataformat</code>格式一致</p>
</li>
<li><p><code>algorithm</code>:为分片函数, </p>
</li>
<li><p><code>dataFormat</code>: 为日期字符串格式</p>
</li>
<li><p><code>sBeginDate</code>为开始日期</p>
</li>
<li><p><code>sEndDate</code>:  为结束日期</p>
<p>注意: 节点个数要大于月份的个数</p>
</li>
</ul>
<p>测试语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO sharding_by_month (create_time,db_nm) VALUES (&#39;2019-10-16&#39;, database());</span><br><span class="line">INSERT INTO sharding_by_month (create_time,db_nm) VALUES (&#39;2019-10-27&#39;, database());</span><br><span class="line">INSERT INTO sharding_by_month (create_time,db_nm) VALUES (&#39;2019-11-04&#39;, database());</span><br><span class="line">INSERT INTO sharding_by_month (create_time,db_nm) VALUES (&#39;2019-11-11&#39;, database());</span><br><span class="line">INSERT INTO sharding_by_month (create_time,db_nm) VALUES (&#39;2019-12-25&#39;, database());</span><br><span class="line">INSERT INTO sharding_by_month (create_time,db_nm) VALUES (&#39;2019-12-31&#39;, database());</span><br></pre></td></tr></table></figure>



<p>另外还有按天分片(可以指定多少天一个分片)、按小时分片</p>
<h3 id="7-2-离散分片"><a href="#7-2-离散分片" class="headerlink" title="7.2 离散分片"></a>7.2 离散分片</h3><h5 id="枚举分片"><a href="#枚举分片" class="headerlink" title="枚举分片"></a>枚举分片</h5><p>将所有可能出现的值列举出来,指定分片.例如: 全局34个省, 要将不同的省的数据存放在不同的节点, 可用枚举 的方式</p>
<p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;sharding_by_intfile&#96; (</span><br><span class="line">&#96;age&#96; int(11) NOT NULL,</span><br><span class="line"> &#96;db_nm&#96; varchar(20) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>逻辑表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_intfile&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn$1-3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-intfile&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-intfile&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>sharding_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.opencloudb.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>type: 默认值为0, 0表示<code>Integer</code>,非零表示<code>String</code></p>
<p><code>PartitionByFileMap.java</code>  通过map实现</p>
<p>策略文件:  <code>partition-hash-int.txt</code></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">16=0</span><br><span class="line">17=1</span><br><span class="line">18=2</span><br></pre></td></tr></table></figure>

<p>插入数据测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;sharding_by_intfile&#96; (age,db_nm) VALUES (16, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_intfile&#96; (age,db_nm) VALUES (17, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_intfile&#96; (age,db_nm) VALUES (18, database())</span><br></pre></td></tr></table></figure>

<p>特点: 适用于枚举值固定的场景. </p>
<h5 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h5><p>一致性hash 有效的解决了分布式数据的扩容问题</p>
<p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;sharding_by_murmur&#96; (</span><br><span class="line">&#96;id&#96; int(10) DEFAULT NULL,</span><br><span class="line"> &#96;db_nm&#96; varchar(20) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>逻辑表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_murmurhash&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn$1-3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding-by-murmur&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-murmur&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>qs-murmur<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;qs-murmur&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMurmurHash&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;seed&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;virtualBucketTimes&quot;</span>&gt;</span>160<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (1, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (2, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (3, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (4, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (5, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (6, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (7, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (8, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (9, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (10, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (11, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (12, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (13, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (14, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (15, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (16, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (17, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (18, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (19, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_murmur&#96; (id,db_nm) VALUES (20, database());</span><br></pre></td></tr></table></figure>

<p>特点: 可以一定程序上 减少数据的迁移. </p>
<h5 id="十进制取模分片"><a href="#十进制取模分片" class="headerlink" title="十进制取模分片"></a>十进制取模分片</h5><p>根据分片键进行十进制求模运算. </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>sid<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>特点: 分布均匀, 但是迁移工作量比较大. </p>
<h5 id="固定分片哈希"><a href="#固定分片哈希" class="headerlink" title="固定分片哈希"></a>固定分片哈希</h5><p>这是先求模得到逻辑分片号, 再根据逻辑分片号直接映射到物理分片的一种散列算法</p>
<p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;sharding_by_long&#96; (</span><br><span class="line">&#96;id&#96; int(10) DEFAULT NULL,</span><br><span class="line">    &#96;db_nm&#96; varchar(20) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>逻辑表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_long&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn$1-3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;qs-sharding-by-long&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>qs-sharding-by-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>平均分成8片(%1024的余数, 1024=128*8)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;qs-sharding-by-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>128<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>partitionCount:  为指定分片个数列表</li>
<li>partitionLength: 为分片范围列表</li>
</ul>
<p><img src="http://files.luyanan.com//img/20200406153633.png" alt="image-20200406153632403"></p>
<p>第二个例子: </p>
<p>两个数组,分成不均匀的3个节点(%1024的余数,1024=2*256+1*512)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;qs-sharding-by-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByLong&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>2,1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>256,512<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3个节点, 对1024取模余数的分布</p>
<p><img src="http://files.luyanan.com//img/20200406153847.png" alt="image-20200406153846049"></p>
<p>测试语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;sharding_by_long&#96; (id,db_nm) VALUES (222, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_long&#96; (id,db_nm) VALUES (333, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_long&#96; (id,db_nm) VALUES (666, database());</span><br></pre></td></tr></table></figure>

<p>特点: 在一定范围内id是连续分布的. </p>
<h5 id="取模范围分布"><a href="#取模范围分布" class="headerlink" title="取模范围分布"></a>取模范围分布</h5><p>逻辑表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_pattern&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn$0-10&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-pattern&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;sharding_by_pattern&#96; (</span><br><span class="line">&#96;id&#96; varchar(20) DEFAULT NULL,</span><br><span class="line"> &#96;db_nm&#96; varchar(20) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-pattern&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>user_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-pattern<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-pattern&quot;</span> <span class="attr">class</span>=<span class="string">&quot; io.mycat.route.function.PartitionByPattern&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;patternValue&quot;</span>&gt;</span>100<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-pattern.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>patternValue</code> 取模基数, 这里设置成100</p>
<p><code>partition-pattern.txt</code> , 一共三个节点</p>
<p>id=19%100=19，在 dn1；<br>       id=222%100=22，dn2；<br>       id=371%100=71，dn3</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id partition range start-end ,data node index</span></span><br><span class="line"><span class="comment">###### first host configuration</span></span><br><span class="line"><span class="meta">1-20</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">21-70</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">71-100</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">0-0</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<p>测试语句: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;sharding_by_pattern&#96; (id,db_nm) VALUES (19, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_pattern&#96; (id,db_nm) VALUES (222, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_pattern&#96; (id,db_nm) VALUES (371, database());</span><br></pre></td></tr></table></figure>

<p>特点: 可以调整节点的数据分布</p>
<h5 id="范围取模分片"><a href="#范围取模分片" class="headerlink" title="范围取模分片"></a>范围取模分片</h5><p>建表语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;sharding_by_rang_mod&#96; (</span><br><span class="line">&#96;id&#96; bigint(20) DEFAULT NULL,</span><br><span class="line"> &#96;db_nm&#96; varchar(20) DEFAULT NULL</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>逻辑表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_rang_mod&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn$1-3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-rang-mod&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;qs-sharding-by-rang-mod&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>qs-rang-mod<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分片算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;qs-rang-mod&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByRangeMod&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-range-mod.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>partition-range-mod.txt</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># range start-end ,data node group size</span></span><br><span class="line"><span class="meta">0-20000</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">20001-40000</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>

<p>解读: 先范围后取模, id在20000以内的, 全部分布到dn1, id在20001-40000的, %2分布到dn2、dn3. </p>
<p>插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (666, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (6667, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (16666, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (21111, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (22222, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (23333, database());</span><br><span class="line">INSERT INTO &#96;sharding_by_rang_mod&#96; (id,db_nm) VALUES (24444, database());</span><br></pre></td></tr></table></figure>

<p>特点:扩容的时候旧数据无需迁移. </p>
<h5 id="其他分片规则"><a href="#其他分片规则" class="headerlink" title="其他分片规则"></a>其他分片规则</h5><p>应用指定分片: <code>PartitionDirectBySubString</code></p>
<p>日期范围哈希: <code>PartitionByRangeDateHash</code></p>
<p>冷热数据分片： <code>PartitionByHotDate</code></p>
<p>也可以自定义分片规则: <code>extends AbstractPartitionAlgorithm implements RuleAlgorithm。</code></p>
<h3 id="7-3-切分规则的选择"><a href="#7-3-切分规则的选择" class="headerlink" title="7.3 切分规则的选择"></a>7.3 切分规则的选择</h3><p>步骤: </p>
<ol>
<li>找到需要切分的大表, 和关联的表</li>
<li>确定分片的字段(尽量使用主键),一般是用最频繁使用的查询条件</li>
<li>考虑单个分片的存储容量和请求,数据增长(业务特性)、扩容和数据迁移问题</li>
</ol>
<p>例如： 按照什么递增? 序号还是日期?主键是否还有业务意义? </p>
<p>一般来说,分片数要比当前规划的节点数要大</p>
<p> 总结: 根据业务场景, 合理的选择分片规则</p>
<h2 id="8-Mycat-离线扩缩容"><a href="#8-Mycat-离线扩缩容" class="headerlink" title="8. Mycat 离线扩缩容"></a>8. Mycat 离线扩缩容</h2><p>当我们规划了数据分片, 而数据已经超过了单个节点的存储上限或者需要下线节点的时候, 就需要对数据进行重新分片. </p>
<h3 id="8-1-Mycat-自带的工具"><a href="#8-1-Mycat-自带的工具" class="headerlink" title="8.1 Mycat 自带的工具"></a>8.1 Mycat 自带的工具</h3><h4 id="8-1-1-准备工作"><a href="#8-1-1-准备工作" class="headerlink" title="8.1.1 准备工作"></a>8.1.1 准备工作</h4><ol>
<li>mycat 所在环境安装mysql 客户端</li>
<li>mycat 的<code>lib</code> 目录下添加<code>mysql</code>的<code>jdbc</code> 驱动</li>
<li>对扩缩容的表所有节点进行备份, 以免迁移失败后的数据恢复</li>
</ol>
<h4 id="8-1-2-步骤"><a href="#8-1-2-步骤" class="headerlink" title="8.1.2 步骤"></a>8.1.2 步骤</h4><p>以取模分片<code>sharding-by-mod</code> 缩容为例. </p>
<p><img src="http://files.luyanan.com//img/20200406160218.png" alt="image-20200406160217558"></p>
<ol>
<li>复制 <code>schema.xml</code>、<code>rule.xml</code> 重命名为<code>newSchema.xml</code>、<code>newRule.xml</code> 放于<code>conf</code>目录下</li>
<li>修改<code>newSchema.xml </code>和 <code>newRule.xml</code> 配置文件为扩缩容后的mycat 配置参数(表的节点数、数据源、路由规则)</li>
</ol>
<p>注意： </p>
<p>只有节点变化的表才会进行迁移,仅分片配置变化不会迁移. </p>
<p><code>newSchema.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_mod&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-mod&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改成(减少了一个节点)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_mod&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;qs-sharding-by-mod&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>newRule.xml</code> 修改<code>count</code> 的个数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;qs-sharding-by-mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>修改<code>conf</code> 目录下的<code>migrateTables.properties</code> 的配置文件,告诉工具那些表需要进行扩容或者缩容, 没有出现在此配置文件的<code>schema</code> 表 不会进行数据迁移, 格式:</p>
<p> 注意: </p>
<ol>
<li>不迁移的表, 不要修改dn的个数, 否则会出错</li>
<li>ER表,因为只有主表有分片规则, 字表不会进行迁移</li>
</ol>
</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">catmall</span>=<span class="string">sharding-by-mod</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><p><code>dataMigrate.sh</code> 中这个配置必须配置</p>
<p> 通过命令 <code>&quot;find / -name mysqldump&quot;</code> 查找<code>mysqldump</code> 路径为：<code>/usr/bin/mysqldump</code>,指定<code>#mysql bin</code> 路径为<code>/usr/bin</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql bin 路径</span></span><br><span class="line"><span class="attr">RUN_CMD</span>=<span class="string">&quot;$RUN_CMD -mysqlBin= /usr/bin/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>停止mycat 服务</p>
</li>
<li><p>执行<code>bin/ dataMigrate.sh</code> 脚本</p>
<blockquote>
<p> 必须要配置java 环境变量, 不能用openjdk</p>
</blockquote>
</li>
<li><p>脚本执行完成, 如果最后的数据迁移验证通过, 就可以将之前的<code>newSchema.xml</code> 和 <code>newRule.xml</code> 替换之前的 <code>schema.xml</code> 和 <code>rule.xml </code>文 件，并重启 mycat 即可。</p>
</li>
</ol>
<p>注意事项： </p>
<ol>
<li><p>保证分片表迁移数据前后路由规则一直(取模-取模)</p>
</li>
<li><p>保证分片表迁移数据前后分片字段一致</p>
</li>
<li><p>全局表将被忽略</p>
</li>
<li><p>不要将非分片表配置到 <code>migrateTables.properties</code> 文件中., </p>
</li>
<li><p>暂时只支持分片表使用Mysql 作为数据源的扩容缩容</p>
<p><code>migrate</code> 限制比较多, 还可以使用<code>mysqldump</code> 方法</p>
</li>
</ol>
<h3 id="8-2-mysqldump-方式"><a href="#8-2-mysqldump-方式" class="headerlink" title="8.2 mysqldump 方式"></a>8.2 <code>mysqldump</code> 方式</h3><p>系统第一次上线, 把单张表迁移到mycat,也可以用<code>mysqldump</code></p>
<p>Mysql 导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p123456 -h127.0.0.1 -P3306 -c -t --skip-extended-insert gpcat &gt; mysql-1017.sql</span><br></pre></td></tr></table></figure>



<ul>
<li>-c 代表带列名</li>
<li>-t 代表只要数据, 不要建表语句</li>
<li>–skip-extended-insert 代表生成多行 insert（mycat childtable 不支持多行插入 咕泡出品，必属精品 <a target="_blank" rel="noopener" href="http://www.gupaoedu.com/">www.gupaoedu.com</a> 28 ChildTable multi insert not provided）</li>
</ul>
<p>Mycat导入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456 -h127.0.0.1 -P8066 catmall &lt; mysql-1017.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Mycat导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -h192.168.8.151 -uroot -p123456 -P8066 -c -t --skip-extended-insert catmall customer &gt; mycat-cust.sql</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>其他导入方式: </p>
<p><code>load data local infile &#39;/mycat/customer.txt&#39; into table customer;</code></p>
<p><code>source sql &#39;/mycat/customer.sql&#39;;</code></p>
<h2 id="9-核心流程总结"><a href="#9-核心流程总结" class="headerlink" title="9. 核心流程总结"></a>9. 核心流程总结</h2><p>官网的架构图</p>
<p><img src="http://files.luyanan.com//img/20200406164438.png" alt="image-20200406164437442"></p>
<h4 id="9-1-启动"><a href="#9-1-启动" class="headerlink" title="9.1  启动"></a>9.1  启动</h4><ol>
<li>mycatServer 启动, 解析配置文件, 包括服务器、分片规则</li>
<li>创建工作线程, 建立前端连接和后端连接</li>
</ol>
<h4 id="9-2-执行SQL"><a href="#9-2-执行SQL" class="headerlink" title="9.2 执行SQL"></a>9.2 执行SQL</h4><ol>
<li><p>前端连接接受MYSQL 命令</p>
</li>
<li><p>解析MYSQL, mycat 用的是Druid 的 DruidParser</p>
</li>
<li><p>获取路由</p>
</li>
<li><p>改写MYSQL,例如两个条件在两个节点, 则变成两条单独的SQL</p>
<p> 例如： <code>select * from customer where id in(5000001, 10000001);</code></p>
<p>改写成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from customer where id &#x3D; 5000001；（dn2 执行）</span><br><span class="line">select * from customer where id &#x3D; 10000001；（dn3 执行）</span><br></pre></td></tr></table></figure>
</li>
<li><p>与后盾数据库建立连接</p>
</li>
<li><p>发送SQL语句到MYSQL 执行</p>
</li>
<li><p>获取返回结果</p>
</li>
<li><p>处理返回结果, 例如排序、计算等等</p>
</li>
<li><p>返回给客户端</p>
</li>
</ol>
<h2 id="10-源码下载和调试环境搭建"><a href="#10-源码下载和调试环境搭建" class="headerlink" title="10 源码下载和调试环境搭建"></a>10 源码下载和调试环境搭建</h2><h3 id="10-1-下载源代码-导入工程"><a href="#10-1-下载源代码-导入工程" class="headerlink" title="10.1 下载源代码, 导入工程"></a>10.1 下载源代码, 导入工程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/MyCATApache/Mycat-Server</span><br></pre></td></tr></table></figure>



<h3 id="10-2-配置"><a href="#10-2-配置" class="headerlink" title="10.2 配置"></a>10.2 配置</h3><p><code>schema.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;travelrecord&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;hotnews&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db2&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db3&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;20&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;127.0.0.1:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="10-3-表结构"><a href="#10-3-表结构" class="headerlink" title="10.3 表结构"></a>10.3 表结构</h3><p>本地数据库创建db1、db2、db3 数据库, 全部执行建表脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;company&#96; (</span><br><span class="line">&#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> &#96;name&#96; varchar(64) DEFAULT &#39;&#39;,</span><br><span class="line"> &#96;market_value&#96; bigint(20) DEFAULT &#39;0&#39;, PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;2 DEFAULT CHARSET&#x3D;utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;hotnews&#96; (</span><br><span class="line">&#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> &#96;title&#96; varchar(64) DEFAULT &#39;&#39;,</span><br><span class="line"> &#96;content&#96; varchar(512) DEFAULT &#39;0&#39;,</span><br><span class="line"> &#96;time&#96; varchar(8) DEFAULT &#39;&#39;,</span><br><span class="line"> &#96;cat_name&#96; varchar(10) DEFAULT &#39;&#39;,</span><br><span class="line"> PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;travelrecord&#96; (</span><br><span class="line">&#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line"> &#96;city&#96; varchar(32) DEFAULT &#39;&#39;,</span><br><span class="line"> &#96;time&#96; varchar(8) DEFAULT &#39;&#39;, </span><br><span class="line">PRIMARY KEY (&#96;id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4;</span><br></pre></td></tr></table></figure>





<h3 id="10-4逻辑表配置"><a href="#10-4逻辑表配置" class="headerlink" title="10.4逻辑表配置"></a>10.4逻辑表配置</h3><p><code>travelrecord</code> 表配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;travelrecord&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><code>hotnews</code> 表配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;hotnews&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">autoIncrement</span>=<span class="string">&quot;true&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><code>company</code> 表配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;company&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;ID&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="10-5-debug-方式启动"><a href="#10-5-debug-方式启动" class="headerlink" title="10.5 debug 方式启动"></a>10.5 debug 方式启动</h3><p>debug方式启动`main 方式</p>
<p><code>Mycat-Server-1.6.5-RELEASE\src\main\java\io\mycat\MycatStartup.java</code></p>
<h3 id="10-6-连接本地Mycat-服务"><a href="#10-6-连接本地Mycat-服务" class="headerlink" title="10.6 连接本地Mycat 服务"></a>10.6 连接本地Mycat 服务</h3><p>测试语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">insert into travelrecord(&#96;id&#96;, &#96;city&#96;, &#96;time&#96;) values(1, &#39;长沙&#39;, &#39;20191020&#39;);</span><br><span class="line">insert into hotnews(&#96;title&#96;, &#96;content&#96;) values(&#39;新闻&#39;, &#39;aaaa&#39;);</span><br><span class="line">insert into company(&#96;name&#96;, &#96;market_value&#96;) values(&#39;spring&#39;, 100);</span><br></pre></td></tr></table></figure>



<h3 id="10-7-调试入口"><a href="#10-7-调试入口" class="headerlink" title="10.7 调试入口"></a>10.7 调试入口</h3><p>连接入口</p>
<p><code>io.mycat.net.NIOAcceptor#accept</code></p>
<p>SQL入口</p>
<p><code>io.mycat.server.ServerQueryHandler#query</code></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BSharding-JDBC(5)/" rel="prev" title="分库分表之Sharding-JDBC(5)">
      <i class="fa fa-chevron-left"></i> 分库分表之Sharding-JDBC(5)
    </a></div>
      <div class="post-nav-item">
    <a href="/%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8(1)/" rel="next" title="为什么要分库分表(1)">
      为什么要分库分表(1) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BMycat"><span class="nav-number">1.</span> <span class="nav-text">分库分表之Mycat</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Mycat%E4%BB%8B%E7%BB%8D%E5%92%8C%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">1.Mycat介绍和核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.0.1.</span> <span class="nav-text">1.1 基本介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.0.2.</span> <span class="nav-text">1.2 核心概念</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Mycat-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.2.</span> <span class="nav-text">2. Mycat 配置详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-server-xml"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 server.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-schema-xml"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2  schema.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#lt-table-gt"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">&lt;&#x2F;table&gt;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lt-dataNode-gt"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">&lt;dataNode&gt;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#lt-dataHost-gt"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">&lt;dataHost&#x2F;&gt;</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-rule-xml"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 rule.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-ZK%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 ZK配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E5%90%AF%E5%8A%A8%E5%81%9C%E6%AD%A2"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 启动停止</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Mycat-%E5%88%86%E7%89%87%E9%AA%8C%E8%AF%81"><span class="nav-number">1.3.</span> <span class="nav-text">3. Mycat 分片验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="nav-number">1.3.0.1.</span> <span class="nav-text">3.1 范围分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87-ER%E8%A1%A8"><span class="nav-number">1.3.0.2.</span> <span class="nav-text">3.2 取模分片(ER表)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="nav-number">1.3.0.3.</span> <span class="nav-text">3.3  全局表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-4-Mycat%E5%85%A8%E5%B1%80id"><span class="nav-number">1.3.0.4.</span> <span class="nav-text">3.4 Mycat全局id</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-1-%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.0.4.1.</span> <span class="nav-text">3.4.1 本地文件方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.0.4.2.</span> <span class="nav-text">3.4.2  数据库方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-3-%E6%9C%AC%E5%9C%B0%E6%97%B6%E9%97%B4%E6%88%B3%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.0.4.3.</span> <span class="nav-text">3.4.3 本地时间戳方式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-4-5-ZK%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.0.4.4.</span> <span class="nav-text">3.4.5 ZK方式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-5-%E4%BD%BF%E7%94%A8"><span class="nav-number">1.3.0.5.</span> <span class="nav-text">3.5 使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Mycat-%E7%9B%91%E6%8E%A7%E5%92%8C%E6%97%A5%E5%BF%97%E7%9B%91%E6%8E%A7"><span class="nav-number">1.4.</span> <span class="nav-text">4. Mycat 监控和日志监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E7%9B%91%E6%8E%A7"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-1-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9B%91%E6%8E%A7"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">4.1.1 命令行监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-2-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%9B%91%E6%8E%A7-mycatweb-%E7%9B%91%E6%8E%A7"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">4.1.2 命令行监控 mycatweb 监控</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E6%97%A5%E5%BF%97"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-wrapper-log-%E6%97%A5%E5%BF%97"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">4.2.1  wrapper.log 日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-mycat-log-%E6%97%A5%E5%BF%97"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">4.2.2  mycat.log 日志</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Mycat-%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">1.5.</span> <span class="nav-text">5. Mycat 高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Mycat%E6%B3%A8%E8%A7%A3"><span class="nav-number">1.6.</span> <span class="nav-text">6.Mycat注解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 注解的作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%B3%A8%E8%A7%A3%E7%9A%84%E7%94%A8%E6%B3%95"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 注解的用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E6%B3%A8%E8%A7%A3%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-number">1.6.3.</span> <span class="nav-text">6.3 注解使用案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%88%96%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">6.3.1 创建表或存储过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-%E7%89%B9%E6%AE%8A%E8%AF%AD%E5%8F%A5%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E7%89%87"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">6.3.2 特殊语句自定义分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-3-%E5%A4%9A%E8%A1%A8shareJoin"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">6.3.3  多表shareJoin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-4-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">1.6.3.4.</span> <span class="nav-text">6.3.4 读写分离</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-%E6%B3%A8%E8%A7%A3%E5%8E%9F%E7%90%86"><span class="nav-number">1.6.4.</span> <span class="nav-text">6.4 注解原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.7.</span> <span class="nav-text">7. 分片策略详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E8%BF%9E%E7%BB%AD%E5%88%86%E7%89%87"><span class="nav-number">1.7.1.</span> <span class="nav-text">7.1 连续分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="nav-number">1.7.1.0.1.</span> <span class="nav-text">范围分片</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8C%89%E8%87%AA%E7%84%B6%E6%9C%88%E5%88%86%E7%89%87"><span class="nav-number">1.7.1.0.2.</span> <span class="nav-text">按自然月分片</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E7%A6%BB%E6%95%A3%E5%88%86%E7%89%87"><span class="nav-number">1.7.2.</span> <span class="nav-text">7.2 离散分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E5%88%86%E7%89%87"><span class="nav-number">1.7.2.0.1.</span> <span class="nav-text">枚举分片</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C"><span class="nav-number">1.7.2.0.2.</span> <span class="nav-text">一致性哈希</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8D%81%E8%BF%9B%E5%88%B6%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87"><span class="nav-number">1.7.2.0.3.</span> <span class="nav-text">十进制取模分片</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9B%BA%E5%AE%9A%E5%88%86%E7%89%87%E5%93%88%E5%B8%8C"><span class="nav-number">1.7.2.0.4.</span> <span class="nav-text">固定分片哈希</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%96%E6%A8%A1%E8%8C%83%E5%9B%B4%E5%88%86%E5%B8%83"><span class="nav-number">1.7.2.0.5.</span> <span class="nav-text">取模范围分布</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87"><span class="nav-number">1.7.2.0.6.</span> <span class="nav-text">范围取模分片</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="nav-number">1.7.2.0.7.</span> <span class="nav-text">其他分片规则</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-%E5%88%87%E5%88%86%E8%A7%84%E5%88%99%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-number">1.7.3.</span> <span class="nav-text">7.3 切分规则的选择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Mycat-%E7%A6%BB%E7%BA%BF%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="nav-number">1.8.</span> <span class="nav-text">8. Mycat 离线扩缩容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-Mycat-%E8%87%AA%E5%B8%A6%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="nav-number">1.8.1.</span> <span class="nav-text">8.1 Mycat 自带的工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">8.1.1 准备工作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.8.1.2.</span> <span class="nav-text">8.1.2 步骤</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-mysqldump-%E6%96%B9%E5%BC%8F"><span class="nav-number">1.8.2.</span> <span class="nav-text">8.2 mysqldump 方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="nav-number">1.9.</span> <span class="nav-text">9. 核心流程总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#9-1-%E5%90%AF%E5%8A%A8"><span class="nav-number">1.9.0.1.</span> <span class="nav-text">9.1  启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-2-%E6%89%A7%E8%A1%8CSQL"><span class="nav-number">1.9.0.2.</span> <span class="nav-text">9.2 执行SQL</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%92%8C%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">1.10.</span> <span class="nav-text">10 源码下载和调试环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%E4%B8%8B%E8%BD%BD%E6%BA%90%E4%BB%A3%E7%A0%81-%E5%AF%BC%E5%85%A5%E5%B7%A5%E7%A8%8B"><span class="nav-number">1.10.1.</span> <span class="nav-text">10.1 下载源代码, 导入工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.2.</span> <span class="nav-text">10.2 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">1.10.3.</span> <span class="nav-text">10.3 表结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4%E9%80%BB%E8%BE%91%E8%A1%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">1.10.4.</span> <span class="nav-text">10.4逻辑表配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-debug-%E6%96%B9%E5%BC%8F%E5%90%AF%E5%8A%A8"><span class="nav-number">1.10.5.</span> <span class="nav-text">10.5 debug 方式启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-6-%E8%BF%9E%E6%8E%A5%E6%9C%AC%E5%9C%B0Mycat-%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.10.6.</span> <span class="nav-text">10.6 连接本地Mycat 服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-7-%E8%B0%83%E8%AF%95%E5%85%A5%E5%8F%A3"><span class="nav-number">1.10.7.</span> <span class="nav-text">10.7 调试入口</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">229</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luyanan0718" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luyanan0718" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/luyanan0718@163.com" title="E-Mail → luyanan0718@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://luyanan.com/" title="https:&#x2F;&#x2F;luyanan.com">Site</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
