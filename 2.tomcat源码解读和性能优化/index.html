<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="tomcat源码解读和性能优化1. 源码解读1.1 BootStrapBootStrap 是tomcat的入口类. org.apache.catalina.startup.Bootstrap#main">
<meta property="og:type" content="article">
<meta property="og:title" content="2">
<meta property="og:url" content="http://luyanan.com/2.tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%92%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="tomcat源码解读和性能优化1. 源码解读1.1 BootStrapBootStrap 是tomcat的入口类. org.apache.catalina.startup.Bootstrap#main">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://files.luyanan.com//img/20200513103841.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200513103844.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200513103848.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200513103826.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200513104314.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200513104345.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200513104730.png">
<meta property="article:published_time" content="2021-03-02T05:42:51.719Z">
<meta property="article:modified_time" content="2021-03-02T05:42:51.719Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Python, Rust, C++, Go, 爬虫, 深度学习, 服务研发, 对象存储">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://files.luyanan.com//img/20200513103841.png">

<link rel="canonical" href="http://luyanan.com/2.tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%92%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>2 | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/2.tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%92%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-02 13:42:51" itemprop="dateCreated datePublished" datetime="2021-03-02T13:42:51+08:00">2021-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tomcat/" itemprop="url" rel="index"><span itemprop="name">tomcat</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="tomcat源码解读和性能优化"><a href="#tomcat源码解读和性能优化" class="headerlink" title="tomcat源码解读和性能优化"></a>tomcat源码解读和性能优化</h1><h2 id="1-源码解读"><a href="#1-源码解读" class="headerlink" title="1. 源码解读"></a>1. 源码解读</h2><h3 id="1-1-BootStrap"><a href="#1-1-BootStrap" class="headerlink" title="1.1 BootStrap"></a>1.1 <code>BootStrap</code></h3><p><code>BootStrap</code> 是<code>tomcat</code>的入口类.</p>
<p><code>org.apache.catalina.startup.Bootstrap#main</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Main method and entry point when starting Tomcat via the provided</span></span><br><span class="line"><span class="comment">    * scripts.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> args Command line arguments to be processed</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (daemon == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// Don&#x27;t set daemon until init() has completed</span></span><br><span class="line">           Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               bootstrap.init();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">               handleThrowable(t);</span><br><span class="line">               t.printStackTrace();</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           daemon = bootstrap;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// When running as a service the call to stop will be on a new</span></span><br><span class="line">           <span class="comment">// thread so make sure the correct class loader is used to prevent</span></span><br><span class="line">           <span class="comment">// a range of class not found exceptions.</span></span><br><span class="line">           Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String command = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">           <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               command = args[args.length - <span class="number">1</span>];</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (command.equals(<span class="string">&quot;startd&quot;</span>)) &#123;</span><br><span class="line">               args[args.length - <span class="number">1</span>] = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">               daemon.load(args);</span><br><span class="line">               daemon.start();</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stopd&quot;</span>)) &#123;</span><br><span class="line">               args[args.length - <span class="number">1</span>] = <span class="string">&quot;stop&quot;</span>;</span><br><span class="line">               daemon.stop();</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">               daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">               daemon.load(args);</span><br><span class="line">               daemon.start();</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stop&quot;</span>)) &#123;</span><br><span class="line">               daemon.stopServer(args);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;configtest&quot;</span>)) &#123;</span><br><span class="line">               daemon.load(args);</span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">null</span>==daemon.getServer()) &#123;</span><br><span class="line">                   System.exit(<span class="number">1</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               System.exit(<span class="number">0</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               log.warn(<span class="string">&quot;Bootstrap: command \&quot;&quot;</span> + command + <span class="string">&quot;\&quot; does not exist.&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           <span class="comment">// Unwrap the Exception for clearer error reporting</span></span><br><span class="line">           <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">                   t.getCause() != <span class="keyword">null</span>) &#123;</span><br><span class="line">               t = t.getCause();</span><br><span class="line">           &#125;</span><br><span class="line">           handleThrowable(t);</span><br><span class="line">           t.printStackTrace();</span><br><span class="line">           System.exit(<span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>bootstrap.init()</code> 和 创建<code>Catalina</code></p>
<h3 id="1-2-Catalina"><a href="#1-2-Catalina" class="headerlink" title="1.2 Catalina"></a>1.2 <code>Catalina</code></h3><p>解析<code>server.xml</code> 配置文件</p>
<p>创建<code>Server</code>组件,并且调用其<code>init</code>和<code>start</code>方法</p>
<p>当调用<code>daemon.load(args);</code>的时候, 进入到<code>org.apache.catalina.startup.Bootstrap#load</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Load daemon.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Call the load() method</span></span><br><span class="line">       String methodName = <span class="string">&quot;load&quot;</span>;</span><br><span class="line">       Object param[];</span><br><span class="line">       Class&lt;?&gt; paramTypes[];</span><br><span class="line">       <span class="keyword">if</span> (arguments==<span class="keyword">null</span> || arguments.length==<span class="number">0</span>) &#123;</span><br><span class="line">           paramTypes = <span class="keyword">null</span>;</span><br><span class="line">           param = <span class="keyword">null</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</span><br><span class="line">           paramTypes[<span class="number">0</span>] = arguments.getClass();</span><br><span class="line">           param = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br><span class="line">           param[<span class="number">0</span>] = arguments;</span><br><span class="line">       &#125;</span><br><span class="line">       Method method =</span><br><span class="line">           catalinaDaemon.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">       <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">           log.debug(<span class="string">&quot;Calling startup class &quot;</span> + method);</span><br><span class="line">       method.invoke(catalinaDaemon, param);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们看到用反射调用了<code>org.apache.catalina.startup.Catalina#load()</code> 方法</p>
<p>真正的执行步骤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Start a new server instance.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line"></span><br><span class="line">       initDirs();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Before digester - it may be needed</span></span><br><span class="line">       initNaming();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Create and execute our Digester</span></span><br><span class="line">       Digester digester = createStartDigester();</span><br><span class="line"></span><br><span class="line">       InputSource inputSource = <span class="keyword">null</span>;</span><br><span class="line">       InputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">       File file = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           file = configFile();</span><br><span class="line">           inputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">           inputSource = <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">               log.debug(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>, file), e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               inputStream = getClass().getClassLoader()</span><br><span class="line">                   .getResourceAsStream(getConfigFile());</span><br><span class="line">               inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">                   (getClass().getClassLoader()</span><br><span class="line">                    .getResource(getConfigFile()).toString());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                   log.debug(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                           getConfigFile()), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// This should be included in catalina.jar</span></span><br><span class="line">       <span class="comment">// Alternative: don&#x27;t bother with xml, just create it manually.</span></span><br><span class="line">       <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               inputStream = getClass().getClassLoader()</span><br><span class="line">                       .getResourceAsStream(<span class="string">&quot;server-embed.xml&quot;</span>);</span><br><span class="line">               inputSource = <span class="keyword">new</span> InputSource</span><br><span class="line">               (getClass().getClassLoader()</span><br><span class="line">                       .getResource(<span class="string">&quot;server-embed.xml&quot;</span>).toString());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                   log.debug(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                           <span class="string">&quot;server-embed.xml&quot;</span>), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (inputStream == <span class="keyword">null</span> || inputSource == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span>  (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">               log.warn(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                       getConfigFile() + <span class="string">&quot;] or [server-embed.xml]&quot;</span>));</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               log.warn(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>,</span><br><span class="line">                       file.getAbsolutePath()));</span><br><span class="line">               <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                   log.warn(<span class="string">&quot;Permissions incorrect, read permission is not allowed on the file.&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           inputSource.setByteStream(inputStream);</span><br><span class="line">           digester.push(<span class="keyword">this</span>);</span><br><span class="line">           digester.parse(inputSource);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (SAXParseException spe) &#123;</span><br><span class="line">           log.warn(<span class="string">&quot;Catalina.start using &quot;</span> + getConfigFile() + <span class="string">&quot;: &quot;</span> +</span><br><span class="line">                   spe.getMessage());</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.warn(<span class="string">&quot;Catalina.start using &quot;</span> + getConfigFile() + <span class="string">&quot;: &quot;</span> , e);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               inputStream.close();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               <span class="comment">// Ignore</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       getServer().setCatalina(<span class="keyword">this</span>);</span><br><span class="line">       getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">       getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Stream redirection</span></span><br><span class="line">       initStreams();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start the new server</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           getServer().init();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.Error(e);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               log.error(<span class="string">&quot;Catalina.start&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">long</span> t2 = System.nanoTime();</span><br><span class="line">       <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">           log.info(<span class="string">&quot;Initialization processed in &quot;</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-3-Lifecycle"><a href="#1-3-Lifecycle" class="headerlink" title="1.3 Lifecycle"></a>1.3 <code>Lifecycle</code></h3><p>用来管理各个组件的生命周期</p>
<p><code>init</code>、<code>start</code>、<code>stop</code>、<code>destroy</code></p>
<p><code>LifecycleBase</code> 实现了<code>Lifecycle</code>, 使用的是模板设计模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"> * &lt;pre&gt;</span><br><span class="line"> *            start()</span><br><span class="line"> *  -----------------------------</span><br><span class="line"> *  |                           |</span><br><span class="line"> *  | init()                    |</span><br><span class="line"> * NEW -&gt;-- INITIALIZING        |</span><br><span class="line"> * | |           |              |     ------------------&lt;-----------------------</span><br><span class="line"> * | |           |auto          |     |                                        |</span><br><span class="line"> * | |          \|/    start() \|/   \|/     <span class="function">auto          auto         <span class="title">stop</span><span class="params">()</span> |</span></span><br><span class="line"><span class="function"> * | |      INITIALIZED --&gt;-- STARTING_PREP --&gt;- STARTING --&gt;- STARTED --&gt;---  |</span></span><br><span class="line"><span class="function"> * | |         |                                                  |         |  |</span></span><br><span class="line"><span class="function"> * | |         |                                                  |         |  |</span></span><br><span class="line"><span class="function"> * | |         |                                                  |         |  |</span></span><br><span class="line"><span class="function"> * | |<span class="title">destroy</span><span class="params">()</span>|                                                  |         |  |</span></span><br><span class="line"><span class="function"> * | --&gt;-----&lt;--       auto                    auto               |         |  |</span></span><br><span class="line"><span class="function"> * |     |       ---------&lt;----- MUST_STOP ---------------------&lt;--         |  |</span></span><br><span class="line"><span class="function"> * |     |       |                                                          |  |</span></span><br><span class="line"><span class="function"> * |    \|/      ---------------------------&lt;--------------------------------  ^</span></span><br><span class="line"><span class="function"> * |     |       |                                                             |</span></span><br><span class="line"><span class="function"> * |     |      \|/            auto                 auto              <span class="title">start</span><span class="params">()</span>  |</span></span><br><span class="line"><span class="function"> * |     |  STOPPING_PREP ------&gt;----- STOPPING ------&gt;----- STOPPED ----&gt;------</span></span><br><span class="line"><span class="function"> * |     |                                ^                  |  |  ^</span></span><br><span class="line"><span class="function"> * |     |               <span class="title">stop</span><span class="params">()</span>           |                  |  |  |</span></span><br><span class="line"><span class="function"> * |     |       --------------------------                  |  |  |</span></span><br><span class="line"><span class="function"> * |     |       |                                  auto     |  |  |</span></span><br><span class="line"><span class="function"> * |     |       |                  MUST_DESTROY------&lt;-------  |  |</span></span><br><span class="line"><span class="function"> * |     |       |                    |                         |  |</span></span><br><span class="line"><span class="function"> * |     |       |                    |auto                     |  |</span></span><br><span class="line"><span class="function"> * |     |       |    <span class="title">destroy</span><span class="params">()</span>      \|/              <span class="title">destroy</span><span class="params">()</span> |  |</span></span><br><span class="line"><span class="function"> * |     |    FAILED ----&gt;------ DESTROYING ---&lt;-----------------  |</span></span><br><span class="line"><span class="function"> * |     |                        ^     |                          |</span></span><br><span class="line"><span class="function"> * |     |     <span class="title">destroy</span><span class="params">()</span>          |     |auto                      |</span></span><br><span class="line"><span class="function"> * |     --------&gt;-----------------    \|/                         |</span></span><br><span class="line"><span class="function"> * |                                 DESTROYED                     |</span></span><br><span class="line"><span class="function"> * |                                                               |</span></span><br><span class="line"><span class="function"> * |                            <span class="title">stop</span><span class="params">()</span>                             |</span></span><br><span class="line"><span class="function"> * ---&gt;------------------------------&gt;------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> interface Lifecycle </span>&#123;</span><br><span class="line"> ...   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prepare for the beginning of active use of the public methods other than</span></span><br><span class="line"><span class="comment">     * property getters/setters and life cycle methods of this component. This</span></span><br><span class="line"><span class="comment">     * method should be called before any of the public methods other than</span></span><br><span class="line"><span class="comment">     * property getters/setters and life cycle methods of this component are</span></span><br><span class="line"><span class="comment">     * utilized. The following &#123;<span class="doctag">@link</span> LifecycleEvent&#125;s will be fired in the</span></span><br><span class="line"><span class="comment">     * following order:</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;BEFORE_START_EVENT: At the beginning of the method. It is as this</span></span><br><span class="line"><span class="comment">     *                           point the state transitions to</span></span><br><span class="line"><span class="comment">     *                           &#123;<span class="doctag">@link</span> LifecycleState#STARTING_PREP&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;START_EVENT: During the method once it is safe to call start() for</span></span><br><span class="line"><span class="comment">     *                    any child components. It is at this point that the</span></span><br><span class="line"><span class="comment">     *                    state transitions to &#123;<span class="doctag">@link</span> LifecycleState#STARTING&#125;</span></span><br><span class="line"><span class="comment">     *                    and that the public methods other than property</span></span><br><span class="line"><span class="comment">     *                    getters/setters and life cycle methods may be</span></span><br><span class="line"><span class="comment">     *                    used.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;AFTER_START_EVENT: At the end of the method, immediately before it</span></span><br><span class="line"><span class="comment">     *                          returns. It is at this point that the state</span></span><br><span class="line"><span class="comment">     *                          transitions to &#123;<span class="doctag">@link</span> LifecycleState#STARTED&#125;.</span></span><br><span class="line"><span class="comment">     *                          &lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="comment">     *  that prevents this component from being used</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gracefully terminate the active use of the public methods other than</span></span><br><span class="line"><span class="comment">     * property getters/setters and life cycle methods of this component. Once</span></span><br><span class="line"><span class="comment">     * the STOP_EVENT is fired, the public methods other than property</span></span><br><span class="line"><span class="comment">     * getters/setters and life cycle methods should not be used. The following</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> LifecycleEvent&#125;s will be fired in the following order:</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;BEFORE_STOP_EVENT: At the beginning of the method. It is at this</span></span><br><span class="line"><span class="comment">     *                          point that the state transitions to</span></span><br><span class="line"><span class="comment">     *                          &#123;<span class="doctag">@link</span> LifecycleState#STOPPING_PREP&#125;.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;STOP_EVENT: During the method once it is safe to call stop() for</span></span><br><span class="line"><span class="comment">     *                   any child components. It is at this point that the</span></span><br><span class="line"><span class="comment">     *                   state transitions to &#123;<span class="doctag">@link</span> LifecycleState#STOPPING&#125;</span></span><br><span class="line"><span class="comment">     *                   and that the public methods other than property</span></span><br><span class="line"><span class="comment">     *                   getters/setters and life cycle methods may no longer be</span></span><br><span class="line"><span class="comment">     *                   used.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;AFTER_STOP_EVENT: At the end of the method, immediately before it</span></span><br><span class="line"><span class="comment">     *                         returns. It is at this point that the state</span></span><br><span class="line"><span class="comment">     *                         transitions to &#123;<span class="doctag">@link</span> LifecycleState#STOPPED&#125;.</span></span><br><span class="line"><span class="comment">     *                         &lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Note that if transitioning from &#123;<span class="doctag">@link</span> LifecycleState#FAILED&#125; then the</span></span><br><span class="line"><span class="comment">     * three events above will be fired but the component will transition</span></span><br><span class="line"><span class="comment">     * directly from &#123;<span class="doctag">@link</span> LifecycleState#FAILED&#125; to</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> LifecycleState#STOPPING&#125;, bypassing</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> LifecycleState#STOPPING_PREP&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="comment">     *  that needs to be reported</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Prepare to discard the object. The following &#123;<span class="doctag">@link</span> LifecycleEvent&#125;s will</span></span><br><span class="line"><span class="comment">     * be fired in the following order:</span></span><br><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br><span class="line"><span class="comment">     *   &lt;li&gt;DESTROY_EVENT: On the successful completion of component</span></span><br><span class="line"><span class="comment">     *                      destruction.&lt;/li&gt;</span></span><br><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</span></span><br><span class="line"><span class="comment">     *  that prevents this component from being used</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-4-Server"><a href="#1-4-Server" class="headerlink" title="1.4 Server"></a>1.4 <code>Server</code></h3><p>管理<code>Service</code>组件, 调用的其<code>init</code>和<code>start</code> 方法</p>
<p><code>org.apache.catalina.Server</code>是一个接口类, 其唯一的实现类<code>org.apache.catalina.core.StandardServer</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">super</span>.initInternal();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Register global String cache</span></span><br><span class="line">       <span class="comment">// Note although the cache is global, if there are multiple Servers</span></span><br><span class="line">       <span class="comment">// present in the JVM (may happen when embedding) then the same cache</span></span><br><span class="line">       <span class="comment">// will be registered under multiple names</span></span><br><span class="line">       onameStringCache = register(<span class="keyword">new</span> StringCache(), <span class="string">&quot;type=StringCache&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Register the MBeanFactory</span></span><br><span class="line">       MBeanFactory factory = <span class="keyword">new</span> MBeanFactory();</span><br><span class="line">       factory.setContainer(<span class="keyword">this</span>);</span><br><span class="line">       onameMBeanFactory = register(factory, <span class="string">&quot;type=MBeanFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Register the naming resources</span></span><br><span class="line">       globalNamingResources.init();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Populate the extension validator with JARs from common and shared</span></span><br><span class="line">       <span class="comment">// class loaders</span></span><br><span class="line">       <span class="keyword">if</span> (getCatalina() != <span class="keyword">null</span>) &#123;</span><br><span class="line">           ClassLoader cl = getCatalina().getParentClassLoader();</span><br><span class="line">           <span class="comment">// Walk the class loader hierarchy. Stop at the system class loader.</span></span><br><span class="line">           <span class="comment">// This will add the shared (if present) and common class loaders</span></span><br><span class="line">           <span class="keyword">while</span> (cl != <span class="keyword">null</span> &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (cl <span class="keyword">instanceof</span> URLClassLoader) &#123;</span><br><span class="line">                   URL[] urls = ((URLClassLoader) cl).getURLs();</span><br><span class="line">                   <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (url.getProtocol().equals(<span class="string">&quot;file&quot;</span>)) &#123;</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               File f = <span class="keyword">new</span> File (url.toURI());</span><br><span class="line">                               <span class="keyword">if</span> (f.isFile() &amp;&amp;</span><br><span class="line">                                       f.getName().endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">                                   ExtensionValidator.addSystemResource(f);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                               <span class="comment">// Ignore</span></span><br><span class="line">                           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                               <span class="comment">// Ignore</span></span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               cl = cl.getParent();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// Initialize our defined Services</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</span><br><span class="line">           services[i].init();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="1-5-Service"><a href="#1-5-Service" class="headerlink" title="1.5 Service"></a>1.5 <code>Service</code></h3><p>管理连接器和<code>Engine</code></p>
<p><code>org.apache.catalina.Service</code> 同样是一个接口类,有唯一的实现<code>org.apache.catalina.core.StandardService</code></p>
<p><img src="http://files.luyanan.com//img/20200513103841.png" alt="image-20200513101014740"></p>
<p><img src="http://files.luyanan.com//img/20200513103844.png" alt="image-20200513101027782"></p>
<p><img src="http://files.luyanan.com//img/20200513103848.png" alt="image-20200513101039045"></p>
<p><code>ContainerBase</code>的类关系图</p>
<p><img src="http://files.luyanan.com//img/20200513103826.png" alt="image-20200513103825522"></p>
<p>关注到上图图解中的<code>ContainerBase.startInternal()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start our subordinate components, if any</span></span><br><span class="line">       logger = <span class="keyword">null</span>;</span><br><span class="line">       getLogger();</span><br><span class="line">       Cluster cluster = getClusterInternal();</span><br><span class="line">       <span class="keyword">if</span> ((cluster != <span class="keyword">null</span>) &amp;&amp; (cluster <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">           ((Lifecycle) cluster).start();</span><br><span class="line">       Realm realm = getRealmInternal();</span><br><span class="line">       <span class="keyword">if</span> ((realm != <span class="keyword">null</span>) &amp;&amp; (realm <span class="keyword">instanceof</span> Lifecycle))</span><br><span class="line">           ((Lifecycle) realm).start();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start our child containers, if any</span></span><br><span class="line">       Container children[] = findChildren();</span><br><span class="line">       List&lt;Future&lt;Void&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.length; i++) &#123;</span><br><span class="line">           <span class="comment">// 这句代码的意思就是调用`contailerBase`下面的一个个子容器的`call`方法</span></span><br><span class="line">           results.add(startStopExecutor.submit(<span class="keyword">new</span> StartChild(children[i])));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">boolean</span> fail = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">for</span> (Future&lt;Void&gt; result : results) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               result.get();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               log.error(sm.getString(<span class="string">&quot;containerBase.threadedStartFailed&quot;</span>), e);</span><br><span class="line">               fail = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (fail) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</span><br><span class="line">                   sm.getString(<span class="string">&quot;containerBase.threadedStartFailed&quot;</span>));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start the Valves in our pipeline (including the basic), if any</span></span><br><span class="line">       <span class="keyword">if</span> (pipeline <span class="keyword">instanceof</span> Lifecycle)</span><br><span class="line">           ((Lifecycle) pipeline).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start our thread</span></span><br><span class="line">       threadStart();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>查看<code>new StartChild</code> 要执行的<code>call</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StartChild</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> Container child;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">StartChild</span><span class="params">(Container child)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.child = child;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</span><br><span class="line">           child.start();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="http://files.luyanan.com//img/20200513104314.png" alt="image-20200513104313879"></p>
<p><code>StandardHost</code> 将一个个<code>web</code>项目部署起来</p>
<p><img src="http://files.luyanan.com//img/20200513104345.png" alt="image-20200513104344727"></p>
<p><code>org.apache.catalina.startup.HostConfig#deployApps()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deployApps</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    File appBase = host.getAppBaseFile();</span><br><span class="line">    File configBase = host.getConfigBaseFile();</span><br><span class="line">    String[] filteredAppPaths = filterAppPaths(appBase.list());</span><br><span class="line">    <span class="comment">// Deploy XML descriptors from configBase</span></span><br><span class="line">    deployDescriptors(configBase, configBase.list());</span><br><span class="line">    <span class="comment">// Deploy WARs</span></span><br><span class="line">    deployWARs(appBase, filteredAppPaths);</span><br><span class="line">    <span class="comment">// Deploy expanded folders</span></span><br><span class="line">    deployDirectories(appBase, filteredAppPaths);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StandardContext.startInternal()</code>解析<code>web.xml</code>文件和添加<code>wrapper</code></p>
<p><img src="http://files.luyanan.com//img/20200513104730.png" alt="image-20200513104729040"></p>
<p><code>ContextConfig.webConfig()</code> 的<code>step9</code>解析到<code>servlets</code> 包装成<code>wrapper</code> 对象</p>
<p><code>StandardContext.startInternal()</code>-&gt;最终会调用<code>if (!loadOnStartup(findChildren()))</code></p>
<p><code>官网</code>： <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/architecture/startup/serverStartup.pdf">https://tomcat.apache.org/tomcat-8.0-doc/architecture/startup/serverStartup.pdf</a></p>
<h2 id="2-性能优化"><a href="#2-性能优化" class="headerlink" title="2. 性能优化"></a>2. 性能优化</h2><p><code>tomcat</code> 性能指标: 吞吐量、响应时间、错误数、线程池、CPU、内存等. </p>
<p>使用<code>jmeter</code> 进行压测,然后观察相应指标. </p>
<p><strong>使用命令查看相关指标</strong></p>
<ol>
<li><p>查看<code>tomcat</code>进程<code>pid</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep tomcat</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看进程的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /pro/pid/status</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看进程的CPU和内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -p pid</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>使用工具查看相应的指标</p>
<p><code>jconsole、jvisualvm、arthas、psi-probe等</code></p>
<h3 id="2-1-优化思路"><a href="#2-1-优化思路" class="headerlink" title="2.1 优化思路"></a>2.1 优化思路</h3><h4 id="2-1-1-conf-server-xml-等核心组件"><a href="#2-1-1-conf-server-xml-等核心组件" class="headerlink" title="2.1.1 conf/server.xml 等核心组件"></a>2.1.1 <code>conf/server.xml</code> 等核心组件</h4><ul>
<li><p><code>Server</code></p>
<p>官网描述 :<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/Server.html">Server interface</a> which is rarely customized by users. 【pass】</p>
</li>
<li><p><code>Service</code></p>
<p>官网描述 :The Service element is rarely customized by users. 【pass】</p>
</li>
<li><p><code>Connector</code></p>
<p>官网描述 :Creating a customized connector is a significant effort. 【 need 】</p>
</li>
<li><p><code>Engine</code></p>
<p>官网描述 :The <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/Engine.html">Engine interface</a> may be implemented to supply custom Engines, though this is uncommon. 【pass】</p>
</li>
<li><p><code>Host</code></p>
<p>官网描述 :Users rarely create custom <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/Host.html">Hosts</a> because the <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/core/StandardHost.html">StandardHost implementation</a> provides significant additional functionality. 【pass】</p>
</li>
<li><p><code>Context</code></p>
<p>官网描述 :The <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/Context.html">Context interface</a> may be implemented to create custom Contexts, but this is rarely the case because the <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/api/org/apache/catalina/core/StandardContext.html">StandardContext</a> provides significant additional functionality. 【 maybe 】</p>
</li>
</ul>
<p><code>context</code> 既然代表的是<code>web</code>应用,是和我们比较接近的,这块我们考虑对其进行适当的优化. </p>
<h4 id="2-1-2-conf-server-xml-非核心组件"><a href="#2-1-2-conf-server-xml-非核心组件" class="headerlink" title="2.1.2 conf/server.xml 非核心组件"></a>2.1.2 <code>conf/server.xml</code> 非核心组件</h4><p><code>官网</code>: <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/config/index.html">https://tomcat.apache.org/tomcat-8.0-doc/config/index.html</a></p>
<ul>
<li><p><code>Listener</code></p>
<p><code>Listener</code>(即监听器) 定义的组件,可以在特定事件发生时执行特定的操作, 被监听的事件通常是<code>Tomcat</code>的启动和停止</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> <span class="attr">SSLEngine</span>=<span class="string">&quot;on&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Global Resources</code></p>
<p><code>GlobalNamingResources</code> 元素定义了全局资源,通过配置可以看出,该配置是通过读取<code>$TOMCAT_HOME/ conf/tomcat-users.xml</code>  实现的. </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Global JNDI resources</span></span><br><span class="line"><span class="comment">     Documentation at /docs/jndi-resources-howto.html</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Editable user database that can also be used by</span></span><br><span class="line"><span class="comment">       UserDatabaseRealm to authenticate users</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">&quot;UserDatabase&quot;</span> <span class="attr">auth</span>=<span class="string">&quot;Container&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;org.apache.catalina.UserDatabase&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">description</span>=<span class="string">&quot;User database that can be updated and saved&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">factory</span>=<span class="string">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">pathname</span>=<span class="string">&quot;conf/tomcat-users.xml&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Valve</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Access log processes all example.</span></span><br><span class="line"><span class="comment">      Documentation at: /docs/config/valve.html</span></span><br><span class="line"><span class="comment">      <span class="doctag">Note:</span> The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Realm</code></p>
<p><code>Realm</code> 可以理解为”域”, <code>Realm</code> 提供了一种用户密码与<code>web</code>应用的映射关系,从而达到角色安全管理的作用,在本例中, <code>Realm</code> 的配置使用<code>name</code>为<code>UserDatabase</code>的资源实现,而该资源在<code>Server</code>元素中使用<code>GlobalNamingResources</code> 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords</span></span><br><span class="line"><span class="comment">     via a brute-force attack --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- This Realm uses the UserDatabase configured in the global JNDI</span></span><br><span class="line"><span class="comment">       resources under the key &quot;UserDatabase&quot;.  Any edits</span></span><br><span class="line"><span class="comment">       that are performed against this UserDatabase are immediately</span></span><br><span class="line"><span class="comment">       available for use by the Realm.  --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">resourceName</span>=<span class="string">&quot;UserDatabase&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="2-1-3-conf-web-xml"><a href="#2-1-3-conf-web-xml" class="headerlink" title="2.1.3 conf/web.xml"></a>2.1.3 <code>conf/web.xml</code></h4><p>全局的<code>web.xml</code> 文件有些标签用不到,可以删除掉</p>
<h4 id="2-1-4-JVM层面"><a href="#2-1-4-JVM层面" class="headerlink" title="2.1.4 JVM层面"></a>2.1.4 JVM层面</h4><p>因为<code>Tomcat</code>本身就是一个<code>java</code>进程,所以可以使用优化JVM的方式进行优化</p>
<h2 id="3-配置优化"><a href="#3-配置优化" class="headerlink" title="3. 配置优化"></a>3. 配置优化</h2><h3 id="3-1-减少web-xml-server-xml中标签"><a href="#3-1-减少web-xml-server-xml中标签" class="headerlink" title="3.1 减少web.xml/server.xml中标签"></a>3.1 减少<code>web.xml/server.xml</code>中标签</h3><p>最终观察<code>tomcat</code> 启动日志(时间/内容)、线程开销、内存大小、GC等. </p>
<ul>
<li><p><code>DefaultServlet</code></p>
<p>官网 :User Guide-&gt;Default Servlet</p>
<blockquote>
<p>The default servlet is the servlet which serves static resources as well as serves the directory listings (if directory listings are enabled).</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>listings<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>JspServlet</code></p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>fork<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>xpoweredBy<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>3<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!-- The mappings for the JSP servlet --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jspx<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>welcome-list-file</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.html<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.htm<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>
</li>
<li><p><code>mime-mapping</code>移除响应的内容</p>
<p>支持的下载打开类型</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span>123<span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mime-type</span>&gt;</span>application/vnd.lotus-1-2-3<span class="tag">&lt;/<span class="name">mime-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extension</span>&gt;</span>3dml<span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mime-type</span>&gt;</span>text/vnd.in3d.3dml<span class="tag">&lt;/<span class="name">mime-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mime-mapping</span>&gt;</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>session-config</code> </p>
<p>默认的<code>jsp</code> 页面有<code>session</code>, 就是在于这个配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>30<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="3-2-调整优化server-xml-中标签"><a href="#3-2-调整优化server-xml-中标签" class="headerlink" title="3.2 调整优化server.xml 中标签"></a>3.2 调整优化<code>server.xml</code> 中标签</h3><h4 id="3-2-1-Connector-标签"><a href="#3-2-1-Connector-标签" class="headerlink" title="3.2.1 Connector 标签"></a>3.2.1 <code>Connector</code> 标签</h4><ul>
<li><p><code>protocol</code> 属性</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>对于<code>protocol=&quot;HTTP/1.1&quot;</code> ,查看源码</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(String protocol)</span> </span>&#123;</span><br><span class="line">       setProtocol(protocol);</span><br><span class="line">       <span class="comment">// Instantiate protocol handler</span></span><br><span class="line">       ProtocolHandler p = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</span><br><span class="line">           p = (ProtocolHandler) clazz.newInstance();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           log.error(sm.getString(</span><br><span class="line">                   <span class="string">&quot;coyoteConnector.protocolHandlerInstantiationFailed&quot;</span>), e);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.protocolHandler = p;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!Globals.STRICT_SERVLET_COMPLIANCE) &#123;</span><br><span class="line">           URIEncoding = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">           URIEncodingLower = URIEncoding.toLowerCase(Locale.ENGLISH);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code> setProtocol(protocol);</code>  因为配置文件中传入的是 <code>HTTP/1.1</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;HTTP/1.1&quot;</span>.equals(protocol)) &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;AJP/1.3&quot;</span>.equals(protocol)) &#123;</span><br><span class="line">               setProtocolHandlerClassName</span><br><span class="line">                   (<span class="string">&quot;org.apache.coyote.ajp.AjpNioProtocol&quot;</span>);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">               setProtocolHandlerClassName(protocol);</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>发现这里调用的是<code>Http11NioProtocol，</code>, 说明<code>tomcat8</code>中默认的是<code>NIO</code></p>
<p>使用同样的方式看<code>tomcat7</code>和<code>tomcat8.5</code>, 你会发现<code>tomcat7</code>中默认使用的是<code>BIO</code>,<code>tomcat8.5</code> 中默认使用的是<code>NIO</code></p>
<ol>
<li><p><code>BIO</code></p>
<p>来到tomcat官网<code>Configuration/HTTP/protocol</code></p>
<blockquote>
<p>org.apache.coyote.http11.Http11Protocol - blocking Java connector org.apache.coyote.http11.Http11NioProtocol - non blocking Java NIO connector org.apache.coyote.http11.Http11Nio2Protocol - non blocking Java NIO2 connector org.apache.coyote.http11.Http11AprProtocol - the APR/native connector.</p>
</blockquote>
</li>
<li><p><code>NIO</code></p>
<p><code>tomcat8.0</code> 中默认使用的就是<code>NIO</code></p>
</li>
<li><p><code>APR</code></p>
<p>调用本地方法库进行<code>io</code>操作</p>
</li>
</ol>
<ul>
<li><p><code>executor</code>属性</p>
<p>最佳线程公式: （(线程等待时间+线程CPU时间)/线程CPU时间）*CPU数量</p>
<blockquote>
<p>The Executor represents a thread pool that can be shared between components in Tomcat. Historically there has been a thread pool per connector created but this allows you to share a thread pool, between (primarily) connector but also other components when those get configured to support executors</p>
</blockquote>
<p>默认的可以查看<code>StandardExecutor</code> 类</p>
<p><strong>设置一些属性</strong></p>
<p><code>官网</code>： <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.0-doc/config/http.html">https://tomcat.apache.org/tomcat-8.0-doc/config/http.html</a></p>
<ol>
<li><p><code>acceptCount</code></p>
<p> 达到最大连接数之后, 等待队列中还能放多少连接, 超过即拒绝, 配置太多也没有意义. </p>
<blockquote>
<p>The maximum queue length for incoming connection requests when all possible request processing threads are in use. Any requests received when the queue is full will be refused. The default value is 100.</p>
</blockquote>
</li>
<li><p><code>maxConnections</code></p>
<p> 超过这个值后,将继续接受连接,但是不处理,能继续接受多少根据<code>acceptCount</code>的值. </p>
<p><code>BIO</code>:<code>maxThreads</code></p>
<p><code>NIO/NIO2</code>:10000 ——— <code>AbstractEndpoint.maxConnections</code></p>
<p><code>APR</code>:8192</p>
<blockquote>
<p>The maximum number of connections that the server will accept and process at any given time. When this number has been reached, the server will accept, but not process, one further connection. This additional connection be blocked until the number of connections being processed falls below maxConnections at which point the server will start accepting and processing new connections again. Note that once the limit has been reached, the operating system may still accept connections based on the acceptCount setting. The default value varies by connector type. For BIO the default is the value of maxThreads unless an Executor is used in which case the default will be the value of maxThreads from the executor. For NIO and NIO2 the default is 10000. For APR/native, the default is 8192. </p>
<p>Note that for APR/native on Windows, the configured value will be reduced to the highest multiple of 1024 that is less than or equal to maxConnections. This is done for performance reasons. If set to a value of -1, the maxConnections feature is disabled and connections are not counted.</p>
</blockquote>
</li>
<li><p><code>maxThreads</code></p>
<p>最大工作线程数,也就是用来处理<code>request</code>请求的,默认是200, 如果自己配置了<code>executor</code>, 并且和<code>Connector</code>有关联了,则之前默认的200就会被忽略,取决于CPU的配置. 监控中就可以看到所有的工作线程是什么状态, 通过监控就可以知道开启多少线程合适. </p>
<blockquote>
<p>The maximum number of request processing threads to be created by this Connector, which therefore determines the maximum number of simultaneous requests that can be handled. If not specified, this attribute is set to 200. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.</p>
</blockquote>
</li>
<li><p><code>minSpareThreads</code></p>
<p> 最小空闲线程数</p>
<blockquote>
<p>The minimum number of threads always kept running. This includes both active and idle threads. If not specified, the default of 10 is used. If an executor is associated with this connector, this attribute is ignored as the connector will execute tasks using the executor rather than an internal thread pool. Note that if an executor is configured any value set for this attribute will be recorded correctly but it will be reported (e.g. via JMX) as -1 to make clear that it is not used.</p>
</blockquote>
<p> 可以实践一下,<code>connector</code> 配置自定义的线程池</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Executor</span> <span class="attr">name</span>=<span class="string">&quot;tomcatThreadPool&quot;</span> <span class="attr">namePrefix</span>=<span class="string">&quot;catalina-exec-&quot;</span></span></span><br><span class="line"><span class="tag">     <span class="attr">maxThreads</span>=<span class="string">&quot;150&quot;</span> <span class="attr">minSpareThreads</span>=<span class="string">&quot;4&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p> 其实这块最好的方式就是结合<code>BIO</code>来查看,因为<code>BIO</code>是一个<code>request</code> 对应一个线程. </p>
<blockquote>
<p>值太低, 并发请求多了之后, 多余的则会进入到等待状态. </p>
<p>值太高,启动<code>tomcat</code> 将花费更多的时间</p>
</blockquote>
</li>
<li><p><code>enableLookups</code></p>
<p>  设置为<code>fasle</code></p>
</li>
<li><p>删掉<code>AJP</code>的<code>Connector</code></p>
</li>
</ol>
<h4 id="3-2-2-Host-标签"><a href="#3-2-2-Host-标签" class="headerlink" title="3.2.2 Host 标签"></a>3.2.2 <code>Host</code> 标签</h4></li>
<li><p><code>autoDeploy</code></p>
<p><code>tomcat</code> 运行时,要用一个线程来进行检查, 生产环境下一定要改成<code>fasle</code></p>
<blockquote>
<p>This flag value indicates if Tomcat should check periodically for new or updated web applications while Tomcat is running. If true, Tomcat periodically checks the appBase and xmlBase directories and deploys any new web applications or context XML descriptors found. Updated web applications or context XML descriptors will trigger a reload of the web application. The flag’s value defaults to true. See Automatic Application Deployment for more information.</p>
</blockquote>
</li>
</ul>
<h4 id="3-2-3-Context-标签"><a href="#3-2-3-Context-标签" class="headerlink" title="3.2.3 Context 标签"></a>3.2.3 <code>Context</code> 标签</h4><p><code>reloadable:false</code></p>
<p><code>reloadable</code> 如果设置为<code>true</code>, <code>tomcat</code> 服务器会在运行状态下监视在<code>WEB-INFO/classes</code>和<code>WEB-INFO/lib</code>  目录下<code>class</code>文件的改动,如果检测到有<code>class</code> 文件被更新,服务器会自动加载<code>web</code>应用. </p>
<p>在开发阶段, 将<code>reloadable</code> 属性设置为<code>true</code>, 有助于调试<code>servlet</code>和其他的<code>class</code>文件,但是这样会加重服务器运行负荷,建议在<code>web</code> 应用的发行阶段将<code>reloadable</code>设置为<code>false</code></p>
<blockquote>
<p>Set to true if you want Catalina to monitor classes in /WEB-INF/classes/ and /WEB-INF/lib for changes, and automatically reload the web application if a change is detected. This feature is very useful during application development, but it requires significant runtime overhead and is not recommended for use on deployed production applications. That’s why the default setting for this attribute is false. You can use the Manager web application, however, to trigger reloads of deployed applications on demand.</p>
</blockquote>
<h2 id="4-启动速度慢优化"><a href="#4-启动速度慢优化" class="headerlink" title="4. 启动速度慢优化"></a>4. 启动速度慢优化</h2><ul>
<li><p>删除没用的<code>web</code>应用</p>
<p>因为<code>tomcat</code>启动每次都会部署这些应用</p>
</li>
<li><p>关闭<code>webSocket</code></p>
<p>如果项目中用不到<code>webSocket</code>的话，可以删除这两个<code>websocket-api.jar</code>和<code>tomcat-websocket.jar</code></p>
</li>
<li><p>随机数优化</p>
<p>设置<code>JVM</code>参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.security.egd=file:/dev/./urandom</span><br></pre></td></tr></table></figure>
</li>
<li><p>多个线程启动<code>web</code>应用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Host</span> <span class="attr">startStopThreads</span>=<span class="string">&quot;0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="5-其他方面的优化"><a href="#5-其他方面的优化" class="headerlink" title="5.  其他方面的优化"></a>5.  其他方面的优化</h2><ul>
<li><p><code>Connector</code></p>
<p>配置压缩属性<code>compression=&quot;500&quot;</code>, 文件大于500bytes 才会被压缩</p>
</li>
<li><p>数据库优化</p>
<p>减少对数据库访问等待的时间,可以从数据库的层面进行优化,或者加缓存等等各种方案</p>
</li>
<li><p>开启浏览器缓存,<code>nginx</code> 静态资源部署</p>
</li>
</ul>
<h2 id="6-常见问题排查"><a href="#6-常见问题排查" class="headerlink" title="6. 常见问题排查"></a>6. 常见问题排查</h2><h3 id="6-1-CPU-使用率过高"><a href="#6-1-CPU-使用率过高" class="headerlink" title="6.1 CPU 使用率过高"></a>6.1 CPU 使用率过高</h3><p><strong>可能原因</strong></p>
<p>GC频繁或者创建了很多的业务线程</p>
<p><strong>排查</strong></p>
<p>哪些线程比较消耗CPU 或者多线程上下文频繁切换</p>
<p><strong>解决思路</strong></p>
<p><code>top -H pid</code> 查看某个java进程各个线程使用CPU的情况,找到哪个线程占用CPU比较高. </p>
<p><code>jstack pid</code> 打印出线程信息,定位到上述线程名称</p>
<h3 id="6-2-拒绝连接"><a href="#6-2-拒绝连接" class="headerlink" title="6.2 拒绝连接"></a>6.2 拒绝连接</h3><ul>
<li><p><code>java.net.BindException: Address already in use: JVM_Bind</code></p>
<p> 端口被占用,可以使用<code>netstat -an</code> 查看端口占用情况,关闭对应的进程或者<code>tomcat</code>修改端口</p>
</li>
<li><p><code>java.net.ConnectException: Connection refused: connect</code></p>
<p><code>ping</code>一下服务端的<code>ip</code>,可能服务端机器有问题</p>
</li>
<li><p><code>java.net.SocketException: Too many open files</code></p>
<p>可能在高并发的情况下,创建的<code>socket</code>过多,文件句柄不够用了,可以关闭无用的句柄,如果都有用,可以增加文件句柄数 <code>ulimit -n 10000</code></p>
</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/9.%20Spring%20%E4%BA%8B%E5%8A%A1%E8%AF%A6%E8%B0%88/" rel="prev" title="9">
      <i class="fa fa-chevron-left"></i> 9
    </a></div>
      <div class="post-nav-item">
    <a href="/1.tomcat%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/" rel="next" title="1">
      1 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#tomcat%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E5%92%8C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.</span> <span class="nav-text">tomcat源码解读和性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="nav-number">1.1.</span> <span class="nav-text">1. 源码解读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-BootStrap"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 BootStrap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Catalina"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 Catalina</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Lifecycle"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 Lifecycle</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-Server"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Service"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 Service</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">1.2.</span> <span class="nav-text">2. 性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 优化思路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-conf-server-xml-%E7%AD%89%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">2.1.1 conf&#x2F;server.xml 等核心组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-conf-server-xml-%E9%9D%9E%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">2.1.2 conf&#x2F;server.xml 非核心组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-conf-web-xml"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">2.1.3 conf&#x2F;web.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-JVM%E5%B1%82%E9%9D%A2"><span class="nav-number">1.2.1.4.</span> <span class="nav-text">2.1.4 JVM层面</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%85%8D%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="nav-number">1.3.</span> <span class="nav-text">3. 配置优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%87%8F%E5%B0%91web-xml-server-xml%E4%B8%AD%E6%A0%87%E7%AD%BE"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 减少web.xml&#x2F;server.xml中标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%B0%83%E6%95%B4%E4%BC%98%E5%8C%96server-xml-%E4%B8%AD%E6%A0%87%E7%AD%BE"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 调整优化server.xml 中标签</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-Connector-%E6%A0%87%E7%AD%BE"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">3.2.1 Connector 标签</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-Host-%E6%A0%87%E7%AD%BE"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">3.2.2 Host 标签</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-Context-%E6%A0%87%E7%AD%BE"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">3.2.3 Context 标签</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6%E6%85%A2%E4%BC%98%E5%8C%96"><span class="nav-number">1.4.</span> <span class="nav-text">4. 启动速度慢优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">1.5.</span> <span class="nav-text">5.  其他方面的优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">1.6.</span> <span class="nav-text">6. 常见问题排查</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-CPU-%E4%BD%BF%E7%94%A8%E7%8E%87%E8%BF%87%E9%AB%98"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 CPU 使用率过高</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E6%8B%92%E7%BB%9D%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 拒绝连接</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">227</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luyanan0718" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luyanan0718" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/luyanan0718@163.com" title="E-Mail → luyanan0718@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://luyanan.com/" title="https:&#x2F;&#x2F;luyanan.com">Site</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
