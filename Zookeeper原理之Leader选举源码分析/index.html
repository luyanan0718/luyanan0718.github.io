<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Zookeeper原理之Leader选举源码分析Zookeeper 的一致性Zookeeper 的来源对于zookeeper的一致性问题, 我们再从来源问题梳理一遍一致性的问题.  我们知道zookeeper的来源, 是来自于Google chubby, 为了分布式环境下, 如何从多个server 中选举出master server. 那么这么多个server 就需要涉及到一致性问题, 这个一致性">
<meta property="og:type" content="article">
<meta property="og:title" content="程序员报社">
<meta property="og:url" content="http://luyanan.com/Zookeeper%E5%8E%9F%E7%90%86%E4%B9%8BLeader%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="Zookeeper原理之Leader选举源码分析Zookeeper 的一致性Zookeeper 的来源对于zookeeper的一致性问题, 我们再从来源问题梳理一遍一致性的问题.  我们知道zookeeper的来源, 是来自于Google chubby, 为了分布式环境下, 如何从多个server 中选举出master server. 那么这么多个server 就需要涉及到一致性问题, 这个一致性">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://files.luyanan.com//img/20191113100127.png">
<meta property="og:image" content="http://files.luyanan.com//img/20191113100912.png">
<meta property="og:image" content="http://files.luyanan.com//img/20191113134052.png">
<meta property="og:image" content="http://files.luyanan.com//img/20191113161725.png">
<meta property="og:image" content="http://files.luyanan.com//img/20191114135751.png">
<meta property="og:image" content="http://files.luyanan.com//img/20191114140808.png">
<meta property="og:image" content="http://files.luyanan.com//img/20191114140956.png">
<meta property="article:published_time" content="2021-03-01T09:46:52.942Z">
<meta property="article:modified_time" content="2020-12-24T09:34:50.094Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Python, Rust, C++, Go, 爬虫, 深度学习, 服务研发, 对象存储">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://files.luyanan.com//img/20191113100127.png">

<link rel="canonical" href="http://luyanan.com/Zookeeper%E5%8E%9F%E7%90%86%E4%B9%8BLeader%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title> | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/Zookeeper%E5%8E%9F%E7%90%86%E4%B9%8BLeader%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-01 17:46:52" itemprop="dateCreated datePublished" datetime="2021-03-01T17:46:52+08:00">2021-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-12-24 17:34:50" itemprop="dateModified" datetime="2020-12-24T17:34:50+08:00">2020-12-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Zookeeper原理之Leader选举源码分析"><a href="#Zookeeper原理之Leader选举源码分析" class="headerlink" title="Zookeeper原理之Leader选举源码分析"></a>Zookeeper原理之Leader选举源码分析</h1><h2 id="Zookeeper-的一致性"><a href="#Zookeeper-的一致性" class="headerlink" title="Zookeeper 的一致性"></a>Zookeeper 的一致性</h2><h3 id="Zookeeper-的来源"><a href="#Zookeeper-的来源" class="headerlink" title="Zookeeper 的来源"></a>Zookeeper 的来源</h3><p>对于zookeeper的一致性问题, 我们再从来源问题梳理一遍一致性的问题. </p>
<p>我们知道zookeeper的来源, 是来自于Google chubby, 为了分布式环境下, 如何从多个server 中选举出master server. 那么这么多个server 就需要涉及到一致性问题, 这个一致性体现的是多个server 就master 这个投票在分布式环境下达成一致性. 简单来说, 就是最终听谁的. 但是在网络环境中由于网络环境的不可靠性, 会存在消息丢失或者被篡改等问题. 所以如何在这样一个环境中快速并且正确的在多个server 中对某一个数据达成一致性并且保证无论发生任何异常, 都不会破坏整个系统一致性呢? </p>
<p>所以Lampot大神设计了一套Paxos算法, 多个server 基于这个算法就可以达成一致性。而Google chubby 就是基于paxos 算法的实现, 用来实现分布式锁服务. 并且提供了master 选举的服务. </p>
<h3 id="Paxos-在chubby-中的应用"><a href="#Paxos-在chubby-中的应用" class="headerlink" title="Paxos 在chubby 中的应用"></a>Paxos 在chubby 中的应用</h3><p>也许大家会有疑问, Chubby 于paxos 算法有什么关系呢? Chubby 本来应该被设计成一个包含Paxos 算法的协议库, 使得应用程序可以基于这个库方便的使用paxos 算法, 但是它并没有这么做, 而是把chubby 设计成了一个需要访问中心化节点的分布式锁服务. 既然是 一个服务, 那么它肯定需要是一个高可靠的服务. 所以Chubby 被构建成了一个集群, 集群中存在一个中心节点(master), 采用paxos协议, 通过投票的方式来选举一个获取过半皮票数的服务器作为master, 在chubby集群中, 每个服务器都会维护一份数据的副本, 在实际运行的过程中, 只有master  服务器能执行事务操作, 其他服务器都是使用paxos 协议从master 节点同步最新的数据, 而zookeeper 是chubby 的开源实现, 所以实现原理和chubby 基本是一致性的. </p>
<h3 id="zookeeper-的一致性是什么情况呢"><a href="#zookeeper-的一致性是什么情况呢" class="headerlink" title="zookeeper 的一致性是什么情况呢?"></a>zookeeper 的一致性是什么情况呢?</h3><p>zookeeper的一致性, 体现的是什么一致性呢? </p>
<p>根据前面讲的zab 协议的同步流程, 在zookeeper 集群内部的数据副本同步,是基于过半提交的策略,意味着他是最终一致性, 并不满足强一致性的要求. </p>
<p>其实正确来说, zookeeper是一个顺序一致性模型. 由于zookeeper 设计出来是提供分布式锁服务, 那么意味着它本身需要实现顺序一致性 （ <a target="_blank" rel="noopener" href="http://zookeeper.apache.org/doc/r3.5.5/zookeeperProgrammers.ht">http://zookeeper.apache.org/doc/r3.5.5/zookeeperProgrammers.ht</a> ml#ch_zkGuarantees ） </p>
<p>顺序一致性是在分布式环境下实现分布式锁的基本要求, 比如当一个多个程序来争抢锁, 如果ClientA 获得锁后,后续所有来挣钱锁的程序看到的锁的状态都应该是被ClientA 锁定了, 而不是其他状态. </p>
<h3 id="什么是顺序一致性"><a href="#什么是顺序一致性" class="headerlink" title="什么是顺序一致性"></a>什么是顺序一致性</h3><p>在讲顺序一致性之前, 咱们先思考一个问题, 假如说zookeeper是 一个最终一致性模型, 那么它会发生什么情况? </p>
<p>ClientA/B/C 假设只串行执行, ClientA 更新zookeeper 上的一个值x. ClientB 和ClientC 分别读取集群中的不同副本, 返回的x 的值是不一样的. ClientC 的读取操作是发生在clientB 之后, 但是却读到了过期的值. 很明显, 这是一种弱一致性模型. 如果用它来实现锁机制是有问题的. </p>
<p><img src="http://files.luyanan.com//img/20191113100127.png"></p>
<p>顺序一致性提供了更强的一致性保证, 我们来观察下面这个图, 从时间轴来看, B0 发生在A0之前, 读取的值是0, B2 发生在A0之后，读取到的x 的值为1, 而读操作B1/C0/C1 和写操作A0 在时间轴上有重叠, 因此他们可能读的旧的值为0, 也有可能读取到新的值1, 但是在强顺序一致性模型中, 如果B1得到的x的值为1, 那么C1看到的值也一定为1. </p>
<p><img src="http://files.luyanan.com//img/20191113100912.png"></p>
<p>需要注意的是,由于网络的延迟以及系统本身执行请求的不确定性, 会导致请求发起的客户端不一定会在服务端执行的早。最终以服务端执行的结果为准. </p>
<p>简单来说: 顺序一致性是针对单个操作, 单个数据对象. 属于CAP中C 这个范畴. 一个数据被更新后, 能够立马被后续的操作读到. </p>
<p>但是zookeeper的 顺序一致性实现是缩水版本, 在下面的这个网页中,可以看到官网对于一致性的这块做了解释. </p>
<p><a target="_blank" rel="noopener" href="http://zookeeper.apache.org/doc/r3.5.5/zookeeperProgrammers.html#ch_zkGuarantees">http://zookeeper.apache.org/doc/r3.5.5/zookeeperProgrammers.html#ch_zkGuarantees</a></p>
<p>zookeeper 不保证在每个实例中, 两个不同的客户端具有相同的zookeeper 数据视图, 由于网络延迟等因素, 一个客户端可能会在另外一个客户端收到更改通知之前执行更新, </p>
<p>考虑到2个客户端A 和B 的场景, 如果A 把znode /a 的值从0设置为1, 然后告诉客户端B 读取/a, 则客户端B 可能读取到旧的值0, 具体取决于他连接到的服务器, 如果客户端A 和B 要读取 必须要读取到想听的值, 那么ClientB 在读取操作之前要执行sync方法. </p>
<p>除此之外, zookeeper 基于zxid 以及阻塞队列的方式来实现请求的顺序一致性. 如果client 连接到一个最新的follower 上, 那么它read 读取到了最近的数据, 然后client 由于网络原因重新连接到zookeeper 节点, 而这个时候连接到一个还没有完成数据同步的follower节点, 那么这一次读取到的数据不就是旧的数据了吗? 实际上zookeeper 处理了这种情况, client 会记录自己已经读取到的最大的zxid, 如果client 重连到server 发现client 的zxid 比自己的大. 连接会失败. </p>
<h3 id="Single-System-Image-的理解"><a href="#Single-System-Image-的理解" class="headerlink" title="Single System Image 的理解"></a>Single System Image 的理解</h3><p> zookeeper 官网还说它保证了 “Single System Image “, 其解释为 “ A client will see the same view of the service regardless of the server that it connects to ”. 实际上看来这个解释还是有一点误导性的. 其实由上面的zxid 原理就可以看出来, 它表达的意思是 client 只要连接过一次zookeeper, 就不会有历史的倒退. </p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/zookeeper/pull/931">https://github.com/apache/zookeeper/pull/931</a></p>
<h2 id="Leader选举的原理"><a href="#Leader选举的原理" class="headerlink" title="Leader选举的原理"></a>Leader选举的原理</h2><p>接下来我们基于源码来分析leader 选举的整个过程, </p>
<p>Leader 选举存在两个阶段, 一个是服务器启动时的leader 选举, 另一个是运行过程中leader 节点宕机导致的leader 选举。 </p>
<blockquote>
<p>在开始分析选举的原理之前, 先了解几个重要的参数。</p>
<h4 id="服务器id-myid"><a href="#服务器id-myid" class="headerlink" title="服务器id(myid)"></a>服务器id(myid)</h4><p>​    比如有三台服务器, 编号分别是1,2,3</p>
<p>​    编号越大在选择算法中的权重越大</p>
<p>​    zxid 事务id</p>
<p>值越大说明数据越新,在选举算法中的权重也越大</p>
<h4 id="逻辑时钟-epoch-logicalclock"><a href="#逻辑时钟-epoch-logicalclock" class="headerlink" title="逻辑时钟(epoch - logicalclock)"></a>逻辑时钟(epoch - logicalclock)</h4><p>或者叫投票的次数, 同一轮投票过程中的逻辑时钟值是相同的. 每投完一票这个数据就会增加, 然后与接收到的其他服务器返回的投票信息中的数值相比,根据不同的值做出不同的判断. </p>
<h4 id="选举状态"><a href="#选举状态" class="headerlink" title="选举状态"></a>选举状态</h4><p>​    LOOKING: 竞选状态。 </p>
<p>​    FOLLOWING: 随从状态, 同步leader 状态, 参与投票</p>
<p>​    OBSERVING : 观察状态, 同步leader 状态, 不参与投票. </p>
<p>​      LEADING :  领导者状态</p>
</blockquote>
<h3 id="服务器启动的时候leader-选举"><a href="#服务器启动的时候leader-选举" class="headerlink" title="服务器启动的时候leader 选举"></a>服务器启动的时候leader 选举</h3><p>每个节点启动的时候状态都是LOOKING ,处于观望状态, 接下来就进行选主流程. </p>
<p>若进行leader选举, 则至少需要两台机器, 这里选取3台机器组成的服务器集群为例. 在集群初始化阶段,当有一台服务器server1 启动时, 其单独无法进行和完成leader 选举。 当第二台服务器server2 启动的时候, 此时两台机器可以相互通信,每台机器都试图找到leader, 于是进入leader 选举过程. 选举过程如下:</p>
<ol>
<li><p>每个server 发出一个投票, 由于是初始情况, server1 和server2 都会将自己作为leader 服务器来进行投票, 每次投票都会包含所推荐的服务器的myid 和zxid、rpoch,使用(myid,zxid,epoch)来标识, 此时server1 的投票为(1,0),server2 的投票为(2,0),然后各自将这个投票发送给集群中的其他机器. </p>
</li>
<li><p>接受来自各个服务器的投票, 集群的每个服务器收到投票后, 首先判断该投票的有效性, 如检查是否为本轮投票(epoch)、是否来自 LOOKING  状态的服务器. </p>
</li>
<li><p>处理投票, 针对每一个投票, 服务器都需要将别人的投票来自己的投票进行PK,PK 规则如下: </p>
<ol>
<li><p>优先比较 epoch</p>
</li>
<li><p>其次检查zxid, zxid 比较大的服务器优先为leader</p>
</li>
<li><p>如果zxid 相同,  那么比较myid, myid 较大的服务器作为leader 服务器. </p>
<p>对于server1 而言,它的投票是(1,0),  接受server2 的投票 为(2,0), 首先会比较两者的zxid,均为0, 再比较myid, 此时server2 的myid 最大, 于是更新自己的投票为(2,0), 然后重新开始投票, 对于server2而言, 其无需更新自己的投票, 只是再次向集群中所有寄去发出上一个投票信息即可. </p>
</li>
</ol>
</li>
<li><p>统计投票</p>
<p>   每次投票后, 服务器都会统计投票信息, 判断是否已经有过接受到相同的投票信息, 对于server1 、server2而言, 都统计出集群中已经有2台机器接受了(2,0) 的投票信息, 此时便认为已经选出了leader. </p>
</li>
<li><p>改变服务器状态</p>
<p>  一旦确定了leader, 每个服务器都会更新自己的状态, 如果是follower, 那么就变更为following, 如果是leader, 就变更为leading. </p>
</li>
</ol>
<h3 id="运行过程中的leader-选举"><a href="#运行过程中的leader-选举" class="headerlink" title="运行过程中的leader 选举"></a>运行过程中的leader 选举</h3><p>当集群中的leader 服务器出现宕机或者不可用的情况下, 那么整个集群将无法对外提供服务, 而是进入新一轮的leader 选举, 服务器运行期间的leader 选举和启动时候的leader 选举基本过程是一致的. </p>
<ol>
<li><p>变更状态</p>
<p> Leader 挂后, 余下的废Observer 服务器都会将自己的服务器状态变更为LOOKING，然后进入到leader 选举过程. </p>
</li>
<li><p>每个server 会发出一个投票, 在运行期间, 每个服务器的zxid 可能不同, 此时假设server1 的zxid 为123, server3的zxid 为122, 在第一轮的投票中,server1 和server3 都投自己, 产生投票(1,123),(3,122), 然后各自将投票发送给集群中所有机器. 接受来自各个服务器的投票,与启动时过程相同. </p>
</li>
<li><p>处理投票, 与启动时过程相同, 此时， server1 将会成为leader</p>
</li>
<li><p>统计投票.与启动时过程相同. </p>
</li>
<li><p>改变服务器状态</p>
</li>
</ol>
<p><img src="http://files.luyanan.com//img/20191113134052.png"></p>
<h2 id="Leader-选举的源码分析"><a href="#Leader-选举的源码分析" class="headerlink" title="Leader 选举的源码分析"></a>Leader 选举的源码分析</h2><p>源码分析, 最关键是要好一个入口, 对于zk 的leader 选举, 并不是由客户端触发的, 而是在启动的时候会触发一次选举. 所以我们们可以直接去看启动脚本 zkServer.sh 中的命令. </p>
<p>ZOOMAIN 就是QuorumPeerMain,我们基于这个入口来看</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup &quot;$JAVA&quot; $ZOO_DATADIR_AUTOCREATE &quot;-Dzookeeper.log.dir=$&#123;ZOO_LOG_DIR&#125;&quot; \&quot;-Dzookeeper.log.file=$&#123;ZOO_LOG_FILE&#125;&quot; &quot;-Dzookeeper.root.logger=$&#123;ZOO_LOG4J_PROP&#125;&quot; \-XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError=&#x27;kill -9 %p&#x27; \-cp &quot;$CLASSPATH&quot; $JVMFLAGS $ZOOMAIN &quot;$ZOOCFG&quot; &gt; &quot;$_ZOO_DAEMON_OUT&quot; 2&gt;&amp;1 &lt; /dev/null &amp;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="QuorumPeerMain-的main方法"><a href="#QuorumPeerMain-的main方法" class="headerlink" title="QuorumPeerMain 的main方法"></a>QuorumPeerMain 的main方法</h3><p>main方法中,调用了initializeAndRun()  方法进行初始化并且运行.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initializeAndRun</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">           <span class="keyword">throws</span> ConfigException, IOException, AdminServerException </span>&#123;</span><br><span class="line">       <span class="comment">// 设置配置参数, 如果args 不为0, 可以基于外部的配置路径来进行解析</span></span><br><span class="line">       QuorumPeerConfig config = <span class="keyword">new</span> QuorumPeerConfig();</span><br><span class="line">       <span class="keyword">if</span> (args.length == <span class="number">1</span>) &#123;</span><br><span class="line">           config.parse(args[<span class="number">0</span>]);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Start and schedule the the purge task</span></span><br><span class="line">       <span class="comment">// 这里启动了一个线程, 来定时对日志进行清理</span></span><br><span class="line">       DatadirCleanupManager purgeMgr = <span class="keyword">new</span> DatadirCleanupManager(config</span><br><span class="line">               .getDataDir(), config.getDataLogDir(), config</span><br><span class="line">               .getSnapRetainCount(), config.getPurgeInterval());</span><br><span class="line">       purgeMgr.start();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 如果是集群模式, 会调用runFromConfig servers 其实就是我们在zoo.cfg 中配置的集群节点</span></span><br><span class="line">       <span class="keyword">if</span> (args.length == <span class="number">1</span> &amp;&amp; config.isDistributed()) &#123;</span><br><span class="line">           runFromConfig(config);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Either no config or no quorum defined in config, running &quot;</span></span><br><span class="line">                   + <span class="string">&quot; in standalone mode&quot;</span>);</span><br><span class="line">           <span class="comment">// there is only server in the quorum -- run as standalone</span></span><br><span class="line">           ZooKeeperServerMain.main(args);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="runFromConfig-config"><a href="#runFromConfig-config" class="headerlink" title="runFromConfig(config)"></a>runFromConfig(config)</h4><p>从名字可以看出, 是基于配置文件来进行启动。</p>
<p>所以整个方法都是对参数进行解析和设置, 直接看核心的代码quorumPeer.start();,启动一个线程, 那么从这句代码可以看出来 QuorumPeerMain 其实是继承了一个Thread, 那么这里面一定有一个run方法. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, AdminServerException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ManagedUtil.registerLog4jMBeans();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMException e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Unable to register log4j JMX control&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG.info(<span class="string">&quot;Starting quorum peer&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerCnxnFactory cnxnFactory = <span class="keyword">null</span>;</span><br><span class="line">            ServerCnxnFactory secureCnxnFactory = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (config.getClientPortAddress() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">                cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                        config.getMaxClientCnxns(),</span><br><span class="line">                        <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (config.getSecureClientPortAddress() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                secureCnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">                secureCnxnFactory.configure(config.getSecureClientPortAddress(),</span><br><span class="line">                        config.getMaxClientCnxns(),</span><br><span class="line">                        <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            quorumPeer = getQuorumPeer();</span><br><span class="line">            quorumPeer.setTxnFactory(<span class="keyword">new</span> FileTxnSnapLog(</span><br><span class="line">                    config.getDataLogDir(),</span><br><span class="line">                    config.getDataDir()));</span><br><span class="line">            quorumPeer.enableLocalSessions(config.areLocalSessionsEnabled());</span><br><span class="line">            quorumPeer.enableLocalSessionsUpgrading(</span><br><span class="line">                    config.isLocalSessionsUpgradingEnabled());</span><br><span class="line">            <span class="comment">//quorumPeer.setQuorumPeers(config.getAllMembers());</span></span><br><span class="line">            quorumPeer.setElectionType(config.getElectionAlg());</span><br><span class="line">            quorumPeer.setMyid(config.getServerId());</span><br><span class="line">            quorumPeer.setTickTime(config.getTickTime());</span><br><span class="line">            quorumPeer.setMinSessionTimeout(config.getMinSessionTimeout());</span><br><span class="line">            quorumPeer.setMaxSessionTimeout(config.getMaxSessionTimeout());</span><br><span class="line">            quorumPeer.setInitLimit(config.getInitLimit());</span><br><span class="line">            quorumPeer.setSyncLimit(config.getSyncLimit());</span><br><span class="line">            quorumPeer.setConfigFileName(config.getConfigFilename());</span><br><span class="line">            quorumPeer.setZKDatabase(<span class="keyword">new</span> ZKDatabase(quorumPeer.getTxnFactory()));</span><br><span class="line">            quorumPeer.setQuorumVerifier(config.getQuorumVerifier(), <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (config.getLastSeenQuorumVerifier() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                quorumPeer.setLastSeenQuorumVerifier(config.getLastSeenQuorumVerifier(), <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            quorumPeer.initConfigInZKDatabase();</span><br><span class="line">            quorumPeer.setCnxnFactory(cnxnFactory);</span><br><span class="line">            quorumPeer.setSecureCnxnFactory(secureCnxnFactory);</span><br><span class="line">            quorumPeer.setSslQuorum(config.isSslQuorum());</span><br><span class="line">            quorumPeer.setUsePortUnification(config.shouldUsePortUnification());</span><br><span class="line">            quorumPeer.setLearnerType(config.getPeerType());</span><br><span class="line">            quorumPeer.setSyncEnabled(config.getSyncEnabled());</span><br><span class="line">            <span class="comment">// 投票决定方式, 默认超过半数就通过. </span></span><br><span class="line">            quorumPeer.setQuorumListenOnAllIPs(config.getQuorumListenOnAllIPs());</span><br><span class="line">            <span class="keyword">if</span> (config.sslQuorumReloadCertFiles) &#123;</span><br><span class="line">                quorumPeer.getX509Util().enableCertFileReloading();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// sets quorum sasl authentication configurations</span></span><br><span class="line">            quorumPeer.setQuorumSaslEnabled(config.quorumEnableSasl);</span><br><span class="line">            <span class="keyword">if</span> (quorumPeer.isQuorumSaslAuthEnabled()) &#123;</span><br><span class="line">                quorumPeer.setQuorumServerSaslRequired(config.quorumServerRequireSasl);</span><br><span class="line">                quorumPeer.setQuorumLearnerSaslRequired(config.quorumLearnerRequireSasl);</span><br><span class="line">                quorumPeer.setQuorumServicePrincipal(config.quorumServicePrincipal);</span><br><span class="line">                quorumPeer.setQuorumServerLoginContext(config.quorumServerLoginContext);</span><br><span class="line">                quorumPeer.setQuorumLearnerLoginContext(config.quorumLearnerLoginContext);</span><br><span class="line">            &#125;</span><br><span class="line">            quorumPeer.setQuorumCnxnThreadsSize(config.quorumCnxnThreadsSize);</span><br><span class="line">            quorumPeer.initialize();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 启动主线程. </span></span><br><span class="line">            quorumPeer.start();</span><br><span class="line">            quorumPeer.join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// warn, but generally this is ok</span></span><br><span class="line">            LOG.warn(<span class="string">&quot;Quorum Peer interrupted&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="quorumPeer-start"><a href="#quorumPeer-start" class="headerlink" title="quorumPeer.start()"></a>quorumPeer.start()</h4><p> quorumPeer.start() 方法,重写了Thread.start() 方法, 也就是在线程启动之前，会做以下操作:</p>
<ol>
<li><p>通过loadDataBase() 恢复快照数据</p>
</li>
<li><p>cnxnFactory.start() 启动zkServer, 相当于用户可以通过2181 这个端口号进行通信了. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!getView().containsKey(myid)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;My id &quot;</span> + myid + <span class="string">&quot; not in the peer list&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 恢复快照数据</span></span><br><span class="line">       loadDataBase();</span><br><span class="line">       <span class="comment">// 启动zk服务</span></span><br><span class="line">       startServerCnxnFactory();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           adminServer.start();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (AdminServerException e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Problem starting AdminServer&quot;</span>, e);</span><br><span class="line">           System.out.println(e);</span><br><span class="line">       &#125;</span><br><span class="line">       startLeaderElection();</span><br><span class="line">       <span class="keyword">super</span>.start();</span><br><span class="line">   &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startServerCnxnFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (cnxnFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">           cnxnFactory.start();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (secureCnxnFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">           secureCnxnFactory.start();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="startLeaderElection"><a href="#startLeaderElection" class="headerlink" title="startLeaderElection()"></a>startLeaderElection()</h4><p>leader  选举的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startLeaderElection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 构建一个票据, 用于投票</span></span><br><span class="line">           currentVote = <span class="keyword">new</span> Vote(myid, getLastLoggedZxid(), getCurrentEpoch());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           RuntimeException re = <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">           re.setStackTrace(e.getStackTrace());</span><br><span class="line">           <span class="keyword">throw</span> re;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 这个 getView() 返回是在配置文件中配置的server.myid=ip:port:port</span></span><br><span class="line">       <span class="keyword">for</span> (QuorumServer p : getView().values()) &#123;</span><br><span class="line">           <span class="comment">// 获得当前zkserver myid 对应的ip地址</span></span><br><span class="line">           <span class="keyword">if</span> (p.id == myid) &#123;</span><br><span class="line">               myQuorumAddr = p.addr;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (myQuorumAddr == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;My id &quot;</span> + myid + <span class="string">&quot; not in the peer list&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 根据electionType 匹配对应的选举算法, electionType 默认值为3, 可以在配置文件中动态生成. </span></span><br><span class="line">       <span class="keyword">if</span> (electionType == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               udpSocket = <span class="keyword">new</span> DatagramSocket(myQuorumAddr.getPort());</span><br><span class="line">               responder = <span class="keyword">new</span> ResponderThread();</span><br><span class="line">               responder.start();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">this</span>.electionAlg = createElectionAlgorithm(electionType);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="QuorumPeer-createElectionAlgorithm"><a href="#QuorumPeer-createElectionAlgorithm" class="headerlink" title="QuorumPeer.createElectionAlgorithm"></a>QuorumPeer.createElectionAlgorithm</h4><p>根据对应的标识创建选举算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Election <span class="title">createElectionAlgorithm</span><span class="params">(<span class="keyword">int</span> electionAlgorithm)</span> </span>&#123;</span><br><span class="line">       Election le = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//<span class="doctag">TODO:</span> use a factory rather than a switch</span></span><br><span class="line">       <span class="keyword">switch</span> (electionAlgorithm) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">               le = <span class="keyword">new</span> LeaderElection(<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">               le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">               le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">               qcm = createCnxnManager();</span><br><span class="line">               QuorumCnxManager.Listener listener = qcm.listener;</span><br><span class="line">               <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// 启动监听</span></span><br><span class="line">                   listener.start();</span><br><span class="line">                   <span class="comment">// 初始化 FastLeaderElection</span></span><br><span class="line">                   le = <span class="keyword">new</span> FastLeaderElection(<span class="keyword">this</span>, qcm);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   LOG.error(<span class="string">&quot;Null listener when initializing cnx manager&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> le;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="FastLeaderElection"><a href="#FastLeaderElection" class="headerlink" title="FastLeaderElection"></a><strong>FastLeaderElection</strong></h4><p>初始化FastLeaderElection , QuorumCnxManager 是一个很核心的对象, 用来实现 领导选举中的网络连接管理功能, </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FastLeaderElection</span><span class="params">(QuorumPeer self, QuorumCnxManager manager)</span></span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.stop = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">this</span>.manager = manager;</span><br><span class="line">       starter(self, manager);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="FastLeaderElection-starter"><a href="#FastLeaderElection-starter" class="headerlink" title="FastLeaderElection.starter"></a>FastLeaderElection.starter</h4><p>starter 方法里面, 设置了一些成员属性, 并且构建了两个阻塞队列, 分别是 sendQueue  和 recvqueue . 并且实例化了一个Messenger </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">starter</span><span class="params">(QuorumPeer self, QuorumCnxManager manager)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.self = self;</span><br><span class="line">       proposedLeader = -<span class="number">1</span>;</span><br><span class="line">       proposedZxid = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">       sendqueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;ToSend&gt;();</span><br><span class="line">       recvqueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Notification&gt;();</span><br><span class="line">       <span class="keyword">this</span>.messenger = <span class="keyword">new</span> Messenger(manager);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="Messenger"><a href="#Messenger" class="headerlink" title="Messenger"></a>Messenger</h4><p>在 Messenger 中构建了两个线程, 一个是WorkerSender, 一个是WorkerReceiver. 这两个线程是分别用来发送和接受消息的线程. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Messenger(QuorumCnxManager manager) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">this</span>.ws = <span class="keyword">new</span> WorkerSender(manager);</span><br><span class="line"></span><br><span class="line">          Thread t = <span class="keyword">new</span> Thread(<span class="keyword">this</span>.ws,</span><br><span class="line">                  <span class="string">&quot;WorkerSender[myid=&quot;</span> + self.getId() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">          t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">          t.start();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">this</span>.wr = <span class="keyword">new</span> WorkerReceiver(manager);</span><br><span class="line"></span><br><span class="line">          t = <span class="keyword">new</span> Thread(<span class="keyword">this</span>.wr,</span><br><span class="line">                  <span class="string">&quot;WorkerReceiver[myid=&quot;</span> + self.getId() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">          t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">          t.start();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h4 id="阶段性提交"><a href="#阶段性提交" class="headerlink" title="阶段性提交"></a>阶段性提交</h4><p>分析到这里,先做一个简单的总结, 通过一个流程图把前面部分的功能串联起来。 </p>
<p><img src="http://files.luyanan.com//img/20191113161725.png"></p>
<h4 id="getView-的解析过程"><a href="#getView-的解析过程" class="headerlink" title="getView() 的解析过程"></a>getView() 的解析过程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;Long, QuorumPeer.QuorumServer&gt; getView() &#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableMap(<span class="keyword">this</span>.quorumPeers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getView()  里面实际上返回是一个quorumPeers, 就是参与本次投票的成员有哪些? 这个属性在哪里赋值呢?</p>
<h4 id="QuorumPeerMain-runFromConfig"><a href="#QuorumPeerMain-runFromConfig" class="headerlink" title="QuorumPeerMain.runFromConfig"></a>QuorumPeerMain.runFromConfig</h4><p>设置了一个值为config.getServers(), </p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quorumPeer.setQuorumPeers(config.getServers());</span><br></pre></td></tr></table></figure>
</blockquote>
<p>config  这个配置信息又是通过 initializeAndRun  方法中初始化的. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 设置配置参数, 如果args 不为0, 可以基于外部的配置路径来解析</span><br><span class="line">      QuorumPeerConfig config &#x3D; new QuorumPeerConfig();</span><br><span class="line">      if (args.length &#x3D;&#x3D; 1) &#123;</span><br><span class="line">          config.parse(args[0]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="QuorumPeerConfig-parse"><a href="#QuorumPeerConfig-parse" class="headerlink" title="QuorumPeerConfig.parse"></a>QuorumPeerConfig.parse</h4><p>这里会根据一个外部的文件去解析, 然后其中一段是这样的, 解析对应的集群信息放到servers 这个集合中. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (key.startsWith(<span class="string">&quot;server.&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">int</span> dot = key.indexOf(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">                <span class="keyword">long</span> sid = Long.parseLong(key.substring(dot + <span class="number">1</span>));</span><br><span class="line">                String parts[] = splitWithLeadingHostname(value);</span><br><span class="line">                <span class="keyword">if</span> ((parts.length != <span class="number">2</span>) &amp;&amp; (parts.length != <span class="number">3</span>) &amp;&amp; (parts.length !=<span class="number">4</span>)) &#123;</span><br><span class="line">                    LOG.error(value</span><br><span class="line">                       + <span class="string">&quot; does not have the form host:port or host:port:port &quot;</span> +</span><br><span class="line">                       <span class="string">&quot; or host:port:port:type&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                LearnerType type = <span class="keyword">null</span>;</span><br><span class="line">                String hostname = parts[<span class="number">0</span>];</span><br><span class="line">                Integer port = Integer.parseInt(parts[<span class="number">1</span>]);</span><br><span class="line">                Integer electionPort = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (parts.length &gt; <span class="number">2</span>)&#123;</span><br><span class="line">                	electionPort=Integer.parseInt(parts[<span class="number">2</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (parts.length &gt; <span class="number">3</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (parts[<span class="number">3</span>].toLowerCase().equals(<span class="string">&quot;observer&quot;</span>)) &#123;</span><br><span class="line">                        type = LearnerType.OBSERVER;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parts[<span class="number">3</span>].toLowerCase().equals(<span class="string">&quot;participant&quot;</span>)) &#123;</span><br><span class="line">                        type = LearnerType.PARTICIPANT;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">&quot;Unrecognised peertype: &quot;</span> + value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (type == LearnerType.OBSERVER)&#123;</span><br><span class="line">                    observers.put(Long.valueOf(sid), <span class="keyword">new</span> QuorumServer(sid, hostname, port, electionPort, type));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    servers.put(Long.valueOf(sid), <span class="keyword">new</span> QuorumServer(sid, hostname, port, electionPort, type));</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Zookeeper-服务启动的逻辑"><a href="#Zookeeper-服务启动的逻辑" class="headerlink" title="Zookeeper 服务启动的逻辑"></a>Zookeeper 服务启动的逻辑</h2><p>在讲leader 选举的时候, 有一个 cnxnFactory.start()  方法来启动zk 服务, 这块具体做了什么呢? 我们来分析看看</p>
<h3 id="QuorumPeerMain-runFromConfig-1"><a href="#QuorumPeerMain-runFromConfig-1" class="headerlink" title="QuorumPeerMain.runFromConfig"></a>QuorumPeerMain.runFromConfig</h3><p>在runFromConfig中， 构建了一个ServerCnxnFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runFromConfig</span><span class="params">(QuorumPeerConfig config)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          ManagedUtil.registerLog4jMBeans();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (JMException e) &#123;</span><br><span class="line">          LOG.warn(<span class="string">&quot;Unable to register log4j JMX control&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      LOG.info(<span class="string">&quot;Starting quorum peer&quot;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory();</span><br><span class="line">          cnxnFactory.configure(config.getClientPortAddress(),</span><br><span class="line">                  config.getMaxClientCnxns());</span><br><span class="line"></span><br><span class="line">          </span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这个明显是一个工厂模式, 基于这个工厂类创建什么呢? 打开createFactory() 方法看看就知道了. </p>
<h3 id="ServerCnxnFactory-createFactory"><a href="#ServerCnxnFactory-createFactory" class="headerlink" title="ServerCnxnFactory.createFactory()"></a>ServerCnxnFactory.createFactory()</h3><p>这个方法里面是根据<code>ZOOKEEPER_SERVER_CNXN_FACTORY</code>  来决定创建NIO Server 还是Netty Server</p>
<p>而默认情况下, 应该是创建一个 NIOServerCnxnFactory </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> ServerCnxnFactory <span class="title">createFactory</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      String serverCnxnFactoryName =</span><br><span class="line">          System.getProperty(ZOOKEEPER_SERVER_CNXN_FACTORY);</span><br><span class="line">      <span class="keyword">if</span> (serverCnxnFactoryName == <span class="keyword">null</span>) &#123;</span><br><span class="line">          serverCnxnFactoryName = NIOServerCnxnFactory.class.getName();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          ServerCnxnFactory serverCnxnFactory = (ServerCnxnFactory) Class.forName(serverCnxnFactoryName)</span><br><span class="line">                  .getDeclaredConstructor().newInstance();</span><br><span class="line">          LOG.info(<span class="string">&quot;Using &#123;&#125; as server connection factory&quot;</span>, serverCnxnFactoryName);</span><br><span class="line">          <span class="keyword">return</span> serverCnxnFactory;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          IOException ioe = <span class="keyword">new</span> IOException(<span class="string">&quot;Couldn&#x27;t instantiate &quot;</span></span><br><span class="line">                  + serverCnxnFactoryName);</span><br><span class="line">          ioe.initCause(e);</span><br><span class="line">          <span class="keyword">throw</span> ioe;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="quorumPeer-start-1"><a href="#quorumPeer-start-1" class="headerlink" title="quorumPeer.start();"></a>quorumPeer.start();</h3><p>因此, 我们再回到 quorumPeer.start(); 方法中,  cnxnFactory.start()，  应该会调用NIOServerCnxnFactory 这个类去启动一个线程. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 恢复快照数据</span></span><br><span class="line">     loadDataBase();</span><br><span class="line">     <span class="comment">// 启动zk 服务</span></span><br><span class="line">     cnxnFactory.start();</span><br><span class="line">     startLeaderElection();</span><br><span class="line">     <span class="keyword">super</span>.start();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="NIOServerCnxnFactory-start"><a href="#NIOServerCnxnFactory-start" class="headerlink" title="NIOServerCnxnFactory.start()"></a>NIOServerCnxnFactory.start()</h3><p>这里通过thread.start  启动一个线程, 那thread 是一个什么对象呢? </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// ensure thread is started once and only once</span></span><br><span class="line">     <span class="keyword">if</span> (thread.getState() == Thread.State.NEW) &#123;</span><br><span class="line">         thread.start();</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="NIOServerCnxnFactory-configure"><a href="#NIOServerCnxnFactory-configure" class="headerlink" title="NIOServerCnxnFactory.configure"></a>NIOServerCnxnFactory.configure</h3><p>thread  其实构建的是一个zookeeperThread 线程, 并且线程的参数为this, 表示当前NIOServerCnxnFactory 也是实现了线程的类, 那么它必须要重写run() 方法, NIOServer 的初始化以及启动过程就完成的. 并且对2181 这个端口号进行监听, 一旦发现有请求进来, 就执行相应的处理即可. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Thread thread;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(InetSocketAddress addr, <span class="keyword">int</span> maxcc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        configureSaslLogin();</span><br><span class="line"></span><br><span class="line">        thread = <span class="keyword">new</span> ZooKeeperThread(<span class="keyword">this</span>, <span class="string">&quot;NIOServerCxn.Factory:&quot;</span> + addr);</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        maxClientCnxns = maxcc;</span><br><span class="line">        <span class="keyword">this</span>.ss = ServerSocketChannel.open();</span><br><span class="line">        ss.socket().setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;binding to port &quot;</span> + addr);</span><br><span class="line">        ss.socket().bind(addr);</span><br><span class="line">        ss.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">        ss.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="选举流程分析"><a href="#选举流程分析" class="headerlink" title="选举流程分析"></a>选举流程分析</h2><p>接下来我们正式分析leader 选举的过程. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 恢复快照数据</span></span><br><span class="line">     loadDataBase();</span><br><span class="line">     <span class="comment">// 启动zk 服务</span></span><br><span class="line">     cnxnFactory.start();</span><br><span class="line">     startLeaderElection();</span><br><span class="line">     <span class="keyword">super</span>.start();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>很明显,super.start()  表示当前类QuorumPeer 继承了线程, 线程必须要重写run() 方法, 所以我们可以在 QuorumPeer 中找到一个run方法</p>
<h3 id="QuorumPeer-run"><a href="#QuorumPeer-run" class="headerlink" title="QuorumPeer.run()"></a>QuorumPeer.run()</h3><p>这段代码的逻辑比较长, 粗略看一下结构, 好像也不难 </p>
<p> PeerState  有几种状态, 分别是: </p>
<ol>
<li> LOOKING : 竞选状态</li>
<li> FOLLOWING:  随从状态. 同步leader 状态, 参与投票</li>
<li> OBSERVING : 观察状态, 同步leader 状态, 不参与投票. </li>
<li> LEADING : 领导者状态. </li>
</ol>
<p>对于选举来说, 默认都是  LOOKING  状态. </p>
<p>只有 LOOKING  状态才会去执行选举算法, 每个服务器在启动的时候都会选择自己作为领导，然后将投票信息发送出去, 循环一直到选举出领导为止. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       setName(<span class="string">&quot;QuorumPeer&quot;</span> + <span class="string">&quot;[myid=&quot;</span> + getId() + <span class="string">&quot;]&quot;</span> +</span><br><span class="line">               cnxnFactory.getLocalAddress());</span><br><span class="line"></span><br><span class="line">       LOG.debug(<span class="string">&quot;Starting quorum peer&quot;</span>);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           jmxQuorumBean = <span class="keyword">new</span> QuorumBean(<span class="keyword">this</span>);</span><br><span class="line">           MBeanRegistry.getInstance().register(jmxQuorumBean, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">for</span> (QuorumServer s : getView().values()) &#123;</span><br><span class="line">               ZKMBeanInfo p;</span><br><span class="line">               <span class="keyword">if</span> (getId() == s.id) &#123;</span><br><span class="line">                   p = jmxLocalPeerBean = <span class="keyword">new</span> LocalPeerBean(<span class="keyword">this</span>);</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">                       jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   p = <span class="keyword">new</span> RemotePeerBean(s);</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">           jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Main loop</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">// 根据选举状态, 选择不同的处理方式</span></span><br><span class="line">           <span class="keyword">while</span> (running) &#123;</span><br><span class="line">               <span class="keyword">switch</span> (getPeerState()) &#123;</span><br><span class="line">                   <span class="keyword">case</span> LOOKING:</span><br><span class="line">                       LOG.info(<span class="string">&quot;LOOKING&quot;</span>);</span><br><span class="line"></span><br><span class="line">                       <span class="comment">// 判断是否为只读模式, 通过readonlymode.enabled 开启</span></span><br><span class="line">                       <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;readonlymode.enabled&quot;</span>)) &#123;</span><br><span class="line">                           LOG.info(<span class="string">&quot;Attempting to start ReadOnlyZooKeeperServer&quot;</span>);</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// 只读模式的启动流程</span></span><br><span class="line">                           <span class="comment">// Create read-only server but don&#x27;t start it immediately</span></span><br><span class="line">                           <span class="keyword">final</span> ReadOnlyZooKeeperServer roZk = <span class="keyword">new</span> ReadOnlyZooKeeperServer(</span><br><span class="line">                                   logFactory, <span class="keyword">this</span>,</span><br><span class="line">                                   <span class="keyword">new</span> ZooKeeperServer.BasicDataTreeBuilder(),</span><br><span class="line">                                   <span class="keyword">this</span>.zkDb);</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// Instead of starting roZk immediately, wait some grace</span></span><br><span class="line">                           <span class="comment">// period before we decide we&#x27;re partitioned.</span></span><br><span class="line">                           <span class="comment">//</span></span><br><span class="line">                           <span class="comment">// Thread is used here because otherwise it would require</span></span><br><span class="line">                           <span class="comment">// changes in each of election strategy classes which is</span></span><br><span class="line">                           <span class="comment">// unnecessary code coupling.</span></span><br><span class="line">                           Thread roZkMgr = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                   <span class="keyword">try</span> &#123;</span><br><span class="line">                                       <span class="comment">// lower-bound grace period to 2 secs</span></span><br><span class="line">                                       sleep(Math.max(<span class="number">2000</span>, tickTime));</span><br><span class="line">                                       <span class="keyword">if</span> (ServerState.LOOKING.equals(getPeerState())) &#123;</span><br><span class="line">                                           roZk.startup();</span><br><span class="line">                                       &#125;</span><br><span class="line">                                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                       LOG.info(<span class="string">&quot;Interrupted while attempting to start ReadOnlyZooKeeperServer, not started&quot;</span>);</span><br><span class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                       LOG.error(<span class="string">&quot;FAILED to start ReadOnlyZooKeeperServer&quot;</span>, e);</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;;</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               roZkMgr.start();</span><br><span class="line">                               setBCVote(<span class="keyword">null</span>);</span><br><span class="line">                               <span class="comment">// 设置当前的投票, 通过策略模式来决定当前用哪个选举算法来进行领导选举</span></span><br><span class="line">                               setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                               LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                               setPeerState(ServerState.LOOKING);</span><br><span class="line">                           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               <span class="comment">// If the thread is in the the grace period, interrupt</span></span><br><span class="line">                               <span class="comment">// to come out of waiting.</span></span><br><span class="line">                               roZkMgr.interrupt();</span><br><span class="line">                               roZk.shutdown();</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               setBCVote(<span class="keyword">null</span>);</span><br><span class="line">                               setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                               LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                               setPeerState(ServerState.LOOKING);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">case</span> OBSERVING:</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           LOG.info(<span class="string">&quot;OBSERVING&quot;</span>);</span><br><span class="line">                           setObserver(makeObserver(logFactory));</span><br><span class="line">                           observer.observeLeader();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                           LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                           observer.shutdown();</span><br><span class="line">                           setObserver(<span class="keyword">null</span>);</span><br><span class="line">                           setPeerState(ServerState.LOOKING);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           LOG.info(<span class="string">&quot;FOLLOWING&quot;</span>);</span><br><span class="line">                           setFollower(makeFollower(logFactory));</span><br><span class="line">                           follower.followLeader();</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                           LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                           follower.shutdown();</span><br><span class="line">                           setFollower(<span class="keyword">null</span>);</span><br><span class="line">                           setPeerState(ServerState.LOOKING);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">case</span> LEADING:</span><br><span class="line">                       LOG.info(<span class="string">&quot;LEADING&quot;</span>);</span><br><span class="line">                       <span class="keyword">try</span> &#123;</span><br><span class="line">                           setLeader(makeLeader(logFactory));</span><br><span class="line">                           leader.lead();</span><br><span class="line">                           setLeader(<span class="keyword">null</span>);</span><br><span class="line">                       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                           LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                           <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               leader.shutdown(<span class="string">&quot;Forcing shutdown&quot;</span>);</span><br><span class="line">                               setLeader(<span class="keyword">null</span>);</span><br><span class="line">                           &#125;</span><br><span class="line">                           setPeerState(ServerState.LOOKING);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;QuorumPeer main thread exited&quot;</span>);</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               MBeanRegistry.getInstance().unregisterAll();</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               LOG.warn(<span class="string">&quot;Failed to unregister with JMX&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">           jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">           jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="FastLeaderElection-lookForLeader"><a href="#FastLeaderElection-lookForLeader" class="headerlink" title="FastLeaderElection .lookForLeader()"></a>FastLeaderElection .lookForLeader()</h3><p>开始发起投票流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           self.jmxLeaderElectionBean = <span class="keyword">new</span> LeaderElectionBean();</span><br><span class="line">           MBeanRegistry.getInstance().register(</span><br><span class="line">                   self.jmxLeaderElectionBean, self.jmxLocalPeerBean);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">           self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (self.start_fle == <span class="number">0</span>) &#123;</span><br><span class="line">           self.start_fle = Time.currentElapsedTime();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           HashMap&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">           HashMap&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> notTimeout = finalizeWait;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="comment">// 更新逻辑时钟, 用来判断是否在同一轮选举周期</span></span><br><span class="line">               logicalclock.incrementAndGet();</span><br><span class="line">               <span class="comment">// 初始化选票数据, 这里其实就是把当前节点的myid,zxid,epoch 更新到本地的成员属性</span></span><br><span class="line">               updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           LOG.info(<span class="string">&quot;New election. My id =  &quot;</span> + self.getId() +</span><br><span class="line">                   <span class="string">&quot;, proposed zxid=0x&quot;</span> + Long.toHexString(proposedZxid));</span><br><span class="line">           <span class="comment">// 异步发送选举消息</span></span><br><span class="line">           sendNotifications();</span><br><span class="line"></span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Loop in which we exchange notifications until we find a leader</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">// 不断循环, 根据投票信息进行leader 选举</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">while</span> ((self.getPeerState() == ServerState.LOOKING) &amp;&amp;</span><br><span class="line">                   (!stop)) &#123;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Remove next notification from queue, times out after 2 times</span></span><br><span class="line"><span class="comment">                * the termination time</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               <span class="comment">// 从 recvqueue 中获取消息</span></span><br><span class="line">               Notification n = recvqueue.poll(notTimeout,</span><br><span class="line">                       TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * Sends more notifications if haven&#x27;t received enough.</span></span><br><span class="line"><span class="comment">                * Otherwise processes new notification.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">               <span class="comment">// 如果没有获取到外部的投票, 有可能是集群之间的节点没有真正连接上</span></span><br><span class="line">               <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// 判断发送队列是否由数据,如果发送队列为空,再发一次自己的选票</span></span><br><span class="line">                   <span class="keyword">if</span> (manager.haveDelivered()) &#123;</span><br><span class="line">                       sendNotifications();</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// 再次发起集群节点之间的连接</span></span><br><span class="line">                       manager.connectAll();</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * Exponential backoff</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                   <span class="keyword">int</span> tmpTimeOut = notTimeout * <span class="number">2</span>;</span><br><span class="line">                   notTimeout = (tmpTimeOut &lt; maxNotificationInterval ?</span><br><span class="line">                           tmpTimeOut : maxNotificationInterval);</span><br><span class="line">                   LOG.info(<span class="string">&quot;Notification time out: &quot;</span> + notTimeout);</span><br><span class="line">                   ...</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>

<h3 id="选票的判断逻辑-核心代码"><a href="#选票的判断逻辑-核心代码" class="headerlink" title="选票的判断逻辑(核心代码)"></a>选票的判断逻辑(核心代码)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 判断收到的选票中的sid 和选举的leader 的sid 是否存在与我们集群锁配置的myid 范围.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validVoter(n.sid) &amp;&amp; validVoter(n.leader)) &#123;</span><br><span class="line">                <span class="comment">// 判断接受到的投票者的状态, 默认是LOOKING 状态, 说明当前发起投票的服务器也是找leader</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Only proceed if the vote comes from a replica in the</span></span><br><span class="line"><span class="comment">                 * voting view for a replica in the voting view.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="keyword">switch</span> (n.state) &#123;</span><br><span class="line">                    <span class="keyword">case</span> LOOKING:</span><br><span class="line">                        <span class="comment">// 说明当前发起投票的服务器也是在找leader</span></span><br><span class="line">                        <span class="comment">// 如果收到的投票的逻辑时钟大于当前的节点的逻辑时钟</span></span><br><span class="line">                        <span class="comment">// If notification &gt; current, replace and send messages out</span></span><br><span class="line">                        <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock.get()) &#123;</span><br><span class="line">                            <span class="comment">// 更新成新一轮的逻辑时钟</span></span><br><span class="line">                            logicalclock.set(n.electionEpoch);</span><br><span class="line">                            recvset.clear();</span><br><span class="line">                            <span class="comment">// 比较接收到的投票和当前节点的细腻些进行比较,比较的顺序</span></span><br><span class="line">                            <span class="comment">// epoch、zxid、myid,如果返回的为true,  在更新当前节点大票据</span></span><br><span class="line">                            <span class="comment">// (sid、zxid、epoch)</span></span><br><span class="line">                            <span class="comment">//那么下一次再发起投票的时候, 就不再选自己了</span></span><br><span class="line">                            <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123;</span><br><span class="line">                                updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// 否则, 说明当前节点的票据优先级更高, 再次更新自己的票据</span></span><br><span class="line">                                updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// 再次发送消息把当前的票据发出去,告诉大家要选择n.leader  为leader</span></span><br><span class="line">                            sendNotifications();</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock.get()) &#123;</span><br><span class="line">                            <span class="comment">// 如果小于, 说明收到的票据已经过期,直接把这张票丢掉</span></span><br><span class="line">                            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                                LOG.debug(<span class="string">&quot;Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x&quot;</span> + Long.toHexString(n.electionEpoch) + <span class="string">&quot;, logicalclock=0x&quot;</span> + Long.toHexString(logicalclock.get()));</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 这个判断表示收到的票据epoch 是想同的, 那么按照epoch、zxid、myid顺序进行比较,比较成功后,把对方的票据信息更新到自己的节点</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                            updateProposal(n.leader, n.zxid, n.peerEpoch);</span><br><span class="line">                            sendNotifications();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                            LOG.debug(<span class="string">&quot;Adding vote: from=&quot;</span> + n.sid + <span class="string">&quot;, proposed leader=&quot;</span> + n.leader + <span class="string">&quot;, proposed zxid=0x&quot;</span> + Long.toHexString(n.zxid) + <span class="string">&quot;, proposed election epoch=0x&quot;</span> + Long.toHexString(n.electionEpoch));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 将收到的投票信心放入到投票的集合recvset中, 用来做最终的&quot;过半原则&quot; 判断</span></span><br><span class="line">                        recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (termPredicate(recvset, <span class="keyword">new</span> Vote(proposedLeader, proposedZxid, logicalclock.get(), proposedEpoch))) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 进入这个判断, 说明选票进入到了leader 选举的要求</span></span><br><span class="line">                            <span class="comment">// 在更新状态之前, 服务器会等待finalizeWait 毫秒时间来接受新的选票,以防止漏下来关键的选票</span></span><br><span class="line">                            <span class="comment">// 如果收到可能改变leader 的选票, 则重新进行计票</span></span><br><span class="line">                            <span class="comment">// Verify if there is any change in the proposed leader</span></span><br><span class="line">                            <span class="keyword">while</span> ((n = recvqueue.poll(finalizeWait, TimeUnit.MILLISECONDS)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch, proposedLeader, proposedZxid, proposedEpoch)) &#123;</span><br><span class="line">                                    recvqueue.put(n);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                             * This predicate is true once we don&#x27;t read any new</span></span><br><span class="line"><span class="comment">                             * relevant message from the reception queue</span></span><br><span class="line"><span class="comment">                             */</span></span><br><span class="line">                            <span class="comment">// 如果Notification为空,说明leader 节点是已经确定好了</span></span><br><span class="line">                            <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// 设置当前节点的状态(判断leader 节点不是我自己, 如果是, 直接更新当前节点的 state 为LEADING)</span></span><br><span class="line">                                <span class="comment">// 否则,根据当前节点的特性进行判断,决定是FOLLOWING 还是OBSERVING</span></span><br><span class="line">                                self.setPeerState((proposedLeader == self.getId()) ? ServerState.LEADING : learningState());</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 组装生成这次leader 选举最终投票的结果.</span></span><br><span class="line">                                Vote endVote = <span class="keyword">new</span> Vote(proposedLeader, proposedZxid, logicalclock.get(), proposedEpoch);</span><br><span class="line">                                <span class="comment">// 清空 recvqueue</span></span><br><span class="line">                                leaveInstance(endVote);</span><br><span class="line">                                <span class="comment">// 返回最终的票据</span></span><br><span class="line">                                <span class="keyword">return</span> endVote;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> OBSERVING:</span><br><span class="line">                        <span class="comment">// OBSERVING 不参与Leader 的选举</span></span><br><span class="line">                        LOG.debug(<span class="string">&quot;Notification from observer: &quot;</span> + n.sid);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> FOLLOWING:</span><br><span class="line">                    <span class="keyword">case</span> LEADING:</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * Consider all notifications from the same epoch</span></span><br><span class="line"><span class="comment">                         * together.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        <span class="keyword">if</span> (n.electionEpoch == logicalclock.get()) &#123;</span><br><span class="line">                            recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (ooePredicate(recvset, outofelection, n)) &#123;</span><br><span class="line">                                self.setPeerState((n.leader == self.getId()) ? ServerState.LEADING : learningState());</span><br><span class="line"></span><br><span class="line">                                Vote endVote = <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch);</span><br><span class="line">                                leaveInstance(endVote);</span><br><span class="line">                                <span class="keyword">return</span> endVote;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                         * Before joining an established ensemble, verify</span></span><br><span class="line"><span class="comment">                         * a majority is following the same leader.</span></span><br><span class="line"><span class="comment">                         */</span></span><br><span class="line">                        outofelection.put(n.sid, <span class="keyword">new</span> Vote(n.version, n.leader, n.zxid, n.electionEpoch, n.peerEpoch, n.state));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (ooePredicate(outofelection, outofelection, n)) &#123;</span><br><span class="line">                            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                                logicalclock.set(n.electionEpoch);</span><br><span class="line">                                self.setPeerState((n.leader == self.getId()) ? ServerState.LEADING : learningState());</span><br><span class="line">                            &#125;</span><br><span class="line">                            Vote endVote = <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch);</span><br><span class="line">                            leaveInstance(endVote);</span><br><span class="line">                            <span class="keyword">return</span> endVote;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        LOG.warn(<span class="string">&quot;Notification state unrecognized: &#123;&#125; (n.state), &#123;&#125; (n.sid)&quot;</span>, n.state, n.sid);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!validVoter(n.leader)) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Ignoring notification for non-cluster member sid &#123;&#125; from sid &#123;&#125;&quot;</span>, n.leader, n.sid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!validVoter(n.sid)) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Ignoring notification for sid &#123;&#125; from non-quorum member sid &#123;&#125;&quot;</span>, n.leader, n.sid);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (self.jmxLeaderElectionBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">                MBeanRegistry.getInstance().unregister(self.jmxLeaderElectionBean);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Failed to unregister with JMX&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Number of connection processing threads: &#123;&#125;&quot;</span>, manager.getConnectionThreadCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check if a given sid is represented in either the current or</span></span><br><span class="line"><span class="comment"> * the next voting view</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sid Server identifier</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">validVoter</span><span class="params">(<span class="keyword">long</span> sid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self.getVotingView().containsKey(sid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="投票处理的流程图"><a href="#投票处理的流程图" class="headerlink" title="投票处理的流程图"></a>投票处理的流程图</h3><p><img src="http://files.luyanan.com//img/20191114135751.png"></p>
<h3 id="termPredicate"><a href="#termPredicate" class="headerlink" title="termPredicate"></a>termPredicate</h3><p>这个方法是使用过半原则来判断选举是否结束的, 如果返回true, 说明能够选出leader 服务器. </p>
<p> votes  表示收到的外部选票的集合</p>
<p> vote  表示当前服务器的选票</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">termPredicate</span><span class="params">(HashMap&lt;Long, Vote&gt; votes, Vote vote)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      HashSet&lt;Long&gt; set = <span class="keyword">new</span> HashSet&lt;Long&gt;();</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * First make the views consistent. Sometimes peers will have</span></span><br><span class="line"><span class="comment">       * different zxids for a server depending on timing.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="comment">// 遍历接受到的所有票据数据</span></span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;Long, Vote&gt; entry : votes.entrySet()) &#123;</span><br><span class="line">          <span class="comment">// 对选票进行归纳, 就是把所有选票数据中和当前节点的票据相同的票据进行统计.</span></span><br><span class="line">          <span class="keyword">if</span> (vote.equals(entry.getValue())) &#123;</span><br><span class="line">              set.add(entry.getKey());</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 对票据进行判断</span></span><br><span class="line">      <span class="keyword">return</span> self.getQuorumVerifier().containsQuorum(set);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="QuorumMaj-containsQuorum"><a href="#QuorumMaj-containsQuorum" class="headerlink" title="QuorumMaj.containsQuorum"></a>QuorumMaj.containsQuorum</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsQuorum</span><span class="params">(Set&lt;Long&gt; set)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (set.size() &gt; half);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个half 的值是多少呢? 可以在 QuorumPeerConfig. parseProperties   这个方法中, 找到如下源码: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">LOG.info(<span class="string">&quot;Defaulting to majority quorums&quot;</span>);</span><br><span class="line">quorumVerifier = <span class="keyword">new</span> QuorumMaj(servers.size());</span><br></pre></td></tr></table></figure>

<p>也就是说, 在构建QuorumMaj的时候,传递了当前集群节点的数量, 这里是3. 那么half = 3/2= 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">QuorumMaj</span><span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.half = n/<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么 set.size()&gt;1 ,意味着至少有两个节点的票据是选择你当leader , 否则, 还得继续投. </p>
<h2 id="投票的网络通信过程"><a href="#投票的网络通信过程" class="headerlink" title="投票的网络通信过程"></a>投票的网络通信过程</h2><h3 id="通信流程图"><a href="#通信流程图" class="headerlink" title="通信流程图"></a>通信流程图</h3><p><img src="http://files.luyanan.com//img/20191114140808.png"></p>
<p><img src="http://files.luyanan.com//img/20191114140956.png"></p>
<h3 id="接受数据-Notification-和发送数据-ToSend"><a href="#接受数据-Notification-和发送数据-ToSend" class="headerlink" title="接受数据  Notification  和发送数据  ToSend"></a>接受数据  Notification  和发送数据  ToSend</h3><table>
<thead>
<tr>
<th>字段</th>
<th>Notification</th>
<th>ToSend</th>
</tr>
</thead>
<tbody><tr>
<td>leader</td>
<td>被推荐的服务器sid</td>
<td>被推荐的服务器sid</td>
</tr>
<tr>
<td>zxid</td>
<td>被推荐的服务器当前最新的事务id</td>
<td>被推荐的服务器当前的事务id</td>
</tr>
<tr>
<td>peerEpoch</td>
<td>被推荐的服务器当前所处的epoch</td>
<td>被推荐的服务器当前所处的epoch</td>
</tr>
<tr>
<td>electionepoch</td>
<td>当前服务器所处的epoch</td>
<td>当前服务器所处的epoch</td>
</tr>
<tr>
<td>state</td>
<td>当前服务器状态</td>
<td>选举服务器当前服务器状态</td>
</tr>
<tr>
<td>sid</td>
<td>接受消息的服务器sid(myid)</td>
<td>选举服务器的sid</td>
</tr>
</tbody></table>
<h3 id="通信过程源码分析"><a href="#通信过程源码分析" class="headerlink" title="通信过程源码分析"></a>通信过程源码分析</h3><h4 id="每个zk-服务启动后创建socket-监听"><a href="#每个zk-服务启动后创建socket-监听" class="headerlink" title="每个zk 服务启动后创建socket 监听"></a>每个zk 服务启动后创建socket 监听</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Election <span class="title">createElectionAlgorithm</span><span class="params">(<span class="keyword">int</span> electionAlgorithm)</span> </span>&#123;</span><br><span class="line">       Election le = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//<span class="doctag">TODO:</span> use a factory rather than a switch</span></span><br><span class="line">       <span class="keyword">switch</span> (electionAlgorithm) &#123;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">               le = <span class="keyword">new</span> LeaderElection(<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">               le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">               le = <span class="keyword">new</span> AuthFastLeaderElection(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">               qcm = createCnxnManager();</span><br><span class="line">               QuorumCnxManager.Listener listener = qcm.listener;</span><br><span class="line">               <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// 启动监听,listener 实现了线程,所以在run方法, 可以看到构建serverSocket 的请求</span></span><br><span class="line">                   <span class="comment">// 这里专门用来接受其他zkServer 的投票请求</span></span><br><span class="line">                   listener.start();</span><br><span class="line">                   <span class="comment">// 初始化 FastLeaderElection</span></span><br><span class="line">                   le = <span class="keyword">new</span> FastLeaderElection(<span class="keyword">this</span>, qcm);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   LOG.error(<span class="string">&quot;Null listener when initializing cnx manager&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> le;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sleeps on accept().</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> numRetries = <span class="number">0</span>;</span><br><span class="line">    InetSocketAddress addr;</span><br><span class="line">    <span class="keyword">while</span>((!shutdown) &amp;&amp; (numRetries &lt; <span class="number">3</span>))&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ss = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">            ss.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (listenOnAllIPs) &#123;</span><br><span class="line">                <span class="keyword">int</span> port = view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid)</span><br><span class="line">                    .electionAddr.getPort();</span><br><span class="line">                addr = <span class="keyword">new</span> InetSocketAddress(port);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addr = view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid)</span><br><span class="line">                    .electionAddr;</span><br><span class="line">            &#125;</span><br><span class="line">            LOG.info(<span class="string">&quot;My election bind port: &quot;</span> + addr.toString());</span><br><span class="line">            setName(view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid)</span><br><span class="line">                    .electionAddr.toString());</span><br><span class="line">            ss.bind(addr);</span><br><span class="line">            <span class="keyword">while</span> (!shutdown) &#123;</span><br><span class="line">                Socket client = ss.accept();</span><br><span class="line">                setSockOpts(client);</span><br><span class="line">                LOG.info(<span class="string">&quot;Received connection request &quot;</span></span><br><span class="line">                        + client.getRemoteSocketAddress());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Receive and handle the connection request</span></span><br><span class="line">                <span class="comment">// asynchronously if the quorum sasl authentication is</span></span><br><span class="line">                <span class="comment">// enabled. This is required because sasl server</span></span><br><span class="line">                <span class="comment">// authentication process may take few seconds to finish,</span></span><br><span class="line">                <span class="comment">// this may delay next peer connection requests.</span></span><br><span class="line">                <span class="keyword">if</span> (quorumSaslAuthEnabled) &#123;</span><br><span class="line">                    receiveConnectionAsync(client);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    receiveConnection(client);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                numRetries = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Exception while listening&quot;</span>, e);</span><br><span class="line">            numRetries++;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ss.close();</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Error closing server socket&quot;</span>, ie);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Interrupted while sleeping. &quot;</span> +</span><br><span class="line">                          <span class="string">&quot;Ignoring exception&quot;</span>, ie);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;Leaving listener&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!shutdown) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;As I&#x27;m leaving the listener thread, &quot;</span></span><br><span class="line">                + <span class="string">&quot;I won&#x27;t be able to participate in leader &quot;</span></span><br><span class="line">                + <span class="string">&quot;election any longer: &quot;</span></span><br><span class="line">                + view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid).electionAddr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="FastLeaderElection-lookForLeader-1"><a href="#FastLeaderElection-lookForLeader-1" class="headerlink" title="FastLeaderElection.lookForLeader"></a>FastLeaderElection.lookForLeader</h3><p>这个方法前面分析过, 里面会调用 sendNotifications  来发送投票请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Vote <span class="title">lookForLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           self.jmxLeaderElectionBean = <span class="keyword">new</span> LeaderElectionBean();</span><br><span class="line">           MBeanRegistry.getInstance().register(self.jmxLeaderElectionBean, self.jmxLocalPeerBean);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">           self.jmxLeaderElectionBean = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (self.start_fle == <span class="number">0</span>) &#123;</span><br><span class="line">           self.start_fle = Time.currentElapsedTime();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           HashMap&lt;Long, Vote&gt; recvset = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">           HashMap&lt;Long, Vote&gt; outofelection = <span class="keyword">new</span> HashMap&lt;Long, Vote&gt;();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">int</span> notTimeout = finalizeWait;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">               <span class="comment">// 更新逻辑时钟, 用来判断是否在同一轮选举周期</span></span><br><span class="line">               logicalclock.incrementAndGet();</span><br><span class="line">               <span class="comment">// 初始化选票数据, 这里其实就是把当前节点的myid,zxid,epoch 更新到本地的成员属性</span></span><br><span class="line">               updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           LOG.info(<span class="string">&quot;New election. My id =  &quot;</span> + self.getId() + <span class="string">&quot;, proposed zxid=0x&quot;</span> + Long.toHexString(proposedZxid));</span><br><span class="line">           <span class="comment">// 异步发送选举消息</span></span><br><span class="line">           sendNotifications();</span><br><span class="line"></span><br><span class="line">           ...</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="FastLeaderElection-sendqueue"><a href="#FastLeaderElection-sendqueue" class="headerlink" title="FastLeaderElection.sendqueue"></a>FastLeaderElection.sendqueue</h3><p>sendqueue 这个队列的数据, 是通过 WorkerSender  来进行获取并发送的, 而这个 WorkerSender  线程, 在构建  fastLeaderElection 的时候会启动.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerSender</span> <span class="keyword">extends</span> <span class="title">ZooKeeperThread</span> </span>&#123;</span><br><span class="line">           <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</span><br><span class="line">           QuorumCnxManager manager;</span><br><span class="line"></span><br><span class="line">           WorkerSender(QuorumCnxManager manager) &#123;</span><br><span class="line">               <span class="keyword">super</span>(<span class="string">&quot;WorkerSender&quot;</span>);</span><br><span class="line">               <span class="keyword">this</span>.stop = <span class="keyword">false</span>;</span><br><span class="line">               <span class="keyword">this</span>.manager = manager;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               <span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       <span class="comment">// 从队列中获取ToSend 对象. </span></span><br><span class="line">                       ToSend m = sendqueue.poll(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">                       <span class="keyword">if</span> (m == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                       process(m);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               LOG.info(<span class="string">&quot;WorkerSender is down&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * Called by run() once there is a new message to send.</span></span><br><span class="line"><span class="comment">            *</span></span><br><span class="line"><span class="comment">            * <span class="doctag">@param</span> m message to send</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ToSend m)</span> </span>&#123;</span><br><span class="line">               ByteBuffer requestBuffer = buildMsg(m.state.ordinal(), m.leader, m.zxid, m.electionEpoch, m.peerEpoch);</span><br><span class="line">               <span class="comment">// 这里就是调用 QuorumCnxManager 进行消息发送. </span></span><br><span class="line">                manager.toSend(m.sid, requestBuffer);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="QuorumCnxManager-toSend"><a href="#QuorumCnxManager-toSend" class="headerlink" title="QuorumCnxManager.toSend"></a>QuorumCnxManager.toSend</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toSend</span><span class="params">(Long sid, ByteBuffer b)</span> </span>&#123;</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * If sending message to myself, then simply enqueue it (loopback).</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">//  如果接收者是自己, 直接放置到接受队列</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.mySid == sid) &#123;</span><br><span class="line">           b.position(<span class="number">0</span>);</span><br><span class="line">           addToRecvQueue(<span class="keyword">new</span> Message(b.duplicate(), sid));</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Otherwise send to the corresponding thread to send.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Start a new connection if doesn&#x27;t have one already.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">// 否则发送到对应的发送队列上</span></span><br><span class="line">           ArrayBlockingQueue&lt;ByteBuffer&gt; bq = <span class="keyword">new</span> ArrayBlockingQueue&lt;ByteBuffer&gt;(SEND_CAPACITY);</span><br><span class="line">           <span class="comment">// 判断当前的sid 是否已经存在与发送队列, 如果是, 则直接把已经存在的数据发送出去.</span></span><br><span class="line">           ArrayBlockingQueue&lt;ByteBuffer&gt; bqExisting = queueSendMap.putIfAbsent(sid, bq);</span><br><span class="line">           <span class="keyword">if</span> (bqExisting != <span class="keyword">null</span>) &#123;</span><br><span class="line">               addToSendQueue(bqExisting, b);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               addToSendQueue(bq, b);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 连接申请 调用链 connectOne-&gt;initiateConnection-&gt; startConnection</span></span><br><span class="line">           <span class="comment">// startConnection 就是发送方启动入口</span></span><br><span class="line">           connectOne(sid);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="startConnection"><a href="#startConnection" class="headerlink" title="startConnection"></a>startConnection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startConnection</span><span class="params">(Socket sock, Long sid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      DataOutputStream dout = <span class="keyword">null</span>;</span><br><span class="line">      DataInputStream din = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// Sending id and challenge</span></span><br><span class="line">          dout = <span class="keyword">new</span> DataOutputStream(sock.getOutputStream());</span><br><span class="line">          dout.writeLong(<span class="keyword">this</span>.mySid);</span><br><span class="line">          dout.flush();</span><br><span class="line"></span><br><span class="line">          din = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(sock.getInputStream()));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          LOG.warn(<span class="string">&quot;Ignoring exception reading or writing challenge: &quot;</span>, e);</span><br><span class="line">          closeSocket(sock);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// authenticate learner</span></span><br><span class="line">      authLearner.authenticate(sock, view.get(sid).hostname);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If lost the challenge, then drop the new connection</span></span><br><span class="line">      <span class="keyword">if</span> (sid &gt; <span class="keyword">this</span>.mySid) &#123;</span><br><span class="line">          <span class="comment">// 为了防止重复建立连接, 只需要sid 大的主动连接sid 小的.</span></span><br><span class="line">          LOG.info(<span class="string">&quot;Have smaller server identifier, so dropping the &quot;</span> + <span class="string">&quot;connection: (&quot;</span> + sid + <span class="string">&quot;, &quot;</span> + <span class="keyword">this</span>.mySid + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">          closeSocket(sock);</span><br><span class="line">          <span class="comment">// Otherwise proceed with the connection</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 构建一个发送线程和接受线程, 负责针对当前连接的数据传输, </span></span><br><span class="line">          SendWorker sw = <span class="keyword">new</span> SendWorker(sock, sid);</span><br><span class="line">          RecvWorker rw = <span class="keyword">new</span> RecvWorker(sock, din, sid, sw);</span><br><span class="line">          sw.setRecv(rw);</span><br><span class="line"></span><br><span class="line">          SendWorker vsw = senderWorkerMap.get(sid);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (vsw != <span class="keyword">null</span>) vsw.finish();</span><br><span class="line"></span><br><span class="line">          senderWorkerMap.put(sid, sw);</span><br><span class="line">          queueSendMap.putIfAbsent(sid, <span class="keyword">new</span> ArrayBlockingQueue&lt;ByteBuffer&gt;(SEND_CAPACITY));</span><br><span class="line"></span><br><span class="line">          sw.start();</span><br><span class="line">          rw.start();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="SendWorker"><a href="#SendWorker" class="headerlink" title="SendWorker"></a>SendWorker</h4><p> SendWorker 会监听对应sid 的阻塞队列, 启动的时候, 如果队列为空时会重新发送一次消息最前最后的消息, 以防止上一次处理是服务器异常退出, 造成上一条消息未处理成功; 然后就是不停监听队列, 发现有消息时调用send 方法.</p>
<h4 id="RecvWorker"><a href="#RecvWorker" class="headerlink" title="RecvWorker"></a>RecvWorker</h4><p> RecvWorker  不停监听socket 的inputstream ,读取消息放到消息接收队列中, 消息放入队列中, qcm的流程就完毕了. </p>
<h3 id="QuorumCnxManager-Listener"><a href="#QuorumCnxManager-Listener" class="headerlink" title="QuorumCnxManager.Listener"></a>QuorumCnxManager.Listener</h3><p>listener 监听到客户端请求后, 开始处理消息. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">int</span> numRetries = <span class="number">0</span>;</span><br><span class="line">         InetSocketAddress addr;</span><br><span class="line">         <span class="keyword">while</span> ((!shutdown) &amp;&amp; (numRetries &lt; <span class="number">3</span>)) &#123;</span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 ss = <span class="keyword">new</span> ServerSocket();</span><br><span class="line">                 ss.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">                 <span class="keyword">if</span> (listenOnAllIPs) &#123;</span><br><span class="line">                     <span class="keyword">int</span> port = view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid).electionAddr.getPort();</span><br><span class="line">                     addr = <span class="keyword">new</span> InetSocketAddress(port);</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     addr = view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid).electionAddr;</span><br><span class="line">                 &#125;</span><br><span class="line">                 LOG.info(<span class="string">&quot;My election bind port: &quot;</span> + addr.toString());</span><br><span class="line">                 setName(view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid).electionAddr.toString());</span><br><span class="line">                 ss.bind(addr);</span><br><span class="line">                 <span class="keyword">while</span> (!shutdown) &#123;</span><br><span class="line">                     Socket client = ss.accept();</span><br><span class="line">                     setSockOpts(client);</span><br><span class="line">                     LOG.info(<span class="string">&quot;Received connection request &quot;</span> + client.getRemoteSocketAddress());</span><br><span class="line"></span><br><span class="line">                     <span class="comment">// Receive and handle the connection request</span></span><br><span class="line">                     <span class="comment">// asynchronously if the quorum sasl authentication is</span></span><br><span class="line">                     <span class="comment">// enabled. This is required because sasl server</span></span><br><span class="line">                     <span class="comment">// authentication process may take few seconds to finish,</span></span><br><span class="line">                     <span class="comment">// this may delay next peer connection requests.</span></span><br><span class="line">                     <span class="keyword">if</span> (quorumSaslAuthEnabled) &#123;</span><br><span class="line">                         receiveConnectionAsync(client);</span><br><span class="line">                     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         <span class="comment">// 接受客户端请求</span></span><br><span class="line">                         receiveConnection(client);</span><br><span class="line">                     &#125;</span><br><span class="line"></span><br><span class="line">                     numRetries = <span class="number">0</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                 LOG.error(<span class="string">&quot;Exception while listening&quot;</span>, e);</span><br><span class="line">                 numRetries++;</span><br><span class="line">                 <span class="keyword">try</span> &#123;</span><br><span class="line">                     ss.close();</span><br><span class="line">                     Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">                     LOG.error(<span class="string">&quot;Error closing server socket&quot;</span>, ie);</span><br><span class="line">                 &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                     LOG.error(<span class="string">&quot;Interrupted while sleeping. &quot;</span> + <span class="string">&quot;Ignoring exception&quot;</span>, ie);</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         LOG.info(<span class="string">&quot;Leaving listener&quot;</span>);</span><br><span class="line">         <span class="keyword">if</span> (!shutdown) &#123;</span><br><span class="line">             LOG.error(<span class="string">&quot;As I&#x27;m leaving the listener thread, &quot;</span> + <span class="string">&quot;I won&#x27;t be able to participate in leader &quot;</span> + <span class="string">&quot;election any longer: &quot;</span> + view.get(QuorumCnxManager.<span class="keyword">this</span>.mySid).electionAddr);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h3 id="QuorumCnxManager-receiveConnection"><a href="#QuorumCnxManager-receiveConnection" class="headerlink" title="QuorumCnxManager.receiveConnection"></a>QuorumCnxManager.receiveConnection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConnection</span><span class="params">(<span class="keyword">final</span> Socket sock)</span> </span>&#123;</span><br><span class="line">       DataInputStream din = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 获取客户端的数据包</span></span><br><span class="line">           din = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(sock.getInputStream()));</span><br><span class="line"></span><br><span class="line">           handleConnection(sock, din);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           LOG.error(<span class="string">&quot;Exception handling connection, addr: &#123;&#125;, closing server connection&quot;</span>, sock.getRemoteSocketAddress());</span><br><span class="line">           closeSocket(sock);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="QuorumCnxManager-handleConnection"><a href="#QuorumCnxManager-handleConnection" class="headerlink" title="QuorumCnxManager.handleConnection"></a>QuorumCnxManager.handleConnection</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleConnection</span><span class="params">(Socket sock, DataInputStream din)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     Long sid = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// Read server id</span></span><br><span class="line">         sid = din.readLong();</span><br><span class="line">         <span class="keyword">if</span> (sid &lt; <span class="number">0</span>) &#123; <span class="comment">// this is not a server id but a protocol version (see ZOOKEEPER-1633)</span></span><br><span class="line">             <span class="comment">// 获取客户端的sid,也就是myid</span></span><br><span class="line">             sid = din.readLong();</span><br><span class="line"></span><br><span class="line">             <span class="comment">// next comes the #bytes in the remainder of the message</span></span><br><span class="line">             <span class="comment">// note that 0 bytes is fine (old servers)</span></span><br><span class="line">             <span class="keyword">int</span> num_remaining_bytes = din.readInt();</span><br><span class="line">             <span class="keyword">if</span> (num_remaining_bytes &lt; <span class="number">0</span> || num_remaining_bytes &gt; maxBuffer) &#123;</span><br><span class="line">                 LOG.error(<span class="string">&quot;Unreasonable buffer length: &#123;&#125;&quot;</span>, num_remaining_bytes);</span><br><span class="line">                 closeSocket(sock);</span><br><span class="line">                 <span class="keyword">return</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[num_remaining_bytes];</span><br><span class="line"></span><br><span class="line">             <span class="comment">// remove the remainder of the message from din</span></span><br><span class="line">             <span class="keyword">int</span> num_read = din.read(b);</span><br><span class="line">             <span class="keyword">if</span> (num_read != num_remaining_bytes) &#123;</span><br><span class="line">                 LOG.error(<span class="string">&quot;Read only &quot;</span> + num_read + <span class="string">&quot; bytes out of &quot;</span> + num_remaining_bytes + <span class="string">&quot; sent by server &quot;</span> + sid);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (sid == QuorumPeer.OBSERVER_ID) &#123;</span><br><span class="line">             <span class="comment">/*</span></span><br><span class="line"><span class="comment">              * Choose identifier at random. We need a value to identify</span></span><br><span class="line"><span class="comment">              * the connection.</span></span><br><span class="line"><span class="comment">              */</span></span><br><span class="line">             sid = observerCounter.getAndDecrement();</span><br><span class="line">             LOG.info(<span class="string">&quot;Setting arbitrary identifier to observer: &quot;</span> + sid);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         closeSocket(sock);</span><br><span class="line">         LOG.warn(<span class="string">&quot;Exception reading or writing challenge: &quot;</span> + e.toString());</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// do authenticating learner</span></span><br><span class="line">     LOG.debug(<span class="string">&quot;Authenticating learner server.id: &#123;&#125;&quot;</span>, sid);</span><br><span class="line">     authServer.authenticate(sock, din);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//If wins the challenge, then close the new connection.</span></span><br><span class="line">     <span class="comment">//</span></span><br><span class="line">     <span class="comment">// 为了防止重复建立连接, 只允许sid 大的主动连接sid 小的</span></span><br><span class="line">     <span class="keyword">if</span> (sid &lt; <span class="keyword">this</span>.mySid) &#123;</span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">          * This replica might still believe that the connection to sid is</span></span><br><span class="line"><span class="comment">          * up, so we have to shut down the workers before trying to open a</span></span><br><span class="line"><span class="comment">          * new connection.</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         SendWorker sw = senderWorkerMap.get(sid);</span><br><span class="line">         <span class="keyword">if</span> (sw != <span class="keyword">null</span>) &#123;</span><br><span class="line">             sw.finish();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">          * Now we start a new connection</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         LOG.debug(<span class="string">&quot;Create new connection to server: &quot;</span> + sid);</span><br><span class="line">         <span class="comment">// 关闭连接</span></span><br><span class="line">         closeSocket(sock);</span><br><span class="line">         <span class="comment">// 向sid 发起连接</span></span><br><span class="line">         connectOne(sid);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Otherwise start worker threads to receive data.</span></span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// 同样, 构建一个SendWorker 和RecvWorker 进行发送数据和接受数据</span></span><br><span class="line">         SendWorker sw = <span class="keyword">new</span> SendWorker(sock, sid);</span><br><span class="line">         RecvWorker rw = <span class="keyword">new</span> RecvWorker(sock, din, sid, sw);</span><br><span class="line">         sw.setRecv(rw);</span><br><span class="line"></span><br><span class="line">         SendWorker vsw = senderWorkerMap.get(sid);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (vsw != <span class="keyword">null</span>) vsw.finish();</span><br><span class="line"></span><br><span class="line">         senderWorkerMap.put(sid, sw);</span><br><span class="line">         queueSendMap.putIfAbsent(sid, <span class="keyword">new</span> ArrayBlockingQueue&lt;ByteBuffer&gt;(SEND_CAPACITY));</span><br><span class="line"></span><br><span class="line">         sw.start();</span><br><span class="line">         rw.start();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Leader-选举完成之后的处理逻辑"><a href="#Leader-选举完成之后的处理逻辑" class="headerlink" title="Leader 选举完成之后的处理逻辑"></a>Leader 选举完成之后的处理逻辑</h2><p>通过 lookForLeader  方法选举完成后, 会设置当前节点的 PeerState， , 要么为Leading, 要么就是 FOLLOWER，或者Observer, 到这里, 只是表示当前的leader 选举出来了, 但是 QuorumPeer.run  方法还没有执行完, 我们再回过头来看看后续的处理过程. </p>
<h3 id="QuorumPeer-run-1"><a href="#QuorumPeer-run-1" class="headerlink" title="QuorumPeer.run"></a>QuorumPeer.run</h3><p>分别来看看 case 为Follower 和Leading  会做什么事情呢? </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       setName(<span class="string">&quot;QuorumPeer&quot;</span> + <span class="string">&quot;[myid=&quot;</span> + getId() + <span class="string">&quot;]&quot;</span> +</span><br><span class="line">               cnxnFactory.getLocalAddress());</span><br><span class="line"></span><br><span class="line">       LOG.debug(<span class="string">&quot;Starting quorum peer&quot;</span>);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           jmxQuorumBean = <span class="keyword">new</span> QuorumBean(<span class="keyword">this</span>);</span><br><span class="line">           MBeanRegistry.getInstance().register(jmxQuorumBean, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">for</span> (QuorumServer s : getView().values()) &#123;</span><br><span class="line">               ZKMBeanInfo p;</span><br><span class="line">               <span class="keyword">if</span> (getId() == s.id) &#123;</span><br><span class="line">                   p = jmxLocalPeerBean = <span class="keyword">new</span> LocalPeerBean(<span class="keyword">this</span>);</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">                       jmxLocalPeerBean = <span class="keyword">null</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   p = <span class="keyword">new</span> RemotePeerBean(s);</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       MBeanRegistry.getInstance().register(p, jmxQuorumBean);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Failed to register with JMX&quot;</span>, e);</span><br><span class="line">           jmxQuorumBean = <span class="keyword">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Main loop</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">// 根据选举状态, 选择不同的处理方式</span></span><br><span class="line">           <span class="keyword">while</span> (running) &#123;</span><br><span class="line">               <span class="keyword">switch</span> (getPeerState()) &#123;</span><br><span class="line">                   <span class="keyword">case</span> LOOKING:</span><br><span class="line">                       LOG.info(<span class="string">&quot;LOOKING&quot;</span>);</span><br><span class="line"></span><br><span class="line">                       <span class="comment">// 判断是否为只读模式, 通过readonlymode.enabled 开启</span></span><br><span class="line">                       <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;readonlymode.enabled&quot;</span>)) &#123;</span><br><span class="line">                           LOG.info(<span class="string">&quot;Attempting to start ReadOnlyZooKeeperServer&quot;</span>);</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// 只读模式的启动流程</span></span><br><span class="line">                           <span class="comment">// Create read-only server but don&#x27;t start it immediately</span></span><br><span class="line">                           <span class="keyword">final</span> ReadOnlyZooKeeperServer roZk = <span class="keyword">new</span> ReadOnlyZooKeeperServer(</span><br><span class="line">                                   logFactory, <span class="keyword">this</span>,</span><br><span class="line">                                   <span class="keyword">new</span> ZooKeeperServer.BasicDataTreeBuilder(),</span><br><span class="line">                                   <span class="keyword">this</span>.zkDb);</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// Instead of starting roZk immediately, wait some grace</span></span><br><span class="line">                           <span class="comment">// period before we decide we&#x27;re partitioned.</span></span><br><span class="line">                           <span class="comment">//</span></span><br><span class="line">                           <span class="comment">// Thread is used here because otherwise it would require</span></span><br><span class="line">                           <span class="comment">// changes in each of election strategy classes which is</span></span><br><span class="line">                           <span class="comment">// unnecessary code coupling.</span></span><br><span class="line">                           Thread roZkMgr = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">                               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                   <span class="keyword">try</span> &#123;</span><br><span class="line">                                       <span class="comment">// lower-bound grace period to 2 secs</span></span><br><span class="line">                                       sleep(Math.max(<span class="number">2000</span>, tickTime));</span><br><span class="line">                                       <span class="keyword">if</span> (ServerState.LOOKING.equals(getPeerState())) &#123;</span><br><span class="line">                                           roZk.startup();</span><br><span class="line">                                       &#125;</span><br><span class="line">                                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                                       LOG.info(<span class="string">&quot;Interrupted while attempting to start ReadOnlyZooKeeperServer, not started&quot;</span>);</span><br><span class="line">                                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                       LOG.error(<span class="string">&quot;FAILED to start ReadOnlyZooKeeperServer&quot;</span>, e);</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;;</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               roZkMgr.start();</span><br><span class="line">                               setBCVote(<span class="keyword">null</span>);</span><br><span class="line">                               <span class="comment">// 设置当前的投票, 通过策略模式来决定当前用哪个选举算法来进行领导选举</span></span><br><span class="line">                               setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                               LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                               setPeerState(ServerState.LOOKING);</span><br><span class="line">                           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                               <span class="comment">// If the thread is in the the grace period, interrupt</span></span><br><span class="line">                               <span class="comment">// to come out of waiting.</span></span><br><span class="line">                               roZkMgr.interrupt();</span><br><span class="line">                               roZk.shutdown();</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="keyword">try</span> &#123;</span><br><span class="line">                               setBCVote(<span class="keyword">null</span>);</span><br><span class="line">                               setCurrentVote(makeLEStrategy().lookForLeader());</span><br><span class="line">                           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                               LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                               setPeerState(ServerState.LOOKING);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                       ...</span><br><span class="line">                           </span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>

<h3 id="makeFollower"><a href="#makeFollower" class="headerlink" title="makeFollower"></a>makeFollower</h3><p>初始化一个 Follower  对象, 构建一个 FollowerZookeeperServer ,表示follower 节点的请求处理服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Follower <span class="title">makeFollower</span><span class="params">(FileTxnSnapLog logFactory)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Follower(<span class="keyword">this</span>, <span class="keyword">new</span> FollowerZooKeeperServer(logFactory,</span><br><span class="line">            <span class="keyword">this</span>, <span class="keyword">new</span> ZooKeeperServer.BasicDataTreeBuilder(), <span class="keyword">this</span>.zkDb));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="follower-followLeader"><a href="#follower-followLeader" class="headerlink" title="follower.followLeader();"></a>follower.followLeader();</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">followLeader</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       self.end_fle = Time.currentElapsedTime();</span><br><span class="line">       <span class="keyword">long</span> electionTimeTaken = self.end_fle - self.start_fle;</span><br><span class="line">       self.setElectionTimeTaken(electionTimeTaken);</span><br><span class="line">       LOG.info(<span class="string">&quot;FOLLOWING - LEADER ELECTION TOOK - &#123;&#125;&quot;</span>, electionTimeTaken);</span><br><span class="line">       self.start_fle = <span class="number">0</span>;</span><br><span class="line">       self.end_fle = <span class="number">0</span>;</span><br><span class="line">       fzk.registerJMX(<span class="keyword">new</span> FollowerBean(<span class="keyword">this</span>, zk), self.jmxLocalPeerBean);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 根据sid 找到对应的leader, 拿到lead 连接信息</span></span><br><span class="line">           QuorumServer leaderServer = findLeader();</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="comment">// 连接到leader</span></span><br><span class="line">               connectToLeader(leaderServer.addr, leaderServer.hostname);</span><br><span class="line">               <span class="comment">// 将Follower 的zxid和myid 等信息封装好发送到leader, 同步epoch</span></span><br><span class="line">               <span class="comment">// 也就是意味着接下来 follower节点 只同步新的epoch 的数据信息</span></span><br><span class="line">               <span class="keyword">long</span> newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO);</span><br><span class="line"></span><br><span class="line">               <span class="comment">//check to see if the leader zxid is lower than ours</span></span><br><span class="line">               <span class="comment">//this should never happen but is just a safety check</span></span><br><span class="line">               <span class="comment">// 如果 leader 的epoch 比当前follower 节点的epoch 还小, 抛异常</span></span><br><span class="line">               <span class="keyword">long</span> newEpoch = ZxidUtils.getEpochFromZxid(newEpochZxid);</span><br><span class="line">               <span class="keyword">if</span> (newEpoch &lt; self.getAcceptedEpoch()) &#123;</span><br><span class="line">                   LOG.error(<span class="string">&quot;Proposed leader epoch &quot;</span> + ZxidUtils.zxidToString(newEpochZxid) + <span class="string">&quot; is less than our accepted epoch &quot;</span> + ZxidUtils.zxidToString(self.getAcceptedEpoch()));</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Error: Epoch of leader is lower&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 和leader 进行数据同步</span></span><br><span class="line">               syncWithLeader(newEpochZxid);</span><br><span class="line">               QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">               <span class="comment">// 接受 leader 消息, 执行并反馈给leader, 线程在此自旋</span></span><br><span class="line">               <span class="keyword">while</span> (<span class="keyword">this</span>.isRunning()) &#123;</span><br><span class="line">                   <span class="comment">// 从 leader 读取数据包</span></span><br><span class="line">                   readPacket(qp);</span><br><span class="line">                   <span class="comment">// 处理packet</span></span><br><span class="line">                   processPacket(qp);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               LOG.warn(<span class="string">&quot;Exception when following the leader&quot;</span>, e);</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   sock.close();</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">                   e1.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// clear pending revalidations</span></span><br><span class="line">               pendingRevalidations.clear();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           zk.unregisterJMX((Learner) <span class="keyword">this</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="makeLeader"><a href="#makeLeader" class="headerlink" title="makeLeader"></a>makeLeader</h3><p>初始化一个Leader 对象, 构建一个 LeaderZookeeperServer , 用于标识leader 节点的请求处理服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Leader <span class="title">makeLeader</span><span class="params">(FileTxnSnapLog logFactory)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Leader(<span class="keyword">this</span>, <span class="keyword">new</span> LeaderZooKeeperServer(logFactory,</span><br><span class="line">               <span class="keyword">this</span>, <span class="keyword">new</span> ZooKeeperServer.BasicDataTreeBuilder(), <span class="keyword">this</span>.zkDb));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="leader-lead"><a href="#leader-lead" class="headerlink" title="leader.lead();"></a>leader.lead();</h3><p>在Leader 端, 则通过lead() 来处理与follower 的交互.</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/Zookeeper%E4%BB%A5%E5%8F%8A%E9%9B%86%E7%BE%A4%E7%9A%84%E5%AE%89%E8%A3%85/" rel="prev" title="">
      <i class="fa fa-chevron-left"></i> 
    </a></div>
      <div class="post-nav-item">
    <a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%B0%83%E6%9C%8D%E5%8A%A1%E7%9A%84zookeeper%E5%BA%94%E7%94%A8%E5%AE%9E%E6%88%98/" rel="next" title="">
       <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Zookeeper%E5%8E%9F%E7%90%86%E4%B9%8BLeader%E9%80%89%E4%B8%BE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">Zookeeper原理之Leader选举源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper-%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">1.1.</span> <span class="nav-text">Zookeeper 的一致性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper-%E7%9A%84%E6%9D%A5%E6%BA%90"><span class="nav-number">1.1.1.</span> <span class="nav-text">Zookeeper 的来源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Paxos-%E5%9C%A8chubby-%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">1.1.2.</span> <span class="nav-text">Paxos 在chubby 中的应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zookeeper-%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E6%98%AF%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E5%91%A2"><span class="nav-number">1.1.3.</span> <span class="nav-text">zookeeper 的一致性是什么情况呢?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">1.1.4.</span> <span class="nav-text">什么是顺序一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Single-System-Image-%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-number">1.1.5.</span> <span class="nav-text">Single System Image 的理解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Leader%E9%80%89%E4%B8%BE%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.</span> <span class="nav-text">Leader选举的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8id-myid"><span class="nav-number">1.2.0.1.</span> <span class="nav-text">服务器id(myid)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%97%B6%E9%92%9F-epoch-logicalclock"><span class="nav-number">1.2.0.2.</span> <span class="nav-text">逻辑时钟(epoch - logicalclock)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%89%E4%B8%BE%E7%8A%B6%E6%80%81"><span class="nav-number">1.2.0.3.</span> <span class="nav-text">选举状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99leader-%E9%80%89%E4%B8%BE"><span class="nav-number">1.2.1.</span> <span class="nav-text">服务器启动的时候leader 选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84leader-%E9%80%89%E4%B8%BE"><span class="nav-number">1.2.2.</span> <span class="nav-text">运行过程中的leader 选举</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Leader-%E9%80%89%E4%B8%BE%E7%9A%84%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">Leader 选举的源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumPeerMain-%E7%9A%84main%E6%96%B9%E6%B3%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">QuorumPeerMain 的main方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#runFromConfig-config"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">runFromConfig(config)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#quorumPeer-start"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">quorumPeer.start()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#startLeaderElection"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">startLeaderElection()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QuorumPeer-createElectionAlgorithm"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">QuorumPeer.createElectionAlgorithm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FastLeaderElection"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">FastLeaderElection</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FastLeaderElection-starter"><span class="nav-number">1.3.1.6.</span> <span class="nav-text">FastLeaderElection.starter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Messenger"><span class="nav-number">1.3.1.7.</span> <span class="nav-text">Messenger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B6%E6%AE%B5%E6%80%A7%E6%8F%90%E4%BA%A4"><span class="nav-number">1.3.1.8.</span> <span class="nav-text">阶段性提交</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getView-%E7%9A%84%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="nav-number">1.3.1.9.</span> <span class="nav-text">getView() 的解析过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QuorumPeerMain-runFromConfig"><span class="nav-number">1.3.1.10.</span> <span class="nav-text">QuorumPeerMain.runFromConfig</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QuorumPeerConfig-parse"><span class="nav-number">1.3.1.11.</span> <span class="nav-text">QuorumPeerConfig.parse</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper-%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E7%9A%84%E9%80%BB%E8%BE%91"><span class="nav-number">1.4.</span> <span class="nav-text">Zookeeper 服务启动的逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumPeerMain-runFromConfig-1"><span class="nav-number">1.4.1.</span> <span class="nav-text">QuorumPeerMain.runFromConfig</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServerCnxnFactory-createFactory"><span class="nav-number">1.4.2.</span> <span class="nav-text">ServerCnxnFactory.createFactory()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#quorumPeer-start-1"><span class="nav-number">1.4.3.</span> <span class="nav-text">quorumPeer.start();</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NIOServerCnxnFactory-start"><span class="nav-number">1.4.4.</span> <span class="nav-text">NIOServerCnxnFactory.start()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NIOServerCnxnFactory-configure"><span class="nav-number">1.4.5.</span> <span class="nav-text">NIOServerCnxnFactory.configure</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E4%B8%BE%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-number">1.5.</span> <span class="nav-text">选举流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumPeer-run"><span class="nav-number">1.5.1.</span> <span class="nav-text">QuorumPeer.run()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FastLeaderElection-lookForLeader"><span class="nav-number">1.5.2.</span> <span class="nav-text">FastLeaderElection .lookForLeader()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E7%A5%A8%E7%9A%84%E5%88%A4%E6%96%AD%E9%80%BB%E8%BE%91-%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81"><span class="nav-number">1.5.3.</span> <span class="nav-text">选票的判断逻辑(核心代码)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%95%E7%A5%A8%E5%A4%84%E7%90%86%E7%9A%84%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.5.4.</span> <span class="nav-text">投票处理的流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#termPredicate"><span class="nav-number">1.5.5.</span> <span class="nav-text">termPredicate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumMaj-containsQuorum"><span class="nav-number">1.5.6.</span> <span class="nav-text">QuorumMaj.containsQuorum</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%95%E7%A5%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B"><span class="nav-number">1.6.</span> <span class="nav-text">投票的网络通信过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.6.1.</span> <span class="nav-text">通信流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%97%E6%95%B0%E6%8D%AE-Notification-%E5%92%8C%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE-ToSend"><span class="nav-number">1.6.2.</span> <span class="nav-text">接受数据  Notification  和发送数据  ToSend</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E4%BF%A1%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.6.3.</span> <span class="nav-text">通信过程源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AF%8F%E4%B8%AAzk-%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E5%90%8E%E5%88%9B%E5%BB%BAsocket-%E7%9B%91%E5%90%AC"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">每个zk 服务启动后创建socket 监听</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FastLeaderElection-lookForLeader-1"><span class="nav-number">1.6.4.</span> <span class="nav-text">FastLeaderElection.lookForLeader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FastLeaderElection-sendqueue"><span class="nav-number">1.6.5.</span> <span class="nav-text">FastLeaderElection.sendqueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumCnxManager-toSend"><span class="nav-number">1.6.6.</span> <span class="nav-text">QuorumCnxManager.toSend</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#startConnection"><span class="nav-number">1.6.7.</span> <span class="nav-text">startConnection</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SendWorker"><span class="nav-number">1.6.7.1.</span> <span class="nav-text">SendWorker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RecvWorker"><span class="nav-number">1.6.7.2.</span> <span class="nav-text">RecvWorker</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumCnxManager-Listener"><span class="nav-number">1.6.8.</span> <span class="nav-text">QuorumCnxManager.Listener</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumCnxManager-receiveConnection"><span class="nav-number">1.6.9.</span> <span class="nav-text">QuorumCnxManager.receiveConnection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumCnxManager-handleConnection"><span class="nav-number">1.6.10.</span> <span class="nav-text">QuorumCnxManager.handleConnection</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Leader-%E9%80%89%E4%B8%BE%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="nav-number">1.7.</span> <span class="nav-text">Leader 选举完成之后的处理逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QuorumPeer-run-1"><span class="nav-number">1.7.1.</span> <span class="nav-text">QuorumPeer.run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#makeFollower"><span class="nav-number">1.7.2.</span> <span class="nav-text">makeFollower</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#follower-followLeader"><span class="nav-number">1.7.3.</span> <span class="nav-text">follower.followLeader();</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#makeLeader"><span class="nav-number">1.7.4.</span> <span class="nav-text">makeLeader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#leader-lead"><span class="nav-number">1.7.5.</span> <span class="nav-text">leader.lead();</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">214</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
