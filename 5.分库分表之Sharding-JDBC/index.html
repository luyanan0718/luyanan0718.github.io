<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="分库分表之Sharding-JDBC1. 架构与核心概念1.1 发展历史它是从当当网的内部架构ddframe  里面的一个分库分表的模块脱胎出来的, 用来解决当当的分库分表问题, 把跟业务相关的敏感的代码剥离后, 就得到了Sharding-JDBC. 它是一个工作在客户端的分库分表的解决方案.  DubboX、Elastic-job  也是当当开源出来的产品.">
<meta property="og:type" content="article">
<meta property="og:title" content="5">
<meta property="og:url" content="http://luyanan.com/5.%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BSharding-JDBC/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="分库分表之Sharding-JDBC1. 架构与核心概念1.1 发展历史它是从当当网的内部架构ddframe  里面的一个分库分表的模块脱胎出来的, 用来解决当当的分库分表问题, 把跟业务相关的敏感的代码剥离后, 就得到了Sharding-JDBC. 它是一个工作在客户端的分库分表的解决方案.  DubboX、Elastic-job  也是当当开源出来的产品.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://files.luyanan.com//img/20200407085557.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407090055.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407090241.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407090830.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407094147.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407095255.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407095440.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407095800.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407103428.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407212653.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200407215328.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200408094815.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200408095205.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200408102528.png">
<meta property="article:published_time" content="2021-03-02T05:51:39.263Z">
<meta property="article:modified_time" content="2021-03-02T05:42:51.793Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://files.luyanan.com//img/20200407085557.png">

<link rel="canonical" href="http://luyanan.com/5.%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BSharding-JDBC/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>5 | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/5.%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BSharding-JDBC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          5
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-02 13:51:39 / 修改时间：13:42:51" itemprop="dateCreated datePublished" datetime="2021-03-02T13:51:39+08:00">2021-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="分库分表之Sharding-JDBC"><a href="#分库分表之Sharding-JDBC" class="headerlink" title="分库分表之Sharding-JDBC"></a>分库分表之<a target="_blank" rel="noopener" href="https://gitee.com/Sharding-Sphere/sharding-sphere">Sharding-JDBC</a></h1><h2 id="1-架构与核心概念"><a href="#1-架构与核心概念" class="headerlink" title="1. 架构与核心概念"></a>1. 架构与核心概念</h2><h3 id="1-1-发展历史"><a href="#1-1-发展历史" class="headerlink" title="1.1 发展历史"></a>1.1 发展历史</h3><p>它是从当当网的内部架构<code>ddframe</code>  里面的一个分库分表的模块脱胎出来的, 用来解决当当的分库分表问题, 把跟业务相关的敏感的代码剥离后, 就得到了<code>Sharding-JDBC</code>. 它是一个工作在客户端的分库分表的解决方案. </p>
<p><code>DubboX</code>、<code>Elastic-job</code>  也是当当开源出来的产品. </p>
<p><img src="http://files.luyanan.com//img/20200407085557.png" alt="image-20200407085555819"></p>
<p>2018年5月份,  因为增加了<code>Proxy</code> 版本的和<code>Sharding-Sidecar</code>(尚未发布), <code>Sharding-JDBC</code> 更名为<code>Sharding-Sphere</code>, 从一个客户端的组件变成了一个套件. </p>
<p>2018年11月,<code>Sharding-Sphere</code> 正式进入<code>Apache</code> 基金孵化器, 这也是对<code>Sharding-Sphere</code>的质量和影响力的认可. 不过现在还没有毕业(名字带<code>incubator</code>), 一般我们用的还是<code>io.shardingsphere</code>的包. </p>
<p><img src="http://files.luyanan.com//img/20200407090055.png" alt="image-20200407090054679"></p>
<p>现在<code>Sharding-Sphere</code> 已经不属于当当网了, 也不属于作者张亮个人了. </p>
<p><img src="http://files.luyanan.com//img/20200407090241.png" alt="image-20200407090240517"></p>
<p>因为更名后和捐献给<code>Apache</code> 之后的<code>groupId</code> 都不一样, 所以在引入依赖的时候千万要注意. 主体功能是相同的, 但是在某些类的用法上有些差异, 如果要升级的话, <code>import</code> 要全部修改, 有些类和方法也要修改.</p>
<h3 id="1-2-基本特性"><a href="#1-2-基本特性" class="headerlink" title="1.2 基本特性"></a>1.2 基本特性</h3><p><code>Sharding-JDBC</code>是怎么工作的呢? </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/overview/">https://shardingsphere.apache.org/document/current/cn/overview/</a></p>
<p>我们来看一下官网的定义:</p>
<blockquote>
<p>定位为轻量级 Java 框架，在 Java 的 JDBC 层提供的额外服务。 它使用客户端直连数据 库，以 jar 包形式提供服务，无需额外部署和依赖，可理解为增强版的 JDBC 驱动，完 全兼容 JDBC 和各种 ORM 框架。</p>
</blockquote>
<p>在<code>maven</code> 工程里面, 我们使用它的方式是引入依赖, 然后进行配置就可以了, 不用像<code>Mycat</code> 一样独立的运行一个服务, 客户端不需要修改任何一行代码, 原来是SSM 连接数据库, 现在还是SSM, 因为它是支持Mybatis的. </p>
<h3 id="1-3-架构"><a href="#1-3-架构" class="headerlink" title="1.3 架构"></a>1.3 架构</h3><p>我们在项目中引入<code>Sharding-JDBC</code>的依赖, 我们的业务代码在操作数据库的时候, 就会通过<code>Sharding-JDBC</code>的代码连接到数据库. </p>
<p>分库分表的一些核心动作, 比如SQL解析、路由、执行、结果处理, 都是由它完成的, 它工作在客户端. </p>
<p><img src="http://files.luyanan.com//img/20200407090830.png" alt="image-20200407090827980"></p>
<p>在<code>Sharding-Sphere</code>  里面同样提供了代理<code>Proxy</code>的版本, 跟Mycat 的作用是一样的.<code>Sharding-Sphere</code> 是一个<code>Kubernetes</code> 的云原生数据库代理, 正在开发中. </p>
<table>
<thead>
<tr>
<th></th>
<th><code>Sharding-JDBC</code></th>
<th><code>Sharding-Proxy</code></th>
<th><code>Sharding-Sidecar</code></th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>任何</td>
<td>Mysql</td>
<td>Mysql</td>
</tr>
<tr>
<td>连接消耗数</td>
<td>高</td>
<td>低</td>
<td>低</td>
</tr>
<tr>
<td>异构语言</td>
<td>仅java</td>
<td>任意</td>
<td>任意</td>
</tr>
<tr>
<td>性能</td>
<td>损耗低</td>
<td>损耗略高</td>
<td>损耗低</td>
</tr>
<tr>
<td>无中心化</td>
<td>是</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>静态入口</td>
<td>无</td>
<td>有</td>
<td>有</td>
</tr>
</tbody></table>
<h3 id="1-4-功能"><a href="#1-4-功能" class="headerlink" title="1.4 功能"></a>1.4 功能</h3><p>分库分表后的几大问题: 跨库关联查询、分布式事务、排序翻页计算、全局主键. </p>
<h4 id="1-4-1-数据分片"><a href="#1-4-1-数据分片" class="headerlink" title="1.4.1 数据分片"></a>1.4.1 数据分片</h4><ol>
<li><p>分库&amp; 分表</p>
</li>
<li><p>读写分离</p>
<p> <a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/read-write-split/">https://shardingsphere.apache.org/document/current/cn/features/read-write-split/</a></p>
</li>
<li><p>分片策略定制化</p>
</li>
<li><p>无中心化分布式主键(包括UUID、雪花、LAF)</p>
<p> <a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/key-generator/">https://shardingsphere.apache.org/document/current/cn/features/sharding/other-features/key-generator/</a></p>
</li>
</ol>
<h4 id="1-4-2-分布式事务"><a href="#1-4-2-分布式事务" class="headerlink" title="1.4.2 分布式事务"></a>1.4.2 分布式事务</h4><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/transaction/">https://shardingsphere.apache.org/document/current/cn/features/transaction/</a></p>
<ol>
<li>标准化事务接口</li>
<li>XA 强一致性事务</li>
<li>弱性事务</li>
</ol>
<h3 id="1-5-核心概念"><a href="#1-5-核心概念" class="headerlink" title="1.5 核心概念"></a>1.5 核心概念</h3><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/">https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sql/</a></p>
<p>逻辑表、真实表、分片键、数据节点、动态表、广播表、绑定表</p>
<h4 id="1-5-1-主要概念"><a href="#1-5-1-主要概念" class="headerlink" title="1.5.1 主要概念"></a>1.5.1 主要概念</h4><p><img src="http://files.luyanan.com//img/20200407094147.png" alt="image-20200407094146438"></p>
<p>逻辑表会在SQL 解析和路由时被替换成真实的表名</p>
<p>分片键不一定是主键, 也不一定有业务含义. </p>
<h4 id="1-5-2-动态表"><a href="#1-5-2-动态表" class="headerlink" title="1.5.2 动态表"></a>1.5.2 动态表</h4><p><img src="http://files.luyanan.com//img/20200407095255.png" alt="image-20200407095254815"></p>
<h4 id="1-5-3-广播表"><a href="#1-5-3-广播表" class="headerlink" title="1.5.3 广播表"></a>1.5.3 广播表</h4><p>跟Mycat的全局表对应</p>
<p><img src="http://files.luyanan.com//img/20200407095440.png" alt="image-20200407095438928"></p>
<h4 id="1-5-4-绑定表"><a href="#1-5-4-绑定表" class="headerlink" title="1.5.4  绑定表"></a>1.5.4  绑定表</h4><p>跟Mycat 的ER表对应</p>
<p><img src="http://files.luyanan.com//img/20200407095800.png" alt="image-20200407095759112"></p>
<h3 id="1-6-使用规范"><a href="#1-6-使用规范" class="headerlink" title="1.6 使用规范"></a>1.6 使用规范</h3><p>不支持的SQL </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/sql/">https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/sql/</a></p>
<p>分页的说明</p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/pagination/">https://shardingsphere.apache.org/document/current/cn/features/sharding/use-norms/pagination/</a></p>
<h2 id="2-Sharding-JDBC实战"><a href="#2-Sharding-JDBC实战" class="headerlink" title="2. Sharding-JDBC实战"></a>2. <code>Sharding-JDBC</code>实战</h2><p>快速入门</p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/quick-start/sharding-jdbc-quick-start/">https://shardingsphere.apache.org/document/current/cn/quick-start/sharding-jdbc-quick-start/</a></p>
<h3 id="2-1-引入依赖"><a href="#2-1-引入依赖" class="headerlink" title="2.1 引入依赖"></a>2.1 引入依赖</h3><p>注意, 在SpringBoot 中使用<code>Sharding-JDBC</code> ,可以直接引入<code>sharding-jdbc</code>的依赖,注意组织名称(<code>groupId</code>)的区别</p>
<p><code>https://mvnrepository.com/artifact/io.shardingjdbc</code>:  更名之前</p>
<p><code>https://mvnrepository.com/artifact/io.shardingsphere</code>: 更名之后</p>
<p><code>https://mvnrepository.com/artifact/org.apache.shardingsphere</code>: 捐献给<code>Apache</code> 之后</p>
<p>包名和某些类有差异,如果替换需要注意, <code>import</code> 的包名都需要修改. </p>
<p>核心依赖是(<code>artifactId</code>): <code>sharding-jdbc-core</code> 和 <code>sharding-core</code></p>
<p>前两个<code>groupId</code>在SpringBoot 中还提供了<code>starter</code>, Apache的暂时没有</p>
<h3 id="2-2-原生JDBC使用"><a href="#2-2-原生JDBC使用" class="headerlink" title="2.2  原生JDBC使用"></a>2.2  原生JDBC使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.database.jdbc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.shardingsphere.api.config.rule.ShardingRuleConfiguration;</span><br><span class="line"><span class="keyword">import</span> io.shardingsphere.api.config.rule.TableRuleConfiguration;</span><br><span class="line"><span class="keyword">import</span> io.shardingsphere.api.config.strategy.InlineShardingStrategyConfiguration;</span><br><span class="line"><span class="keyword">import</span> io.shardingsphere.shardingjdbc.api.ShardingDataSourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.dbcp.BasicDataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> luyanan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/4/7</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;jdbc&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardJDBCTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置普通的数据源</span></span><br><span class="line">        Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// 配置第一个数据源</span></span><br><span class="line">        BasicDataSource dataSource1 = createDataSource(<span class="string">&quot;jdbc:mysql://localhost:3306/shard0&quot;</span>);</span><br><span class="line">        <span class="comment">//  配置第二个数据源</span></span><br><span class="line">        BasicDataSource dataSource2 = createDataSource(<span class="string">&quot;jdbc:mysql://localhost:3306/shard1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        dataSourceMap.put(<span class="string">&quot;ds0&quot;</span>, dataSource1);</span><br><span class="line">        dataSourceMap.put(<span class="string">&quot;ds1&quot;</span>, dataSource2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置Order 表规则</span></span><br><span class="line">        TableRuleConfiguration orderTableRuleConfig = <span class="keyword">new</span> TableRuleConfiguration();</span><br><span class="line">        orderTableRuleConfig.setLogicTable(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">        orderTableRuleConfig.setActualDataNodes(<span class="string">&quot;ds$&#123;0..1&#125;.order$&#123;0..1&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置分库+分表策略</span></span><br><span class="line">        orderTableRuleConfig.setDatabaseShardingStrategyConfig(</span><br><span class="line">                <span class="keyword">new</span> InlineShardingStrategyConfiguration(<span class="string">&quot;order_id&quot;</span>, <span class="string">&quot;ds$&#123;order_id % 2&#125;&quot;</span>));</span><br><span class="line">        orderTableRuleConfig.setTableShardingStrategyConfig(</span><br><span class="line">                <span class="keyword">new</span> InlineShardingStrategyConfiguration(<span class="string">&quot;order_id&quot;</span>, <span class="string">&quot;order$&#123;order_id % 2&#125;&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置分片规则</span></span><br><span class="line">        ShardingRuleConfiguration shardingRuleConfiguration = <span class="keyword">new</span> ShardingRuleConfiguration();</span><br><span class="line">        shardingRuleConfiguration.getTableRuleConfigs().add(orderTableRuleConfig);</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// 获取数据源</span></span><br><span class="line">        DataSource dataSource = ShardingDataSourceFactory.createDataSource(dataSourceMap, shardingRuleConfiguration, map, <span class="keyword">new</span> Properties());</span><br><span class="line"></span><br><span class="line">        String sql = <span class="string">&quot;select * from order where user_id = ?&quot;</span>;</span><br><span class="line">        Connection connection = dataSource.getConnection();</span><br><span class="line">        PreparedStatement preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">        preparedStatement.setInt(<span class="number">1</span>, <span class="number">2673</span>);</span><br><span class="line">        <span class="keyword">try</span> (ResultSet rs = preparedStatement.executeQuery()) &#123;</span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                <span class="comment">// %2结果，路由到 shard1.order1</span></span><br><span class="line">                System.out.println(<span class="string">&quot;order_id---------&quot;</span> + rs.getInt(<span class="number">1</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;user_id---------&quot;</span> + rs.getInt(<span class="number">2</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;create_time---------&quot;</span> + rs.getTime(<span class="number">3</span>));</span><br><span class="line">                System.out.println(<span class="string">&quot;total_price---------&quot;</span> + rs.getInt(<span class="number">4</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BasicDataSource <span class="title">createDataSource</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        BasicDataSource dataSource = <span class="keyword">new</span> BasicDataSource();</span><br><span class="line">        dataSource.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        dataSource.setPassword(<span class="string">&quot;rootroot&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>总结: <code>ShardingRuleConfiguration</code> 可以包含多个<code>TableRuleConfiguration</code>(多张表), 也可以设置默认的分库和分表策略</p>
<p>每个<code>TableRuleConfiguration</code>  可以针对表设置 <code>ShardingStrategyConfiguration</code>, 包括分库分表策略</p>
<p><code>ShardingStrategyConfiguration</code> 有5种实现(标准、行内、复合、Hint、无)</p>
<p><code>ShardingDataSourceFactory</code> 利用了 <code>ShardingStrategyConfiguration</code>  创建数据源</p>
<p>有了数据源, 就可以走JDBC的流程了.</p>
<p><img src="http://files.luyanan.com//img/20200407103428.png" alt="image-20200407103427714"></p>
<p>在JDBC中使用,我们可以直接创建数据源, 如果在Spring 中使用, 我们自定义的数据源怎么定义呢? 可以通过注解或者xml 配置文件注入. </p>
<h3 id="2-3-Spring-使用"><a href="#2-3-Spring-使用" class="headerlink" title="2.3 Spring 使用"></a>2.3 Spring 使用</h3><p>先来总结一下, 因为我们要使用<code>Sharding-JDBC</code> 去访问数据库,所以我们不再使用ORM框架或者容器去定义数据源, 而是注入到<code>Sharding-JDBC</code> 自定义的数据源, 这样才能保证动态的选择数据源。</p>
<p>第二个, 因为<code>Sharding-JDBC</code> 是工作在客户端, 所以我们要在客户端配置分库分表的策略,跟Mycat 不一样的是, <code>Sharding-JDBC</code> 没有内置各种分片策略和算法,需要我们通过表达式或者自定义的配置文件实现。我们创建的数据源中包含了分片的策略. </p>
<p>总体上, 需要配置的就是这两个,数据源和分片策略。当然分片策略又包含分库策略和分表的策略. </p>
<p>配置的方式是各种各样的. </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/configuration/config-java/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/configuration/config-java/</a></p>
<p>位置: 4 用户手册-?&gt; 4.1 <code>Sharding-JDBC</code> -&gt; 4.1.2 配置手册</p>
<h4 id="2-3-1-java配置"><a href="#2-3-1-java配置" class="headerlink" title="2.3.1 java配置"></a>2.3.1 java配置</h4><p>第一种是把数据源和分片策略都写在<code>Java Config</code> 中,它的特点是非常灵活的, 我们可以实现各种定义的分片策略。但是缺点是, 如果把数据源和策略都配置在<code>Java Config</code> 中, 就出现了硬编码, 在修改的时候就比较麻烦. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShardingJDBCDataSourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">shardingDataSource</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        ShardingRuleConfiguration src = <span class="keyword">new</span> ShardingRuleConfiguration();</span><br><span class="line">        <span class="comment">// 默认的分库策略</span></span><br><span class="line">        src.setDefaultDatabaseShardingStrategyConfig(<span class="keyword">new</span> StandardShardingStrategyConfiguration(<span class="string">&quot;user_id&quot;</span>, DBShardAlgo.class.getName()));</span><br><span class="line">        <span class="comment">// 默认的分表策略</span></span><br><span class="line">        src.setDefaultTableShardingStrategyConfig(<span class="keyword">new</span> StandardShardingStrategyConfiguration(<span class="string">&quot;user_id&quot;</span>, TblPreShardAlgo.class.getName(), TblRangeShardAlgo.class.getName()));</span><br><span class="line">        <span class="comment">// 为user_info表设置分库分表策略、算法</span></span><br><span class="line">        <span class="comment">// src.getTableRuleConfigs().add(getUserTableRuleConfiguration());</span></span><br><span class="line">        <span class="comment">// 数据源名和数据源的映射表</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShardingDataSource(src.build(createDataSourceMap()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置数据源</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, DataSource&gt; <span class="title">createDataSourceMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, DataSource&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;shard0&quot;</span>, createDataSource(<span class="string">&quot;jdbc:mysql://localhost:3306/shard0?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&quot;</span>));</span><br><span class="line">        result.put(<span class="string">&quot;shard1&quot;</span>, createDataSource(<span class="string">&quot;jdbc:mysql://localhost:3306/shard1?characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=UTC&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据数据源地址创建 DataSource</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DataSource <span class="title">createDataSource</span><span class="params">(<span class="keyword">final</span> String dataSourceName)</span> </span>&#123;</span><br><span class="line">        BasicDataSource result = <span class="keyword">new</span> BasicDataSource();</span><br><span class="line">        result.setDriverClassName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        result.setUrl(dataSourceName);</span><br><span class="line">        result.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        result.setPassword(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务管理器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceTransactionManager <span class="title">transactitonManager</span><span class="params">(DataSource shardingDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(shardingDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为user_info表设置分库分表策略、算法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TableRuleConfiguration <span class="title">getUserTableRuleConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TableRuleConfiguration userTableRuleConfig = <span class="keyword">new</span> TableRuleConfiguration();</span><br><span class="line">        userTableRuleConfig.setLogicTable(<span class="string">&quot;user_info&quot;</span>);</span><br><span class="line">        userTableRuleConfig.setActualDataNodes(<span class="string">&quot;ds0.user_info, ds1.user_info&quot;</span>);</span><br><span class="line">        userTableRuleConfig.setDatabaseShardingStrategyConfig(<span class="keyword">new</span> StandardShardingStrategyConfiguration(<span class="string">&quot;user_id&quot;</span>, DBShardAlgo.class.getName()));</span><br><span class="line">        userTableRuleConfig.setTableShardingStrategyConfig(<span class="keyword">new</span> StandardShardingStrategyConfiguration(<span class="string">&quot;user_id&quot;</span>, TblPreShardAlgo.class.getName(), TblRangeShardAlgo.class.getName()));</span><br><span class="line">        <span class="keyword">return</span> userTableRuleConfig;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-3-2-SpringBoot-配置"><a href="#2-3-2-SpringBoot-配置" class="headerlink" title="2.3.2 SpringBoot 配置"></a>2.3.2 SpringBoot 配置</h4><p>第二种是直接使用SpringBoot的<code>application.properties</code> 来配置, 这个要基于<code>start</code> 模块, <code>，org.apache.shardingsphere</code>的包还没有<code>starter</code>,只有<code>o.shardingsphere</code>的包有<code>starter</code></p>
<p>把数据源和分库分表的策略都配置在<code>application.properties</code>文件中, 这种方式配置简单, 但是不能实现复杂的分片策略, 不够灵活. </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 数据源配置</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.names</span>=<span class="string">shard0,shard1</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds0.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds0.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds0.url</span>=<span class="string">jdbc:mysql://localhost:3306/shard0</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds0.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds0.password</span>=<span class="string">rootroot</span></span><br><span class="line"></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds1.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds1.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds1.url</span>=<span class="string">jdbc:mysql://localhost:3306/shard1</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds1.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">sharding.jdbc.datasource.ds1.password</span>=<span class="string">rootroot</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sharding.jdbc.config.sharding.default-database-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#sharding.jdbc.config.sharding.default-database-strategy.inline.algorithm-expression=ds$&#123;user_id % 2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分库算法 user_info，多库分表</span></span><br><span class="line"><span class="comment"># 单库内没有分表，注释了分表策略</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.user_info</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.shardingColumn</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;user_id % 2&#125;</span></span><br><span class="line"><span class="comment">###sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.standard.shardingColumn=user_id</span></span><br><span class="line"><span class="comment">###sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.standard.preciseAlgorithmClassName=com.gupaoedu.config.DBShardAlgo</span></span><br><span class="line"><span class="comment">###sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.shardingColumn=user_id</span></span><br><span class="line"><span class="comment">###sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.preciseAlgorithmClassName=com.gupaoedu.config.TblPreShardAlgo</span></span><br><span class="line"><span class="comment">###sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.rangeAlgorithmClassName=com.gupaoedu.config.TblRangeShardAlgo</span></span><br><span class="line"><span class="comment">##sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">##sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.algorithm-expression=user_info</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分库算法 t_order 多库分表</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.shardingColumn</span>=<span class="string">order_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;order_id % 2&#125;</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_order</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分库算法 t_order_item 多库分表</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.shardingColumn</span>=<span class="string">order_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;order_id % 2&#125;</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order_item.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_order_item</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绑定表规则列表，防止关联查询出现笛卡尔积</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.binding-tables[0]</span>=<span class="string">t_order,t_order_item</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 广播表</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.broadcast-tables</span>=<span class="string">t_config</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="2-3-3-yml配置"><a href="#2-3-3-yml配置" class="headerlink" title="2.3.3 yml配置"></a>2.3.3 <code>yml</code>配置</h4><p>第三种是<code>Spring Boot</code>的<code>yml</code>配置, 也要依赖<code>starter</code>模块, 当然我们也可以结合不同的配置方法, 比如把分片策略放在<code>Java Config</code>中, 数据源配置在<code>yml</code> 中或者<code>properties</code> 中. </p>
<h3 id="2-4-Spring案例验证"><a href="#2-4-Spring案例验证" class="headerlink" title="2.4 Spring案例验证"></a>2.4 Spring案例验证</h3><p>这里验证的是切分到本地的两个库<code>shard0</code>和<code>shard1</code></p>
<p>两个库里面都是相同的四张表(<code>user_info</code>，<code>t_order</code>，<code>t_order_item</code>，<code>t_config</code>)</p>
<p>这些表必须提前创建, 中见表不会帮助我们生成的. </p>
<p>然后我们用Mybatis的generator 生成相应的实体类、Mapper接口和映射器</p>
<p>对数据库的基本的SSM的操作弄完了, 接下来就是分库分表的配置, 一个是数据源, 一个是分片策略. </p>
<p>我们先来看一下我们的数据源的配置<code>application.properties</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sharding.jdbc.datasource</span></span><br></pre></td></tr></table></figure>

<p>如果用Spring 管理数据源</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://192.168.8.168:8066/shard1</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">rootroot</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br></pre></td></tr></table></figure>

<p>但我们使用了<code>Sharding-JDBC</code>的数据源之后, 对于数据的操作就会交给<code>Sharding-JDBC</code>的代码处理. </p>
<p>分片策略从维度上分为两种: 一种是分库, 一种是分表.</p>
<p>我们可以定义默认的分库分表策略,例如用<code>user_id</code> 作为分片键, 这里用到了一种分片策略的实现 ,叫做行内表达式. 我们对<code>user_id</code>取模, 然后选择数据库. 如果 模等于0, 在第一个数据库中,模等于1, 在第二个数据库中.</p>
<p>数据源名称是行内表达式组装出来的</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sharding.jdbc.config.sharding.default-database-strategy.inline.sharding-column</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.default-database-strategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;user_id % 2&#125;</span></span><br></pre></td></tr></table></figure>

<p>对于不同的表, 也可以单独配置分库策略(<code>databaseStrategy</code>) 和分表策略(<code>tableStrategy</code>), </p>
<p>使用以下配置打印路由信息</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sharding.jdbc.config.sharding.props.sql.show</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h4 id="2-4-1-取模分片"><a href="#2-4-1-取模分片" class="headerlink" title="2.4.1 取模分片"></a>2.4.1 取模分片</h4><p>我们用<code>user_info</code> 表来验证取模分片,根据<code>user_id</code>, 把用户数据划分到两个数据节点上. </p>
<p>在本地创建两个数据库<code>shard0</code>和<code>shard1</code>, 都创建<code>user_info</code>表. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;user_info&#96; (</span><br><span class="line">&#96;user_id&#96; bigint(19) NOT NULL,</span><br><span class="line">&#96;user_name&#96; varchar(45) DEFAULT NULL,</span><br><span class="line">&#96;account&#96; varchar(45) NOT NULL,</span><br><span class="line">&#96;password&#96; varchar(45) DEFAULT NULL,</span><br><span class="line"> PRIMARY KEY (&#96;user_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>这里只定义了分库策略, 没有定义单库内的分表策略, 两个库都是相同的表. </p>
<p>路由的结果 ：<code>ds0.user_info</code>，<code>ds1.user_info</code></p>
<p>如果定义了分库策略, 两个库里面都有两张表, 那么路由的结果可能有4种: </p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ds0.user_info0，</span><br><span class="line">ds0.user_info1；</span><br><span class="line">ds1. user_info0,</span><br><span class="line">ds1. user_info1</span><br></pre></td></tr></table></figure>



<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.shardingColumn</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;user_id % 2&#125;</span></span><br><span class="line"><span class="comment">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.algorithm-expression=user_info</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.user_info</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;com.database.dao&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserShardingTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        userInfoService.insert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        UserInfo userInfo1 = userInfoService.getUserInfoByUserId(<span class="number">1L</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;------userInfo1:&quot;</span> + userInfo1);</span><br><span class="line"></span><br><span class="line">        UserInfo userInfo2 = userInfoService.getUserInfoByUserId(<span class="number">2L</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;------userInfo2:&quot;</span> + userInfo2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoMapper userInfoMapper;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long userId = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line"></span><br><span class="line">            UserInfo userInfo = <span class="keyword">new</span> UserInfo();</span><br><span class="line">            userInfo.setUserId(userId);</span><br><span class="line">            userInfo.setAccount(<span class="string">&quot;account&quot;</span> + i);</span><br><span class="line">            userInfo.setPassword(<span class="string">&quot;password&quot;</span> + i);</span><br><span class="line">            userInfo.setUserName(<span class="string">&quot;name&quot;</span> + i);</span><br><span class="line">            userId++;</span><br><span class="line">            userInfoMapper.insert(userInfo);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserInfo <span class="title">getUserInfoByUserId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoMapper.selectByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">selectByRange</span><span class="params">(Long firstId, Long lastId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoMapper.selectByRange(firstId, lastId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>演示结果: </p>
<p>我们看一下插入的结果, <code>user_id</code> 为偶数的数据, 都落到了第一个库,<code>user_id</code>为奇数的库,都落到了第二个库. </p>
<p>执行<code>select()</code> 测一下查询, 看看数据分布到两个节点的时候 ,我们用程序查询, 能不能取回正确的数据. </p>
<h4 id="2-4-2-绑定表"><a href="#2-4-2-绑定表" class="headerlink" title="2.4.2 绑定表"></a>2.4.2 绑定表</h4><p>第二种是绑定表, 也就是父表和子表有关联关系, 主表和子表使用相同的分片策略. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;t_order&#96; (</span><br><span class="line">&#96;order_id&#96; int(11) NOT NULL,</span><br><span class="line">&#96;user_id&#96; int(11) NOT NULL,</span><br><span class="line"> PRIMARY KEY (&#96;order_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;t_order_item&#96; (</span><br><span class="line">&#96;item_id&#96; int(11) NOT NULL,</span><br><span class="line">&#96;order_id&#96; int(11) NOT NULL,</span><br><span class="line"> &#96;user_id&#96; int(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;item_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8;</span><br></pre></td></tr></table></figure>

<p>除了定义分库和分表的算法之外, 我们还需要多定义一个<code>binding-tables</code>. </p>
<p>绑定表将使用主表的分片策略. </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.shardingColumn</span>=<span class="string">user_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;user_id % 2&#125;</span></span><br><span class="line"><span class="comment">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.sharding-column=user_id</span></span><br><span class="line"><span class="comment">#sharding.jdbc.config.sharding.tables.user_info.table-strategy.inline.algorithm-expression=user_info</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.user_info</span></span><br><span class="line"><span class="comment"># 分库算法 t_order 多库分表</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.shardingColumn</span>=<span class="string">order_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;order_id % 2&#125;</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_order</span></span><br><span class="line"><span class="comment"># 分库算法 t_order_item 多库分表</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.shardingColumn</span>=<span class="string">order_id</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order_item.databaseStrategy.inline.algorithm-expression</span>=<span class="string">ds$&#123;order_id % 2&#125;</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order_item.actual-data-nodes</span>=<span class="string">ds$-&gt;&#123;0..1&#125;.t_order_item</span></span><br><span class="line"><span class="comment"># 绑定表规则列表</span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.binding-tables[0]</span>=<span class="string">t_order,t_order_item</span></span><br></pre></td></tr></table></figure>

<p>绑定表不使用分片键查询时, 会出现笛卡尔积。 </p>
<p>什么叫笛卡尔积,假如有2个数据库, 两张表要相互关联, 两张表又各有分表, 那么SQL的执行路径就是<code>是 2*2*2=8 </code>种</p>
<p><img src="http://files.luyanan.com//img/20200407212653.png" alt="image-20200407212614047"></p>
<h4 id="2-4-3-广播表"><a href="#2-4-3-广播表" class="headerlink" title="2.4.3  广播表"></a>2.4.3  广播表</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> luyanan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/4/7</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;广播表的分库分表策略&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &quot;com.database.dao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigShardingTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ConfigService configService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        configService.insert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        configService.update(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Config config1 = configService.geConfigById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;------config1:&quot;</span>+config1);</span><br><span class="line"></span><br><span class="line">        Config config2 = configService.geConfigById(<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;------config2:&quot;</span>+config2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>插入和更新都会在所有的节点上执行 </p>
<p>如果我们需要更加复杂的分片策略, <code>properties</code> 文件内行内表达式的这种方式肯定满足不了 , 实际上<code>properties</code> 里面的分片策略都可以指定, 比如<code>user_info</code> 表的分库和分表策略. </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.shardingColumn</span>=<span class="string"></span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.preciseAlgorithmClassName</span>=<span class="string"></span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.user_info.tableStrategy.standard.rangeAlgorithmClassName</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>

<p>这个时候我们需要了解<code>Sharding-JDBC</code> 中几种不同的分片策略. </p>
<h2 id="3-分片策略详解"><a href="#3-分片策略详解" class="headerlink" title="3. 分片策略详解"></a>3. 分片策略详解</h2><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sharding/">https://shardingsphere.apache.org/document/current/cn/features/sharding/concept/sharding/</a></p>
<p><code>Sharding-JDBC</code>中的分片策略有两个维度,分库(数据源分片)策略和分表策略. </p>
<p>分库策略表示数据路由到物理目标数据源, 分表分片策略表示数据被路由到的目的表。 分表策略是依赖分库策略的, 也就是说要先分库再分表, 当然也可以不分库只分表</p>
<p>跟Mycat 不一样的是, <code>Sharding-jdbc</code>  没有提供内置的分片算法, 而是通过抽象成接口, 让开发者自行去实现, 这样可以根据业务实际情况灵活地实现. </p>
<h3 id="3-1-分片策略"><a href="#3-1-分片策略" class="headerlink" title="3.1 分片策略"></a>3.1 分片策略</h3><p>包含分片键和分片算法, 分片算法是需要自定义的, 可以用于分库, 也可以用于分表. </p>
<p><code>Sharding-JDBC</code>  提供了5种分片策略, 这些策略全部继承自<code>ShardingStrategy</code></p>
<p><img src="http://files.luyanan.com//img/20200407215328.png" alt="image-20200407215326062"></p>
<h4 id="3-1-1-行表达式分片策略"><a href="#3-1-1-行表达式分片策略" class="headerlink" title="3.1.1 行表达式分片策略"></a>3.1.1 行表达式分片策略</h4><p>对应<code>InlineShardingStrategy</code> 类,只支持单分片键, 提供对<code>+</code>和<code>IN</code>操作的支持, 行内表达式    的配置比较简单. </p>
<p>例如: <code>$&#123;begin..end&#125;</code>: 表示范围区间</p>
<p><code>$&#123;[unit1, unit2, unit_x]&#125;</code>: 表示枚举值</p>
<p><code>t_user_$-&gt;&#123;u_id % 8&#125;</code>: 表示<code>t_user</code> 表根据<code>u_id</code>模8, 而分成8张表,表名称为<code>t_user_0</code>到<code>t_user_8</code> </p>
<p>行表达式中如果出现连续多个<code>个$&#123; expression &#125;</code>或<code>$-&gt;&#123; expression &#125;</code> 表达式, 整个表达式最终的结果将会根据每个子表达式的结果进行笛卡尔积. </p>
<p>例如: 以下行表达式</p>
<p><code>$&#123;[&#39;db1&#39;, &#39;db2&#39;]&#125;_table$&#123;1..3&#125;</code><br>最终会解析为: </p>
<p><code>db1_table1</code>, <code>db1_table2</code>, <code>db1_table3</code>, <code>db2_table1</code>,<code>db2_table2</code>,<code>db2_table3</code></p>
<h4 id="3-1-2-标准分片策略"><a href="#3-1-2-标准分片策略" class="headerlink" title="3.1.2 标准分片策略"></a>3.1.2 标准分片策略</h4><p>对应<code>StandardShardingStrategy</code> 类</p>
<p>标准分片策略只支持单分片键, 提供了提供<code>PreciseShardingAlgorithm</code> 和 <code>RangeShardingAlgorithm</code> 两个分片算法,分别对应SQL 语句中的<code>=</code>、<code>IN</code>和<code>BETWEEN AND</code></p>
<p>如果要使用标准分片策略, 必须实现<code>PreciseShardingAlgorithm</code>, 用来处理<code>=</code>和<code>IN</code>的分片上。<code>RangeShardingAlgorithm</code> 是可选的, 如果没有实现,SQL语句会发到所有的数据节点上执行. </p>
<h4 id="3-1-3-符合分片策略"><a href="#3-1-3-符合分片策略" class="headerlink" title="3.1.3 符合分片策略"></a>3.1.3 符合分片策略</h4><p>比如: 根据日期和ID两个字段分片,每个月3张表,先根据日期, 再根据id取模,</p>
<p>对应<code>ComplexShardingStrategy</code> 类, 可以支持等值查询和范围查询. </p>
<p>符合分片策略支持多分片键, 提供了<code>ComplexKeysShardingAlgorithm</code>,分片算法需要自己实现. </p>
<h4 id="3-1-4-Hint-分片策略"><a href="#3-1-4-Hint-分片策略" class="headerlink" title="3.1.4 Hint 分片策略"></a>3.1.4 Hint 分片策略</h4><p>对应<code>HintShardingStrategy</code>. 通过<code>Hint</code> 而非SQL解析的方式分片的策略, 有点类似于Mycat 的指定分片注解. </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/</a></p>
<h4 id="3-1-5-不分片策略"><a href="#3-1-5-不分片策略" class="headerlink" title="3.1.5  不分片策略"></a>3.1.5  不分片策略</h4><p>对应<code>NoneShardingStrategy</code>, 不分片的策略</p>
<h3 id="3-2-分片算法"><a href="#3-2-分片算法" class="headerlink" title="3.2 分片算法"></a>3.2 分片算法</h3><p>创建了分片策略之后, 还需要实现分片算法, <code>Sharding-JDBC</code> 目前提供了4种分片算法. </p>
<h4 id="3-2-1-精确分片算法"><a href="#3-2-1-精确分片算法" class="headerlink" title="3.2.1 精确分片算法"></a>3.2.1 精确分片算法</h4><p>对应<code>PreciseShardingAlgorithm</code>,用于处理使用单一键作为分片键的<code>=</code>与<code>IN</code> 进行分片的场景,需要配合<code>StandardShardingStrategy</code> 使用. </p>
<h4 id="3-2-2-范围分片算法"><a href="#3-2-2-范围分片算法" class="headerlink" title="3.2.2 范围分片算法"></a>3.2.2 范围分片算法</h4><p>对应<code>RangeShardingAlgorithm</code> ,用于处理使用单一键作为分片键的<code>BETWEEN AND</code> 进行分片的场景, 需要配合<code>StandardShardingStrategy</code> 使用. </p>
<p>如果不配置范围分片算法, 范围查询默认会路由到所有的节点. </p>
<h4 id="3-2-3-复合分片算法"><a href="#3-2-3-复合分片算法" class="headerlink" title="3.2.3 复合分片算法"></a>3.2.3 复合分片算法</h4><p>对应<code>ComplexKeysShardingAlgorithm</code>, 用于处理使用多键作为分片键进行分片的场景, 包含多个分片键的逻辑较为复杂，需要应用开发者自行处理其中的复杂度,需要配合<code>ComplexShardingStrategy</code> 使用. </p>
<h4 id="3-2-4-Hint-分片算法"><a href="#3-2-4-Hint-分片算法" class="headerlink" title="3.2.4 Hint 分片算法"></a>3.2.4 Hint 分片算法</h4><p>对应<code>HintShardingAlgorithm</code>, 用于处理使用Hint 行分片的场景, 需要配合<code>HintShardingStrategy</code> 使用. </p>
<p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/hint/</a></p>
<h4 id="3-2-5-算法实现"><a href="#3-2-5-算法实现" class="headerlink" title="3.2.5 算法实现"></a>3.2.5 算法实现</h4><p>所有的算法都需要实现对应的接口, 实现<code>doSharding()</code> 方法.</p>
<p>例如: <code>PreciseShardingAlgorithm</code></p>
<p>传入分片键,返回一个精确的分片(数据源名称)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, PreciseShardingValue&lt;T&gt; shardingValue)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>RangeShardingAlgorithm</code></p>
<p>传入分片键, 返回多个数据源名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, RangeShardingValue&lt;T&gt; shardingValue)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ComplexKeysShardingAlgorithm</code></p>
<p>传入多个分片键,返回多个数据源名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, Collection&lt;ShardingValue&gt; shardingValues)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="4-分布式事务"><a href="#4-分布式事务" class="headerlink" title="4.分布式事务"></a>4.分布式事务</h2><h3 id="4-1-事务概况"><a href="#4-1-事务概况" class="headerlink" title="4.1 事务概况"></a>4.1 事务概况</h3><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/transaction/">https://shardingsphere.apache.org/document/current/cn/features/transaction/</a></p>
<h3 id="4-2-两阶段事务-XA"><a href="#4-2-两阶段事务-XA" class="headerlink" title="4.2 两阶段事务-XA"></a>4.2 两阶段事务-XA</h3><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--xa分布式事务--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-2pc-xa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认用<code>atomikos</code> 实现的. </p>
<p>在<code>Server</code> 类上加上注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.XA)</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br></pre></td></tr></table></figure>

<p>其他的事务类型:<code>Local</code>、<code>BASE</code></p>
<p>模拟在两个节点上操作,id=12673,id=12674 路由到两个节点,第二个节点上插入两个相同的对象,发生主键冲突,会发现回滚. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试跨库事务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.XA)</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTransactional</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user1 = <span class="keyword">new</span> User(<span class="number">12673</span>, <span class="string">&quot;张三&quot;</span>, <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">this</span>.userDao.addOne(user1);</span><br><span class="line">    User user2 = <span class="keyword">new</span> User(<span class="number">12674</span>, <span class="string">&quot;张三&quot;</span>, <span class="number">12</span>);</span><br><span class="line">    <span class="comment">// 主键冲突</span></span><br><span class="line">    <span class="keyword">this</span>.userDao.addOne(user2);</span><br><span class="line">    <span class="keyword">this</span>.userDao.addOne(user2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>XA 的实现类</p>
<p><code>ShardingTransactionManager</code> -&gt; <code>XATransactionManager</code>-&gt; <code>AtomikosTransactionManager</code></p>
<h3 id="4-3-柔性事务"><a href="#4-3-柔性事务" class="headerlink" title="4.3 柔性事务"></a>4.3 柔性事务</h3><p><code>ShardingSphere</code> 的柔性事务已经过第三方SPI实现<code>Sega</code>事务,<code>Sega</code> 引擎使用<code>Servicecomb-Saga</code></p>
<p>参考官方的这篇文章<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwMzc4NDY4Mw==&mid=2247486704&idx=1&sn=edc76d838cbed006a107573732ba271b&chksm=96cb6474a1bced623e55db47e2d2fa5b7493eff5730bc3a6d0a5f1c4b08d2cc27fcccd61513e&mpshare=1&scene=1&srcid=1022xTpRYjxUbdUEZPgLpvV6&sharer_sharetime=1571725596151&sharer_shareid=035a2b61dca579f53be4eae95018f9cf&key=07d257d046da7c4bd15ab473b579736eb78a263ceaf74f267306f034ad9d436c49c55f92ae9d7ab24b1fd410a4de62b2ae1c6f968405882d59633162adc18476f01c6db048de3071e6c2549918a20836&ascene=1&uin=MTE5MTQzNjA0MA==&devicetype=Windows+7&version=62070152&lang=zh_CN&pass_ticket=Q2/OQotkJiA//FksN+2ivqC0PU2wLceaL8QDpYYehC5L5uxZ69kRygI53NXEXcdU">《分布式事务在 Sharding-Sphere 中的实现》</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-2pc-spi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="4-4-柔性事务Seata"><a href="#4-4-柔性事务Seata" class="headerlink" title="4.4 柔性事务Seata"></a>4.4 柔性事务<code>Seata</code></h3><p><a target="_blank" rel="noopener" href="https://github.com/seata/seata">https://github.com/seata/seata</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata-workshop">https://github.com/seata/seata-workshop</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/xfUGep5XMcIqRTGY3WFpgA">https://mp.weixin.qq.com/s/xfUGep5XMcIqRTGY3WFpgA</a></p>
<p><code>GTS</code> 的社区版本叫 <code>Fescar</code>（<code>Fast &amp; Easy Commit And Rollback</code>），<code>Fescar</code> 改名后 叫 <code>Seata AT</code>（<code>Simple Extensible Autonomous Transaction Architecture</code>）。</p>
<p>需要额外部署<code>Seata-server</code> 服务进行分支事务的协调. </p>
<p>官方的demo中有一个例子: </p>
<p><a target="_blank" rel="noopener" href="https://github.com/apache/incubator-shardingsphere-example">https://github.com/apache/incubator-shardingsphere-example</a></p>
<p><code>incubator-shardingsphere-example-dev\sharding-jdbc-example\transaction -example\transaction-base-seata-raw-jdbc-example</code></p>
<h2 id="5-分布式全局ID"><a href="#5-分布式全局ID" class="headerlink" title="5.  分布式全局ID"></a>5.  分布式全局ID</h2><p>我们可以使用<code>key-generator-column-name</code> 配置, 生成一个18位的ID</p>
<p><code>properties</code>的配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">sharding.jdbc.config.sharding.default-key-generator-class-name</span>=<span class="string"></span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.keyGeneratorColumnName</span>=<span class="string"></span></span><br><span class="line"><span class="meta">sharding.jdbc.config.sharding.tables.t_order.keyGeneratorClassName</span>=<span class="string"></span></span><br></pre></td></tr></table></figure>

<p><code>Java Config</code>的配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tableRuleConfig.setKeyGeneratorColumnName(<span class="string">&quot;order_id&quot;</span>);</span><br><span class="line">tableRuleConfig.setKeyGeneratorClass(<span class="string">&quot;io.shardingsphere.core.keygen.DefaultKeyGenerator&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>keyGeneratorColumnName</code>: 指定需要ID的实例</p>
<p><code>KeyGenerotorClass</code>：指定生成器类，默认是 <code>DefaultKeyGenerator.java</code>, 里面使用了雪花算法. </p>
<h2 id="6-Sharding-JDBC-工作流程"><a href="#6-Sharding-JDBC-工作流程" class="headerlink" title="6. Sharding-JDBC 工作流程"></a>6. <code>Sharding-JDBC</code> 工作流程</h2><p><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/features/sharding/principle/">内核剖析</a></p>
<p><code>Sharding-JDBC</code>的原理总结起来很简单</p>
<p><code>SQL解析</code>-&gt; <code>执行器优化</code>-&gt;<code>SQL路由</code> -&gt;<code>SQL改写</code> -&gt;<code>SQL执行</code> -&gt; <code>结果归并</code></p>
<p><img src="http://files.luyanan.com//img/20200408094815.png" alt="image-20200408094743237"></p>
<h3 id="6-1-SQL解析"><a href="#6-1-SQL解析" class="headerlink" title="6.1 SQL解析"></a>6.1 SQL解析</h3><p>SQL解析主要是词法和语法的解析,目前常见的sql解析器有<code>fdb</code>、<code>jsqlparser</code>和<code>Druid</code>.<code>Shard-JDBC</code> 1.4x之前的版本使用的是<code>Druid</code> 作为sql解析器, 从 1.5X版本开始, <code>Sharding-JDBC</code> 采用完全自研的SQL解析引擎. </p>
<h3 id="6-2-SQL路由"><a href="#6-2-SQL路由" class="headerlink" title="6.2 SQL路由"></a>6.2 SQL路由</h3><p><img src="http://files.luyanan.com//img/20200408095205.png" alt="image-20200408095204423"></p>
<p>SQL路由是根据分片规则配置以及解析上下文的分片条件, 将SQL 定位至真正的数据源, 它又分为直接路由、简单路由和笛卡尔积路由. </p>
<p>直接路由,使用<code>Hint</code>方式. </p>
<p><code>Binding</code> 表是指使用同样的分片键和分片规则的一组表,也就是说任何情况下, <code>Binding</code> 表的分片结果应该与主表一致. 例如<code>order_info</code> 表和<code>order_item</code> 表, 都根据<code>order_id</code> 分片, 结果应该是<code>order_1</code>与<code>order_item_1</code>  成对出现. 这样的关联查询和单表查询复杂度和性能相当,如果分片条件不是等于, 而是<code>BETWEEN</code> 或者<code>IN</code>,则路由结果不一定落入单库(表)，因此一条逻辑sql最终可能拆分成多条SQL 语句. </p>
<p>笛卡尔积查询最为复杂,因为无法根据<code>Binding</code> 关系定位分片规则的一致性, 所以非<code>Binding</code> 表的关联查询需要拆解为笛卡尔积组合执行. 查询性能较低, 而且数据库连接比较高, 需谨慎使用, </p>
<h3 id="6-3-SQL-改写"><a href="#6-3-SQL-改写" class="headerlink" title="6.3 SQL 改写"></a>6.3 SQL 改写</h3><p>例如: 将逻辑表名称改写成真实表的名称, 优化分页查询等. </p>
<h3 id="6-4-SQL执行"><a href="#6-4-SQL执行" class="headerlink" title="6.4 SQL执行."></a>6.4 SQL执行.</h3><p>因为可能连接到多个真实的数据源,<code>Sharding-JDBC</code>将采用多线程并发执行SQL.</p>
<h3 id="6-5-结果归总"><a href="#6-5-结果归总" class="headerlink" title="6.5 结果归总"></a>6.5 结果归总</h3><p>例如数据的组装、分页、排序等等    .</p>
<h2 id="7-Sharding-JDBC-实现原理"><a href="#7-Sharding-JDBC-实现原理" class="headerlink" title="7. Sharding-JDBC 实现原理"></a>7. <code>Sharding-JDBC</code> 实现原理</h2><p>我们知道JDBC的四大核心对象 <code>DataSource</code>、<code>Connection</code>、<code>Statement（PS）</code>、<code>ResulstSet</code>。<code>Sharding-JDBC</code> 封装了这四个核心类,在类名前面加上了<code>Sharding</code>. </p>
<p><img src="http://files.luyanan.com//img/20200408102528.png" alt="image-20200408102527034"></p>
<p>如果说带<code>Sharding</code>的类要替换JDBC的对象，那么一定要找到创建和调用他们的地方.<code>ShardingDataSource</code> 我们就不说了, 系统启动的时候就创建好了. </p>
<p>问题就在于, 我们是什么时候用<code>ShardingDataSource</code> 获取一个<code>ShardingConnection</code> 的?</p>
<p>没有看过Mybatis的源码的同学一定要去看看,我们的查询方法最终会走到<code>SimpleExecutor</code> 的<code>doQuery()</code> 方法, 这个是我们的前提知识, 那我们直接在<code>doQuery()</code>打断点. </p>
<p><code>doQuery()</code> 方法里面调用了<code>prepareStatement()</code>  创建连接. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Statement <span class="title">prepareStatement</span><span class="params">(StatementHandler handler, Log statementLog)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">       Connection connection = <span class="keyword">this</span>.getConnection(statementLog);</span><br><span class="line">       Statement stmt = handler.prepare(connection, <span class="keyword">this</span>.transaction.getTimeout());</span><br><span class="line">       handler.parameterize(stmt);</span><br><span class="line">       <span class="keyword">return</span> stmt;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>它经过以下两个方法, 返回一个<code>ShardingConnection</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DataSourceUtil.fetchConnection()</span><br><span class="line">Connection con = dataSource.getConnection();</span><br></pre></td></tr></table></figure>

<p>基于这个<code>ShardingConnection</code>，最终得到一个 <code>ShardingStatement</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stmt = handler.prepare(connection, transaction.getTimeout());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来就是执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> handler.query(stmt, resultHandler);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再调用了<code>ShardingStatement</code>的<code>execute()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">    ps.execute();</span><br><span class="line">    <span class="keyword">return</span> resultSetHandler.handleResultSets(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终调用的是<code>ShardingPreparedStatement</code> 的<code>execute</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      clearPrevious();</span><br><span class="line">      sqlRoute();</span><br><span class="line">      initPreparedStatementExecutor();</span><br><span class="line">      <span class="keyword">return</span> preparedStatementExecutor.execute();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    refreshTableMetaData(connection.getShardingContext(), routeResult.getSqlStatement());</span><br><span class="line">    clearBatch();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SQL的解析路由就是在这一步完成的。 </p>
<h2 id="8-Sharding-Proxy-介绍"><a href="#8-Sharding-Proxy-介绍" class="headerlink" title="8. Sharding-Proxy 介绍"></a>8. <code>Sharding-Proxy</code> 介绍</h2><p>下载地址</p>
<p><a target="_blank" rel="noopener" href="https://github.com/sharding-sphere/sharding-sphere-doc/raw/master/dist/sharding-proxy-3.0.0.tar.gz">https://github.com/sharding-sphere/sharding-sphere-doc/raw/master/dist/sharding-proxy-3.0.0.tar.gz</a></p>
<p><code>lib</code> 目录就是<code>sharding-proxy</code> 核心代码,以及依赖的jar</p>
<p><code>bin</code>目录就是存在启停脚本的地方</p>
<p><code>conf</code> 目录就是存放所有配置文件,包括<code>sharding-proxy</code> 服务的配置文件、数据源以及<code>sahrding</code> 规则配置文件和项目日志配置文件. </p>
<p>linux 运行<code>start.sh</code> 文件(window用<code>start.bat</code>) ,默认端口为3307</p>
<p>需要的自定义分表算法, 只需要将他编译成class文件, 然后放到<code>conf</code>目录下,也可以打成jar 包放到<code>lib</code> 目录</p>
<h2 id="9-与Mycat-对比"><a href="#9-与Mycat-对比" class="headerlink" title="9. 与Mycat 对比"></a>9. 与Mycat 对比</h2><table>
<thead>
<tr>
<th></th>
<th><code>Sharding-JDBC</code></th>
<th><code>Mycat</code></th>
</tr>
</thead>
<tbody><tr>
<td>工作层面</td>
<td>JDBC协议</td>
<td>Mysql协议JDBC协议</td>
</tr>
<tr>
<td>运行方式</td>
<td>jar包, 客户端</td>
<td>独立服务, 服务端</td>
</tr>
<tr>
<td>开发方式</td>
<td>代码/配置改动</td>
<td>连接地址(数据源)</td>
</tr>
<tr>
<td>运维方式</td>
<td>无</td>
<td>管理独立服务,运维成本高</td>
</tr>
<tr>
<td>性能</td>
<td>多线程并发操作, 性能高</td>
<td>独立服务+网络开销,存在性能损失风险</td>
</tr>
<tr>
<td>功能范围</td>
<td>协议层面</td>
<td>包括分布式事务、数据迁移</td>
</tr>
<tr>
<td>适用操作</td>
<td>OLTP</td>
<td>OLTP+OLAP</td>
</tr>
<tr>
<td>支持数据库</td>
<td>基于JDBC协议的数据库</td>
<td>mysql 和其他支持JDBC协议的数据库</td>
</tr>
<tr>
<td>支持语言</td>
<td>java项目中使用</td>
<td>支持JDBC协议</td>
</tr>
</tbody></table>
<p>从易用性和功能完善的角度来看看,Mycat 似乎比<code>Sharding-JDBC</code> 要好, 因为有现成的分片规则, 也提供了4种ID生成方式, 通过注解可以支持高级功能, 比如跨库关联查询. </p>
<p>建议: 小型项目, 分片规则简单的项目用<code>sharding-JDBC</code>.大型项目, 可以用<code>Mycat</code></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/4.%20Mysql%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="prev" title="4">
      <i class="fa fa-chevron-left"></i> 4
    </a></div>
      <div class="post-nav-item">
    <a href="/CENTOS%207%20%E5%92%8C%20JDK%20%E6%B7%BB%E5%8A%A0%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93/" rel="next" title="CENTOS 7 和 JDK 添加中文字体">
      CENTOS 7 和 JDK 添加中文字体 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E4%B9%8BSharding-JDBC"><span class="nav-number">1.</span> <span class="nav-text">分库分表之Sharding-JDBC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.</span> <span class="nav-text">1. 架构与核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 发展历史</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E5%9F%BA%E6%9C%AC%E7%89%B9%E6%80%A7"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 基本特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E5%8A%9F%E8%83%BD"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-1-%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">1.4.1 数据分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-2-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">1.4.2 分布式事务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-1-%E4%B8%BB%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">1.5.1 主要概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-2-%E5%8A%A8%E6%80%81%E8%A1%A8"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">1.5.2 动态表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-3-%E5%B9%BF%E6%92%AD%E8%A1%A8"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">1.5.3 广播表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-4-%E7%BB%91%E5%AE%9A%E8%A1%A8"><span class="nav-number">1.1.5.4.</span> <span class="nav-text">1.5.4  绑定表</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83"><span class="nav-number">1.1.6.</span> <span class="nav-text">1.6 使用规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Sharding-JDBC%E5%AE%9E%E6%88%98"><span class="nav-number">1.2.</span> <span class="nav-text">2. Sharding-JDBC实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 引入依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-%E5%8E%9F%E7%94%9FJDBC%E4%BD%BF%E7%94%A8"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2  原生JDBC使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Spring-%E4%BD%BF%E7%94%A8"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 Spring 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-java%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">2.3.1 java配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-SpringBoot-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">2.3.2 SpringBoot 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-yml%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">2.3.3 yml配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Spring%E6%A1%88%E4%BE%8B%E9%AA%8C%E8%AF%81"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 Spring案例验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">2.4.1 取模分片</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-%E7%BB%91%E5%AE%9A%E8%A1%A8"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">2.4.2 绑定表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-%E5%B9%BF%E6%92%AD%E8%A1%A8"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">2.4.3  广播表</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3"><span class="nav-number">1.3.</span> <span class="nav-text">3. 分片策略详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 分片策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-%E8%A1%8C%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">3.1.1 行表达式分片策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-%E6%A0%87%E5%87%86%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">3.1.2 标准分片策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-%E7%AC%A6%E5%90%88%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">3.1.3 符合分片策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-Hint-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">3.1.4 Hint 分片策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-5-%E4%B8%8D%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">3.1.5  不分片策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 分片算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E7%B2%BE%E7%A1%AE%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">3.2.1 精确分片算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">3.2.2 范围分片算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-%E5%A4%8D%E5%90%88%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">3.2.3 复合分片算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-Hint-%E5%88%86%E7%89%87%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">3.2.4 Hint 分片算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-5-%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">3.2.5 算法实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.4.</span> <span class="nav-text">4.分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E4%BA%8B%E5%8A%A1%E6%A6%82%E5%86%B5"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 事务概况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E4%B8%A4%E9%98%B6%E6%AE%B5%E4%BA%8B%E5%8A%A1-XA"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2 两阶段事务-XA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="nav-number">1.4.3.</span> <span class="nav-text">4.3 柔性事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1Seata"><span class="nav-number">1.4.4.</span> <span class="nav-text">4.4 柔性事务Seata</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%88%86%E5%B8%83%E5%BC%8F%E5%85%A8%E5%B1%80ID"><span class="nav-number">1.5.</span> <span class="nav-text">5.  分布式全局ID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Sharding-JDBC-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.6.</span> <span class="nav-text">6. Sharding-JDBC 工作流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-SQL%E8%A7%A3%E6%9E%90"><span class="nav-number">1.6.1.</span> <span class="nav-text">6.1 SQL解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-SQL%E8%B7%AF%E7%94%B1"><span class="nav-number">1.6.2.</span> <span class="nav-text">6.2 SQL路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-SQL-%E6%94%B9%E5%86%99"><span class="nav-number">1.6.3.</span> <span class="nav-text">6.3 SQL 改写</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-SQL%E6%89%A7%E8%A1%8C"><span class="nav-number">1.6.4.</span> <span class="nav-text">6.4 SQL执行.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-%E7%BB%93%E6%9E%9C%E5%BD%92%E6%80%BB"><span class="nav-number">1.6.5.</span> <span class="nav-text">6.5 结果归总</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Sharding-JDBC-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="nav-number">1.7.</span> <span class="nav-text">7. Sharding-JDBC 实现原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Sharding-Proxy-%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.8.</span> <span class="nav-text">8. Sharding-Proxy 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E4%B8%8EMycat-%E5%AF%B9%E6%AF%94"><span class="nav-number">1.9.</span> <span class="nav-text">9. 与Mycat 对比</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">227</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luyanan0718" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luyanan0718" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/luyanan0718@163.com" title="E-Mail → luyanan0718@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://luyanan.com/" title="https:&#x2F;&#x2F;luyanan.com">Site</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
