<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="zookeeper原理之watcher源码分析watcher 的基本流程zookeeper 的watcher 机制, 总的来说分为三个过程: 客户端注册watcher、服务端处理watcher和客户端回调watcher .  基于zk客户端发起一个数据操作12345678910111213141516171819public static void main(String[] args) thro">
<meta property="og:type" content="article">
<meta property="og:title" content="zookeeper之watcher原理分析">
<meta property="og:url" content="http://luyanan.com/zookeeper%E4%B9%8Bwatcher%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="zookeeper原理之watcher源码分析watcher 的基本流程zookeeper 的watcher 机制, 总的来说分为三个过程: 客户端注册watcher、服务端处理watcher和客户端回调watcher .  基于zk客户端发起一个数据操作12345678910111213141516171819public static void main(String[] args) thro">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-03-02T05:42:51.788Z">
<meta property="article:modified_time" content="2021-03-02T05:42:51.788Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://luyanan.com/zookeeper%E4%B9%8Bwatcher%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>zookeeper之watcher原理分析 | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/zookeeper%E4%B9%8Bwatcher%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          zookeeper之watcher原理分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-02 13:42:51" itemprop="dateCreated datePublished" datetime="2021-03-02T13:42:51+08:00">2021-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/zookpeer/" itemprop="url" rel="index"><span itemprop="name">zookpeer</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="zookeeper原理之watcher源码分析"><a href="#zookeeper原理之watcher源码分析" class="headerlink" title="zookeeper原理之watcher源码分析"></a>zookeeper原理之watcher源码分析</h1><h2 id="watcher-的基本流程"><a href="#watcher-的基本流程" class="headerlink" title="watcher 的基本流程"></a>watcher 的基本流程</h2><p>zookeeper 的watcher 机制, 总的来说分为三个过程: 客户端注册watcher、服务端处理watcher和客户端回调watcher . </p>
<h2 id="基于zk客户端发起一个数据操作"><a href="#基于zk客户端发起一个数据操作" class="headerlink" title="基于zk客户端发起一个数据操作"></a>基于zk客户端发起一个数据操作</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, KeeperException, InterruptedException </span>&#123;</span><br><span class="line">       ZooKeeper zooKeeper = <span class="keyword">new</span> ZooKeeper(<span class="string">&quot;192.168.9.22:2181&quot;</span>,</span><br><span class="line">               <span class="number">4000</span>, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">               System.out.println(<span class="string">&quot;event.type:&quot;</span> + watchedEvent.getType());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       String path = <span class="string">&quot;/watcher&quot;</span>;</span><br><span class="line">       <span class="comment">//  创建节点</span></span><br><span class="line">       zooKeeper.create(path, <span class="string">&quot;0&quot;</span>.getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);</span><br><span class="line">       <span class="comment">//  注册监听</span></span><br><span class="line">       zooKeeper.exists(path, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 修改节点的值触发监听</span></span><br><span class="line">       zooKeeper.setData(path, <span class="string">&quot;1&quot;</span>.getBytes(), -<span class="number">1</span>);</span><br><span class="line">       System.in.read();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在创建一个zookeeper 客户端对象实例的时候. 我们通过<code>new Watcher</code> 向构造方法中传入一个默认的watcher, 这个watcher 将作为整个整个zookeeper 会话期间默认的watcher,会一直被保存在客户端 ZKWatchManager  的 defaultWatcher 中, 代码如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZooKeeper</span><span class="params">(String connectString, <span class="keyword">int</span> sessionTimeout, Watcher watcher, <span class="keyword">boolean</span> canBeReadOnly, HostProvider aHostProvider, ZKClientConfig clientConfig)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       LOG.info(<span class="string">&quot;Initiating client connection, connectString=&quot;</span> + connectString + <span class="string">&quot; sessionTimeout=&quot;</span> + sessionTimeout + <span class="string">&quot; watcher=&quot;</span> + watcher);</span><br><span class="line">       <span class="keyword">if</span> (clientConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">           clientConfig = <span class="keyword">new</span> ZKClientConfig();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">this</span>.clientConfig = clientConfig;</span><br><span class="line">    </span><br><span class="line">       <span class="keyword">this</span>.watchManager = <span class="keyword">this</span>.defaultWatchManager();</span><br><span class="line">    <span class="comment">// 这里将watcher 设置到ZKWatchManager  </span></span><br><span class="line">    <span class="keyword">this</span>.watchManager.defaultWatcher = watcher;</span><br><span class="line">       ConnectStringParser connectStringParser = <span class="keyword">new</span> ConnectStringParser(connectString);</span><br><span class="line">       <span class="keyword">this</span>.hostProvider = aHostProvider;</span><br><span class="line">       <span class="keyword">this</span>.cnxn = <span class="keyword">new</span> ClientCnxn(connectStringParser.getChrootPath(), <span class="keyword">this</span>.hostProvider, sessionTimeout, <span class="keyword">this</span>, <span class="keyword">this</span>.watchManager, <span class="keyword">this</span>.getClientCnxnSocket(), canBeReadOnly);</span><br><span class="line">       <span class="keyword">this</span>.cnxn.start();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p> ClientCnxn : 是zookeeper 客户端和zookeeper 服务端进行通信和事件通知处理的主要类, 它主要包含两个类: </p>
<ul>
<li> SendThread : 负责客户端和服务端的数据通信, 也包括事件信息的传输</li>
<li> EventThread : 主要在客户端回调注册的watcher 进行通知处理. </li>
</ul>
<h2 id="ClientCnxn-初始化"><a href="#ClientCnxn-初始化" class="headerlink" title="ClientCnxn  初始化"></a>ClientCnxn  初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClientCnxn</span><span class="params">(String chrootPath, HostProvider hostProvider, <span class="keyword">int</span> sessionTimeout, ZooKeeper zooKeeper, ClientWatchManager watcher, ClientCnxnSocket clientCnxnSocket, <span class="keyword">long</span> sessionId, <span class="keyword">byte</span>[] sessionPasswd, <span class="keyword">boolean</span> canBeReadOnly)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.authInfo = <span class="keyword">new</span> CopyOnWriteArraySet();</span><br><span class="line">    <span class="keyword">this</span>.pendingQueue = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    <span class="keyword">this</span>.outgoingQueue = <span class="keyword">new</span> LinkedBlockingDeque();</span><br><span class="line">    <span class="keyword">this</span>.sessionPasswd = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">this</span>.closing = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.seenRwServerBefore = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.eventOfDeath = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">this</span>.xid = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">this</span>.state = States.NOT_CONNECTED;</span><br><span class="line">    <span class="keyword">this</span>.zooKeeper = zooKeeper;</span><br><span class="line">    <span class="keyword">this</span>.watcher = watcher;</span><br><span class="line">    <span class="keyword">this</span>.sessionId = sessionId;</span><br><span class="line">    <span class="keyword">this</span>.sessionPasswd = sessionPasswd;</span><br><span class="line">    <span class="keyword">this</span>.sessionTimeout = sessionTimeout;</span><br><span class="line">    <span class="keyword">this</span>.hostProvider = hostProvider;</span><br><span class="line">    <span class="keyword">this</span>.chrootPath = chrootPath;</span><br><span class="line">    <span class="keyword">this</span>.connectTimeout = sessionTimeout / hostProvider.size();</span><br><span class="line">    <span class="keyword">this</span>.readTimeout = sessionTimeout * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">this</span>.readOnly = canBeReadOnly;</span><br><span class="line">    <span class="comment">//初始化sendThread</span></span><br><span class="line">    <span class="keyword">this</span>.sendThread = <span class="keyword">new</span> ClientCnxn.SendThread(clientCnxnSocket);</span><br><span class="line">    <span class="comment">// 初始化eventThread</span></span><br><span class="line">    <span class="keyword">this</span>.eventThread = <span class="keyword">new</span> ClientCnxn.EventThread();</span><br><span class="line">    <span class="keyword">this</span>.clientConfig = zooKeeper.getClientConfig();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 启动两个线程</span></span><br><span class="line">    <span class="keyword">this</span>.sendThread.start();</span><br><span class="line">    <span class="keyword">this</span>.eventThread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="服务端接收请求处理流程"><a href="#服务端接收请求处理流程" class="headerlink" title="服务端接收请求处理流程"></a>服务端接收请求处理流程</h2><p>服务端有一个 NIOServerCnxn  类, 有来处理客户端发送过来的请求 </p>
<h3 id="NIOServerCnxn"><a href="#NIOServerCnxn" class="headerlink" title="NIOServerCnxn"></a>NIOServerCnxn</h3><h4 id="ZookeeperServer-processPacket-this-bb"><a href="#ZookeeperServer-processPacket-this-bb" class="headerlink" title="ZookeeperServer.processPacket(this, bb);"></a>ZookeeperServer.processPacket(this, bb);</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processPacket</span><span class="params">(ServerCnxn cnxn, ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       <span class="comment">// We have the request, now process and setup for next</span></span><br><span class="line">       InputStream bais = <span class="keyword">new</span> ByteBufferInputStream(incomingBuffer);</span><br><span class="line">       BinaryInputArchive bia = BinaryInputArchive.getArchive(bais);</span><br><span class="line">       RequestHeader h = <span class="keyword">new</span> RequestHeader();</span><br><span class="line">       h.deserialize(bia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">       <span class="comment">// Through the magic of byte buffers, txn will not be</span></span><br><span class="line">       <span class="comment">// pointing</span></span><br><span class="line">       <span class="comment">// to the start of the txn</span></span><br><span class="line">       incomingBuffer = incomingBuffer.slice();</span><br><span class="line">       <span class="comment">// 判断当前操作类型, 如果是auth操作, 就直接以下代码</span></span><br><span class="line">       <span class="keyword">if</span> (h.getType() == OpCode.auth) &#123;</span><br><span class="line">           LOG.info(<span class="string">&quot;got auth packet &quot;</span> + cnxn.getRemoteSocketAddress());</span><br><span class="line">           AuthPacket authPacket = <span class="keyword">new</span> AuthPacket();</span><br><span class="line">           ByteBufferInputStream.byteBuffer2Record(incomingBuffer, authPacket);</span><br><span class="line">           String scheme = authPacket.getScheme();</span><br><span class="line">           AuthenticationProvider ap = ProviderRegistry.getProvider(scheme);</span><br><span class="line">           Code authReturn = KeeperException.Code.AUTHFAILED;</span><br><span class="line">           <span class="keyword">if</span>(ap != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   authReturn = ap.handleAuthentication(cnxn, authPacket.getAuth());</span><br><span class="line">               &#125; <span class="keyword">catch</span>(RuntimeException e) &#123;</span><br><span class="line">                   LOG.warn(<span class="string">&quot;Caught runtime exception from AuthenticationProvider: &quot;</span> + scheme + <span class="string">&quot; due to &quot;</span> + e);</span><br><span class="line">                   authReturn = KeeperException.Code.AUTHFAILED;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (authReturn!= KeeperException.Code.OK) &#123;</span><br><span class="line">               <span class="keyword">if</span> (ap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   LOG.warn(<span class="string">&quot;No authentication provider for scheme: &quot;</span></span><br><span class="line">                           + scheme + <span class="string">&quot; has &quot;</span></span><br><span class="line">                           + ProviderRegistry.listProviders());</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   LOG.warn(<span class="string">&quot;Authentication failed for scheme: &quot;</span> + scheme);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// send a response...</span></span><br><span class="line">               ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>,</span><br><span class="line">                       KeeperException.Code.AUTHFAILED.intValue());</span><br><span class="line">               cnxn.sendResponse(rh, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">               <span class="comment">// ... and close connection</span></span><br><span class="line">               cnxn.sendBuffer(ServerCnxnFactory.closeConn);</span><br><span class="line">               cnxn.disableRecv();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Authentication succeeded for scheme: &quot;</span></span><br><span class="line">                             + scheme);</span><br><span class="line">               &#125;</span><br><span class="line">               LOG.info(<span class="string">&quot;auth success &quot;</span> + cnxn.getRemoteSocketAddress());</span><br><span class="line">               ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>,</span><br><span class="line">                       KeeperException.Code.OK.intValue());</span><br><span class="line">               cnxn.sendResponse(rh, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (h.getType() == OpCode.sasl) &#123;</span><br><span class="line">               Record rsp = processSasl(incomingBuffer,cnxn);</span><br><span class="line">               ReplyHeader rh = <span class="keyword">new</span> ReplyHeader(h.getXid(), <span class="number">0</span>, KeeperException.Code.OK.intValue());</span><br><span class="line">               cnxn.sendResponse(rh,rsp, <span class="string">&quot;response&quot;</span>); <span class="comment">// not sure about 3rd arg..what is it?</span></span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//  最终进入这个代码块进行处理</span></span><br><span class="line">               <span class="comment">// 封装请求对象</span></span><br><span class="line">               Request si = <span class="keyword">new</span> Request(cnxn, cnxn.getSessionId(), h.getXid(),</span><br><span class="line">                 h.getType(), incomingBuffer, cnxn.getAuthInfo());</span><br><span class="line">               si.setOwner(ServerCnxn.me);</span><br><span class="line">               submitRequest(si);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       cnxn.incrOutstandingRequests(h);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="submitRequest"><a href="#submitRequest" class="headerlink" title="submitRequest"></a>submitRequest</h4><p>负责在服务端提交当前请求. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitRequest</span><span class="params">(Request si)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (firstProcessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// Since all requests are passed to the request</span></span><br><span class="line">                  <span class="comment">// processor it should wait for setting up the request</span></span><br><span class="line">                  <span class="comment">// processor chain. The state will be updated to RUNNING</span></span><br><span class="line">                  <span class="comment">// after the setup.</span></span><br><span class="line">                  <span class="keyword">while</span> (state == State.INITIAL) &#123;</span><br><span class="line">                      wait(<span class="number">1000</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                  LOG.warn(<span class="string">&quot;Unexpected interruption&quot;</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (firstProcessor == <span class="keyword">null</span> || state != State.RUNNING) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Not started&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          touch(si.cnxn);</span><br><span class="line">          <span class="comment">// 判断是否合法</span></span><br><span class="line">          <span class="keyword">boolean</span> validpacket = Request.isValid(si.type);</span><br><span class="line">          <span class="keyword">if</span> (validpacket) &#123;</span><br><span class="line">              <span class="comment">// 调用firstProcessor 发起请求, firstProcessor 是一个接口, 有多个实现类, </span></span><br><span class="line">              firstProcessor.processRequest(si);</span><br><span class="line">              <span class="keyword">if</span> (si.cnxn != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  incInProcess();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              LOG.warn(<span class="string">&quot;Received packet at server of unknown type &quot;</span> + si.type);</span><br><span class="line">              <span class="keyword">new</span> UnimplementedRequestProcessor().processRequest(si);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (MissingSessionException e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Dropping request: &quot;</span> + e.getMessage());</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">          LOG.error(<span class="string">&quot;Unable to process request:&quot;</span> + e.getMessage(), e);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="firstProcessor-请求链组成"><a href="#firstProcessor-请求链组成" class="headerlink" title="firstProcessor  请求链组成"></a>firstProcessor  请求链组成</h4><p> firstProcessor  的初始化是在 ZookeeperServer  的 setupRequestProcessor  中完成的, 代码如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setupRequestProcessors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RequestProcessor finalProcessor = <span class="keyword">new</span> FinalRequestProcessor(<span class="keyword">this</span>);</span><br><span class="line">    RequestProcessor syncProcessor = <span class="keyword">new</span> SyncRequestProcessor(<span class="keyword">this</span>,</span><br><span class="line">            finalProcessor);</span><br><span class="line">    ((SyncRequestProcessor)syncProcessor).start();</span><br><span class="line">    firstProcessor = <span class="keyword">new</span> PrepRequestProcessor(<span class="keyword">this</span>, syncProcessor);</span><br><span class="line">    ((PrepRequestProcessor)firstProcessor).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面我们可以看到     firstProcessor  的实例是一个PrepRequestProcessor, 而这个构造方法中又传递到了一个Processor 构成一个调用链. </p>
<p> RequestProcessor syncProcessor = new SyncRequestProcessor(this,  finalProcessor); </p>
<p>而syncProcessor  的构造方法传递的又是一个Processor , 对应的是 FinalRequestProcessor . </p>
<p>所以整个调用链是 PrepRequestProcessor -&gt; SyncRequestProcessor - &gt;FinalRequestProcessor </p>
<h4 id="PredRequestProcessor-processRequest-si"><a href="#PredRequestProcessor-processRequest-si" class="headerlink" title="PredRequestProcessor.processRequest(si);"></a>PredRequestProcessor.processRequest(si);</h4><p>通过上面了解到调用链关系后, 我们继续往下看  firstProcessor.processRequest(si)； , 会调用到 PrepRequestProcessor . </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// request.addRQRec(&quot;&gt;prep=&quot;+zks.outstandingChanges.size());</span></span><br><span class="line">     submittedRequests.add(request);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p> processRequest  只是把request 添加到 submittedRequests  中, 这是一个异步操作,  submittedRequests  是一个阻塞队列. </p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LinkedBlockingQueue&lt;Request&gt; submittedRequests &#x3D; new LinkedBlockingQueue&lt;Request&gt;();</span><br></pre></td></tr></table></figure>
</blockquote>
<p>而 PrepRequestProcessor  这个类又继承了线程类, 因此我们直接找到当前类中的run方法如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">               Request request = submittedRequests.take();</span><br><span class="line">               <span class="keyword">long</span> traceMask = ZooTrace.CLIENT_REQUEST_TRACE_MASK;</span><br><span class="line">               <span class="keyword">if</span> (request.type == OpCode.ping) &#123;</span><br><span class="line">                   traceMask = ZooTrace.CLIENT_PING_TRACE_MASK;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                   ZooTrace.logRequest(LOG, traceMask, <span class="string">&#x27;P&#x27;</span>, request, <span class="string">&quot;&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (Request.requestOfDeath == request) &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               pRequest(request);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (RequestProcessorException e) &#123;</span><br><span class="line">           <span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> XidRolloverException) &#123;</span><br><span class="line">               LOG.info(e.getCause().getMessage());</span><br><span class="line">           &#125;</span><br><span class="line">           handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           handleException(<span class="keyword">this</span>.getName(), e);</span><br><span class="line">       &#125;</span><br><span class="line">       LOG.info(<span class="string">&quot;PrepRequestProcessor exited loop!&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="pRequest"><a href="#pRequest" class="headerlink" title="pRequest"></a>pRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest</span><span class="params">(Request request)</span> <span class="keyword">throws</span> RequestProcessorException </span>&#123;</span><br><span class="line">      <span class="comment">// LOG.info(&quot;Prep&gt;&gt;&gt; cxid = &quot; + request.cxid + &quot; type = &quot; +</span></span><br><span class="line">      <span class="comment">// request.type + &quot; id = 0x&quot; + Long.toHexString(request.sessionId));</span></span><br><span class="line">      request.hdr = <span class="keyword">null</span>;</span><br><span class="line">      request.txn = <span class="keyword">null</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">switch</span> (request.type) &#123;</span><br><span class="line">              <span class="keyword">case</span> OpCode.create:</span><br><span class="line">              CreateRequest createRequest = <span class="keyword">new</span> CreateRequest();</span><br><span class="line">              pRequest2Txn(request.type, zks.getNextZxid(), request, createRequest, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OpCode.delete:</span><br><span class="line">              DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest();               </span><br><span class="line">              pRequest2Txn(request.type, zks.getNextZxid(), request, deleteRequest, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OpCode.setData:</span><br><span class="line">              SetDataRequest setDataRequest = <span class="keyword">new</span> SetDataRequest();                </span><br><span class="line">              pRequest2Txn(request.type, zks.getNextZxid(), request, setDataRequest, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OpCode.setACL:</span><br><span class="line">              SetACLRequest setAclRequest = <span class="keyword">new</span> SetACLRequest();                </span><br><span class="line">              pRequest2Txn(request.type, zks.getNextZxid(), request, setAclRequest, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OpCode.check:</span><br><span class="line">              CheckVersionRequest checkRequest = <span class="keyword">new</span> CheckVersionRequest();              </span><br><span class="line">              pRequest2Txn(request.type, zks.getNextZxid(), request, checkRequest, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> OpCode.multi:</span><br><span class="line">              MultiTransactionRecord multiRequest = <span class="keyword">new</span> MultiTransactionRecord();</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  ByteBufferInputStream.byteBuffer2Record(request.request, multiRequest);</span><br><span class="line">              &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">                  request.hdr =  <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zks.getNextZxid(),</span><br><span class="line">                          Time.currentWallTime(), OpCode.multi);</span><br><span class="line">                  <span class="keyword">throw</span> e;</span><br><span class="line">              &#125;</span><br><span class="line">              List&lt;Txn&gt; txns = <span class="keyword">new</span> ArrayList&lt;Txn&gt;();</span><br><span class="line">              <span class="comment">//Each op in a multi-op must have the same zxid!</span></span><br><span class="line">              <span class="keyword">long</span> zxid = zks.getNextZxid();</span><br><span class="line">              KeeperException ke = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">              <span class="comment">//Store off current pending change records in case we need to rollback</span></span><br><span class="line">              HashMap&lt;String, ChangeRecord&gt; pendingChanges = getPendingChanges(multiRequest);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">for</span>(Op op: multiRequest) &#123;</span><br><span class="line">                  Record subrequest = op.toRequestRecord() ;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">/* If we&#x27;ve already failed one of the ops, don&#x27;t bother</span></span><br><span class="line"><span class="comment">                   * trying the rest as we know it&#x27;s going to fail and it</span></span><br><span class="line"><span class="comment">                   * would be confusing in the logfiles.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line">                  <span class="keyword">if</span> (ke != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      request.hdr.setType(OpCode.error);</span><br><span class="line">                      request.txn = <span class="keyword">new</span> ErrorTxn(Code.RUNTIMEINCONSISTENCY.intValue());</span><br><span class="line">                  &#125; </span><br><span class="line">                  </span><br><span class="line">                  <span class="comment">/* Prep the request and convert to a Txn */</span></span><br><span class="line">                  <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                          pRequest2Txn(op.getType(), zxid, request, subrequest, <span class="keyword">false</span>);</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">                          ke = e;</span><br><span class="line">                          request.hdr.setType(OpCode.error);</span><br><span class="line">                          request.txn = <span class="keyword">new</span> ErrorTxn(e.code().intValue());</span><br><span class="line">                          LOG.info(<span class="string">&quot;Got user-level KeeperException when processing &quot;</span></span><br><span class="line">                          		+ request.toString() + <span class="string">&quot; aborting remaining multi ops.&quot;</span></span><br><span class="line">                          		+ <span class="string">&quot; Error Path:&quot;</span> + e.getPath()</span><br><span class="line">                          		+ <span class="string">&quot; Error:&quot;</span> + e.getMessage());</span><br><span class="line"></span><br><span class="line">                          request.setException(e);</span><br><span class="line"></span><br><span class="line">                          <span class="comment">/* Rollback change records from failed multi-op */</span></span><br><span class="line">                          rollbackPendingChanges(zxid, pendingChanges);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">//<span class="doctag">FIXME:</span> I don&#x27;t want to have to serialize it here and then</span></span><br><span class="line">                  <span class="comment">//       immediately deserialize in next processor. But I&#x27;m </span></span><br><span class="line">                  <span class="comment">//       not sure how else to get the txn stored into our list.</span></span><br><span class="line">                  ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                  BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);</span><br><span class="line">                  request.txn.serialize(boa, <span class="string">&quot;request&quot;</span>) ;</span><br><span class="line">                  ByteBuffer bb = ByteBuffer.wrap(baos.toByteArray());</span><br><span class="line"></span><br><span class="line">                  txns.add(<span class="keyword">new</span> Txn(request.hdr.getType(), bb.array()));</span><br><span class="line">                  index++;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              request.hdr = <span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</span><br><span class="line">                      Time.currentWallTime(), request.type);</span><br><span class="line">              request.txn = <span class="keyword">new</span> MultiTxn(txns);</span><br><span class="line">              </span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//create/close session don&#x27;t require request record</span></span><br><span class="line">          <span class="keyword">case</span> OpCode.createSession:</span><br><span class="line">          <span class="keyword">case</span> OpCode.closeSession:</span><br><span class="line">              pRequest2Txn(request.type, zks.getNextZxid(), request, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"> </span><br><span class="line">          <span class="comment">//All the rest don&#x27;t need to create a Txn - just verify session</span></span><br><span class="line">          <span class="keyword">case</span> OpCode.sync:</span><br><span class="line">          <span class="keyword">case</span> OpCode.exists:</span><br><span class="line">          <span class="keyword">case</span> OpCode.getData:</span><br><span class="line">          <span class="keyword">case</span> OpCode.getACL:</span><br><span class="line">          <span class="keyword">case</span> OpCode.getChildren:</span><br><span class="line">          <span class="keyword">case</span> OpCode.getChildren2:</span><br><span class="line">          <span class="keyword">case</span> OpCode.ping:</span><br><span class="line">          <span class="keyword">case</span> OpCode.setWatches:</span><br><span class="line">              zks.sessionTracker.checkSession(request.sessionId,</span><br><span class="line">                      request.getOwner());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              LOG.warn(<span class="string">&quot;unknown type &quot;</span> + request.type);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">              request.hdr.setType(OpCode.error);</span><br><span class="line">              request.txn = <span class="keyword">new</span> ErrorTxn(e.code().intValue());</span><br><span class="line">          &#125;</span><br><span class="line">          LOG.info(<span class="string">&quot;Got user-level KeeperException when processing &quot;</span></span><br><span class="line">                  + request.toString()</span><br><span class="line">                  + <span class="string">&quot; Error Path:&quot;</span> + e.getPath()</span><br><span class="line">                  + <span class="string">&quot; Error:&quot;</span> + e.getMessage());</span><br><span class="line">          request.setException(e);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="comment">// log at error level as we are returning a marshalling</span></span><br><span class="line">          <span class="comment">// error to the user</span></span><br><span class="line">          LOG.error(<span class="string">&quot;Failed to process &quot;</span> + request, e);</span><br><span class="line"></span><br><span class="line">          StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">          ByteBuffer bb = request.request;</span><br><span class="line">          <span class="keyword">if</span>(bb != <span class="keyword">null</span>)&#123;</span><br><span class="line">              bb.rewind();</span><br><span class="line">              <span class="keyword">while</span> (bb.hasRemaining()) &#123;</span><br><span class="line">                  sb.append(Integer.toHexString(bb.get() &amp; <span class="number">0xff</span>));</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              sb.append(<span class="string">&quot;request buffer is null&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          LOG.error(<span class="string">&quot;Dumping request buffer: 0x&quot;</span> + sb.toString());</span><br><span class="line">          <span class="keyword">if</span> (request.hdr != <span class="keyword">null</span>) &#123;</span><br><span class="line">              request.hdr.setType(OpCode.error);</span><br><span class="line">              request.txn = <span class="keyword">new</span> ErrorTxn(Code.MARSHALLINGERROR.intValue());</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      request.zxid = zks.getZxid();</span><br><span class="line">      nextProcessor.processRequest(request);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>前面的N行代码都是根据当前的OP 类型进行判断和做相应的处理, 这个方法中的最后一行中, 我们会看到</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nextProcessor.processRequest(request);</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="SyncRequestProcessor-processRequest"><a href="#SyncRequestProcessor-processRequest" class="headerlink" title="SyncRequestProcessor. processRequest"></a>SyncRequestProcessor. processRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(Request request)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// request.addRQRec(&quot;&gt;sync&quot;);</span></span><br><span class="line">      queuedRequests.add(request);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的代码也是一样, 基于差异化操作, 把请求添加到queuedRequests中, 我们继续在当前类中找到run方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">int</span> logCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// we do this in an attempt to ensure that not all of the servers</span></span><br><span class="line">           <span class="comment">// in the ensemble take a snapshot at the same time</span></span><br><span class="line">           setRandRoll(r.nextInt(snapCount/<span class="number">2</span>));</span><br><span class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">               Request si = <span class="keyword">null</span>;</span><br><span class="line">               <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                   si = queuedRequests.take();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   si = queuedRequests.poll();</span><br><span class="line">                   <span class="keyword">if</span> (si == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       flush(toFlush);</span><br><span class="line">                       <span class="keyword">continue</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (si == requestOfDeath) &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (si != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// track the number of records written to the log</span></span><br><span class="line">                   <span class="keyword">if</span> (zks.getZKDatabase().append(si)) &#123;</span><br><span class="line">                       logCount++;</span><br><span class="line">                       <span class="keyword">if</span> (logCount &gt; (snapCount / <span class="number">2</span> + randRoll)) &#123;</span><br><span class="line">                           setRandRoll(r.nextInt(snapCount/<span class="number">2</span>));</span><br><span class="line">                           <span class="comment">// roll the log</span></span><br><span class="line">                           zks.getZKDatabase().rollLog();</span><br><span class="line">                           <span class="comment">// take a snapshot</span></span><br><span class="line">                           <span class="keyword">if</span> (snapInProcess != <span class="keyword">null</span> &amp;&amp; snapInProcess.isAlive()) &#123;</span><br><span class="line">                               LOG.warn(<span class="string">&quot;Too busy to snap, skipping&quot;</span>);</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               snapInProcess = <span class="keyword">new</span> ZooKeeperThread(<span class="string">&quot;Snapshot Thread&quot;</span>) &#123;</span><br><span class="line">                                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                           <span class="keyword">try</span> &#123;</span><br><span class="line">                                               zks.takeSnapshot();</span><br><span class="line">                                           &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">                                               LOG.warn(<span class="string">&quot;Unexpected exception&quot;</span>, e);</span><br><span class="line">                                           &#125;</span><br><span class="line">                                       &#125;</span><br><span class="line">                                   &#125;;</span><br><span class="line">                               snapInProcess.start();</span><br><span class="line">                           &#125;</span><br><span class="line">                           logCount = <span class="number">0</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (toFlush.isEmpty()) &#123;</span><br><span class="line">                       <span class="comment">// optimization for read heavy workloads</span></span><br><span class="line">                       <span class="comment">// iff this is a read, and there are no pending</span></span><br><span class="line">                       <span class="comment">// flushes (writes), then just pass this to the next</span></span><br><span class="line">                       <span class="comment">// processor</span></span><br><span class="line">                       <span class="keyword">if</span> (nextProcessor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           nextProcessor.processRequest(si);</span><br><span class="line">                           <span class="keyword">if</span> (nextProcessor <span class="keyword">instanceof</span> Flushable) &#123;</span><br><span class="line">                               ((Flushable)nextProcessor).flush();</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">continue</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   toFlush.add(si);</span><br><span class="line">                   <span class="keyword">if</span> (toFlush.size() &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                       flush(toFlush);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">           handleException(<span class="keyword">this</span>.getName(), t);</span><br><span class="line">           running = <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       LOG.info(<span class="string">&quot;SyncRequestProcessor exited!&quot;</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="FinalRequestProcessor-processRequest"><a href="#FinalRequestProcessor-processRequest" class="headerlink" title="FinalRequestProcessor. processRequest"></a>FinalRequestProcessor. processRequest</h4><p> FinalRequestProcessor. processRequest  方法根据request方法中的操作更新内容中session 信息或者znode数据。 </p>
<p>这块代码又300行, 就不全部贴出来了, 我们直接定位到关键代码，根据客户端的OP 类型找到如下代码: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> OpCode.exists: &#123;</span><br><span class="line">               lastOp = <span class="string">&quot;EXIS&quot;</span>;</span><br><span class="line">               <span class="comment">// TODO we need to figure out the security requirement for this!</span></span><br><span class="line">               <span class="comment">// 反序列化(将byteBuffer反序列化为ExistsRequest, 这个就是我们在客户端请求的时候传过来的request对象)</span></span><br><span class="line">               ExistsRequest existsRequest = <span class="keyword">new</span> ExistsRequest();</span><br><span class="line">               ByteBufferInputStream.byteBuffer2Record(request.request,</span><br><span class="line">                       existsRequest);</span><br><span class="line">               String path = existsRequest.getPath();</span><br><span class="line">               <span class="keyword">if</span> (path.indexOf(<span class="string">&#x27;\0&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.BadArgumentsException();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 终于找到一个很关键的代码, 判断请求的getwatch 是否存在, 如果存在,则传入 cnxn</span></span><br><span class="line">               <span class="comment">// 对于exits 请求, 需要监听data 变化事件, 添加watch</span></span><br><span class="line">               Stat stat = zks.getZKDatabase().statNode(path, existsRequest</span><br><span class="line">                       .getWatch() ? cnxn : <span class="keyword">null</span>);</span><br><span class="line">               <span class="comment">// 在服务端内存数据库中根据路径得到结果进行封装, 设置为ExistsResponse</span></span><br><span class="line">               rsp = <span class="keyword">new</span> ExistsResponse(stat);</span><br><span class="line">               <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>



<h2 id="客户端接收服务端处理完成的响应"><a href="#客户端接收服务端处理完成的响应" class="headerlink" title="客户端接收服务端处理完成的响应"></a>客户端接收服务端处理完成的响应</h2><p> ClientCnxnSocketNIO.doIO </p>
<p>服务端处理完成后, 会通过 NIOServerCnxn.sendResponse  发送返回的响应信息, 客户端会在 ClientCnxnSocketNIO.doIO  接收服务端的返回. 注意一下  SendThread.readResponse ,接收服务端的信息机进行读取. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doIO</span><span class="params">(List&lt;Packet&gt; pendingQueue, LinkedList&lt;Packet&gt; outgoingQueue, ClientCnxn cnxn)</span></span></span><br><span class="line"><span class="function">     <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">       SocketChannel sock = (SocketChannel) sockKey.channel();</span><br><span class="line">       <span class="keyword">if</span> (sock == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Socket is null!&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (sockKey.isReadable()) &#123;</span><br><span class="line">           <span class="keyword">int</span> rc = sock.read(incomingBuffer);</span><br><span class="line">           <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> EndOfStreamException(</span><br><span class="line">                       <span class="string">&quot;Unable to read additional data from server sessionid 0x&quot;</span></span><br><span class="line">                               + Long.toHexString(sessionId)</span><br><span class="line">                               + <span class="string">&quot;, likely server has closed socket&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (!incomingBuffer.hasRemaining()) &#123;</span><br><span class="line">               incomingBuffer.flip();</span><br><span class="line">               <span class="keyword">if</span> (incomingBuffer == lenBuffer) &#123;</span><br><span class="line">                   recvCount++;</span><br><span class="line">                   readLength();</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">                   readConnectResult();</span><br><span class="line">                   enableRead();</span><br><span class="line">                   <span class="keyword">if</span> (findSendablePacket(outgoingQueue,</span><br><span class="line">                           cnxn.sendThread.clientTunneledAuthenticationInProgress()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="comment">// Since SASL authentication has completed (if client is configured to do so),</span></span><br><span class="line">                       <span class="comment">// outgoing packets waiting in the outgoingQueue can now be sent.</span></span><br><span class="line">                       enableWrite();</span><br><span class="line">                   &#125;</span><br><span class="line">                   lenBuffer.clear();</span><br><span class="line">                   incomingBuffer = lenBuffer;</span><br><span class="line">                   updateLastHeard();</span><br><span class="line">                   initialized = <span class="keyword">true</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   sendThread.readResponse(incomingBuffer);</span><br><span class="line">                   lenBuffer.clear();</span><br><span class="line">                   incomingBuffer = lenBuffer;</span><br><span class="line">                   updateLastHeard();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (sockKey.isWritable()) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span>(outgoingQueue) &#123;</span><br><span class="line">               Packet p = findSendablePacket(outgoingQueue,</span><br><span class="line">                       cnxn.sendThread.clientTunneledAuthenticationInProgress());</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   updateLastSend();</span><br><span class="line">                   <span class="comment">// If we already started writing p, p.bb will already exist</span></span><br><span class="line">                   <span class="keyword">if</span> (p.bb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="keyword">if</span> ((p.requestHeader != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                               (p.requestHeader.getType() != OpCode.ping) &amp;&amp;</span><br><span class="line">                               (p.requestHeader.getType() != OpCode.auth)) &#123;</span><br><span class="line">                           p.requestHeader.setXid(cnxn.getXid());</span><br><span class="line">                       &#125;</span><br><span class="line">                       p.createBB();</span><br><span class="line">                   &#125;</span><br><span class="line">                   sock.write(p.bb);</span><br><span class="line">                   <span class="keyword">if</span> (!p.bb.hasRemaining()) &#123;</span><br><span class="line">                       sentCount++;</span><br><span class="line">                       outgoingQueue.removeFirstOccurrence(p);</span><br><span class="line">                       <span class="keyword">if</span> (p.requestHeader != <span class="keyword">null</span></span><br><span class="line">                               &amp;&amp; p.requestHeader.getType() != OpCode.ping</span><br><span class="line">                               &amp;&amp; p.requestHeader.getType() != OpCode.auth) &#123;</span><br><span class="line">                           <span class="keyword">synchronized</span> (pendingQueue) &#123;</span><br><span class="line">                               pendingQueue.add(p);</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (outgoingQueue.isEmpty()) &#123;</span><br><span class="line">                   <span class="comment">// No more packets to send: turn off write interest flag.</span></span><br><span class="line">                   <span class="comment">// Will be turned on later by a later call to enableWrite(),</span></span><br><span class="line">                   <span class="comment">// from within ZooKeeperSaslClient (if client is configured</span></span><br><span class="line">                   <span class="comment">// to attempt SASL authentication), or in either doIO() or</span></span><br><span class="line">                   <span class="comment">// in doTransport() if not.</span></span><br><span class="line">                   disableWrite();</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!initialized &amp;&amp; p != <span class="keyword">null</span> &amp;&amp; !p.bb.hasRemaining()) &#123;</span><br><span class="line">                   <span class="comment">// On initial connection, write the complete connect request</span></span><br><span class="line">                   <span class="comment">// packet, but then disable further writes until after</span></span><br><span class="line">                   <span class="comment">// receiving a successful connection response.  If the</span></span><br><span class="line">                   <span class="comment">// session is expired, then the server sends the expiration</span></span><br><span class="line">                   <span class="comment">// response and immediately closes its end of the socket.  If</span></span><br><span class="line">                   <span class="comment">// the client is simultaneously writing on its end, then the</span></span><br><span class="line">                   <span class="comment">// TCP stack may choose to abort with RST, in which case the</span></span><br><span class="line">                   <span class="comment">// client would never receive the session expired event.  See</span></span><br><span class="line">                   <span class="comment">// http://docs.oracle.com/javase/6/docs/technotes/guides/net/articles/connection_release.html</span></span><br><span class="line">                   disableWrite();</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// Just in case</span></span><br><span class="line">                   enableWrite();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="SendThread-readResponse"><a href="#SendThread-readResponse" class="headerlink" title="SendThread. readResponse"></a>SendThread. readResponse</h4><p>这个方法里面主要流程如下: </p>
<ol>
<li>读取head, 如果其xid ==2, 表明是一个ping 的reponse,return</li>
<li>如果xid == 4,表明是一个 AuthPacket 的 response return </li>
<li>如果xid ==1, 表明是一个 notification , 此时要继续读取并构造一个event, 通过 EventThread.queueEvent , 并return.</li>
</ol>
<p>其他情况下:</p>
<p>从 pendingQueue  中拿出一个 Packet，校验后更新 packet 信息. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">           ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(</span><br><span class="line">                   incomingBuffer);</span><br><span class="line">           BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">           ReplyHeader replyHdr = <span class="keyword">new</span> ReplyHeader();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 反序列化header</span></span><br><span class="line">           replyHdr.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">2</span>) &#123;</span><br><span class="line">               <span class="comment">// -2 is the xid for pings</span></span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got ping response for sessionid: 0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId)</span><br><span class="line">                           + <span class="string">&quot; after &quot;</span></span><br><span class="line">                           + ((System.nanoTime() - lastPingSentNs) / <span class="number">1000000</span>)</span><br><span class="line">                           + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">4</span>) &#123;</span><br><span class="line">               <span class="comment">// -4 is the xid for AuthPacket</span></span><br><span class="line">               <span class="keyword">if</span>(replyHdr.getErr() == KeeperException.Code.AUTHFAILED.intValue()) &#123;</span><br><span class="line">                   state = States.AUTH_FAILED;</span><br><span class="line">                   eventThread.queueEvent( <span class="keyword">new</span> WatchedEvent(Watcher.Event.EventType.None,</span><br><span class="line">                           Watcher.Event.KeeperState.AuthFailed, <span class="keyword">null</span>) );</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got auth sessionid:0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId));</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 表示当前的消息类型为一个notification(意味着是服务端的一个响应事件)</span></span><br><span class="line">           <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">               <span class="comment">// -1 means notification</span></span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got notification sessionid:0x&quot;</span></span><br><span class="line">                       + Long.toHexString(sessionId));</span><br><span class="line">               &#125;</span><br><span class="line">               WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">               <span class="comment">// 反序列化响应信息</span></span><br><span class="line">               event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// convert from a server path to a client path</span></span><br><span class="line">               <span class="keyword">if</span> (chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   String serverPath = event.getPath();</span><br><span class="line">                   <span class="keyword">if</span>(serverPath.compareTo(chrootPath)==<span class="number">0</span>)</span><br><span class="line">                       event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                   <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; chrootPath.length())</span><br><span class="line">                       event.setPath(serverPath.substring(chrootPath.length()));</span><br><span class="line">                   <span class="keyword">else</span> &#123;</span><br><span class="line">                   	LOG.warn(<span class="string">&quot;Got server path &quot;</span> + event.getPath()</span><br><span class="line">                   			+ <span class="string">&quot; which is too short for chroot path &quot;</span></span><br><span class="line">                   			+ chrootPath);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got &quot;</span> + we + <span class="string">&quot; for sessionid 0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId));</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               eventThread.queueEvent( we );</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If SASL authentication is currently in progress, construct and</span></span><br><span class="line">           <span class="comment">// send a response packet immediately, rather than queuing a</span></span><br><span class="line">           <span class="comment">// response as with other packets.</span></span><br><span class="line">           <span class="keyword">if</span> (clientTunneledAuthenticationInProgress()) &#123;</span><br><span class="line">               GetSASLRequest request = <span class="keyword">new</span> GetSASLRequest();</span><br><span class="line">               request.deserialize(bbia,<span class="string">&quot;token&quot;</span>);</span><br><span class="line">               zooKeeperSaslClient.respondToServer(request.getToken(),</span><br><span class="line">                 ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           Packet packet;</span><br><span class="line">           <span class="keyword">synchronized</span> (pendingQueue) &#123;</span><br><span class="line">               <span class="keyword">if</span> (pendingQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Nothing in the queue, but got &quot;</span></span><br><span class="line">                           + replyHdr.getXid());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 因为当前的数据包已经收到了响应,所以将他从pendingQueue 中移除了.</span></span><br><span class="line">               packet = pendingQueue.remove();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Since requests are processed in order, we better get a response</span></span><br><span class="line"><span class="comment">            * to the first request!</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">// 校验 数据包信息, 校验成功后将数据包信息进行更新(替换为服务端信息)</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (packet.requestHeader.getXid() != replyHdr.getXid()) &#123;</span><br><span class="line">                   packet.replyHeader.setErr(</span><br><span class="line">                           KeeperException.Code.CONNECTIONLOSS.intValue());</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Xid out of order. Got Xid &quot;</span></span><br><span class="line">                           + replyHdr.getXid() + <span class="string">&quot; with err &quot;</span> +</span><br><span class="line">                           + replyHdr.getErr() +</span><br><span class="line">                           <span class="string">&quot; expected Xid &quot;</span></span><br><span class="line">                           + packet.requestHeader.getXid()</span><br><span class="line">                           + <span class="string">&quot; for a packet with details: &quot;</span></span><br><span class="line">                           + packet );</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               packet.replyHeader.setXid(replyHdr.getXid());</span><br><span class="line">               packet.replyHeader.setErr(replyHdr.getErr());</span><br><span class="line">               packet.replyHeader.setZxid(replyHdr.getZxid());</span><br><span class="line">               <span class="keyword">if</span> (replyHdr.getZxid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   lastZxid = replyHdr.getZxid();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (packet.response != <span class="keyword">null</span> &amp;&amp; replyHdr.getErr() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// 获取服务端的响应, 反序列化之后设置到packet.response 属性中, 所以我们可以在exits方法的最后一行中通过packet.response 拿到该请求的返回结果</span></span><br><span class="line">                   packet.response.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Reading reply sessionid:0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId) + <span class="string">&quot;, packet:: &quot;</span> + packet);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="comment">// 最后调用finishPacket 方法完成处理</span></span><br><span class="line">               finishPacket(packet);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h4 id="finishPacket-方法"><a href="#finishPacket-方法" class="headerlink" title="finishPacket 方法"></a>finishPacket 方法</h4><p>主要功能是把从packet 中取出对应的Watcher 注册到  ZKWatchManager  中. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishPacket</span><span class="params">(Packet p)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (p.watchRegistration != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// 将事件注册到 zkwatchermanage 中</span></span><br><span class="line">           <span class="comment">// watchRegistration, 在组装请求的时候,我们初始化了这个对象, 把 watchRegistration 子类里面的</span></span><br><span class="line">           <span class="comment">// watcher 实例放到了ZKWatcherMananage 的exists watches 中存储起来</span></span><br><span class="line">           p.watchRegistration.register(p.replyHeader.getErr());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// cb 就是AsnycCallback，如果为null, 表明是同步调用地方接口,不需要异步回调, 因为直接notifyAll</span></span><br><span class="line">       <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (p) &#123;</span><br><span class="line">               p.finished = <span class="keyword">true</span>;</span><br><span class="line">               p.notifyAll();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           p.finished = <span class="keyword">true</span>;</span><br><span class="line">           eventThread.queuePacket(p);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h4 id="watchRegistration-register"><a href="#watchRegistration-register" class="headerlink" title="watchRegistration.register"></a>watchRegistration.register</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">int</span> rc)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (shouldAddWatch(rc)) &#123;</span><br><span class="line">              <span class="comment">// 通过子类的实现取得 ZKWatchManager 中的 existsWatches</span></span><br><span class="line">              Map&lt;String, Set&lt;Watcher&gt;&gt; watches = getWatches(rc);</span><br><span class="line">              <span class="keyword">synchronized</span>(watches) &#123;</span><br><span class="line">                  Set&lt;Watcher&gt; watchers = watches.get(clientPath);</span><br><span class="line">                  <span class="keyword">if</span> (watchers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      watchers = <span class="keyword">new</span> HashSet&lt;Watcher&gt;();</span><br><span class="line">                      watches.put(clientPath, watchers);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">// 将watcher 对象放到到 ZKWatchManager 中的 existsWatches 里面</span></span><br><span class="line">                  watchers.add(watcher);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>



<p>下面这段代码是客户端存储watcher的几个map 集合, 分别对应三种注册监听事件. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ZKWatchManager</span> <span class="keyword">implements</span> <span class="title">ClientWatchManager</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;Watcher&gt;&gt; dataWatches =</span><br><span class="line">          <span class="keyword">new</span> HashMap&lt;String, Set&lt;Watcher&gt;&gt;();</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;Watcher&gt;&gt; existWatches =</span><br><span class="line">          <span class="keyword">new</span> HashMap&lt;String, Set&lt;Watcher&gt;&gt;();</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Set&lt;Watcher&gt;&gt; childWatches =</span><br><span class="line">          <span class="keyword">new</span> HashMap&lt;String, Set&lt;Watcher&gt;&gt;();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总的来说, 当使用zookeeper 构造方法或者使用getData、exits和getChildren 三个接口来向zookeeper 服务器注册watcher 的时候, 首先将此消息传递给服务端, 传递成功后, 服务端会通知客户端, 然后客户端将该路径和watcher 对应关系存储起来备用. </p>
<h4 id="EventThread-queuePacket"><a href="#EventThread-queuePacket" class="headerlink" title="EventThread.queuePacket()"></a>EventThread.queuePacket()</h4><p> finishPacket  方法最终会调用 EventThread.queuePacket()    , 将当前的数据包添加到等待事件通知的队列中. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queuePacket</span><span class="params">(Packet packet)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (wasKilled) &#123;</span><br><span class="line">           <span class="keyword">synchronized</span> (waitingEvents) &#123;</span><br><span class="line">              <span class="keyword">if</span> (isRunning) waitingEvents.add(packet);</span><br><span class="line">              <span class="keyword">else</span> processEvent(packet);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           waitingEvents.add(packet);</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h2><p>通过那么长的说明, 只是为了清晰的说明事件的注册流程, 最终的触发, 还得需要通过事务性操作来完成. </p>
<p>在我们最开始的案例中,通过如下代码来完成事件的触发: </p>
<blockquote>
<p>zooKeeper.setData(path, “1”.getBytes(), -1);</p>
</blockquote>
<p>前面的客户端和服务端对戒的流程就不重复讲解了, 交互流程是一样的, 唯一的差别就是在于事件触发了. </p>
<h4 id="服务端的事件响应-DataTree-setData"><a href="#服务端的事件响应-DataTree-setData" class="headerlink" title="服务端的事件响应  DataTree.setData()"></a>服务端的事件响应  DataTree.setData()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stat <span class="title">setData</span><span class="params">(String path, <span class="keyword">byte</span> data[], <span class="keyword">int</span> version, <span class="keyword">long</span> zxid,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">long</span> time)</span> <span class="keyword">throws</span> KeeperException.NoNodeException </span>&#123;</span><br><span class="line">       Stat s = <span class="keyword">new</span> Stat();</span><br><span class="line">       DataNode n = nodes.get(path);</span><br><span class="line">       <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> KeeperException.NoNodeException();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">byte</span> lastdata[] = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">synchronized</span> (n) &#123;</span><br><span class="line">           lastdata = n.data;</span><br><span class="line">           n.data = data;</span><br><span class="line">           n.stat.setMtime(time);</span><br><span class="line">           n.stat.setMzxid(zxid);</span><br><span class="line">           n.stat.setVersion(version);</span><br><span class="line">           n.copyStat(s);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// now update if the path is in a quota subtree.</span></span><br><span class="line">       String lastPrefix;</span><br><span class="line">       <span class="keyword">if</span>((lastPrefix = getMaxPrefixWithQuota(path)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">this</span>.updateBytes(lastPrefix, (data == <span class="keyword">null</span> ? <span class="number">0</span> : data.length)</span><br><span class="line">             - (lastdata == <span class="keyword">null</span> ? <span class="number">0</span> : lastdata.length));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 触发对应节点的NodeDataChanged 事件</span></span><br><span class="line">       dataWatches.triggerWatch(path, EventType.NodeDataChanged);</span><br><span class="line">       <span class="keyword">return</span> s;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h4 id="WatcherManager-triggerWatch"><a href="#WatcherManager-triggerWatch" class="headerlink" title="WatcherManager. triggerWatch"></a>WatcherManager. triggerWatch</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">triggerWatch</span><span class="params">(String path, EventType type)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> triggerWatch(path, type, <span class="keyword">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">triggerWatch</span><span class="params">(String path, EventType type, Set&lt;Watcher&gt; supress)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 根据事件类型、连接状态、节点路径创建WatchedEvent</span></span><br><span class="line">       WatchedEvent e = <span class="keyword">new</span> WatchedEvent(type,</span><br><span class="line">               KeeperState.SyncConnected, path);</span><br><span class="line">       HashSet&lt;Watcher&gt; watchers;</span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="comment">// 从watcher 中移除path, 并返回其对应的watcher 集合.</span></span><br><span class="line">           watchers = watchTable.remove(path);</span><br><span class="line">           <span class="keyword">if</span> (watchers == <span class="keyword">null</span> || watchers.isEmpty()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                   ZooTrace.logTraceMessage(LOG,</span><br><span class="line">                           ZooTrace.EVENT_DELIVERY_TRACE_MASK,</span><br><span class="line">                           <span class="string">&quot;No watchers for &quot;</span> + path);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 遍历watcher 集合</span></span><br><span class="line">           <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">               <span class="comment">// 根据watcher 从watcher 表中取出路径集合</span></span><br><span class="line">               HashSet&lt;String&gt; paths = watch2Paths.get(w);</span><br><span class="line">               <span class="keyword">if</span> (paths != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// 移除路径</span></span><br><span class="line">                   paths.remove(path);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//  遍历watcher 集合</span></span><br><span class="line">       <span class="keyword">for</span> (Watcher w : watchers) &#123;</span><br><span class="line">           <span class="keyword">if</span> (supress != <span class="keyword">null</span> &amp;&amp; supress.contains(w)) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           w.process(e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> watchers;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h4 id="w-process-e"><a href="#w-process-e" class="headerlink" title="w.process(e);"></a>w.process(e);</h4><p>还记得我们在服务端绑定事件的时候，watcher  绑定的是什么吗? 是 ServerCnxn，  所以w.process(e); , 其实就是调用的是 ServerCnxn  的process 方法, 而ServerCnxn 又是一个抽象方法, 分别是 NIOServerCnxn 和  NettyServerCnxn。那接下来我们扒开  NettyServerCnxn这个类的process 方法看看究竟. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">      ReplyHeader h = <span class="keyword">new</span> ReplyHeader(-<span class="number">1</span>, -<span class="number">1L</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">          ZooTrace.logTraceMessage(LOG, ZooTrace.EVENT_DELIVERY_TRACE_MASK,</span><br><span class="line">                                   <span class="string">&quot;Deliver event &quot;</span> + event + <span class="string">&quot; to 0x&quot;</span></span><br><span class="line">                                   + Long.toHexString(<span class="keyword">this</span>.sessionId)</span><br><span class="line">                                   + <span class="string">&quot; through &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Convert WatchedEvent to a type that can be sent over the wire</span></span><br><span class="line">      WatcherEvent e = event.getWrapper();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 这个地方发送了一个事件,事件对象为WatchedEvent</span></span><br><span class="line">          sendResponse(h, e, <span class="string">&quot;notification&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e1) &#123;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Problem sending to &quot;</span> + getRemoteSocketAddress(), e1);</span><br><span class="line">          &#125;</span><br><span class="line">          close();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>那接下来, 客户端会受到这个response, 触发SendThread.readResponse  方法</p>
<h3 id="客户端处理事件响应"><a href="#客户端处理事件响应" class="headerlink" title="客户端处理事件响应"></a>客户端处理事件响应</h3><h4 id="SendThread-readResponse-1"><a href="#SendThread-readResponse-1" class="headerlink" title="SendThread.readResponse"></a>SendThread.readResponse</h4><p>watcher.materializwatcher.materializ这块代码已经贴过了, 我们只挑选当前流程的代码进行讲解, 按照我们前面讲到的,  notifacation  通知消息的xid 为-1, u意味着直接找到-1的判断进行分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readResponse</span><span class="params">(ByteBuffer incomingBuffer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">           ByteBufferInputStream bbis = <span class="keyword">new</span> ByteBufferInputStream(</span><br><span class="line">                   incomingBuffer);</span><br><span class="line">           BinaryInputArchive bbia = BinaryInputArchive.getArchive(bbis);</span><br><span class="line">           ReplyHeader replyHdr = <span class="keyword">new</span> ReplyHeader();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 反序列化header</span></span><br><span class="line">           replyHdr.deserialize(bbia, <span class="string">&quot;header&quot;</span>);</span><br><span class="line">           <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">2</span>) &#123;</span><br><span class="line">               <span class="comment">// -2 is the xid for pings</span></span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got ping response for sessionid: 0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId)</span><br><span class="line">                           + <span class="string">&quot; after &quot;</span></span><br><span class="line">                           + ((System.nanoTime() - lastPingSentNs) / <span class="number">1000000</span>)</span><br><span class="line">                           + <span class="string">&quot;ms&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">4</span>) &#123;</span><br><span class="line">               <span class="comment">// -4 is the xid for AuthPacket</span></span><br><span class="line">               <span class="keyword">if</span>(replyHdr.getErr() == KeeperException.Code.AUTHFAILED.intValue()) &#123;</span><br><span class="line">                   state = States.AUTH_FAILED;</span><br><span class="line">                   eventThread.queueEvent( <span class="keyword">new</span> WatchedEvent(Watcher.Event.EventType.None,</span><br><span class="line">                           Watcher.Event.KeeperState.AuthFailed, <span class="keyword">null</span>) );</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got auth sessionid:0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId));</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 表示当前的消息类型为一个notification(意味着是服务端的一个响应事件)</span></span><br><span class="line">           <span class="keyword">if</span> (replyHdr.getXid() == -<span class="number">1</span>) &#123;</span><br><span class="line">               <span class="comment">// -1 means notification</span></span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got notification sessionid:0x&quot;</span></span><br><span class="line">                       + Long.toHexString(sessionId));</span><br><span class="line">               &#125;</span><br><span class="line">               WatcherEvent event = <span class="keyword">new</span> WatcherEvent();</span><br><span class="line">               <span class="comment">// 反序列化响应信息</span></span><br><span class="line">               event.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// convert from a server path to a client path</span></span><br><span class="line">               <span class="keyword">if</span> (chrootPath != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   String serverPath = event.getPath();</span><br><span class="line">                   <span class="keyword">if</span>(serverPath.compareTo(chrootPath)==<span class="number">0</span>)</span><br><span class="line">                       event.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                   <span class="keyword">else</span> <span class="keyword">if</span> (serverPath.length() &gt; chrootPath.length())</span><br><span class="line">                       event.setPath(serverPath.substring(chrootPath.length()));</span><br><span class="line">                   <span class="keyword">else</span> &#123;</span><br><span class="line">                   	LOG.warn(<span class="string">&quot;Got server path &quot;</span> + event.getPath()</span><br><span class="line">                   			+ <span class="string">&quot; which is too short for chroot path &quot;</span></span><br><span class="line">                   			+ chrootPath);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               WatchedEvent we = <span class="keyword">new</span> WatchedEvent(event);</span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Got &quot;</span> + we + <span class="string">&quot; for sessionid 0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId));</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               eventThread.queueEvent( we );</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If SASL authentication is currently in progress, construct and</span></span><br><span class="line">           <span class="comment">// send a response packet immediately, rather than queuing a</span></span><br><span class="line">           <span class="comment">// response as with other packets.</span></span><br><span class="line">           <span class="keyword">if</span> (clientTunneledAuthenticationInProgress()) &#123;</span><br><span class="line">               GetSASLRequest request = <span class="keyword">new</span> GetSASLRequest();</span><br><span class="line">               request.deserialize(bbia,<span class="string">&quot;token&quot;</span>);</span><br><span class="line">               zooKeeperSaslClient.respondToServer(request.getToken(),</span><br><span class="line">                 ClientCnxn.<span class="keyword">this</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           Packet packet;</span><br><span class="line">           <span class="keyword">synchronized</span> (pendingQueue) &#123;</span><br><span class="line">               <span class="keyword">if</span> (pendingQueue.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Nothing in the queue, but got &quot;</span></span><br><span class="line">                           + replyHdr.getXid());</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 因为当前的数据包已经收到了响应,所以将他从pendingQueue 中移除了.</span></span><br><span class="line">               packet = pendingQueue.remove();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/*</span></span><br><span class="line"><span class="comment">            * Since requests are processed in order, we better get a response</span></span><br><span class="line"><span class="comment">            * to the first request!</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="comment">// 校验 数据包信息, 校验成功后将数据包信息进行更新(替换为服务端信息)</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (packet.requestHeader.getXid() != replyHdr.getXid()) &#123;</span><br><span class="line">                   packet.replyHeader.setErr(</span><br><span class="line">                           KeeperException.Code.CONNECTIONLOSS.intValue());</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Xid out of order. Got Xid &quot;</span></span><br><span class="line">                           + replyHdr.getXid() + <span class="string">&quot; with err &quot;</span> +</span><br><span class="line">                           + replyHdr.getErr() +</span><br><span class="line">                           <span class="string">&quot; expected Xid &quot;</span></span><br><span class="line">                           + packet.requestHeader.getXid()</span><br><span class="line">                           + <span class="string">&quot; for a packet with details: &quot;</span></span><br><span class="line">                           + packet );</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               packet.replyHeader.setXid(replyHdr.getXid());</span><br><span class="line">               packet.replyHeader.setErr(replyHdr.getErr());</span><br><span class="line">               packet.replyHeader.setZxid(replyHdr.getZxid());</span><br><span class="line">               <span class="keyword">if</span> (replyHdr.getZxid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   lastZxid = replyHdr.getZxid();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (packet.response != <span class="keyword">null</span> &amp;&amp; replyHdr.getErr() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// 获取服务端的响应, 反序列化之后设置到packet.response 属性中, 所以我们可以在exits方法的最后一行中通过packet.response 拿到该请求的返回结果</span></span><br><span class="line">                   packet.response.deserialize(bbia, <span class="string">&quot;response&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                   LOG.debug(<span class="string">&quot;Reading reply sessionid:0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId) + <span class="string">&quot;, packet:: &quot;</span> + packet);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="comment">// 最后调用finishPacket 方法完成处理</span></span><br><span class="line">               finishPacket(packet);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>



<h4 id="eventThread-queueEvent"><a href="#eventThread-queueEvent" class="headerlink" title="eventThread.queueEvent"></a>eventThread.queueEvent</h4><p> SendThread  接受到服务端的通知事件, 会通过调用 EventThread  类的queueEvent 方法将事件传给 EventThread 线程, queueEvent 方法根据该通知事件, 从 ZKWatchManager  中取出所有相关的watcher, 如果获取到相应的watcher, 就会让watcher 移除失效. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">queueEvent</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (event.getType() == EventType.None</span><br><span class="line">                 &amp;&amp; sessionState == event.getState()) &#123;</span><br><span class="line">             <span class="comment">// 判断类型</span></span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         sessionState = event.getState();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// materialize the watchers based on the event</span></span><br><span class="line">         <span class="comment">// 封装 WatcherSetEventPair 对象, 添加到waitingEvents 队列中</span></span><br><span class="line">         WatcherSetEventPair pair = <span class="keyword">new</span> WatcherSetEventPair(</span><br><span class="line">                 watcher.materialize(event.getState(), event.getType(),</span><br><span class="line">                         event.getPath()),</span><br><span class="line">                         event);</span><br><span class="line">         <span class="comment">// queue the pair (watch set &amp; event) for later processing</span></span><br><span class="line">         waitingEvents.add(pair);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h4 id="watcher-materializ"><a href="#watcher-materializ" class="headerlink" title="watcher.materializ"></a>watcher.materializ</h4><p>通过  dataWatches 或者 existWatches 或者 childWatches 的 remove 取出对应的watch, 表明客户端watch 也是注册一次就移除. </p>
<p>同时需要根据 keeperState、eventType 和 path  返回应该被通知的watcher 集合. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Set&lt;Watcher&gt; <span class="title">materialize</span><span class="params">(Watcher.Event.KeeperState state,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       Watcher.Event.EventType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       String clientPath)</span></span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           Set&lt;Watcher&gt; result = <span class="keyword">new</span> HashSet&lt;Watcher&gt;();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">           <span class="keyword">case</span> None:</span><br><span class="line">               result.add(defaultWatcher);</span><br><span class="line">               <span class="keyword">boolean</span> clear = ClientCnxn.getDisableAutoResetWatch() &amp;&amp;</span><br><span class="line">                       state != Watcher.Event.KeeperState.SyncConnected;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">synchronized</span>(dataWatches) &#123;</span><br><span class="line">                   <span class="keyword">for</span>(Set&lt;Watcher&gt; ws: dataWatches.values()) &#123;</span><br><span class="line">                       result.addAll(ws);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (clear) &#123;</span><br><span class="line">                       dataWatches.clear();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">synchronized</span>(existWatches) &#123;</span><br><span class="line">                   <span class="keyword">for</span>(Set&lt;Watcher&gt; ws: existWatches.values()) &#123;</span><br><span class="line">                       result.addAll(ws);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (clear) &#123;</span><br><span class="line">                       existWatches.clear();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">synchronized</span>(childWatches) &#123;</span><br><span class="line">                   <span class="keyword">for</span>(Set&lt;Watcher&gt; ws: childWatches.values()) &#123;</span><br><span class="line">                       result.addAll(ws);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (clear) &#123;</span><br><span class="line">                       childWatches.clear();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> result;</span><br><span class="line">           <span class="keyword">case</span> NodeDataChanged:</span><br><span class="line">           <span class="keyword">case</span> NodeCreated:</span><br><span class="line">               <span class="keyword">synchronized</span> (dataWatches) &#123;</span><br><span class="line">                   addTo(dataWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">synchronized</span> (existWatches) &#123;</span><br><span class="line">                   addTo(existWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> NodeChildrenChanged:</span><br><span class="line">               <span class="keyword">synchronized</span> (childWatches) &#123;</span><br><span class="line">                   addTo(childWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">case</span> NodeDeleted:</span><br><span class="line">               <span class="keyword">synchronized</span> (dataWatches) &#123;</span><br><span class="line">                   addTo(dataWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// XXX This shouldn&#x27;t be needed, but just in case</span></span><br><span class="line">               <span class="keyword">synchronized</span> (existWatches) &#123;</span><br><span class="line">                   Set&lt;Watcher&gt; list = existWatches.remove(clientPath);</span><br><span class="line">                   <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       addTo(list, result);</span><br><span class="line">                       LOG.warn(<span class="string">&quot;We are triggering an exists watch for delete! Shouldn&#x27;t happen!&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">synchronized</span> (childWatches) &#123;</span><br><span class="line">                   addTo(childWatches.remove(clientPath), result);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               String msg = <span class="string">&quot;Unhandled watch event type &quot;</span> + type</span><br><span class="line">                   + <span class="string">&quot; with state &quot;</span> + state + <span class="string">&quot; on path &quot;</span> + clientPath;</span><br><span class="line">               LOG.error(msg);</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> result;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h4 id="waitingEvents-add"><a href="#waitingEvents-add" class="headerlink" title="waitingEvents.add"></a>waitingEvents.add</h4><p>最后一步, 接近真相了. </p>
<p>waitingEvents 是  EventThread  这个线程的祖寺啊队列, 很明显, 又是我们在第一步操作的时候实例化的一个线程. </p>
<p>从名字可以知道, waitingEvents  是一个待处理的watcher 的队列, EventThread   的run()  方法 会不断的从队列中取数据,交由  processEvent  方法处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            isRunning = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 从待处理的事件队列中取出事件</span></span><br><span class="line">               Object event = waitingEvents.take();</span><br><span class="line">               <span class="keyword">if</span> (event == eventOfDeath) &#123;</span><br><span class="line">                  wasKilled = <span class="keyword">true</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// 执行事件处理</span></span><br><span class="line">                  processEvent(event);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (wasKilled)</span><br><span class="line">                  <span class="keyword">synchronized</span> (waitingEvents) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (waitingEvents.isEmpty()) &#123;</span><br><span class="line">                        isRunning = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Event thread exiting due to interruption&quot;</span>, e);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">          LOG.info(<span class="string">&quot;EventThread shut down for session: 0x&#123;&#125;&quot;</span>,</span><br><span class="line">                   Long.toHexString(getSessionId()));</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<h4 id="processEvent"><a href="#processEvent" class="headerlink" title="processEvent"></a>processEvent</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 判断事件类型, </span></span><br><span class="line">            <span class="keyword">if</span> (event <span class="keyword">instanceof</span> WatcherSetEventPair) &#123;</span><br><span class="line">                <span class="comment">// each watcher will process the event</span></span><br><span class="line">                <span class="comment">// 得到WatcherSetEventPair</span></span><br><span class="line">                WatcherSetEventPair pair = (WatcherSetEventPair) event;</span><br><span class="line">                <span class="comment">// 拿到符合触发机制的所有watcher列表， 循环调用. </span></span><br><span class="line">                <span class="keyword">for</span> (Watcher watcher : pair.watchers) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 调用客户端的回调process</span></span><br><span class="line">                        watcher.process(pair.event);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        LOG.error(<span class="string">&quot;Error while calling watcher &quot;</span>, t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Packet p = (Packet) event;</span><br><span class="line">                <span class="keyword">int</span> rc = <span class="number">0</span>;</span><br><span class="line">                String clientPath = p.clientPath;</span><br><span class="line">                <span class="keyword">if</span> (p.replyHeader.getErr() != <span class="number">0</span>) &#123;</span><br><span class="line">                    rc = p.replyHeader.getErr();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (p.cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;Somehow a null cb got to EventThread!&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> ExistsResponse</span><br><span class="line">                        || p.response <span class="keyword">instanceof</span> SetDataResponse</span><br><span class="line">                        || p.response <span class="keyword">instanceof</span> SetACLResponse) &#123;</span><br><span class="line">                    StatCallback cb = (StatCallback) p.cb;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> ExistsResponse) &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx,</span><br><span class="line">                                    ((ExistsResponse) p.response)</span><br><span class="line">                                            .getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetDataResponse) &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx,</span><br><span class="line">                                    ((SetDataResponse) p.response)</span><br><span class="line">                                            .getStat());</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> SetACLResponse) &#123;</span><br><span class="line">                            cb.processResult(rc, clientPath, p.ctx,</span><br><span class="line">                                    ((SetACLResponse) p.response)</span><br><span class="line">                                            .getStat());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetDataResponse) &#123;</span><br><span class="line">                    DataCallback cb = (DataCallback) p.cb;</span><br><span class="line">                    GetDataResponse rsp = (GetDataResponse) p.response;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, rsp</span><br><span class="line">                                .getData(), rsp.getStat());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetACLResponse) &#123;</span><br><span class="line">                    ACLCallback cb = (ACLCallback) p.cb;</span><br><span class="line">                    GetACLResponse rsp = (GetACLResponse) p.response;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, rsp</span><br><span class="line">                                .getAcl(), rsp.getStat());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>,</span><br><span class="line">                                <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildrenResponse) &#123;</span><br><span class="line">                    ChildrenCallback cb = (ChildrenCallback) p.cb;</span><br><span class="line">                    GetChildrenResponse rsp = (GetChildrenResponse) p.response;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, rsp</span><br><span class="line">                                .getChildren());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> GetChildren2Response) &#123;</span><br><span class="line">                    Children2Callback cb = (Children2Callback) p.cb;</span><br><span class="line">                    GetChildren2Response rsp = (GetChildren2Response) p.response;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, rsp</span><br><span class="line">                                .getChildren(), rsp.getStat());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> CreateResponse) &#123;</span><br><span class="line">                    StringCallback cb = (StringCallback) p.cb;</span><br><span class="line">                    CreateResponse rsp = (CreateResponse) p.response;</span><br><span class="line">                    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx,</span><br><span class="line">                                (chrootPath == <span class="keyword">null</span></span><br><span class="line">                                        ? rsp.getPath()</span><br><span class="line">                                        : rsp.getPath()</span><br><span class="line">                                  .substring(chrootPath.length())));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p.response <span class="keyword">instanceof</span> MultiResponse) &#123;</span><br><span class="line">                        MultiCallback cb = (MultiCallback) p.cb;</span><br><span class="line">                        MultiResponse rsp = (MultiResponse) p.response;</span><br><span class="line">                        <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">                                List&lt;OpResult&gt; results = rsp.getResultList();</span><br><span class="line">                                <span class="keyword">int</span> newRc = rc;</span><br><span class="line">                                <span class="keyword">for</span> (OpResult result : results) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ErrorResult</span><br><span class="line">                                            &amp;&amp; KeeperException.Code.OK.intValue()</span><br><span class="line">                                                != (newRc = ((ErrorResult) result).getErr())) &#123;</span><br><span class="line">                                                <span class="keyword">break</span>;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                cb.processResult(newRc, clientPath, p.ctx, results);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                cb.processResult(rc, clientPath, p.ctx, <span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (p.cb <span class="keyword">instanceof</span> VoidCallback) &#123;</span><br><span class="line">                    VoidCallback cb = (VoidCallback) p.cb;</span><br><span class="line">                    cb.processResult(rc, clientPath, p.ctx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Caught unexpected throwable&quot;</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h2 id="服务端接受数据请求"><a href="#服务端接受数据请求" class="headerlink" title="服务端接受数据请求."></a>服务端接受数据请求.</h2><p>服务端收到的数据包应该在哪里呢? zookee 启动的时候, 通过下面的代码中构建了一个</p>
<blockquote>
<p> ServerCnxnFactory cnxnFactory = ServerCnxnFactory.createFactory();  </p>
</blockquote>
<p>ServerCnxnFactory  ,它实现类 Thread, 所以在启动的时候, 会在run 方法中不断循环接受客户端的请求进行分发. </p>
<h4 id="NIOServerCnxnFactory-run"><a href="#NIOServerCnxnFactory-run" class="headerlink" title="NIOServerCnxnFactory.run"></a>NIOServerCnxnFactory.run</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (!ss.socket().isClosed()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// 获取client 的连接请求</span></span><br><span class="line">              selector.select(<span class="number">1000</span>);</span><br><span class="line">              Set&lt;SelectionKey&gt; selected;</span><br><span class="line">              <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                  selected = selector.selectedKeys();</span><br><span class="line">              &#125;</span><br><span class="line">              ArrayList&lt;SelectionKey&gt; selectedList = <span class="keyword">new</span> ArrayList&lt;SelectionKey&gt;(</span><br><span class="line">                      selected);</span><br><span class="line">              Collections.shuffle(selectedList);</span><br><span class="line">              <span class="keyword">for</span> (SelectionKey k : selectedList) &#123;</span><br><span class="line">                  <span class="keyword">if</span> ((k.readyOps() &amp; SelectionKey.OP_ACCEPT) != <span class="number">0</span>) &#123;</span><br><span class="line">                      SocketChannel sc = ((ServerSocketChannel) k</span><br><span class="line">                              .channel()).accept();</span><br><span class="line">                      InetAddress ia = sc.socket().getInetAddress();</span><br><span class="line">                      <span class="keyword">int</span> cnxncount = getClientCnxnCount(ia);</span><br><span class="line">                      <span class="keyword">if</span> (maxClientCnxns &gt; <span class="number">0</span> &amp;&amp; cnxncount &gt;= maxClientCnxns)&#123;</span><br><span class="line">                          LOG.warn(<span class="string">&quot;Too many connections from &quot;</span> + ia</span><br><span class="line">                                   + <span class="string">&quot; - max is &quot;</span> + maxClientCnxns );</span><br><span class="line">                          sc.close();</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          LOG.info(<span class="string">&quot;Accepted socket connection from &quot;</span></span><br><span class="line">                                   + sc.socket().getRemoteSocketAddress());</span><br><span class="line">                          sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                          SelectionKey sk = sc.register(selector,</span><br><span class="line">                                  SelectionKey.OP_READ);</span><br><span class="line">                          NIOServerCnxn cnxn = createConnection(sc, sk);</span><br><span class="line">                          sk.attach(cnxn);</span><br><span class="line">                          addCnxn(cnxn);</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="comment">// 处理客户端的读写请求</span></span><br><span class="line">                  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((k.readyOps() &amp; (SelectionKey.OP_READ | SelectionKey.OP_WRITE)) != <span class="number">0</span>) &#123;</span><br><span class="line">                      NIOServerCnxn c = (NIOServerCnxn) k.attachment();</span><br><span class="line">                     <span class="comment">// 处理IO操作</span></span><br><span class="line">                      c.doIO(k);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                          LOG.debug(<span class="string">&quot;Unexpected ops in select &quot;</span></span><br><span class="line">                                    + k.readyOps());</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              selected.clear();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">              LOG.warn(<span class="string">&quot;Ignoring unexpected runtime exception&quot;</span>, e);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              LOG.warn(<span class="string">&quot;Ignoring exception&quot;</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      closeAll();</span><br><span class="line">      LOG.info(<span class="string">&quot;NIOServerCnxn factory exited run method&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h4 id="NIOServerCnxn-doIO"><a href="#NIOServerCnxn-doIO" class="headerlink" title="NIOServerCnxn.doIO"></a>NIOServerCnxn.doIO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doIO</span><span class="params">(SelectionKey k)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (isSocketOpen() == <span class="keyword">false</span>) &#123;</span><br><span class="line">               LOG.warn(<span class="string">&quot;trying to do i/o on a null socket for session:0x&quot;</span></span><br><span class="line">                        + Long.toHexString(sessionId));</span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 处理读请求, 表示接受</span></span><br><span class="line">           <span class="keyword">if</span> (k.isReadable()) &#123;</span><br><span class="line">               <span class="keyword">int</span> rc = sock.read(incomingBuffer);</span><br><span class="line">               <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> EndOfStreamException(</span><br><span class="line">                           <span class="string">&quot;Unable to read additional data from client sessionid 0x&quot;</span></span><br><span class="line">                           + Long.toHexString(sessionId)</span><br><span class="line">                           + <span class="string">&quot;, likely client has closed socket&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (incomingBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="keyword">boolean</span> isPayload;</span><br><span class="line">                   <span class="keyword">if</span> (incomingBuffer == lenBuffer) &#123; <span class="comment">// start of next request</span></span><br><span class="line">                       incomingBuffer.flip();</span><br><span class="line">                       isPayload = readLength(k);</span><br><span class="line">                       incomingBuffer.clear();</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// continuation</span></span><br><span class="line">                       isPayload = <span class="keyword">true</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">if</span> (isPayload) &#123; <span class="comment">// not the case for 4letterword</span></span><br><span class="line">                       readPayload();</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">// four letter words take care</span></span><br><span class="line">                       <span class="comment">// need not do anything else</span></span><br><span class="line">                       <span class="keyword">return</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (k.isWritable()) &#123;</span><br><span class="line">               <span class="comment">// ZooLog.logTraceMessage(LOG,</span></span><br><span class="line">               <span class="comment">// ZooLog.CLIENT_DATA_PACKET_TRACE_MASK</span></span><br><span class="line">               <span class="comment">// &quot;outgoingBuffers.size() = &quot; +</span></span><br><span class="line">               <span class="comment">// outgoingBuffers.size());</span></span><br><span class="line">               <span class="keyword">if</span> (outgoingBuffers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   <span class="comment">// ZooLog.logTraceMessage(LOG,</span></span><br><span class="line">                   <span class="comment">// ZooLog.CLIENT_DATA_PACKET_TRACE_MASK,</span></span><br><span class="line">                   <span class="comment">// &quot;sk &quot; + k + &quot; is valid: &quot; +</span></span><br><span class="line">                   <span class="comment">// k.isValid());</span></span><br><span class="line"></span><br><span class="line">                   <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * This is going to reset the buffer position to 0 and the</span></span><br><span class="line"><span class="comment">                    * limit to the size of the buffer, so that we can fill it</span></span><br><span class="line"><span class="comment">                    * with data from the non-direct buffers that we need to</span></span><br><span class="line"><span class="comment">                    * send.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                   ByteBuffer directBuffer = factory.directBuffer;</span><br><span class="line">                   directBuffer.clear();</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">for</span> (ByteBuffer b : outgoingBuffers) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (directBuffer.remaining() &lt; b.remaining()) &#123;</span><br><span class="line">                           <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            * When we call put later, if the directBuffer is to</span></span><br><span class="line"><span class="comment">                            * small to hold everything, nothing will be copied,</span></span><br><span class="line"><span class="comment">                            * so we&#x27;ve got to slice the buffer if it&#x27;s too big.</span></span><br><span class="line"><span class="comment">                            */</span></span><br><span class="line">                           b = (ByteBuffer) b.slice().limit(</span><br><span class="line">                                   directBuffer.remaining());</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        * put() is going to modify the positions of both</span></span><br><span class="line"><span class="comment">                        * buffers, put we don&#x27;t want to change the position of</span></span><br><span class="line"><span class="comment">                        * the source buffers (we&#x27;ll do that after the send, if</span></span><br><span class="line"><span class="comment">                        * needed), so we save and reset the position after the</span></span><br><span class="line"><span class="comment">                        * copy</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                       <span class="keyword">int</span> p = b.position();</span><br><span class="line">                       directBuffer.put(b);</span><br><span class="line">                       b.position(p);</span><br><span class="line">                       <span class="keyword">if</span> (directBuffer.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">/*</span></span><br><span class="line"><span class="comment">                    * Do the flip: limit becomes position, position gets set to</span></span><br><span class="line"><span class="comment">                    * 0. This sets us up for the write.</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                   directBuffer.flip();</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">int</span> sent = sock.write(directBuffer);</span><br><span class="line">                   ByteBuffer bb;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Remove the buffers that we have sent</span></span><br><span class="line">                   <span class="keyword">while</span> (outgoingBuffers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                       bb = outgoingBuffers.peek();</span><br><span class="line">                       <span class="keyword">if</span> (bb == ServerCnxnFactory.closeConn) &#123;</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> CloseRequestException(<span class="string">&quot;close requested&quot;</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">int</span> left = bb.remaining() - sent;</span><br><span class="line">                       <span class="keyword">if</span> (left &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="comment">/*</span></span><br><span class="line"><span class="comment">                            * We only partially sent this buffer, so we update</span></span><br><span class="line"><span class="comment">                            * the position and exit the loop.</span></span><br><span class="line"><span class="comment">                            */</span></span><br><span class="line">                           bb.position(bb.position() + sent);</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       packetSent();</span><br><span class="line">                       <span class="comment">/* We&#x27;ve sent the whole buffer, so drop the buffer */</span></span><br><span class="line">                       sent -= bb.remaining();</span><br><span class="line">                       outgoingBuffers.remove();</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">// ZooLog.logTraceMessage(LOG,</span></span><br><span class="line">                   <span class="comment">// ZooLog.CLIENT_DATA_PACKET_TRACE_MASK, &quot;after send,</span></span><br><span class="line">                   <span class="comment">// outgoingBuffers.size() = &quot; + outgoingBuffers.size());</span></span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">synchronized</span>(<span class="keyword">this</span>.factory)&#123;</span><br><span class="line">                   <span class="keyword">if</span> (outgoingBuffers.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (!initialized</span><br><span class="line">                               &amp;&amp; (sk.interestOps() &amp; SelectionKey.OP_READ) == <span class="number">0</span>) &#123;</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> CloseRequestException(<span class="string">&quot;responded to info probe&quot;</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       sk.interestOps(sk.interestOps()</span><br><span class="line">                               &amp; (~SelectionKey.OP_WRITE));</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       sk.interestOps(sk.interestOps()</span><br><span class="line">                               | SelectionKey.OP_WRITE);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;CancelledKeyException causing close of session 0x&quot;</span></span><br><span class="line">                    + Long.toHexString(sessionId));</span><br><span class="line">           <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">               LOG.debug(<span class="string">&quot;CancelledKeyException stack trace&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">           close();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (CloseRequestException e) &#123;</span><br><span class="line">           <span class="comment">// expecting close to log session closure</span></span><br><span class="line">           close();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (EndOfStreamException e) &#123;</span><br><span class="line">           LOG.warn(e.getMessage());</span><br><span class="line">           <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">               LOG.debug(<span class="string">&quot;EndOfStreamException stack trace&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// expecting close to log session closure</span></span><br><span class="line">           close();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           LOG.warn(<span class="string">&quot;Exception causing close of session 0x&quot;</span></span><br><span class="line">                    + Long.toHexString(sessionId) + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">           <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">               LOG.debug(<span class="string">&quot;IOException stack trace&quot;</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">           close();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h4 id="NIOServerCnxn-readRequest"><a href="#NIOServerCnxn-readRequest" class="headerlink" title="NIOServerCnxn.readRequest"></a>NIOServerCnxn.readRequest</h4><p>读取客户端的请求, 进行具体的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    zkServer.processPacket(<span class="keyword">this</span>, incomingBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="ZookeeperServer-processPacket"><a href="#ZookeeperServer-processPacket" class="headerlink" title="ZookeeperServer.processPacket"></a>ZookeeperServer.processPacket</h4><p>这个方法根据数据包的类型来处理不同的数据包，对于读写请求, 我们主要关注下面这块代码即可. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  最终进入这个代码块进行处理</span></span><br><span class="line">               <span class="comment">// 封装请求对象</span></span><br><span class="line">               Request si = <span class="keyword">new</span> Request(cnxn, cnxn.getSessionId(), h.getXid(),</span><br><span class="line">                 h.getType(), incomingBuffer, cnxn.getAuthInfo());</span><br><span class="line">               si.setOwner(ServerCnxn.me);</span><br><span class="line">               submitRequest(si);</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/zookeeper%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/" rel="prev" title="zookeeper 核心原理">
      <i class="fa fa-chevron-left"></i> zookeeper 核心原理
    </a></div>
      <div class="post-nav-item">
    <a href="/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%B0%83%E6%9C%8D%E5%8A%A1%E7%9A%84zookeeper%E5%BA%94%E7%94%A8%E5%AE%9E%E6%88%98/" rel="next" title="分布式协调服务的zookeeper应用实战">
      分布式协调服务的zookeeper应用实战 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#zookeeper%E5%8E%9F%E7%90%86%E4%B9%8Bwatcher%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">zookeeper原理之watcher源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#watcher-%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">watcher 的基本流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ezk%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%8F%91%E8%B5%B7%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="nav-number">1.2.</span> <span class="nav-text">基于zk客户端发起一个数据操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ClientCnxn-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.3.</span> <span class="nav-text">ClientCnxn  初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.</span> <span class="nav-text">服务端接收请求处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NIOServerCnxn"><span class="nav-number">1.4.1.</span> <span class="nav-text">NIOServerCnxn</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ZookeeperServer-processPacket-this-bb"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">ZookeeperServer.processPacket(this, bb);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#submitRequest"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">submitRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#firstProcessor-%E8%AF%B7%E6%B1%82%E9%93%BE%E7%BB%84%E6%88%90"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">firstProcessor  请求链组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PredRequestProcessor-processRequest-si"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">PredRequestProcessor.processRequest(si);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pRequest"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">pRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SyncRequestProcessor-processRequest"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">SyncRequestProcessor. processRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FinalRequestProcessor-processRequest"><span class="nav-number">1.4.1.7.</span> <span class="nav-text">FinalRequestProcessor. processRequest</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A5%E6%94%B6%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%E7%9A%84%E5%93%8D%E5%BA%94"><span class="nav-number">1.5.</span> <span class="nav-text">客户端接收服务端处理完成的响应</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SendThread-readResponse"><span class="nav-number">1.5.0.1.</span> <span class="nav-text">SendThread. readResponse</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#finishPacket-%E6%96%B9%E6%B3%95"><span class="nav-number">1.5.0.2.</span> <span class="nav-text">finishPacket 方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#watchRegistration-register"><span class="nav-number">1.5.0.3.</span> <span class="nav-text">watchRegistration.register</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EventThread-queuePacket"><span class="nav-number">1.5.0.4.</span> <span class="nav-text">EventThread.queuePacket()</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91"><span class="nav-number">1.6.</span> <span class="nav-text">事件触发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94-DataTree-setData"><span class="nav-number">1.6.0.1.</span> <span class="nav-text">服务端的事件响应  DataTree.setData()</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WatcherManager-triggerWatch"><span class="nav-number">1.6.0.2.</span> <span class="nav-text">WatcherManager. triggerWatch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#w-process-e"><span class="nav-number">1.6.0.3.</span> <span class="nav-text">w.process(e);</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94"><span class="nav-number">1.6.1.</span> <span class="nav-text">客户端处理事件响应</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SendThread-readResponse-1"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">SendThread.readResponse</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#eventThread-queueEvent"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">eventThread.queueEvent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#watcher-materializ"><span class="nav-number">1.6.1.3.</span> <span class="nav-text">watcher.materializ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#waitingEvents-add"><span class="nav-number">1.6.1.4.</span> <span class="nav-text">waitingEvents.add</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#processEvent"><span class="nav-number">1.6.1.5.</span> <span class="nav-text">processEvent</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%97%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82"><span class="nav-number">1.7.</span> <span class="nav-text">服务端接受数据请求.</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NIOServerCnxnFactory-run"><span class="nav-number">1.7.0.1.</span> <span class="nav-text">NIOServerCnxnFactory.run</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NIOServerCnxn-doIO"><span class="nav-number">1.7.0.2.</span> <span class="nav-text">NIOServerCnxn.doIO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NIOServerCnxn-readRequest"><span class="nav-number">1.7.0.3.</span> <span class="nav-text">NIOServerCnxn.readRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ZookeeperServer-processPacket"><span class="nav-number">1.7.0.4.</span> <span class="nav-text">ZookeeperServer.processPacket</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">227</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luyanan0718" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luyanan0718" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/luyanan0718@163.com" title="E-Mail → luyanan0718@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://luyanan.com/" title="https:&#x2F;&#x2F;luyanan.com">Site</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
