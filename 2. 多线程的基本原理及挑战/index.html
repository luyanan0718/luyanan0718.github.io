<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="2. 多线程的基本原理由一个问题引发的思考线程的合理使用能够提升程序的处理性能,主要由两个方面:  第一是能够利用多核CPU以及超线程技术来实现线程的并行执行. 第二是线程的异步化执行相比于同步执行来说,异步执行能够很好的优化程序的处理性能提升吞吐量">
<meta property="og:type" content="article">
<meta property="og:title" content="2">
<meta property="og:url" content="http://luyanan.com/2.%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%8F%8A%E6%8C%91%E6%88%98/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="2. 多线程的基本原理由一个问题引发的思考线程的合理使用能够提升程序的处理性能,主要由两个方面:  第一是能够利用多核CPU以及超线程技术来实现线程的并行执行. 第二是线程的异步化执行相比于同步执行来说,异步执行能够很好的优化程序的处理性能提升吞吐量">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://files.luyanan.com/e5df1b50-34b7-4000-8eb6-b06a0becf5bd.jpg">
<meta property="og:image" content="http://files.luyanan.com/ebd891ed-a379-410a-8e66-89888ba3f471.png">
<meta property="og:image" content="http://files.luyanan.com/b5636cdc-9a38-49ee-8f13-7683ba2a5863.jpg">
<meta property="og:image" content="http://files.luyanan.com/c2eaeea8-426e-4155-896c-88fcbeb1dba3.jpg">
<meta property="og:image" content="http://files.luyanan.com/670ce5b3-c30e-4edb-9323-72ee5b22203c.jpg">
<meta property="og:image" content="http://files.luyanan.com/27044d51-a076-4f4b-bd6d-c27d3912b3a5.jpg">
<meta property="og:image" content="http://files.luyanan.com/30884cf9-017e-488b-9f3d-cfa2cc13540d.jpg">
<meta property="og:image" content="http://files.luyanan.com/73e18db6-f38a-46af-a18a-bd162c12931e.jpg">
<meta property="og:image" content="http://files.luyanan.com/73e18db6-f38a-46af-a18a-bd162c12931e.jpg">
<meta property="article:published_time" content="2021-03-02T05:42:51.748Z">
<meta property="article:modified_time" content="2021-03-02T05:42:51.748Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://files.luyanan.com/e5df1b50-34b7-4000-8eb6-b06a0becf5bd.jpg">

<link rel="canonical" href="http://luyanan.com/2.%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%8F%8A%E6%8C%91%E6%88%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>2 | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/2.%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%8F%8A%E6%8C%91%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-02 13:42:51" itemprop="dateCreated datePublished" datetime="2021-03-02T13:42:51+08:00">2021-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">并发编程</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <hr>
<h1 id="2-多线程的基本原理"><a href="#2-多线程的基本原理" class="headerlink" title="2. 多线程的基本原理"></a>2. 多线程的基本原理</h1><h2 id="由一个问题引发的思考"><a href="#由一个问题引发的思考" class="headerlink" title="由一个问题引发的思考"></a>由一个问题引发的思考</h2><p>线程的合理使用能够提升程序的处理性能,主要由两个方面:</p>
<ol>
<li>第一是能够利用多核CPU以及超线程技术来实现线程的并行执行.</li>
<li>第二是线程的异步化执行相比于同步执行来说,异步执行能够很好的优化程序的处理性能提升吞吐量</li>
</ol>
<p>同时,也带来了很多麻烦,举个简单的例子</p>
<h3 id="多线程对于共享变量访问带来的安全性问题"><a href="#多线程对于共享变量访问带来的安全性问题" class="headerlink" title="多线程对于共享变量访问带来的安全性问题"></a>多线程对于共享变量访问带来的安全性问题</h3><p> 一个变量i 假如一个线程去访问这个变量进行修改,这个时候对于数据的修改和访问没有任何问题.但是如果多个线程对于这同一个变量进行修改,就会存在一个数据安全性问题.</p>
<p> <img src="http://files.luyanan.com/e5df1b50-34b7-4000-8eb6-b06a0becf5bd.jpg" alt="image"></p>
<p> 对于线程安全性,本质上是管理对于数据状态的访问,而且这个状态通常来说是共享的,可变的. 共享,是指这个数据变量可以被多个线程访问. 可变,指这个变量的值在它的生命周期内是可以改变的.</p>
<p> 一个对象是否是线程安全,取决于它是否会被多个线程访问,以及程序中是如何使用这个对象的. 所以,如果多个线程同时访问同一个共享对象,在不需要额外的同步以及调用端代码不用做其他协调的情况下,这个共享对象的状态依然是正确的(正确性意味着这个对象的结果与我们预期的规定的结果是保持一致的),那说明这个对象是线程安全的.</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> package com.notes.concurrent.synchronizeds;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author luyanan</span><br><span class="line"> * @since 2019&#x2F;7&#x2F;17</span><br><span class="line"> * &lt;p&gt;线程不安全&lt;&#x2F;p&gt;</span><br><span class="line"> **&#x2F;</span><br><span class="line">public class UnSafeThread &#123;</span><br><span class="line"></span><br><span class="line">    private static int i &#x3D; 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void inc() &#123;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(1);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 1000; i++) &#123;</span><br><span class="line">            new Thread(() -&gt; UnSafeThread.inc()).start();</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(3000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在java中如何解决由于线程并行导致的数据安全性问题呢？</p>
</blockquote>
<h4 id="思考如何保证线程并行的数据安全性"><a href="#思考如何保证线程并行的数据安全性" class="headerlink" title="思考如何保证线程并行的数据安全性"></a>思考如何保证线程并行的数据安全性</h4><p>我们可以思考一下,问题的本质在于共享数据存在并发访问.如果我们能够有一种方法使得线程的并行变得串行,那是不是就不存在这个问题了呢?</p>
<p>按照大家已有的知识,最先想到的应该就是锁了把？</p>
<p>毕竟这个场景并不陌生,我们在和数据库打交道的时候,就了解过悲观锁和乐观锁. 什么是锁? 他是处理并发的一种同步手段,而如果需要达到我们说的一个目的,那么这个锁就需要实现互斥的特性.</p>
<p>java提供的加锁方法就是Synchronized 关键字.</p>
<h3 id="Synchronized的基本认识"><a href="#Synchronized的基本认识" class="headerlink" title="Synchronized的基本认识"></a>Synchronized的基本认识</h3><p>在多线程并发编程中synchronized 一直是元老级角色,很多人就会称呼它为 重量级锁. 但是,锁着java Se 1.6 对synchronized 进行了各种优化之后,有些情况下它就并不那么重,java se 1.6 中为了减少获取锁和释放锁带来的性能消耗而引入的偏向锁和轻量级锁.</p>
<h4 id="synchronized-的基本语法"><a href="#synchronized-的基本语法" class="headerlink" title="synchronized 的基本语法"></a>synchronized 的基本语法</h4><p>synchronized 有三种方式加锁,分别是:</p>
<ol>
<li><strong>修饰实例方法</strong>,作用于当前实例加锁,进入同步代码块前要获取当前实例的锁</li>
<li><strong>静态方法</strong>,作用于当前类对象加锁,进入同步代码前要获得当前类对象的锁.</li>
<li><strong>修饰代码块</strong>,指定加锁对象,对给定对象加锁,进入同步代码库前要获得给定对象的锁.</li>
</ol>
<p>不同的修饰类型,代码锁的控制粒度.</p>
<h4 id="synchronized-的应用"><a href="#synchronized-的应用" class="headerlink" title="synchronized 的应用"></a>synchronized 的应用</h4><p>修改前面的案例,使用synchronized 关键字后,可以达到数据安全的效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.notes.concurrent.synchronizeds;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author luyanan</span><br><span class="line"> * @since 2019&#x2F;7&#x2F;18</span><br><span class="line"> * &lt;p&gt;线程安全的例子&lt;&#x2F;p&gt;</span><br><span class="line"> **&#x2F;</span><br><span class="line">public class SafeThread &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private static int i &#x3D; 0;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void inc() &#123;</span><br><span class="line"></span><br><span class="line">        synchronized (SafeThread.class) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(1);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; 1000; i++) &#123;</span><br><span class="line">            new Thread(() -&gt; SafeThread.inc()).start();</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(3000);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果</p>
<blockquote>
<p>1000</p>
</blockquote>
<h3 id="思考锁是如何存储的"><a href="#思考锁是如何存储的" class="headerlink" title="思考锁是如何存储的"></a>思考锁是如何存储的</h3><p>可以思考一下,要实现多线程的互斥特性,那么这把锁需要哪些因素呢?</p>
<ol>
<li>锁需要有一个东西来表示,比如获得锁是什么状态.无锁是什么状态,</li>
<li>这个状态需要对多个线程共享<br>那么我们来分析,synchronized 锁是如何存储的呢? 观察synchronized 的整个语法发现,synchronized(lock)是基于lock这个对象的生命周期俩控制锁粒度的,那是不是锁的存储和这个lock对象有关系呢?</li>
</ol>
<p>于是我们以对象在jvm内存中是如何存储的作为切入点,去看看对象里面有什么特性能够实现锁</p>
<h4 id="对象在内存中的布局"><a href="#对象在内存中的布局" class="headerlink" title="对象在内存中的布局"></a>对象在内存中的布局</h4><p>在Hotspot 虚拟机中,对象在内存中的存储布局,可以分为三个区域:对象头(Header),实例数据(Instance Data), 对齐填充(Padding).<br><img src="http://files.luyanan.com/ebd891ed-a379-410a-8e66-89888ba3f471.png" alt="image"></p>
<h4 id="探究jvm-源码实现"><a href="#探究jvm-源码实现" class="headerlink" title="探究jvm 源码实现"></a>探究jvm 源码实现</h4><p>当我们在java代码中,使用new 创建一个实例对象的时候,(hotsport虚拟机) JVM 层面实际上会创建一个instanceOopDesc 对象</p>
<p>Hotspot 虚拟机 采用 OOP -Klass 模型 来描述java对象实例,OOP(Ordinary Object Point) 指的是普通对象指针,Klass 用来描述对象对象的具体类型.Hotspot 采用instanceOopDesc 和arrayOopDesc 来描述对象头,arrayOopDesc 对象来描述数组类型.</p>
<p>instanceOopDesc 的定义在Hotspot 源码汇总的instanceOop.hpp 文件中.另外,arrayOopDesc的定义对应在 arrayOop.hpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#ifndef SHARE_VM_OOPS_INSTANCEOOP_HPP</span><br><span class="line">#define SHARE_VM_OOPS_INSTANCEOOP_HPP</span><br><span class="line"></span><br><span class="line">#include &quot;oops&#x2F;oop.hpp&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; An instanceOop is an instance of a Java Class</span><br><span class="line">&#x2F;&#x2F; Evaluating &quot;new HashTable()&quot; will create an instanceOop.</span><br><span class="line"></span><br><span class="line">class instanceOopDesc : public oopDesc &#123;</span><br><span class="line"> public:</span><br><span class="line">  &#x2F;&#x2F; aligned header size.</span><br><span class="line">  static int header_size() &#123; return sizeof(instanceOopDesc)&#x2F;HeapWordSize; &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; If compressed, the offset of the fields of the instance may not be aligned.</span><br><span class="line">  static int base_offset_in_bytes() &#123;</span><br><span class="line">    &#x2F;&#x2F; offset computation code breaks if UseCompressedClassPointers</span><br><span class="line">    &#x2F;&#x2F; only is true</span><br><span class="line">    return (UseCompressedOops &amp;&amp; UseCompressedClassPointers) ?</span><br><span class="line">             klass_gap_offset_in_bytes() :</span><br><span class="line">             sizeof(instanceOopDesc);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static bool contains_field_offset(int offset, int nonstatic_field_size) &#123;</span><br><span class="line">    int base_in_bytes &#x3D; base_offset_in_bytes();</span><br><span class="line">    return (offset &gt;&#x3D; base_in_bytes &amp;&amp;</span><br><span class="line">            (offset-base_in_bytes) &lt; nonstatic_field_size * heapOopSize);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif &#x2F;&#x2F; SHARE_VM_OOPS_INSTANCEOOP_HPP</span><br></pre></td></tr></table></figure>

<p>从instanceOopDesc 代码中可以看到 instanceOopDesc 继承自 oopDesc, oopDesc 的定义在Hotspot 源码中的oop.hpp 中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Copyright (c) 1997, 2013, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span><br><span class="line"> *</span><br><span class="line"> * This code is free software; you can redistribute it and&#x2F;or modify it</span><br><span class="line"> * under the terms of the GNU General Public License version 2 only, as</span><br><span class="line"> * published by the Free Software Foundation.</span><br><span class="line"> *</span><br><span class="line"> * This code is distributed in the hope that it will be useful, but WITHOUT</span><br><span class="line"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span><br><span class="line"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span><br><span class="line"> * version 2 for more details (a copy is included in the LICENSE file that</span><br><span class="line"> * accompanied this code).</span><br><span class="line"> *</span><br><span class="line"> * You should have received a copy of the GNU General Public License version</span><br><span class="line"> * 2 along with this work; if not, write to the Free Software Foundation,</span><br><span class="line"> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</span><br><span class="line"> *</span><br><span class="line"> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</span><br><span class="line"> * or visit www.oracle.com if you need additional information or have any</span><br><span class="line"> * questions.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef SHARE_VM_OOPS_OOP_HPP</span><br><span class="line">#define SHARE_VM_OOPS_OOP_HPP</span><br><span class="line"></span><br><span class="line">#include &quot;memory&#x2F;iterator.hpp&quot;</span><br><span class="line">#include &quot;memory&#x2F;memRegion.hpp&quot;</span><br><span class="line">#include &quot;memory&#x2F;specialized_oop_closures.hpp&quot;</span><br><span class="line">#include &quot;oops&#x2F;metadata.hpp&quot;</span><br><span class="line">#include &quot;utilities&#x2F;macros.hpp&quot;</span><br><span class="line">#include &quot;utilities&#x2F;top.hpp&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; oopDesc is the top baseclass for objects classes.  The &#123;name&#125;Desc classes describe</span><br><span class="line">&#x2F;&#x2F; the format of Java objects so the fields can be accessed from C++.</span><br><span class="line">&#x2F;&#x2F; oopDesc is abstract.</span><br><span class="line">&#x2F;&#x2F; (see oopHierarchy for complete oop class hierarchy)</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; no virtual functions allowed</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; store into oop with store check</span><br><span class="line">template &lt;class T&gt; void oop_store(T* p, oop v);</span><br><span class="line">template &lt;class T&gt; void oop_store(volatile T* p, oop v);</span><br><span class="line"></span><br><span class="line">extern bool always_do_update_barrier;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Forward declarations.</span><br><span class="line">class OopClosure;</span><br><span class="line">class ScanClosure;</span><br><span class="line">class FastScanClosure;</span><br><span class="line">class FilteringClosure;</span><br><span class="line">class BarrierSet;</span><br><span class="line">class CMSIsAliveClosure;</span><br><span class="line"></span><br><span class="line">class PSPromotionManager;</span><br><span class="line">class ParCompactionManager;</span><br><span class="line"></span><br><span class="line">class oopDesc &#123;</span><br><span class="line">  friend class VMStructs;</span><br><span class="line"> private:</span><br><span class="line">  volatile markOop  _mark;</span><br><span class="line">  union _metadata &#123;</span><br><span class="line">    Klass*      _klass;</span><br><span class="line">    narrowKlass _compressed_klass;</span><br><span class="line">  &#125; _metadata;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Fast access to barrier set.  Must be initialized.</span><br><span class="line">  static BarrierSet* _bs;</span><br><span class="line"></span><br><span class="line"> public:</span><br><span class="line">  markOop  mark() const         &#123; return _mark; &#125;</span><br><span class="line">  markOop* mark_addr() const    &#123; return (markOop*) &amp;_mark; &#125;</span><br><span class="line"></span><br><span class="line">  void set_mark(volatile markOop m)      &#123; _mark &#x3D; m;   &#125;</span><br><span class="line"></span><br><span class="line">  void    release_set_mark(markOop m);</span><br><span class="line">  markOop cas_set_mark(markOop new_mark, markOop old_mark);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Used only to re-initialize the mark word (e.g., of promoted</span><br><span class="line">  &#x2F;&#x2F; objects during a GC) -- requires a valid klass pointer</span><br><span class="line">  void init_mark();</span><br><span class="line"></span><br><span class="line">  Klass* klass() const;</span><br><span class="line">  Klass* klass_or_null() const volatile;</span><br><span class="line">  Klass** klass_addr();</span><br><span class="line">  narrowKlass* compressed_klass_addr();</span><br><span class="line"></span><br><span class="line">  void set_klass(Klass* k);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; For klass field compression</span><br><span class="line">  int klass_gap() const;</span><br><span class="line">  void set_klass_gap(int z);</span><br><span class="line">  &#x2F;&#x2F; For when the klass pointer is being used as a linked list &quot;next&quot; field.</span><br><span class="line">  void set_klass_to_list_ptr(oop k);</span><br><span class="line">  oop list_ptr_from_klass();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; size of object header, aligned to platform wordSize</span><br><span class="line">  static int header_size()          &#123; return sizeof(oopDesc)&#x2F;HeapWordSize; &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Returns whether this is an instance of k or an instance of a subclass of k</span><br><span class="line">  bool is_a(Klass* k)  const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Returns the actual oop size of the object</span><br><span class="line">  int size();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Sometimes (for complicated concurrency-related reasons), it is useful</span><br><span class="line">  &#x2F;&#x2F; to be able to figure out the size of an object knowing its klass.</span><br><span class="line">  int size_given_klass(Klass* klass);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; type test operations (inlined in oop.inline.h)</span><br><span class="line">  bool is_instance()           const;</span><br><span class="line">  bool is_instanceMirror()     const;</span><br><span class="line">  bool is_instanceRef()        const;</span><br><span class="line">  bool is_array()              const;</span><br><span class="line">  bool is_objArray()           const;</span><br><span class="line">  bool is_typeArray()          const;</span><br><span class="line"></span><br><span class="line"> private:</span><br><span class="line">  &#x2F;&#x2F; field addresses in oop</span><br><span class="line">  void*     field_base(int offset)        const;</span><br><span class="line"></span><br><span class="line">  jbyte*    byte_field_addr(int offset)   const;</span><br><span class="line">  jchar*    char_field_addr(int offset)   const;</span><br><span class="line">  jboolean* bool_field_addr(int offset)   const;</span><br><span class="line">  jint*     int_field_addr(int offset)    const;</span><br><span class="line">  jshort*   short_field_addr(int offset)  const;</span><br><span class="line">  jlong*    long_field_addr(int offset)   const;</span><br><span class="line">  jfloat*   float_field_addr(int offset)  const;</span><br><span class="line">  jdouble*  double_field_addr(int offset) const;</span><br><span class="line">  Metadata** metadata_field_addr(int offset) const;</span><br><span class="line"></span><br><span class="line"> public:</span><br><span class="line">  &#x2F;&#x2F; Need this as public for garbage collection.</span><br><span class="line">  template &lt;class T&gt; T* obj_field_addr(int offset) const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Needed for javaClasses</span><br><span class="line">  address*  address_field_addr(int offset) const;</span><br><span class="line"></span><br><span class="line">  static bool is_null(oop obj);</span><br><span class="line">  static bool is_null(narrowOop obj);</span><br><span class="line">  static bool is_null(Klass* obj);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Decode an oop pointer from a narrowOop if compressed.</span><br><span class="line">  &#x2F;&#x2F; These are overloaded for oop and narrowOop as are the other functions</span><br><span class="line">  &#x2F;&#x2F; below so that they can be called in template functions.</span><br><span class="line">  static oop decode_heap_oop_not_null(oop v);</span><br><span class="line">  static oop decode_heap_oop_not_null(narrowOop v);</span><br><span class="line">  static oop decode_heap_oop(oop v);</span><br><span class="line">  static oop decode_heap_oop(narrowOop v);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Encode an oop pointer to a narrow oop.  The or_null versions accept</span><br><span class="line">  &#x2F;&#x2F; null oop pointer, others do not in order to eliminate the</span><br><span class="line">  &#x2F;&#x2F; null checking branches.</span><br><span class="line">  static narrowOop encode_heap_oop_not_null(oop v);</span><br><span class="line">  static narrowOop encode_heap_oop(oop v);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Load an oop out of the Java heap</span><br><span class="line">  static narrowOop load_heap_oop(narrowOop* p);</span><br><span class="line">  static oop       load_heap_oop(oop* p);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Load an oop out of Java heap and decode it to an uncompressed oop.</span><br><span class="line">  static oop load_decode_heap_oop_not_null(narrowOop* p);</span><br><span class="line">  static oop load_decode_heap_oop_not_null(oop* p);</span><br><span class="line">  static oop load_decode_heap_oop(narrowOop* p);</span><br><span class="line">  static oop load_decode_heap_oop(oop* p);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Store an oop into the heap.</span><br><span class="line">  static void store_heap_oop(narrowOop* p, narrowOop v);</span><br><span class="line">  static void store_heap_oop(oop* p, oop v);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Encode oop if UseCompressedOops and store into the heap.</span><br><span class="line">  static void encode_store_heap_oop_not_null(narrowOop* p, oop v);</span><br><span class="line">  static void encode_store_heap_oop_not_null(oop* p, oop v);</span><br><span class="line">  static void encode_store_heap_oop(narrowOop* p, oop v);</span><br><span class="line">  static void encode_store_heap_oop(oop* p, oop v);</span><br><span class="line"></span><br><span class="line">  static void release_store_heap_oop(volatile narrowOop* p, narrowOop v);</span><br><span class="line">  static void release_store_heap_oop(volatile oop* p, oop v);</span><br><span class="line"></span><br><span class="line">  static void release_encode_store_heap_oop_not_null(volatile narrowOop* p, oop v);</span><br><span class="line">  static void release_encode_store_heap_oop_not_null(volatile oop* p, oop v);</span><br><span class="line">  static void release_encode_store_heap_oop(volatile narrowOop* p, oop v);</span><br><span class="line">  static void release_encode_store_heap_oop(volatile oop* p, oop v);</span><br><span class="line"></span><br><span class="line">  static oop atomic_exchange_oop(oop exchange_value, volatile HeapWord *dest);</span><br><span class="line">  static oop atomic_compare_exchange_oop(oop exchange_value,</span><br><span class="line">                                         volatile HeapWord *dest,</span><br><span class="line">                                         oop compare_value,</span><br><span class="line">                                         bool prebarrier &#x3D; false);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Access to fields in a instanceOop through these methods.</span><br><span class="line">  oop obj_field(int offset) const;</span><br><span class="line">  volatile oop obj_field_volatile(int offset) const;</span><br><span class="line">  void obj_field_put(int offset, oop value);</span><br><span class="line">  void obj_field_put_raw(int offset, oop value);</span><br><span class="line">  void obj_field_put_volatile(int offset, oop value);</span><br><span class="line"></span><br><span class="line">  Metadata* metadata_field(int offset) const;</span><br><span class="line">  void metadata_field_put(int offset, Metadata* value);</span><br><span class="line"></span><br><span class="line">  jbyte byte_field(int offset) const;</span><br><span class="line">  void byte_field_put(int offset, jbyte contents);</span><br><span class="line"></span><br><span class="line">  jchar char_field(int offset) const;</span><br><span class="line">  void char_field_put(int offset, jchar contents);</span><br><span class="line"></span><br><span class="line">  jboolean bool_field(int offset) const;</span><br><span class="line">  void bool_field_put(int offset, jboolean contents);</span><br><span class="line"></span><br><span class="line">  jint int_field(int offset) const;</span><br><span class="line">  void int_field_put(int offset, jint contents);</span><br><span class="line"></span><br><span class="line">  jshort short_field(int offset) const;</span><br><span class="line">  void short_field_put(int offset, jshort contents);</span><br><span class="line"></span><br><span class="line">  jlong long_field(int offset) const;</span><br><span class="line">  void long_field_put(int offset, jlong contents);</span><br><span class="line"></span><br><span class="line">  jfloat float_field(int offset) const;</span><br><span class="line">  void float_field_put(int offset, jfloat contents);</span><br><span class="line"></span><br><span class="line">  jdouble double_field(int offset) const;</span><br><span class="line">  void double_field_put(int offset, jdouble contents);</span><br><span class="line"></span><br><span class="line">  address address_field(int offset) const;</span><br><span class="line">  void address_field_put(int offset, address contents);</span><br><span class="line"></span><br><span class="line">  oop obj_field_acquire(int offset) const;</span><br><span class="line">  void release_obj_field_put(int offset, oop value);</span><br><span class="line"></span><br><span class="line">  jbyte byte_field_acquire(int offset) const;</span><br><span class="line">  void release_byte_field_put(int offset, jbyte contents);</span><br><span class="line"></span><br><span class="line">  jchar char_field_acquire(int offset) const;</span><br><span class="line">  void release_char_field_put(int offset, jchar contents);</span><br><span class="line"></span><br><span class="line">  jboolean bool_field_acquire(int offset) const;</span><br><span class="line">  void release_bool_field_put(int offset, jboolean contents);</span><br><span class="line"></span><br><span class="line">  jint int_field_acquire(int offset) const;</span><br><span class="line">  void release_int_field_put(int offset, jint contents);</span><br><span class="line"></span><br><span class="line">  jshort short_field_acquire(int offset) const;</span><br><span class="line">  void release_short_field_put(int offset, jshort contents);</span><br><span class="line"></span><br><span class="line">  jlong long_field_acquire(int offset) const;</span><br><span class="line">  void release_long_field_put(int offset, jlong contents);</span><br><span class="line"></span><br><span class="line">  jfloat float_field_acquire(int offset) const;</span><br><span class="line">  void release_float_field_put(int offset, jfloat contents);</span><br><span class="line"></span><br><span class="line">  jdouble double_field_acquire(int offset) const;</span><br><span class="line">  void release_double_field_put(int offset, jdouble contents);</span><br><span class="line"></span><br><span class="line">  address address_field_acquire(int offset) const;</span><br><span class="line">  void release_address_field_put(int offset, address contents);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; printing functions for VM debugging</span><br><span class="line">  void print_on(outputStream* st) const;         &#x2F;&#x2F; First level print</span><br><span class="line">  void print_value_on(outputStream* st) const;   &#x2F;&#x2F; Second level print.</span><br><span class="line">  void print_address_on(outputStream* st) const; &#x2F;&#x2F; Address printing</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; printing on default output stream</span><br><span class="line">  void print();</span><br><span class="line">  void print_value();</span><br><span class="line">  void print_address();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; return the print strings</span><br><span class="line">  char* print_string();</span><br><span class="line">  char* print_value_string();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; verification operations</span><br><span class="line">  void verify_on(outputStream* st);</span><br><span class="line">  void verify();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; locking operations</span><br><span class="line">  bool is_locked()   const;</span><br><span class="line">  bool is_unlocked() const;</span><br><span class="line">  bool has_bias_pattern() const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; asserts</span><br><span class="line">  bool is_oop(bool ignore_mark_word &#x3D; false) const;</span><br><span class="line">  bool is_oop_or_null(bool ignore_mark_word &#x3D; false) const;</span><br><span class="line">#ifndef PRODUCT</span><br><span class="line">  bool is_unlocked_oop() const;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; garbage collection</span><br><span class="line">  bool is_gc_marked() const;</span><br><span class="line">  &#x2F;&#x2F; Apply &quot;MarkSweep::mark_and_push&quot; to (the address of) every non-NULL</span><br><span class="line">  &#x2F;&#x2F; reference field in &quot;this&quot;.</span><br><span class="line">  void follow_contents(void);</span><br><span class="line"></span><br><span class="line">#if INCLUDE_ALL_GCS</span><br><span class="line">  &#x2F;&#x2F; Parallel Scavenge</span><br><span class="line">  void push_contents(PSPromotionManager* pm);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Parallel Old</span><br><span class="line">  void update_contents(ParCompactionManager* cm);</span><br><span class="line"></span><br><span class="line">  void follow_contents(ParCompactionManager* cm);</span><br><span class="line">#endif &#x2F;&#x2F; INCLUDE_ALL_GCS</span><br><span class="line"></span><br><span class="line">  bool is_scavengable() const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Forward pointer operations for scavenge</span><br><span class="line">  bool is_forwarded() const;</span><br><span class="line"></span><br><span class="line">  void forward_to(oop p);</span><br><span class="line">  bool cas_forward_to(oop p, markOop compare);</span><br><span class="line"></span><br><span class="line">#if INCLUDE_ALL_GCS</span><br><span class="line">  &#x2F;&#x2F; Like &quot;forward_to&quot;, but inserts the forwarding pointer atomically.</span><br><span class="line">  &#x2F;&#x2F; Exactly one thread succeeds in inserting the forwarding pointer, and</span><br><span class="line">  &#x2F;&#x2F; this call returns &quot;NULL&quot; for that thread; any other thread has the</span><br><span class="line">  &#x2F;&#x2F; value of the forwarding pointer returned and does not modify &quot;this&quot;.</span><br><span class="line">  oop forward_to_atomic(oop p);</span><br><span class="line">#endif &#x2F;&#x2F; INCLUDE_ALL_GCS</span><br><span class="line"></span><br><span class="line">  oop forwardee() const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Age of object during scavenge</span><br><span class="line">  uint age() const;</span><br><span class="line">  void incr_age();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Adjust all pointers in this object to point at it&#39;s forwarded location and</span><br><span class="line">  &#x2F;&#x2F; return the size of this oop.  This is used by the MarkSweep collector.</span><br><span class="line">  int adjust_pointers();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; mark-sweep support</span><br><span class="line">  void follow_body(int begin, int end);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Fast access to barrier set</span><br><span class="line">  static BarrierSet* bs()            &#123; return _bs; &#125;</span><br><span class="line">  static void set_bs(BarrierSet* bs) &#123; _bs &#x3D; bs; &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; iterators, returns size of object</span><br><span class="line">#define OOP_ITERATE_DECL(OopClosureType, nv_suffix)                      \</span><br><span class="line">  int oop_iterate(OopClosureType* blk);                                  \</span><br><span class="line">  int oop_iterate(OopClosureType* blk, MemRegion mr);  &#x2F;&#x2F; Only in mr.</span><br><span class="line"></span><br><span class="line">  ALL_OOP_OOP_ITERATE_CLOSURES_1(OOP_ITERATE_DECL)</span><br><span class="line">  ALL_OOP_OOP_ITERATE_CLOSURES_2(OOP_ITERATE_DECL)</span><br><span class="line"></span><br><span class="line">#if INCLUDE_ALL_GCS</span><br><span class="line"></span><br><span class="line">#define OOP_ITERATE_BACKWARDS_DECL(OopClosureType, nv_suffix)            \</span><br><span class="line">  int oop_iterate_backwards(OopClosureType* blk);</span><br><span class="line"></span><br><span class="line">  ALL_OOP_OOP_ITERATE_CLOSURES_1(OOP_ITERATE_BACKWARDS_DECL)</span><br><span class="line">  ALL_OOP_OOP_ITERATE_CLOSURES_2(OOP_ITERATE_BACKWARDS_DECL)</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  int oop_iterate_no_header(OopClosure* bk);</span><br><span class="line">  int oop_iterate_no_header(OopClosure* bk, MemRegion mr);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; identity hash; returns the identity hash key (computes it if necessary)</span><br><span class="line">  &#x2F;&#x2F; NOTE with the introduction of UseBiasedLocking that identity_hash() might reach a</span><br><span class="line">  &#x2F;&#x2F; safepoint if called on a biased object. Calling code must be aware of that.</span><br><span class="line">  intptr_t identity_hash();</span><br><span class="line">  intptr_t slow_identity_hash();</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Alternate hashing code if string table is rehashed</span><br><span class="line">  unsigned int new_hash(jint seed);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; marks are forwarded to stack when object is locked</span><br><span class="line">  bool     has_displaced_mark() const;</span><br><span class="line">  markOop  displaced_mark() const;</span><br><span class="line">  void     set_displaced_mark(markOop m);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; for code generation</span><br><span class="line">  static int mark_offset_in_bytes()    &#123; return offset_of(oopDesc, _mark); &#125;</span><br><span class="line">  static int klass_offset_in_bytes()   &#123; return offset_of(oopDesc, _metadata._klass); &#125;</span><br><span class="line">  static int klass_gap_offset_in_bytes();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif &#x2F;&#x2F; SHARE_VM_OOPS_OOP_HPP</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在普通实例对象中, oopDesc 的定义包含两个成员,分别是 _mark和_metadata.</p>
<p>_mark 表示对象标记,属于markOop类型,也就是接下来要讲解的Mark Work ,他记录了对象和锁的有关信息,</p>
<p>_metadata 表示类元信息,类元信息存储的是对象指向它的类元数据(Klass)的首地址,其中 Klass 表示普通指针,_compressed_klass 表示压缩指针类型</p>
<h4 id="MarkWord"><a href="#MarkWord" class="headerlink" title="MarkWord"></a>MarkWord</h4><p>在Hotspot 中,markOop的定义在markOop.hpp 文件中,代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Copyright (c) 1997, 2012, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line"> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</span><br><span class="line"> *</span><br><span class="line"> * This code is free software; you can redistribute it and&#x2F;or modify it</span><br><span class="line"> * under the terms of the GNU General Public License version 2 only, as</span><br><span class="line"> * published by the Free Software Foundation.</span><br><span class="line"> *</span><br><span class="line"> * This code is distributed in the hope that it will be useful, but WITHOUT</span><br><span class="line"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span><br><span class="line"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span><br><span class="line"> * version 2 for more details (a copy is included in the LICENSE file that</span><br><span class="line"> * accompanied this code).</span><br><span class="line"> *</span><br><span class="line"> * You should have received a copy of the GNU General Public License version</span><br><span class="line"> * 2 along with this work; if not, write to the Free Software Foundation,</span><br><span class="line"> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</span><br><span class="line"> *</span><br><span class="line"> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</span><br><span class="line"> * or visit www.oracle.com if you need additional information or have any</span><br><span class="line"> * questions.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef SHARE_VM_OOPS_MARKOOP_HPP</span><br><span class="line">#define SHARE_VM_OOPS_MARKOOP_HPP</span><br><span class="line"></span><br><span class="line">#include &quot;oops&#x2F;oop.hpp&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; The markOop describes the header of an object.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Note that the mark is not a real oop but just a word.</span><br><span class="line">&#x2F;&#x2F; It is placed in the oop hierarchy for historical reasons.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; Bit-format of an object header (most significant first, big endian layout below):</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  32 bits:</span><br><span class="line">&#x2F;&#x2F;  --------</span><br><span class="line">&#x2F;&#x2F;             hash:25 ------------&gt;| age:4    biased_lock:1 lock:2 (normal object)</span><br><span class="line">&#x2F;&#x2F;             JavaThread*:23 epoch:2 age:4    biased_lock:1 lock:2 (biased object)</span><br><span class="line">&#x2F;&#x2F;             size:32 ------------------------------------------&gt;| (CMS free block)</span><br><span class="line">&#x2F;&#x2F;             PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  64 bits:</span><br><span class="line">&#x2F;&#x2F;  --------</span><br><span class="line">&#x2F;&#x2F;  unused:25 hash:31 --&gt;| unused:1   age:4    biased_lock:1 lock:2 (normal object)</span><br><span class="line">&#x2F;&#x2F;  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)</span><br><span class="line">&#x2F;&#x2F;  PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span><br><span class="line">&#x2F;&#x2F;  size:64 -----------------------------------------------------&gt;| (CMS free block)</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  unused:25 hash:31 --&gt;| cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; normal object)</span><br><span class="line">&#x2F;&#x2F;  JavaThread*:54 epoch:2 cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; biased object)</span><br><span class="line">&#x2F;&#x2F;  narrowOop:32 unused:24 cms_free:1 unused:4 promo_bits:3 -----&gt;| (COOPs &amp;&amp; CMS promoted object)</span><br><span class="line">&#x2F;&#x2F;  unused:21 size:35 --&gt;| cms_free:1 unused:7 ------------------&gt;| (COOPs &amp;&amp; CMS free block)</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  - hash contains the identity hash value: largest value is</span><br><span class="line">&#x2F;&#x2F;    31 bits, see os::random().  Also, 64-bit vm&#39;s require</span><br><span class="line">&#x2F;&#x2F;    a hash value no bigger than 32 bits because they will not</span><br><span class="line">&#x2F;&#x2F;    properly generate a mask larger than that: see library_call.cpp</span><br><span class="line">&#x2F;&#x2F;    and c1_CodePatterns_sparc.cpp.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  - the biased lock pattern is used to bias a lock toward a given</span><br><span class="line">&#x2F;&#x2F;    thread. When this pattern is set in the low three bits, the lock</span><br><span class="line">&#x2F;&#x2F;    is either biased toward a given thread or &quot;anonymously&quot; biased,</span><br><span class="line">&#x2F;&#x2F;    indicating that it is possible for it to be biased. When the</span><br><span class="line">&#x2F;&#x2F;    lock is biased toward a given thread, locking and unlocking can</span><br><span class="line">&#x2F;&#x2F;    be performed by that thread without using atomic operations.</span><br><span class="line">&#x2F;&#x2F;    When a lock&#39;s bias is revoked, it reverts back to the normal</span><br><span class="line">&#x2F;&#x2F;    locking scheme described below.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;    Note that we are overloading the meaning of the &quot;unlocked&quot; state</span><br><span class="line">&#x2F;&#x2F;    of the header. Because we steal a bit from the age we can</span><br><span class="line">&#x2F;&#x2F;    guarantee that the bias pattern will never be seen for a truly</span><br><span class="line">&#x2F;&#x2F;    unlocked object.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;    Note also that the biased state contains the age bits normally</span><br><span class="line">&#x2F;&#x2F;    contained in the object header. Large increases in scavenge</span><br><span class="line">&#x2F;&#x2F;    times were seen when these bits were absent and an arbitrary age</span><br><span class="line">&#x2F;&#x2F;    assigned to all biased objects, because they tended to consume a</span><br><span class="line">&#x2F;&#x2F;    significant fraction of the eden semispaces and were not</span><br><span class="line">&#x2F;&#x2F;    promoted promptly, causing an increase in the amount of copying</span><br><span class="line">&#x2F;&#x2F;    performed. The runtime system aligns all JavaThread* pointers to</span><br><span class="line">&#x2F;&#x2F;    a very large value (currently 128 bytes (32bVM) or 256 bytes (64bVM))</span><br><span class="line">&#x2F;&#x2F;    to make room for the age bits &amp; the epoch bits (used in support of</span><br><span class="line">&#x2F;&#x2F;    biased locking), and for the CMS &quot;freeness&quot; bit in the 64bVM (+COOPs).</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;    [JavaThread* | epoch | age | 1 | 01]       lock is biased toward given thread</span><br><span class="line">&#x2F;&#x2F;    [0           | epoch | age | 1 | 01]       lock is anonymously biased</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  - the two lock bits are used to describe three states: locked&#x2F;unlocked and monitor.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;    [ptr             | 00]  locked             ptr points to real header on stack</span><br><span class="line">&#x2F;&#x2F;    [header      | 0 | 01]  unlocked           regular object header</span><br><span class="line">&#x2F;&#x2F;    [ptr             | 10]  monitor            inflated lock (header is wapped out)</span><br><span class="line">&#x2F;&#x2F;    [ptr             | 11]  marked             used by markSweep to mark an object</span><br><span class="line">&#x2F;&#x2F;                                               not valid at any other time</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;    We assume that stack&#x2F;thread pointers have the lowest two bits cleared.</span><br><span class="line"></span><br><span class="line">class BasicLock;</span><br><span class="line">class ObjectMonitor;</span><br><span class="line">class JavaThread;</span><br><span class="line"></span><br><span class="line">class markOopDesc: public oopDesc &#123;</span><br><span class="line"> private:</span><br><span class="line">  &#x2F;&#x2F; Conversion</span><br><span class="line">  uintptr_t value() const &#123; return (uintptr_t) this; &#125;</span><br><span class="line"></span><br><span class="line"> public:</span><br><span class="line">  &#x2F;&#x2F; Constants</span><br><span class="line">  enum &#123; age_bits                 &#x3D; 4,</span><br><span class="line">         lock_bits                &#x3D; 2,</span><br><span class="line">         biased_lock_bits         &#x3D; 1,</span><br><span class="line">         max_hash_bits            &#x3D; BitsPerWord - age_bits - lock_bits - biased_lock_bits,</span><br><span class="line">         hash_bits                &#x3D; max_hash_bits &gt; 31 ? 31 : max_hash_bits,</span><br><span class="line">         cms_bits                 &#x3D; LP64_ONLY(1) NOT_LP64(0),</span><br><span class="line">         epoch_bits               &#x3D; 2</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; The biased locking code currently requires that the age bits be</span><br><span class="line">  &#x2F;&#x2F; contiguous to the lock bits.</span><br><span class="line">  enum &#123; lock_shift               &#x3D; 0,</span><br><span class="line">         biased_lock_shift        &#x3D; lock_bits,</span><br><span class="line">         age_shift                &#x3D; lock_bits + biased_lock_bits,</span><br><span class="line">         cms_shift                &#x3D; age_shift + age_bits,</span><br><span class="line">         hash_shift               &#x3D; cms_shift + cms_bits,</span><br><span class="line">         epoch_shift              &#x3D; hash_shift</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  enum &#123; lock_mask                &#x3D; right_n_bits(lock_bits),</span><br><span class="line">         lock_mask_in_place       &#x3D; lock_mask &lt;&lt; lock_shift,</span><br><span class="line">         biased_lock_mask         &#x3D; right_n_bits(lock_bits + biased_lock_bits),</span><br><span class="line">         biased_lock_mask_in_place&#x3D; biased_lock_mask &lt;&lt; lock_shift,</span><br><span class="line">         biased_lock_bit_in_place &#x3D; 1 &lt;&lt; biased_lock_shift,</span><br><span class="line">         age_mask                 &#x3D; right_n_bits(age_bits),</span><br><span class="line">         age_mask_in_place        &#x3D; age_mask &lt;&lt; age_shift,</span><br><span class="line">         epoch_mask               &#x3D; right_n_bits(epoch_bits),</span><br><span class="line">         epoch_mask_in_place      &#x3D; epoch_mask &lt;&lt; epoch_shift,</span><br><span class="line">         cms_mask                 &#x3D; right_n_bits(cms_bits),</span><br><span class="line">         cms_mask_in_place        &#x3D; cms_mask &lt;&lt; cms_shift</span><br><span class="line">#ifndef _WIN64</span><br><span class="line">         ,hash_mask               &#x3D; right_n_bits(hash_bits),</span><br><span class="line">         hash_mask_in_place       &#x3D; (address_word)hash_mask &lt;&lt; hash_shift</span><br><span class="line">#endif</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Alignment of JavaThread pointers encoded in object header required by biased locking</span><br><span class="line">  enum &#123; biased_lock_alignment    &#x3D; 2 &lt;&lt; (epoch_shift + epoch_bits)</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">#ifdef _WIN64</span><br><span class="line">    &#x2F;&#x2F; These values are too big for Win64</span><br><span class="line">    const static uintptr_t hash_mask &#x3D; right_n_bits(hash_bits);</span><br><span class="line">    const static uintptr_t hash_mask_in_place  &#x3D;</span><br><span class="line">                            (address_word)hash_mask &lt;&lt; hash_shift;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">  enum &#123; locked_value             &#x3D; 0,</span><br><span class="line">         unlocked_value           &#x3D; 1,</span><br><span class="line">         monitor_value            &#x3D; 2,</span><br><span class="line">         marked_value             &#x3D; 3,</span><br><span class="line">         biased_lock_pattern      &#x3D; 5</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  enum &#123; no_hash                  &#x3D; 0 &#125;;  &#x2F;&#x2F; no hash value assigned</span><br><span class="line"></span><br><span class="line">  enum &#123; no_hash_in_place         &#x3D; (address_word)no_hash &lt;&lt; hash_shift,</span><br><span class="line">         no_lock_in_place         &#x3D; unlocked_value</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  enum &#123; max_age                  &#x3D; age_mask &#125;;</span><br><span class="line"></span><br><span class="line">  enum &#123; max_bias_epoch           &#x3D; epoch_mask &#125;;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Biased Locking accessors.</span><br><span class="line">  &#x2F;&#x2F; These must be checked by all code which calls into the</span><br><span class="line">  &#x2F;&#x2F; ObjectSynchronizer and other code. The biasing is not understood</span><br><span class="line">  &#x2F;&#x2F; by the lower-level CAS-based locking code, although the runtime</span><br><span class="line">  &#x2F;&#x2F; fixes up biased locks to be compatible with it when a bias is</span><br><span class="line">  &#x2F;&#x2F; revoked.</span><br><span class="line">  bool has_bias_pattern() const &#123;</span><br><span class="line">    return (mask_bits(value(), biased_lock_mask_in_place) &#x3D;&#x3D; biased_lock_pattern);</span><br><span class="line">  &#125;</span><br><span class="line">  JavaThread* biased_locker() const &#123;</span><br><span class="line">    assert(has_bias_pattern(), &quot;should not call this otherwise&quot;);</span><br><span class="line">    return (JavaThread*) ((intptr_t) (mask_bits(value(), ~(biased_lock_mask_in_place | age_mask_in_place | epoch_mask_in_place))));</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; Indicates that the mark has the bias bit set but that it has not</span><br><span class="line">  &#x2F;&#x2F; yet been biased toward a particular thread</span><br><span class="line">  bool is_biased_anonymously() const &#123;</span><br><span class="line">    return (has_bias_pattern() &amp;&amp; (biased_locker() &#x3D;&#x3D; NULL));</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; Indicates epoch in which this bias was acquired. If the epoch</span><br><span class="line">  &#x2F;&#x2F; changes due to too many bias revocations occurring, the biases</span><br><span class="line">  &#x2F;&#x2F; from the previous epochs are all considered invalid.</span><br><span class="line">  int bias_epoch() const &#123;</span><br><span class="line">    assert(has_bias_pattern(), &quot;should not call this otherwise&quot;);</span><br><span class="line">    return (mask_bits(value(), epoch_mask_in_place) &gt;&gt; epoch_shift);</span><br><span class="line">  &#125;</span><br><span class="line">  markOop set_bias_epoch(int epoch) &#123;</span><br><span class="line">    assert(has_bias_pattern(), &quot;should not call this otherwise&quot;);</span><br><span class="line">    assert((epoch &amp; (~epoch_mask)) &#x3D;&#x3D; 0, &quot;epoch overflow&quot;);</span><br><span class="line">    return markOop(mask_bits(value(), ~epoch_mask_in_place) | (epoch &lt;&lt; epoch_shift));</span><br><span class="line">  &#125;</span><br><span class="line">  markOop incr_bias_epoch() &#123;</span><br><span class="line">    return set_bias_epoch((1 + bias_epoch()) &amp; epoch_mask);</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; Prototype mark for initialization</span><br><span class="line">  static markOop biased_locking_prototype() &#123;</span><br><span class="line">    return markOop( biased_lock_pattern );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; lock accessors (note that these assume lock_shift &#x3D;&#x3D; 0)</span><br><span class="line">  bool is_locked()   const &#123;</span><br><span class="line">    return (mask_bits(value(), lock_mask_in_place) !&#x3D; unlocked_value);</span><br><span class="line">  &#125;</span><br><span class="line">  bool is_unlocked() const &#123;</span><br><span class="line">    return (mask_bits(value(), biased_lock_mask_in_place) &#x3D;&#x3D; unlocked_value);</span><br><span class="line">  &#125;</span><br><span class="line">  bool is_marked()   const &#123;</span><br><span class="line">    return (mask_bits(value(), lock_mask_in_place) &#x3D;&#x3D; marked_value);</span><br><span class="line">  &#125;</span><br><span class="line">  bool is_neutral()  const &#123; return (mask_bits(value(), biased_lock_mask_in_place) &#x3D;&#x3D; unlocked_value); &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Special temporary state of the markOop while being inflated.</span><br><span class="line">  &#x2F;&#x2F; Code that looks at mark outside a lock need to take this into account.</span><br><span class="line">  bool is_being_inflated() const &#123; return (value() &#x3D;&#x3D; 0); &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Distinguished markword value - used when inflating over</span><br><span class="line">  &#x2F;&#x2F; an existing stacklock.  0 indicates the markword is &quot;BUSY&quot;.</span><br><span class="line">  &#x2F;&#x2F; Lockword mutators that use a LD...CAS idiom should always</span><br><span class="line">  &#x2F;&#x2F; check for and avoid overwriting a 0 value installed by some</span><br><span class="line">  &#x2F;&#x2F; other thread.  (They should spin or block instead.  The 0 value</span><br><span class="line">  &#x2F;&#x2F; is transient and *should* be short-lived).</span><br><span class="line">  static markOop INFLATING() &#123; return (markOop) 0; &#125;    &#x2F;&#x2F; inflate-in-progress</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Should this header be preserved during GC?</span><br><span class="line">  inline bool must_be_preserved(oop obj_containing_mark) const;</span><br><span class="line">  inline bool must_be_preserved_with_bias(oop obj_containing_mark) const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Should this header (including its age bits) be preserved in the</span><br><span class="line">  &#x2F;&#x2F; case of a promotion failure during scavenge?</span><br><span class="line">  &#x2F;&#x2F; Note that we special case this situation. We want to avoid</span><br><span class="line">  &#x2F;&#x2F; calling BiasedLocking::preserve_marks()&#x2F;restore_marks() (which</span><br><span class="line">  &#x2F;&#x2F; decrease the number of mark words that need to be preserved</span><br><span class="line">  &#x2F;&#x2F; during GC) during each scavenge. During scavenges in which there</span><br><span class="line">  &#x2F;&#x2F; is no promotion failure, we actually don&#39;t need to call the above</span><br><span class="line">  &#x2F;&#x2F; routines at all, since we don&#39;t mutate and re-initialize the</span><br><span class="line">  &#x2F;&#x2F; marks of promoted objects using init_mark(). However, during</span><br><span class="line">  &#x2F;&#x2F; scavenges which result in promotion failure, we do re-initialize</span><br><span class="line">  &#x2F;&#x2F; the mark words of objects, meaning that we should have called</span><br><span class="line">  &#x2F;&#x2F; these mark word preservation routines. Currently there&#39;s no good</span><br><span class="line">  &#x2F;&#x2F; place in which to call them in any of the scavengers (although</span><br><span class="line">  &#x2F;&#x2F; guarded by appropriate locks we could make one), but the</span><br><span class="line">  &#x2F;&#x2F; observation is that promotion failures are quite rare and</span><br><span class="line">  &#x2F;&#x2F; reducing the number of mark words preserved during them isn&#39;t a</span><br><span class="line">  &#x2F;&#x2F; high priority.</span><br><span class="line">  inline bool must_be_preserved_for_promotion_failure(oop obj_containing_mark) const;</span><br><span class="line">  inline bool must_be_preserved_with_bias_for_promotion_failure(oop obj_containing_mark) const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Should this header be preserved during a scavenge where CMS is</span><br><span class="line">  &#x2F;&#x2F; the old generation?</span><br><span class="line">  &#x2F;&#x2F; (This is basically the same body as must_be_preserved_for_promotion_failure(),</span><br><span class="line">  &#x2F;&#x2F; but takes the Klass* as argument instead)</span><br><span class="line">  inline bool must_be_preserved_for_cms_scavenge(Klass* klass_of_obj_containing_mark) const;</span><br><span class="line">  inline bool must_be_preserved_with_bias_for_cms_scavenge(Klass* klass_of_obj_containing_mark) const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; WARNING: The following routines are used EXCLUSIVELY by</span><br><span class="line">  &#x2F;&#x2F; synchronization functions. They are not really gc safe.</span><br><span class="line">  &#x2F;&#x2F; They must get updated if markOop layout get changed.</span><br><span class="line">  markOop set_unlocked() const &#123;</span><br><span class="line">    return markOop(value() | unlocked_value);</span><br><span class="line">  &#125;</span><br><span class="line">  bool has_locker() const &#123;</span><br><span class="line">    return ((value() &amp; lock_mask_in_place) &#x3D;&#x3D; locked_value);</span><br><span class="line">  &#125;</span><br><span class="line">  BasicLock* locker() const &#123;</span><br><span class="line">    assert(has_locker(), &quot;check&quot;);</span><br><span class="line">    return (BasicLock*) value();</span><br><span class="line">  &#125;</span><br><span class="line">  bool has_monitor() const &#123;</span><br><span class="line">    return ((value() &amp; monitor_value) !&#x3D; 0);</span><br><span class="line">  &#125;</span><br><span class="line">  ObjectMonitor* monitor() const &#123;</span><br><span class="line">    assert(has_monitor(), &quot;check&quot;);</span><br><span class="line">    &#x2F;&#x2F; Use xor instead of &amp;~ to provide one extra tag-bit check.</span><br><span class="line">    return (ObjectMonitor*) (value() ^ monitor_value);</span><br><span class="line">  &#125;</span><br><span class="line">  bool has_displaced_mark_helper() const &#123;</span><br><span class="line">    return ((value() &amp; unlocked_value) &#x3D;&#x3D; 0);</span><br><span class="line">  &#125;</span><br><span class="line">  markOop displaced_mark_helper() const &#123;</span><br><span class="line">    assert(has_displaced_mark_helper(), &quot;check&quot;);</span><br><span class="line">    intptr_t ptr &#x3D; (value() &amp; ~monitor_value);</span><br><span class="line">    return *(markOop*)ptr;</span><br><span class="line">  &#125;</span><br><span class="line">  void set_displaced_mark_helper(markOop m) const &#123;</span><br><span class="line">    assert(has_displaced_mark_helper(), &quot;check&quot;);</span><br><span class="line">    intptr_t ptr &#x3D; (value() &amp; ~monitor_value);</span><br><span class="line">    *(markOop*)ptr &#x3D; m;</span><br><span class="line">  &#125;</span><br><span class="line">  markOop copy_set_hash(intptr_t hash) const &#123;</span><br><span class="line">    intptr_t tmp &#x3D; value() &amp; (~hash_mask_in_place);</span><br><span class="line">    tmp |&#x3D; ((hash &amp; hash_mask) &lt;&lt; hash_shift);</span><br><span class="line">    return (markOop)tmp;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; it is only used to be stored into BasicLock as the</span><br><span class="line">  &#x2F;&#x2F; indicator that the lock is using heavyweight monitor</span><br><span class="line">  static markOop unused_mark() &#123;</span><br><span class="line">    return (markOop) marked_value;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F; the following two functions create the markOop to be</span><br><span class="line">  &#x2F;&#x2F; stored into object header, it encodes monitor info</span><br><span class="line">  static markOop encode(BasicLock* lock) &#123;</span><br><span class="line">    return (markOop) lock;</span><br><span class="line">  &#125;</span><br><span class="line">  static markOop encode(ObjectMonitor* monitor) &#123;</span><br><span class="line">    intptr_t tmp &#x3D; (intptr_t) monitor;</span><br><span class="line">    return (markOop) (tmp | monitor_value);</span><br><span class="line">  &#125;</span><br><span class="line">  static markOop encode(JavaThread* thread, uint age, int bias_epoch) &#123;</span><br><span class="line">    intptr_t tmp &#x3D; (intptr_t) thread;</span><br><span class="line">    assert(UseBiasedLocking &amp;&amp; ((tmp &amp; (epoch_mask_in_place | age_mask_in_place | biased_lock_mask_in_place)) &#x3D;&#x3D; 0), &quot;misaligned JavaThread pointer&quot;);</span><br><span class="line">    assert(age &lt;&#x3D; max_age, &quot;age too large&quot;);</span><br><span class="line">    assert(bias_epoch &lt;&#x3D; max_bias_epoch, &quot;bias epoch too large&quot;);</span><br><span class="line">    return (markOop) (tmp | (bias_epoch &lt;&lt; epoch_shift) | (age &lt;&lt; age_shift) | biased_lock_pattern);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; used to encode pointers during GC</span><br><span class="line">  markOop clear_lock_bits() &#123; return markOop(value() &amp; ~lock_mask_in_place); &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; age operations</span><br><span class="line">  markOop set_marked()   &#123; return markOop((value() &amp; ~lock_mask_in_place) | marked_value); &#125;</span><br><span class="line">  markOop set_unmarked() &#123; return markOop((value() &amp; ~lock_mask_in_place) | unlocked_value); &#125;</span><br><span class="line"></span><br><span class="line">  uint    age()               const &#123; return mask_bits(value() &gt;&gt; age_shift, age_mask); &#125;</span><br><span class="line">  markOop set_age(uint v) const &#123;</span><br><span class="line">    assert((v &amp; ~age_mask) &#x3D;&#x3D; 0, &quot;shouldn&#39;t overflow age field&quot;);</span><br><span class="line">    return markOop((value() &amp; ~age_mask_in_place) | (((uintptr_t)v &amp; age_mask) &lt;&lt; age_shift));</span><br><span class="line">  &#125;</span><br><span class="line">  markOop incr_age()          const &#123; return age() &#x3D;&#x3D; max_age ? markOop(this) : set_age(age() + 1); &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; hash operations</span><br><span class="line">  intptr_t hash() const &#123;</span><br><span class="line">    return mask_bits(value() &gt;&gt; hash_shift, hash_mask);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bool has_no_hash() const &#123;</span><br><span class="line">    return hash() &#x3D;&#x3D; no_hash;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Prototype mark for initialization</span><br><span class="line">  static markOop prototype() &#123;</span><br><span class="line">    return markOop( no_hash_in_place | no_lock_in_place );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Helper function for restoration of unmarked mark oops during GC</span><br><span class="line">  static inline markOop prototype_for_object(oop obj);</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Debugging</span><br><span class="line">  void print_on(outputStream* st) const;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Prepare address of oop for placement into mark</span><br><span class="line">  inline static markOop encode_pointer_as_mark(void* p) &#123; return markOop(p)-&gt;set_marked(); &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Recover address of oop from encoded form used in mark</span><br><span class="line">  inline void* decode_pointer() &#123; if (UseBiasedLocking &amp;&amp; has_bias_pattern()) return NULL; return clear_lock_bits(); &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; These markOops indicate cms free chunk blocks and not objects.</span><br><span class="line">  &#x2F;&#x2F; In 64 bit, the markOop is set to distinguish them from oops.</span><br><span class="line">  &#x2F;&#x2F; These are defined in 32 bit mode for vmStructs.</span><br><span class="line">  const static uintptr_t cms_free_chunk_pattern  &#x3D; 0x1;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; Constants for the size field.</span><br><span class="line">  enum &#123; size_shift                &#x3D; cms_shift + cms_bits,</span><br><span class="line">         size_bits                 &#x3D; 35    &#x2F;&#x2F; need for compressed oops 32G</span><br><span class="line">       &#125;;</span><br><span class="line">  &#x2F;&#x2F; These values are too big for Win64</span><br><span class="line">  const static uintptr_t size_mask &#x3D; LP64_ONLY(right_n_bits(size_bits))</span><br><span class="line">                                     NOT_LP64(0);</span><br><span class="line">  const static uintptr_t size_mask_in_place &#x3D;</span><br><span class="line">                                     (address_word)size_mask &lt;&lt; size_shift;</span><br><span class="line"></span><br><span class="line">#ifdef _LP64</span><br><span class="line">  static markOop cms_free_prototype() &#123;</span><br><span class="line">    return markOop(((intptr_t)prototype() &amp; ~cms_mask_in_place) |</span><br><span class="line">                   ((cms_free_chunk_pattern &amp; cms_mask) &lt;&lt; cms_shift));</span><br><span class="line">  &#125;</span><br><span class="line">  uintptr_t cms_encoding() const &#123;</span><br><span class="line">    return mask_bits(value() &gt;&gt; cms_shift, cms_mask);</span><br><span class="line">  &#125;</span><br><span class="line">  bool is_cms_free_chunk() const &#123;</span><br><span class="line">    return is_neutral() &amp;&amp;</span><br><span class="line">           (cms_encoding() &amp; cms_free_chunk_pattern) &#x3D;&#x3D; cms_free_chunk_pattern;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  size_t get_size() const       &#123; return (size_t)(value() &gt;&gt; size_shift); &#125;</span><br><span class="line">  static markOop set_size_and_free(size_t size) &#123;</span><br><span class="line">    assert((size &amp; ~size_mask) &#x3D;&#x3D; 0, &quot;shouldn&#39;t overflow size field&quot;);</span><br><span class="line">    return markOop(((intptr_t)cms_free_prototype() &amp; ~size_mask_in_place) |</span><br><span class="line">                   (((intptr_t)size &amp; size_mask) &lt;&lt; size_shift));</span><br><span class="line">  &#125;</span><br><span class="line">#endif &#x2F;&#x2F; _LP64</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif &#x2F;&#x2F; SHARE_VM_OOPS_MARKOOP_HPP</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Mark word 记录了对象和锁有关的信息,当某个对象被synchronized 关键字当成同步锁时,那么围绕这个锁的一系列操作都和Mark Word 有关系. Mark Word 在32虚拟机的长度是 32bit,在64位虚拟机的长度是64bit.</p>
<p>Mark Word 可能变化为存储以上五种情况<br><img src="http://files.luyanan.com/b5636cdc-9a38-49ee-8f13-7683ba2a5863.jpg" alt="image"></p>
<h4 id="为什么每个对象都可以实现锁"><a href="#为什么每个对象都可以实现锁" class="headerlink" title="为什么每个对象都可以实现锁?"></a>为什么每个对象都可以实现锁?</h4><ol>
<li><p>首先,java中的每个对象都派生自Object类,而每个java Object 在JVM 内部都有一个 native 的C++ 对象 oop/oopDesc 进行对应.</p>
</li>
<li><p>在线程获取锁的时候,实际上就是获取一个监视器对象(minitor),monitor 可以认为是一个同步对象,所有的java 对象天生到monitor .在hotspot 源码中 markOop.hpp源码中,可以看到下面这段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ObjectMonitor* monitor() const &#123;</span><br><span class="line">  assert(has_monitor(), &quot;check&quot;);</span><br><span class="line">  &#x2F;&#x2F; Use xor instead of &amp;~ to provide one extra tag-bit check.</span><br><span class="line">  return (ObjectMonitor*) (value() ^ monitor_value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>多个线程访问同步代码块,相当于去争抢对象监视器,修改对象中的锁标识,上面的代码汇总objectMonitor 这个对象和线程争抢锁的逻辑有密切的关系。</p>
<h3 id="synchronized-锁的升级"><a href="#synchronized-锁的升级" class="headerlink" title="synchronized 锁的升级"></a>synchronized 锁的升级</h3><p>在分析 synchronized 时,提高了偏向锁,轻量级锁,重量级锁.在分析这几种锁的区别的时候,我们先来思考一个问题, 使用锁能够实现数据的安全性,但是会带来性能的下降. 不使用锁能够基于线程并行提升程序性能,但是却不能保证线程安全性. 这两者之间似乎是没办法达到既能满足性能也能满足安全性的要求.</p>
<p>hotspot 虚拟机的作者经过调查发现, 大部分情况下,加锁的代码不仅仅不存在多线程竞争,而且总是由同一个线程多次获得.所以基于这样一个概率,synchronized 在JDK1.6之后做了一些优化, 为了减少获得锁和释放锁带来的性能开销,引入了偏向锁,轻量级锁的概念. 因为大家会发现在synchronized 中,锁存在四种状态. 分别为无锁,偏向锁,轻量级锁,重量级锁;锁的状态根据竞争激烈的程序 从低到高不断升级.</p>
<h4 id="偏向锁的基本原理"><a href="#偏向锁的基本原理" class="headerlink" title="偏向锁的基本原理"></a>偏向锁的基本原理</h4><p>前面说过,大部分情况下,锁不仅仅不存在多线程竞争,而是总是由同一个线程多次获得,为了让线程获得锁的代价更低就引入了偏向锁的概念. 怎么理解偏向锁呢?</p>
<p>当一个线程访问了加了同步锁的代码块时,会在对象头汇总存储当前线程的ID,后续这个线程进入和退出这段加了同步锁的代码块的时候,不需要再次加锁和释放锁.,而是直接比较对象头里面是否存储了指向当前线程的偏向锁.如果相等表示偏向锁是偏向于当前线程,就不需要再尝试获得锁了.</p>
<h5 id="偏向锁的获取逻辑"><a href="#偏向锁的获取逻辑" class="headerlink" title="偏向锁的获取逻辑"></a>偏向锁的获取逻辑</h5><ol>
<li>首先获取锁对象的MarkWord ,判断是否处于可偏向状态(biased_lock =1 且 ThreadId 为空)</li>
<li>如果是可偏向状态,则通过CAS 操作,把当前线程的ID 写入到 MarkWord <ol>
<li>如果cas成功,那么markword 就会变成这样,表示已经获得了锁对象的偏向锁,接着执行同步代码块</li>
<li>如果cas失败,说明有其他线程已经获得了偏向锁,正宗情况说明当前锁存在竞争,需要撤销已获得偏向锁的线程,并且把他持有的锁升级为轻量级锁(这个操作需要等到全局安全点,也就是没有线程在执行的字节码) 才能执行.</li>
</ol>
</li>
<li>如果是已偏向状态,需要检查markword 中存储的ThreadID 是否等于当前线程的Thread ID<ol>
<li>如果相等,不需要再次获得锁,可以直接执行同步代码块.</li>
<li>如果不相等,说明当前锁偏向于其他线程,需要撤销偏向锁并升级到轻量级锁.</li>
</ol>
</li>
</ol>
<h5 id="偏向锁的撤销"><a href="#偏向锁的撤销" class="headerlink" title="偏向锁的撤销"></a>偏向锁的撤销</h5><p>偏向锁的撤销并不是把对象恢复到无锁可偏向状态(因为偏向锁并不存在锁释放的概念),而是在获得偏向锁的过程中,发现cas 失败也就是存在线程竞争的时候,直接把被偏向的锁的对象升级到了被加了轻量级锁的状态.</p>
<p>对原持有偏向锁多线程进行撤销时,原获得偏向锁的线程存在两种情况:</p>
<ol>
<li>原获得偏向锁的线程如果已经退出了临界区,也就是同步代码块执行完了,那么这个时候就会把对象头设置成无锁状态并且争抢锁的线程可以基于CAS 重新偏向前线程.</li>
<li>如果原获得偏向锁的线程的同步代码块还没有执行完,处于临界区之内,这个时候会把原获得偏向锁的线程升级为轻量级锁后继续执行同步代码块.</li>
</ol>
<p>在我们的应用开发中,绝大部分情况下一定会存在2个以上的线程竞争,那么如果开启偏向锁,反而会提升获取锁的资源消耗.所以可以通过jvm参数 UseBiasedLocking 来设置开启或者关闭偏向锁.</p>
<p><img src="http://files.luyanan.com/c2eaeea8-426e-4155-896c-88fcbeb1dba3.jpg" alt="image"></p>
<h4 id="轻量级锁的基本原理"><a href="#轻量级锁的基本原理" class="headerlink" title="轻量级锁的基本原理"></a>轻量级锁的基本原理</h4><h5 id="轻量级锁的加锁和解锁逻辑"><a href="#轻量级锁的加锁和解锁逻辑" class="headerlink" title="轻量级锁的加锁和解锁逻辑"></a>轻量级锁的加锁和解锁逻辑</h5><p>锁升级为轻量级之后,对象的MarkWord 也会进行相应的变化.升级为轻量级锁的过程:</p>
<ol>
<li>线程在自己的栈帧中创建锁记录LockRecore</li>
<li>将锁对象的对象头中的 MarkWord 复制到线程的刚创建的锁记录中.</li>
<li>将锁记录中的Owner 指针指向锁对象。</li>
<li>将锁对象的对象头的MarkWord 替换为指向锁记录的指针.</li>
</ol>
<p><img src="http://files.luyanan.com/670ce5b3-c30e-4edb-9323-72ee5b22203c.jpg" alt="image"></p>
<p><img src="http://files.luyanan.com/27044d51-a076-4f4b-bd6d-c27d3912b3a5.jpg" alt="image"></p>
<h5 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h5><p>轻量级锁在加锁过程中用到了自旋锁</p>
<p>所谓自旋,就是指当有另外一个线程来竞争锁的时候,这个线程会在原地循环等待,而不是把该线程阻塞,知道那个获得锁的线程释放锁之后,这个线程就可以马上获得锁. 注意,锁在原地循环的时候,会消耗cpu,就相当于执行一个什么也没有的for循环.</p>
<p>所以,轻量级锁适用于那些同步代码块执行的很快的场景,这样,线程原地等待很短的时间就能够获得锁了.</p>
<p>自旋锁的使用,其实也是有一定的概率背景的,在大部分同步代码块执行的时间都是很短的,所在通过看似无意义的循环反而能够提升锁的性能.</p>
<p>但是自旋必须要有一定的条件控制,否则如果一个线程执行同步代码块的时间很长,那么这个线程不断的循环反而会消耗CPU 资源.默认情况下自旋的次数是10次.可以通过 preBlockSpin 来修改</p>
<p>在JDK1.6之后,引入了自适应自旋锁,自适用意味着自旋的次数不是固定的,而是根据前一次在同一个锁上自旋的时间以及锁的拥有者的状态来决定的.</p>
<p>如果在同一个锁对象上,自旋等待刚刚成功获得过锁,并且持有锁的线程正在运行,那么虚拟机就会认为这次自旋也很有可能再次成功,进而它将允许自旋等待持续相对更长的时间. 如果对于这个锁,自旋很少成功获得过,那在以后尝试获取这个锁的时候将可能省略掉自旋的过程,直接阻塞线程,避免浪费处理器资源.</p>
<h5 id="轻量级锁的解锁"><a href="#轻量级锁的解锁" class="headerlink" title="轻量级锁的解锁"></a>轻量级锁的解锁</h5><p>轻量级锁的锁释放逻辑其实就是获得锁的逆向逻辑,通过CAS 操作把线程栈帧中的LockRecord 替换回到锁对象的MarkWord 中,如果成功表示没有竞争,如果失败,表示当前锁存在竞争,那么轻量级锁就会膨胀为重量级锁。</p>
<p>流程图分析<br><img src="http://files.luyanan.com/30884cf9-017e-488b-9f3d-cfa2cc13540d.jpg" alt="image"></p>
<h4 id="重量级锁的基本原理"><a href="#重量级锁的基本原理" class="headerlink" title="重量级锁的基本原理"></a>重量级锁的基本原理</h4><p>当轻量级锁膨胀为重量级锁的时候,意味着线程只能被挂起阻塞来等待被唤醒了.</p>
<p>重量级锁的monitor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package com.notes.concurrent.synchronizeds;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author luyanan</span><br><span class="line"> * @since 2019&#x2F;7&#x2F;18</span><br><span class="line"> * &lt;p&gt;重量级锁&lt;&#x2F;p&gt;</span><br><span class="line"> **&#x2F;</span><br><span class="line">public class HeavyweightThread &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        synchronized (HeavyweightThread.class) &#123;</span><br><span class="line">            test();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void test() &#123;</span><br><span class="line">        System.out.println(&quot;打印&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>运行以后通过javap 工具查看生成的class 文件信息分析synchronzied 关键字的实现细节</p>
<blockquote>
<p>javap -v /d/workspace/lyn/lyn-project/notes/java/javaNotes/concurrent-notes/target/classes/com/notes/concurrent/synchronizeds/HeavyweightThread.class</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">Classfile &#x2F;D:&#x2F;workspace&#x2F;lyn&#x2F;lyn-project&#x2F;notes&#x2F;java&#x2F;javaNotes&#x2F;concurrent-notes&#x2F;ta                                                                                                                                  rget&#x2F;classes&#x2F;com&#x2F;notes&#x2F;concurrent&#x2F;synchronizeds&#x2F;HeavyweightThread.class</span><br><span class="line">  Last modified 2019-7-18; size 795 bytes</span><br><span class="line">  MD5 checksum 4bfd6f95270bf0aad230cbdd4243efac</span><br><span class="line">  Compiled from &quot;HeavyweightThread.java&quot;</span><br><span class="line">public class com.notes.concurrent.synchronizeds.HeavyweightThread</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 &#x3D; Methodref          #7.#26         &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; Class              #27            &#x2F;&#x2F; com&#x2F;notes&#x2F;concurrent&#x2F;synchronizeds&#x2F;                                                                                                                                  HeavyweightThread</span><br><span class="line">   #3 &#x3D; Methodref          #2.#28         &#x2F;&#x2F; com&#x2F;notes&#x2F;concurrent&#x2F;synchronizeds&#x2F;                                                                                                                                  HeavyweightThread.test:()V</span><br><span class="line">   #4 &#x3D; Fieldref           #29.#30        &#x2F;&#x2F; java&#x2F;lang&#x2F;System.out:Ljava&#x2F;io&#x2F;Print                                                                                                                                  Stream;</span><br><span class="line">   #5 &#x3D; String             #31            &#x2F;&#x2F; ▒▒ӡ</span><br><span class="line">   #6 &#x3D; Methodref          #32.#33        &#x2F;&#x2F; java&#x2F;io&#x2F;PrintStream.println:(Ljava&#x2F;                                                                                                                                  lang&#x2F;String;)V</span><br><span class="line">   #7 &#x3D; Class              #34            &#x2F;&#x2F; java&#x2F;lang&#x2F;Object</span><br><span class="line">   #8 &#x3D; Utf8               &lt;init&gt;</span><br><span class="line">   #9 &#x3D; Utf8               ()V</span><br><span class="line">  #10 &#x3D; Utf8               Code</span><br><span class="line">  #11 &#x3D; Utf8               LineNumberTable</span><br><span class="line">  #12 &#x3D; Utf8               LocalVariableTable</span><br><span class="line">  #13 &#x3D; Utf8               this</span><br><span class="line">  #14 &#x3D; Utf8               Lcom&#x2F;notes&#x2F;concurrent&#x2F;synchronizeds&#x2F;HeavyweightThread                                                                                                                                  ;</span><br><span class="line">  #15 &#x3D; Utf8               main</span><br><span class="line">  #16 &#x3D; Utf8               ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">  #17 &#x3D; Utf8               args</span><br><span class="line">  #18 &#x3D; Utf8               [Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">  #19 &#x3D; Utf8               StackMapTable</span><br><span class="line">  #20 &#x3D; Class              #18            &#x2F;&#x2F; &quot;[Ljava&#x2F;lang&#x2F;String;&quot;</span><br><span class="line">  #21 &#x3D; Class              #34            &#x2F;&#x2F; java&#x2F;lang&#x2F;Object</span><br><span class="line">  #22 &#x3D; Class              #35            &#x2F;&#x2F; java&#x2F;lang&#x2F;Throwable</span><br><span class="line">  #23 &#x3D; Utf8               test</span><br><span class="line">  #24 &#x3D; Utf8               SourceFile</span><br><span class="line">  #25 &#x3D; Utf8               HeavyweightThread.java</span><br><span class="line">  #26 &#x3D; NameAndType        #8:#9          &#x2F;&#x2F; &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #27 &#x3D; Utf8               com&#x2F;notes&#x2F;concurrent&#x2F;synchronizeds&#x2F;HeavyweightThread</span><br><span class="line">  #28 &#x3D; NameAndType        #23:#9         &#x2F;&#x2F; test:()V</span><br><span class="line">  #29 &#x3D; Class              #36            &#x2F;&#x2F; java&#x2F;lang&#x2F;System</span><br><span class="line">  #30 &#x3D; NameAndType        #37:#38        &#x2F;&#x2F; out:Ljava&#x2F;io&#x2F;PrintStream;</span><br><span class="line">  #31 &#x3D; Utf8               ▒▒ӡ</span><br><span class="line">  #32 &#x3D; Class              #39            &#x2F;&#x2F; java&#x2F;io&#x2F;PrintStream</span><br><span class="line">  #33 &#x3D; NameAndType        #40:#41        &#x2F;&#x2F; println:(Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">  #34 &#x3D; Utf8               java&#x2F;lang&#x2F;Object</span><br><span class="line">  #35 &#x3D; Utf8               java&#x2F;lang&#x2F;Throwable</span><br><span class="line">  #36 &#x3D; Utf8               java&#x2F;lang&#x2F;System</span><br><span class="line">  #37 &#x3D; Utf8               out</span><br><span class="line">  #38 &#x3D; Utf8               Ljava&#x2F;io&#x2F;PrintStream;</span><br><span class="line">  #39 &#x3D; Utf8               java&#x2F;io&#x2F;PrintStream</span><br><span class="line">  #40 &#x3D; Utf8               println</span><br><span class="line">  #41 &#x3D; Utf8               (Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">&#123;</span><br><span class="line">  public com.notes.concurrent.synchronizeds.HeavyweightThread();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;1, locals&#x3D;1, args_size&#x3D;1</span><br><span class="line">         0: aload_0</span><br><span class="line">         1: invokespecial #1                  &#x2F;&#x2F; Method java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;                                                                                                                                  &quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       5     0  this   Lcom&#x2F;notes&#x2F;concurrent&#x2F;synchronizeds&#x2F;Heavywei                                                                                                                                  ghtThread;</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;2, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; class com&#x2F;notes&#x2F;concurrent&#x2F;sync                                                                                                                                  hronizeds&#x2F;HeavyweightThread</span><br><span class="line">         2: dup</span><br><span class="line">         3: astore_1</span><br><span class="line">         4: monitorenter</span><br><span class="line">         5: invokestatic  #3                  &#x2F;&#x2F; Method test:()V</span><br><span class="line">         8: aload_1</span><br><span class="line">         9: monitorexit</span><br><span class="line">        10: goto          18</span><br><span class="line">        13: astore_2</span><br><span class="line">        14: aload_1</span><br><span class="line">        15: monitorexit</span><br><span class="line">        16: aload_2</span><br><span class="line">        17: athrow</span><br><span class="line">        18: return</span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">             5    10    13   any</span><br><span class="line">            13    16    13   any</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 13: 0</span><br><span class="line">        line 14: 5</span><br><span class="line">        line 15: 8</span><br><span class="line">        line 16: 18</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      19     0  args   [Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">      StackMapTable: number_of_entries &#x3D; 2</span><br><span class="line">        frame_type &#x3D; 255 &#x2F;* full_frame *&#x2F;</span><br><span class="line">          offset_delta &#x3D; 13</span><br><span class="line">          locals &#x3D; [ class &quot;[Ljava&#x2F;lang&#x2F;String;&quot;, class java&#x2F;lang&#x2F;Object ]</span><br><span class="line">          stack &#x3D; [ class java&#x2F;lang&#x2F;Throwable ]</span><br><span class="line">        frame_type &#x3D; 250 &#x2F;* chop *&#x2F;</span><br><span class="line">          offset_delta &#x3D; 4</span><br><span class="line"></span><br><span class="line">  public static void test();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;2, locals&#x3D;0, args_size&#x3D;0</span><br><span class="line">         0: getstatic     #4                  &#x2F;&#x2F; Field java&#x2F;lang&#x2F;System.out:Ljav                                                                                                                                  a&#x2F;io&#x2F;PrintStream;</span><br><span class="line">         3: ldc           #5                  &#x2F;&#x2F; String ▒▒ӡ</span><br><span class="line">         5: invokevirtual #6                  &#x2F;&#x2F; Method java&#x2F;io&#x2F;PrintStream.prin                                                                                                                                  tln:(Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 19: 0</span><br><span class="line">        line 20: 8</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;HeavyweightThread.java&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加了同步代码块之后,在字节码中会看到一个</p>
<p>monitorenter 和monitorexit</p>
<p>每一个java对象都会与一个监视器monitor 关联,我们可以把他理解成一把锁,当一个线程想要执行一段被synchronized 修饰的同步方法或者代码块时,该线程得先获取到synchronized 修饰的对象对应的monitor .</p>
<p>monitorenter 表示去获取一个对象的监视器,monitorexit 表示释放monitor 监视器的所有权,使得其他被阻塞的线程可以尝试去获得这个监视器.</p>
<p>monitor 依赖操作系统的MutexLock(互斥锁)来实现的,线程被阻塞后便进入到内核(Linux)调度任务,这个会导致系统在用户态和内核态之间来回切换,严重影响锁的性能.</p>
<p><strong>重量级锁的加锁的基本流程</strong><br><img src="http://files.luyanan.com/73e18db6-f38a-46af-a18a-bd162c12931e.jpg" alt="image"></p>
<p>任意线程对Object(Object由synchronized保护)的访问,首先要先获得Object的监视器.如果获取失败,线程进入同步队列,线程状态变为Blocked. 当访问Object 进程(获得了锁的线程) 释放了锁,则该释放操作唤醒阻塞在同步队列中的线程,使其重新尝试对监视器的获取.</p>
<h5 id="回顾线程的竞争机制"><a href="#回顾线程的竞争机制" class="headerlink" title="回顾线程的竞争机制"></a>回顾线程的竞争机制</h5><p>再来回顾一下线程的竞争机制对于锁升级这块的基本流程,方便大家更好的理解</p>
<p>加入有这样一个同步代码块,存在Thread#1,Thread#2等多个线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">synchronized(lock)&#123;</span><br><span class="line">    &#x2F;&#x2F; do Something </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>情况一: 只有Thread#1 会进入临界区</p>
<p>情况二: Thread#1和Thread#2 交替进入临界区,竞争不激烈</p>
<p>情况三: Thread#1/Thread#2/Thread#3… 同时进入临界区,竞争激烈</p>
<h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h4><p>此时当Thread#1 进入临界区时,JVM会将lockObject 对象头Mark Word 的锁标志位设置”01”,同时会用CAS操作把Thread#1的线程ID 记录到Mark Word 中,此时进入偏向模式.所谓偏向,指的是这个锁会偏向于Thread#1,若接下来没有其他线程进入临界区,则Thread#1 再出入临界区无需再执行任何的同步操作,也就是说,若只有Thread#1 会进入临界区,实际上只有Thread#1 初次进入临界区时需要执行CAS 操作,以后再出入临界区都不会有同步操作带来的开销.</p>
<h4 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h4><p>偏向锁的场景太多理想化,更多的时候是Thread#2 也会尝试进入临界区,如果Thread#2 也进入临界区但是Thread#! 还没有执行完同步代码块的时候,会暂停Thread#1 并且升级到轻量级锁.Thread#2 通过自旋再次尝试以轻量级锁的方式来获得锁.</p>
<h4 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h4><p>如果Thread#1和Thread#2正常交替执行,那么轻量级锁基本能够满足锁的需求.但是Thread#1和Thread#2 同时进入临界区,那么轻量级锁就会膨胀成重量级锁,意味着Thread#1 线程获得了重量级锁的情况下,Thread#2 就会被阻塞.</p>
<h2 id="Synchronized-结合java-Object-对象中的wait-notify-notifyAll"><a href="#Synchronized-结合java-Object-对象中的wait-notify-notifyAll" class="headerlink" title="Synchronized 结合java Object 对象中的wait,notify,notifyAll"></a>Synchronized 结合java Object 对象中的wait,notify,notifyAll</h2><p>前面讲到我们再将synchroized 的时候,发现被阻塞的线程什么时候被唤醒,取决于获得锁的线程什么时候执行完同步块并且释放锁.那么怎么做到显示控制呢? 我们就需要借助一个信号机制:在Object对象中,提供了wait/nofity/nofityAll，可以用于控制线程的状态.</p>
<h3 id="wait-nofity-nofityAll的基本概念"><a href="#wait-nofity-nofityAll的基本概念" class="headerlink" title="wait/nofity/nofityAll的基本概念"></a>wait/nofity/nofityAll的基本概念</h3><p><strong>wait</strong>:表示持有对象锁的线程A 准备释放对象锁权限,释放CPU资源并进入等待状态.<br><strong>notify</strong>:表示持有对象锁的线程A 准备释放对象锁权限,通知jvm唤醒某个竞争该线程锁的线程X. 线程A synchronized代码执行结束并且释放了锁之后,线程x 直接获得锁权限,其他竞争线程继续等待(即使线程X同步完毕,释放对象锁,其他竞争线程仍然等待,直至有新的 notify/notifyAll被调用)</p>
<p><strong>notifyAll</strong>: notifyAll和noify的区别在于,notifyAll会唤醒所有竞争同一个对象锁的所有线程,当已经获得锁的线程A 释放锁之后,所有被唤醒的线程都有可能获得对象锁权限.</p>
<p>需要注意的是:三个方法都必须在synchronized 同步关键字所限定的作用域中,否则会报java.lang.IllegalMonitorStateException,意思是没有同步方法.所以线程对象锁的状态是不确定的,不能调用这些方法.</p>
<p>另外,通过同步机制来确保线程从wait方法返回时能够感知到notify线程对变量做出的改变.</p>
<h4 id="wait-notify的基本使用"><a href="#wait-notify的基本使用" class="headerlink" title="wait/notify的基本使用"></a>wait/notify的基本使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">package com.notes.concurrent.synchronizeds;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author luyanan</span><br><span class="line"> * @since 2019&#x2F;7&#x2F;19</span><br><span class="line"> * &lt;p&gt;&lt;&#x2F;p&gt;</span><br><span class="line"> **&#x2F;</span><br><span class="line">public class ThreadA extends Thread &#123;</span><br><span class="line"></span><br><span class="line">    private Object lock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public ThreadA(Object lock) &#123;</span><br><span class="line">        this.lock &#x3D; lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line"></span><br><span class="line">        synchronized (lock) &#123;</span><br><span class="line">            System.out.println(&quot;start ThreadA&quot;);</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;&#x2F; 实现线程的阻塞</span><br><span class="line">                lock.wait();</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(&quot;end ThreadA&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.notes.concurrent.synchronizeds;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author luyanan</span><br><span class="line"> * @since 2019&#x2F;7&#x2F;19</span><br><span class="line"> * &lt;p&gt;&lt;&#x2F;p&gt;</span><br><span class="line"> **&#x2F;</span><br><span class="line">public class ThreadB extends Thread &#123;</span><br><span class="line"></span><br><span class="line">    private Object lock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public ThreadB(Object lock) &#123;</span><br><span class="line">        this.lock &#x3D; lock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run() &#123;</span><br><span class="line"></span><br><span class="line">        synchronized (lock) &#123;</span><br><span class="line">            System.out.println(&quot;start ThreadB&quot;);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 唤醒被阻塞的线程</span><br><span class="line">            lock.notify();</span><br><span class="line">            System.out.println(&quot;end ThreadB&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.notes.concurrent.synchronizeds;</span><br><span class="line"></span><br><span class="line">import javax.tools.Diagnostic;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * @author luyanan</span><br><span class="line"> * @since 2019&#x2F;7&#x2F;19</span><br><span class="line"> * &lt;p&gt;&lt;&#x2F;p&gt;</span><br><span class="line"> **&#x2F;</span><br><span class="line">public class WaitNotifyDemo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Object lock &#x3D; new Object();</span><br><span class="line">        ThreadA threadA &#x3D; new ThreadA(lock);</span><br><span class="line">        threadA.start();</span><br><span class="line">        ThreadB threadB &#x3D; new ThreadB(lock);</span><br><span class="line">        threadB.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">start ThreadA</span><br><span class="line">start ThreadB</span><br><span class="line">end ThreadB</span><br><span class="line">end ThreadA</span><br></pre></td></tr></table></figure>
<h4 id="wait-notify的基本原理"><a href="#wait-notify的基本原理" class="headerlink" title="wait/notify的基本原理"></a>wait/notify的基本原理</h4><h5 id="wait-notify的基本原理-1"><a href="#wait-notify的基本原理-1" class="headerlink" title="wait/notify的基本原理"></a>wait/notify的基本原理</h5><p><img src="http://files.luyanan.com/73e18db6-f38a-46af-a18a-bd162c12931e.jpg" alt="image"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
              <a href="/tags/C/" rel="tag"># C++</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/1.%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%86/" rel="prev" title="1">
      <i class="fa fa-chevron-left"></i> 1
    </a></div>
      <div class="post-nav-item">
    <a href="/4.%20ReentrantLock%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" rel="next" title="4">
      4 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">2. 多线程的基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%B1%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83"><span class="nav-number">1.1.</span> <span class="nav-text">由一个问题引发的思考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%AF%B9%E4%BA%8E%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F%E8%AE%BF%E9%97%AE%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E9%97%AE%E9%A2%98"><span class="nav-number">1.1.1.</span> <span class="nav-text">多线程对于共享变量访问带来的安全性问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E7%BA%BF%E7%A8%8B%E5%B9%B6%E8%A1%8C%E7%9A%84%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">思考如何保证线程并行的数据安全性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Synchronized%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AE%A4%E8%AF%86"><span class="nav-number">1.1.2.</span> <span class="nav-text">Synchronized的基本认识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#synchronized-%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">synchronized 的基本语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#synchronized-%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">synchronized 的应用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%9D%E8%80%83%E9%94%81%E6%98%AF%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%E7%9A%84"><span class="nav-number">1.1.3.</span> <span class="nav-text">思考锁是如何存储的</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E5%B8%83%E5%B1%80"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">对象在内存中的布局</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A2%E7%A9%B6jvm-%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">探究jvm 源码实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MarkWord"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">MarkWord</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%AF%8F%E4%B8%AA%E5%AF%B9%E8%B1%A1%E9%83%BD%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0%E9%94%81"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">为什么每个对象都可以实现锁?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronized-%E9%94%81%E7%9A%84%E5%8D%87%E7%BA%A7"><span class="nav-number">1.1.4.</span> <span class="nav-text">synchronized 锁的升级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">偏向锁的基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E7%9A%84%E8%8E%B7%E5%8F%96%E9%80%BB%E8%BE%91"><span class="nav-number">1.1.4.1.1.</span> <span class="nav-text">偏向锁的获取逻辑</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E7%9A%84%E6%92%A4%E9%94%80"><span class="nav-number">1.1.4.1.2.</span> <span class="nav-text">偏向锁的撤销</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">轻量级锁的基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E7%9A%84%E5%8A%A0%E9%94%81%E5%92%8C%E8%A7%A3%E9%94%81%E9%80%BB%E8%BE%91"><span class="nav-number">1.1.4.2.1.</span> <span class="nav-text">轻量级锁的加锁和解锁逻辑</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-number">1.1.4.2.2.</span> <span class="nav-text">自旋锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E7%9A%84%E8%A7%A3%E9%94%81"><span class="nav-number">1.1.4.2.3.</span> <span class="nav-text">轻量级锁的解锁</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.4.3.</span> <span class="nav-text">重量级锁的基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9B%9E%E9%A1%BE%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%AB%9E%E4%BA%89%E6%9C%BA%E5%88%B6"><span class="nav-number">1.1.4.3.1.</span> <span class="nav-text">回顾线程的竞争机制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%81%8F%E5%90%91%E9%94%81"><span class="nav-number">1.1.4.4.</span> <span class="nav-text">偏向锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">1.1.4.5.</span> <span class="nav-text">轻量级锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81"><span class="nav-number">1.1.4.6.</span> <span class="nav-text">重量级锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Synchronized-%E7%BB%93%E5%90%88java-Object-%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84wait-notify-notifyAll"><span class="nav-number">1.2.</span> <span class="nav-text">Synchronized 结合java Object 对象中的wait,notify,notifyAll</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#wait-nofity-nofityAll%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.2.1.</span> <span class="nav-text">wait&#x2F;nofity&#x2F;nofityAll的基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#wait-notify%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">wait&#x2F;notify的基本使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wait-notify%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">wait&#x2F;notify的基本原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#wait-notify%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86-1"><span class="nav-number">1.2.1.2.1.</span> <span class="nav-text">wait&#x2F;notify的基本原理</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">227</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luyanan0718" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luyanan0718" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/luyanan0718@163.com" title="E-Mail → luyanan0718@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://luyanan.com/" title="https:&#x2F;&#x2F;luyanan.com">Site</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
