<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.jpg">
  <link rel="mask-icon" href="/images/logo.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"luyanan.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Istio 核心架构和实战1. 组件介绍Components 官网:https:&#x2F;&#x2F;istio.io&#x2F;docs&#x2F;ops&#x2F;deployment&#x2F;architecture&#x2F;#components 1.1 Proxy[Envoy]proxy 在Istio 架构中必须存在.">
<meta property="og:type" content="article">
<meta property="og:title" content="Istio架构原理和实战(2)">
<meta property="og:url" content="http://luyanan.com/Istio%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E6%88%98(2)/index.html">
<meta property="og:site_name" content="程序员报社">
<meta property="og:description" content="Istio 核心架构和实战1. 组件介绍Components 官网:https:&#x2F;&#x2F;istio.io&#x2F;docs&#x2F;ops&#x2F;deployment&#x2F;architecture&#x2F;#components 1.1 Proxy[Envoy]proxy 在Istio 架构中必须存在.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://files.luyanan.com//img/20200506162752.png">
<meta property="og:image" content="http://files.luyanan.com//img/20200506210601.png">
<meta property="article:published_time" content="2021-03-12T02:17:43.857Z">
<meta property="article:modified_time" content="2021-03-12T02:17:43.857Z">
<meta property="article:author" content="luyanan">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="C++">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://files.luyanan.com//img/20200506162752.png">

<link rel="canonical" href="http://luyanan.com/Istio%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E6%88%98(2)/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Istio架构原理和实战(2) | 程序员报社</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程序员报社" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程序员报社</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">程序员报社</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://luyanan.com/Istio%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E6%88%98(2)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/logo.jpg">
      <meta itemprop="name" content="luyanan">
      <meta itemprop="description" content="程序员报社">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程序员报社">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Istio架构原理和实战(2)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-12 10:17:43" itemprop="dateCreated datePublished" datetime="2021-03-12T10:17:43+08:00">2021-03-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Service-Mesh/" itemprop="url" rel="index"><span itemprop="name">Service Mesh</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Istio-核心架构和实战"><a href="#Istio-核心架构和实战" class="headerlink" title="Istio 核心架构和实战"></a><code>Istio</code> 核心架构和实战</h1><h2 id="1-组件介绍"><a href="#1-组件介绍" class="headerlink" title="1. 组件介绍"></a>1. 组件介绍</h2><p><code>Components</code> 官网:<a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#components">https://istio.io/docs/ops/deployment/architecture/#components</a></p>
<h3 id="1-1-Proxy-Envoy"><a href="#1-1-Proxy-Envoy" class="headerlink" title="1.1 Proxy[Envoy]"></a>1.1 <code>Proxy[Envoy]</code></h3><p><code>proxy</code> 在<code>Istio</code> 架构中必须存在. </p>
<p><code>Envoy</code> 是由<code>Lyft</code>开发并开源的,使用<code>C++</code> 编写的高性能代理,负责在服务网格中服务的进出流量</p>
<blockquote>
<p>Istio uses an extended version of the Envoy proxy. Envoy is a highperformance proxy developed in C++ to mediate all inbound and outbound traffic for all services in the service mesh. Envoy proxies are the only Istio components that interact with data plane traffic.</p>
</blockquote>
<p><code>官网:</code><a target="_blank" rel="noopener" href="https://www.envoyproxy.io/">https://www.envoyproxy.io/</a></p>
<blockquote>
<p>ENVOY IS AN OPEN SOURCE EDGE AND SERVICE PROXY, DESIGNED FOR CLOUD-NATIVE APPLICATIONS</p>
</blockquote>
<p><code>github</code>: <a target="_blank" rel="noopener" href="https://github.com/envoyproxy/envoy">https://github.com/envoyproxy/envoy</a></p>
<blockquote>
<p>Envoy is hosted by the Cloud Native Computing Foundation (CNCF). If you are a company that wants to help shape the evolution of technologies that are container-packaged, dynamically-scheduled and microservices-oriented, consider joining the CNCF. For details about who’s involved and how Envoy plays a role, read the CNCF announcement.</p>
</blockquote>
<h4 id="1-1-1-Features"><a href="#1-1-1-Features" class="headerlink" title="1.1.1  Features"></a>1.1.1  <code>Features</code></h4><ul>
<li>Dynamic service discovery </li>
<li>Load balancing </li>
<li>TLS termination </li>
<li>HTTP/2 and gRPC proxies </li>
<li>Circuit breakers </li>
<li>Health checks </li>
<li>Staged rollouts with %-based traffic split </li>
<li>Fault injection </li>
<li>Rich metrics</li>
</ul>
<h4 id="1-1-2-为什么选择Envoy"><a href="#1-1-2-为什么选择Envoy" class="headerlink" title="1.1.2  为什么选择Envoy"></a>1.1.2  为什么选择<code>Envoy</code></h4><p>对于<code>Sidecar/Proxy</code> 其实不仅仅可以选择<code>Envoy</code>, 还可以用<code>Likerd</code>、<code>Nginx</code>和<code>NginMesh</code>等. </p>
<p>像<code>Nginx</code> 作为分布式架构中比较广泛使用的网关,<code>Istio</code> 默认却没有选择,是因为<code>Nginx</code> 没有<code>Envoy</code> 优秀的配置扩展,<code>Envoy</code> 可以实时配置. </p>
<h3 id="1-2-Mixer"><a href="#1-2-Mixer" class="headerlink" title="1.2 Mixer"></a>1.2 <code>Mixer</code></h3><blockquote>
<p><code>Mixer</code> 在<code>Istio</code> 架构中不是必须的. </p>
</blockquote>
<p><code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#mixer">https://istio.io/docs/ops/deployment/architecture/#mixer</a></p>
<blockquote>
<p>Mixer is a platform-independent component. Mixer enforces access control and usage policies across the service mesh, and collects telemetry data from the Envoy proxy and other services. The proxy extracts request level attributes, and sends them to Mixer for evaluation. You can find more information on this attribute extraction and policy evaluation in our Mixer Configuration documentation. </p>
<p>Mixer includes a flexible plugin model. This model enables Istio to interface with a variety of host environments and infrastructure backends. Thus, Istio abstracts the Envoy proxy and Istio-managed services from these details.</p>
</blockquote>
<ul>
<li>为集群执行访问控制,哪些用户可以访问哪些服务? 包括白名单检查、ACL 检查等. </li>
<li>策略管理,比如某个服务最多只能接受多少流量请求</li>
<li>遥测报告上报,比如从<code>Envoy</code>中收集数据[请求数据、使用时间、使用的协议等], 通过<code>Adpater</code> 上报给<code>Primethues</code>、<code>Heapster</code>等. </li>
</ul>
<h3 id="1-3-Pilot"><a href="#1-3-Pilot" class="headerlink" title="1.3 Pilot"></a>1.3 <code>Pilot</code></h3><p><code>Pilot</code>在<code>Istio</code>架构中必须要有</p>
<blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#pilot">https://istio.io/docs/ops/deployment/architecture/#pilot</a></p>
</blockquote>
<blockquote>
<p>Pilot provides service discovery for the Envoy sidecars, traffic management capabilities for intelligent routing (e.g., A/B tests, canary rollouts, etc.), and resiliency (timeouts, retries, circuit breakers, etc.).</p>
<p>Pilot converts high level routing rules that control traffic behavior into Envoy-specific configurations, and propagates them to the sidecars at runtime. Pilot abstracts platform-specific service discovery mechanisms and synthesizes them into a standard format that any sidecar conforming with the <a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/api/api">Envoy API</a> can consume.</p>
</blockquote>
<p><code>Pilot</code> 为<code>Envoy Sidecar</code> 提供了服务发现功能, 为智能路由提供了流量管理能力(比如A/B测试,金丝雀发布等)</p>
<p><code>Pilot</code> 本身不做服务注册,它会提供一个接口,对接已有的服务注册系统,比如<code>Eureka</code>、<code>Etcd</code>等, <code>Pilot</code> 对配置的格式做了抽象,整理成能够符合<code>Envoy</code> 数据层的<code>API</code></p>
<blockquote>
<ol>
<li><code>Pilot</code> 定义了一个抽象模型,从特定平台细节中解耦,用于对接外部的不同平台</li>
<li><code>Envoy API</code> 负责和<code>Envoy</code> 的通讯,主要是发送服务发现信息和流量控制规则给<code>Envoy</code></li>
<li><code>Platform Adapter</code>  是<code>Pilot</code> 抽象模型的实现版本,用于对接外部的不同平台</li>
</ol>
</blockquote>
<h3 id="1-4-Galley"><a href="#1-4-Galley" class="headerlink" title="1.4 Galley"></a>1.4 <code>Galley</code></h3><p><code>Galley</code> 在<code>Istio</code> 架构中不是必须的</p>
<blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#galley">https://istio.io/docs/ops/deployment/architecture/#galley</a></p>
</blockquote>
<blockquote>
<p>Galley is Istio’s configuration validation, ingestion, processing and distribution component. It is responsible for insulating the rest of the Istio components from the details of obtaining user configuration from the underlying platform (e.g. Kubernetes).</p>
</blockquote>
<p>主要负责<code>Istio</code> 配置的校验、各种配置之间的统筹,为<code>Istio</code> 提供配置管理服务, 通过<code>Kubernetes</code> 的<code>webhook</code> 机制对<code>pilot</code> 和<code>mixer</code>的配置进行验证. </p>
<h3 id="1-5-Citadel"><a href="#1-5-Citadel" class="headerlink" title="1.5 Citadel"></a>1.5 <code>Citadel</code></h3><p><code>Citadel</code>在<code>Istio</code> 架构中不是必须的</p>
<blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/ops/deployment/architecture/#citadel">https://istio.io/docs/ops/deployment/architecture/#citadel</a></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/security/">Citadel</a> enables strong service-to-service and end-user authentication with built-in identity and credential management. You can use Citadel to upgrade unencrypted traffic in the service mesh. Using Citadel, operators can enforce policies based on service identity rather than on relatively unstable layer 3 or layer 4 network identifiers. Starting from release 0.5, you can use <a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/security/#authorization">Istio’s authorization feature</a> to control who can access your services.</p>
</blockquote>
<p>在有一些场景中,对于安全的要求是非常高的,比如支付,所以<code>Citadel</code> 就是用来保证安全的. </p>
<h2 id="2-实战之Bookinfo"><a href="#2-实战之Bookinfo" class="headerlink" title="2. 实战之Bookinfo"></a>2. 实战之<code>Bookinfo</code></h2><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/">https://istio.io/docs/examples/bookinfo/</a></p>
</blockquote>
<blockquote>
<p>This example deploys a sample application composed of four separate microservices used to demonstrate various Istio features.</p>
<p>The application displays information about a book, similar to a single catalog entry of an online book store. Displayed on the page is a description of the book, book details (ISBN, number of pages, and so on), and a few book reviews.</p>
<p>The Bookinfo application is broken into four separate microservices:</p>
<ul>
<li><code>productpage</code>. The <code>productpage</code> microservice calls the <code>details</code> and <code>reviews</code> microservices to populate the page.</li>
<li><code>details</code>. The <code>details</code> microservice contains book information.</li>
<li><code>reviews</code>. The <code>reviews</code> microservice contains book reviews. It also calls the <code>ratings</code> microservice.</li>
<li><code>ratings</code>. The <code>ratings</code> microservice contains book ranking information that accompanies a book review.</li>
</ul>
<p>There are 3 versions of the <code>reviews</code> microservice:</p>
<ul>
<li>Version v1 doesn’t call the <code>ratings</code> service.</li>
<li>Version v2 calls the <code>ratings</code> service, and displays each rating as 1 to 5 black stars.</li>
<li>Version v3 calls the <code>ratings</code> service, and displays each rating as 1 to 5 red stars.</li>
</ul>
<p>The end-to-end architecture of the application is shown below.</p>
<p><img src="http://files.luyanan.com//img/20200506162752.png" alt="image-20200506162720701"></p>
</blockquote>
<blockquote>
<p> This application is polyglot, i.e., the microservices are written in different languages. It’s worth noting that these services have no dependencies on Istio, but make an interesting service mesh example, particularly because of the multitude of services, languages and versions for the <code>reviews</code> service.</p>
</blockquote>
<h3 id="2-1-理解Bookinfo"><a href="#2-1-理解Bookinfo" class="headerlink" title="2.1 理解Bookinfo"></a>2.1 理解<code>Bookinfo</code></h3><ol>
<li> <code>productpage</code> 是<code>python</code>  语言编写的,用于前端页面展示,会调用 <code>reviews</code>微服务和<code>details</code>服务</li>
<li><code>details</code> 是<code>Ruby</code> 语言编写的,是书籍的详情信息</li>
<li><code>reviews</code> 是java编写的,是书籍的评论信息,会调用<code>ratings</code> 微服务, 有3个版本</li>
<li><code>ratings</code>是<code>node.js</code> 语言编写的,是书籍的评分部分</li>
</ol>
<h3 id="2-2-Sidecar-自动注入到微服务"><a href="#2-2-Sidecar-自动注入到微服务" class="headerlink" title="2.2 Sidecar 自动注入到微服务"></a>2.2 <code>Sidecar</code> 自动注入到微服务</h3><p><code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/#start-the-application-services">https://istio.io/docs/examples/bookinfo/#start-the-application-services</a></p>
<blockquote>
<p>To run the sample with Istio requires no changes to the application itself. Instead, you simply need to configure and run the services in an Istio-enabled environment, with Envoy sidecars injected along side each service. The resulting deployment will look like this</p>
</blockquote>
<blockquote>
<p>All of the microservices will be packaged with an Envoy sidecar that intercepts incoming and outgoing calls for the services, providing the hooks needed to externally control, via the Istio control plane, routing, telemetry collection, and policy enforcement for the application as a whole.</p>
</blockquote>
<ol>
<li><p>Change directory to the root of the Istio installation.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> istio-1.0.6</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>)The default Istio installation uses automatic sidecar injection. Label the namespace that will host the application with <code>istio-injection=enabled</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br><span class="line">kubectl get namespaces --show-labels</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Deploy your application using the kubectl command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f istio-1.0.6/samples/bookinfo/platform/kube/bookinfo.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>pod</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME READY STATUS</span><br><span class="line">details-v1-d458c8599-l2rpr 2/2 Running</span><br><span class="line">productpage-v1-79d85ff9fc-jvlrn 2/2 Running</span><br><span class="line">ratings-v1-567bfb85cf-lrkpm 2/2 Running</span><br><span class="line">reviews-v1-fd6c96c74-ncl8k 2/2 Running</span><br><span class="line">reviews-v2-68d98477f6-s5f7l 2/2 Running</span><br><span class="line">reviews-v3-8495f5f6bb-mx8q2 2/2 Running</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>sv</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span><br><span class="line">details ClusterIP 10.103.89.119 &lt;none&gt; 9080/TCP 5m48s</span><br><span class="line">kubernetes ClusterIP 10.96.0.1 &lt;none&gt; 443/TCP 18d</span><br><span class="line">productpage ClusterIP 10.104.220.93 &lt;none&gt; 9080/TCP 5m48s</span><br><span class="line">ratings ClusterIP 10.106.48.89 &lt;none&gt; 9080/TCP 5m48s</span><br><span class="line">reviews ClusterIP 10.98.5.206 &lt;none&gt; 9080/TCP 5m48s</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试一下是否成功</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it $(kubectl get pod -l app=ratings -o</span><br><span class="line">jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -c ratings -- curl</span><br><span class="line">productpage:9080/productpage | grep -o <span class="string">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





</li>
</ol>
<h3 id="2-3-通过Ingress-方式访问"><a href="#2-3-通过Ingress-方式访问" class="headerlink" title="2.3 通过Ingress 方式访问"></a>2.3 通过<code>Ingress</code> 方式访问</h3><ol>
<li><p>创建<code>ingress</code> 规则</p>
<p><code>productpage-ingress.yaml</code> 资源文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">productpage.istio.luyanan.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">productpage</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">9080</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>访问测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">productpage.istio.luyanan.com</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h3 id="2-4-通过Istio的Ingressgateway访问"><a href="#2-4-通过Istio的Ingressgateway访问" class="headerlink" title="2.4  通过Istio的Ingressgateway访问"></a>2.4  通过<code>Istio</code>的<code>Ingressgateway</code>访问</h3><p><code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/#determine-the-ingress-ip-and-port">https://istio.io/docs/examples/bookinfo/#determine-the-ingress-ip-and-port</a></p>
<ol>
<li><p>Define the ingress gateway for the application:</p>
<p><code>istio-1.0.6/samples/bookinfo/networking/bookinfo-gateway.yaml</code></p>
<p>可以查看一下该yaml文件，一个是Gateway，一个是VirtualService</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f bookinfo-gateway.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Confirm the gateway has been created:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get gateway</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>set the <code>INGRESS_HOST</code> and <code>INGRESS_PORT</code> variables for accessing the gateway</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o</span><br><span class="line">jsonpath=<span class="string">&#x27;&#123;.items[0].status.hostIP&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -</span><br><span class="line">o jsonpath=<span class="string">&#x27;&#123;.spec.ports[?(@.name==&quot;http2&quot;)].nodePort&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Set <code>GATEWAY_URL</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GATEWAY_URL=<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>INGRESS_PORT</code>端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如结果为31380</span></span><br><span class="line">env | grep INGRESS_PORT</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<p>不断的访问测试,发现会访问<code>review</code>的不同版本</p>
</li>
<li><p>Apply default destination rules</p>
<p> <code>官网</code>: <a target="_blank" rel="noopener" href="https://istio.io/docs/examples/bookinfo/#apply-default-destination-rules">https://istio.io/docs/examples/bookinfo/#apply-default-destination-rules</a></p>
<blockquote>
<p>Before you can use Istio to control the Bookinfo version routing, you need to define the available versions, called <em>subsets</em>, in <a target="_blank" rel="noopener" href="https://istio.io/docs/concepts/traffic-management/#destination-rules">destination rules</a>.</p>
</blockquote>
<p><code>istio-1.0.6/samples/bookinfo/networking/destination-rule-all.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f destination-rule-all.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>





</li>
</ol>
<h3 id="2-5-体验Istio的流量管理"><a href="#2-5-体验Istio的流量管理" class="headerlink" title="2.5 体验Istio的流量管理"></a>2.5 体验<code>Istio</code>的流量管理</h3><p>流量这块就体现了<code>Pilot</code>和<code>Envoy</code>的功能</p>
<h4 id="2-5-1-基于版本的路由"><a href="#2-5-1-基于版本的路由" class="headerlink" title="2.5.1 基于版本的路由"></a>2.5.1 基于版本的路由</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/request-routing/#apply-a-virtual-service">https://istio.io/docs/tasks/traffic-management/request-routing/#apply-a-virtual-service</a></p>
</blockquote>
<p>之前刷新<code>productpage</code>页面的时候,发现<code>review</code>的版本一直会变,能不能一直访问某个版本呢?</p>
<p><code>istio-1.0.6/samples/bookinfo/networking/virtual-service-reviews-v3.yaml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-reviews-v3.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再次访问测试<code>http://121.41.10.13:31380/productpage</code></p>
<h4 id="2-5-2-基于用户身份的路由"><a href="#2-5-2-基于用户身份的路由" class="headerlink" title="2.5.2 基于用户身份的路由"></a>2.5.2 基于用户身份的路由</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/request-routing/#route-based-on-user-identity">https://istio.io/docs/tasks/traffic-management/request-routing/#route-based-on-user-identity</a></p>
</blockquote>
<blockquote>
<p>Next, you will change the route configuration so that all traffic from a specific user is routed to a specific service version. In this case, all traffic from a user named Jason will be routed to the service <code>reviews:v2</code>.</p>
<p>Note that Istio doesn’t have any special, built-in understanding of user identity. This example is enabled by the fact that the <code>productpage</code> service adds a custom <code>end-user</code> header to all outbound HTTP requests to the reviews service.</p>
<p>Remember, <code>reviews:v2</code> is the version that includes the star ratings feature.</p>
</blockquote>
<ol>
<li><p>根据对应文件创建资源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">istio-1.0.6/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<p><code># 使用jason来登录[右上角有Sign in的功能或者url?u=jason]，一直会访问到v2版本</code></p>
<blockquote>
<p>On the /productpage of the Bookinfo app, log in as user jason. Refresh the browser. What do you see? The star ratings appear next to each review.</p>
</blockquote>
<p>  <code># 使用其他用户登陆,一直会访问到v1版本</code></p>
<blockquote>
<p>Log in as another user (pick any name you wish). Refresh the browser. Now the stars are gone. This is because traffic is routed to reviews:v1 for all users except Jason.</p>
</blockquote>
</li>
</ol>
<h4 id="2-5-3-基于权重的路由"><a href="#2-5-3-基于权重的路由" class="headerlink" title="2.5.3  基于权重的路由"></a>2.5.3  基于权重的路由</h4><ol>
<li><p>根据对应文件创建资源</p>
<p><code>istio-1.0.6/samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml</code></p>
<p>一般几率访问到v1,一般的几率访问到v3</p>
<p>这里就相当于之前的蓝绿部署,AB测试或者灰度发布</p>
<p>权重加起来必须是100</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-reviews-50-v3.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://121.41.10.13:31380/productpage</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h4 id="2-5-4-故障注入"><a href="#2-5-4-故障注入" class="headerlink" title="2.5.4  故障注入"></a>2.5.4  故障注入</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/fault-injection/">https://istio.io/docs/tasks/traffic-management/fault-injection/</a></p>
</blockquote>
<blockquote>
<p>Apply application version routing by either performing the <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/request-routing/">request routing</a> task or by running the following commands:</p>
</blockquote>
<p><code>istio-1.0.6/samples/bookinfo/networking/</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-all-v1.yaml</span><br><span class="line">kubectl apply -f virtual-service-reviews-test-v2.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>With the above configuration, this is how requests flow:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">productpage → reviews:v2 → ratings (only <span class="keyword">for</span> user jason)</span><br><span class="line">productpage → reviews:v1 (<span class="keyword">for</span> everyone <span class="keyword">else</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>To test the Bookinfo application microservices for resiliency, inject a 7s delay between the <code>reviews:v2</code> and <code>ratings</code> microservices for user <code>jason</code>. This test will uncover a bug that was intentionally introduced into the Bookinfo app.</p>
<p>Note that the <code>reviews:v2</code> service has a 10s hard-coded connection timeout for calls to the <code>ratings</code> service. Even with the 7s delay that you introduced, you still expect the end-to-end flow to continue without any errors.</p>
</blockquote>
<ol>
<li><p>创建一个故障注入规则,使得<code>jason</code> 用户访问v2 到<code>ratings</code> 有7秒的延迟</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-ratings-test-delay.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>使得<code>jason</code>账户登陆,并且访问<code>productpage</code>页面,会得到这样一个返回信息</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error fetching product reviews!</span><br><span class="line">Sorry, product reviews are currently unavailable for this book.</span><br></pre></td></tr></table></figure>
</li>
<li><p>View the web page response times:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Open the Developer Tools menu in you web browser.</span><br><span class="line">Open the Network tab</span><br><span class="line">Reload the /productpage web page. You will see that the page actually loads in</span><br><span class="line">about 6 seconds.</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h4 id="2-5-5-流量迁移"><a href="#2-5-5-流量迁移" class="headerlink" title="2.5.5  流量迁移"></a>2.5.5  流量迁移</h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/traffic-management/traffic-shifting/">https://istio.io/docs/tasks/traffic-management/traffic-shifting/</a></p>
</blockquote>
<blockquote>
<p>This task shows you how to gradually migrate traffic from one version of a microservice to another. For example, you might migrate traffic from an older version to a new version.</p>
<p>A common use case is to migrate traffic gradually from one version of a microservice to another. In Istio, you accomplish this goal by configuring a sequence of rules that route a percentage of traffic to one service or another. In this task, you will send 50% of traffic to <code>reviews:v1</code> and 50% to <code>reviews:v3</code>. Then, you will complete the migration by sending 100% of traffic to <code>reviews:v3</code>.</p>
</blockquote>
<ol>
<li><p>让所有的流量都到v1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>将v1的50% 流量转移到v3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-reviews-50-v3.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>确保v3版本没问题后,可以将流量都转移到v3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-reviews-v3.yaml</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>访问测试,看是否都访问到v3 版本</p>
</li>
</ol>
<h3 id="2-6-体验Istio的Obseerve"><a href="#2-6-体验Istio的Obseerve" class="headerlink" title="2.6  体验Istio的Obseerve"></a>2.6  体验<code>Istio</code>的<code>Obseerve</code></h3><p>这块就体现了<code>Mixer</code>和<code>Envoy</code>的功能</p>
<h4 id="2-6-1-收集Metrics"><a href="#2-6-1-收集Metrics" class="headerlink" title="2.6.1 收集Metrics"></a>2.6.1 收集<code>Metrics</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/collecting-metrics/">https://istio.io/docs/tasks/observability/metrics/collecting-metrics/</a></p>
</blockquote>
<blockquote>
<p>This task shows how to configure Istio to automatically gather telemetry for services in a mesh. At the end of this task, a new metric will be enabled for calls to services within your mesh.</p>
</blockquote>
<ol>
<li><p>Apply a YAML file with configuration for the new metric that Istio will generate and collect automatically</p>
<p><code>metrics-crd.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Configuration for metric instances</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;config.istio.io/v1alpha2&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">instance</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">doublerequestcount</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">compiledTemplate:</span> <span class="string">metric</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;2&quot;</span> <span class="comment"># count each request twice</span></span><br><span class="line">    <span class="attr">dimensions:</span></span><br><span class="line">      <span class="attr">reporter:</span> <span class="string">conditional((context.reporter.kind</span> <span class="string">|</span> <span class="string">&quot;inbound&quot;</span><span class="string">)</span> <span class="string">==</span> <span class="string">&quot;outbound&quot;</span><span class="string">,</span> <span class="string">&quot;client&quot;</span><span class="string">,</span> <span class="string">&quot;server&quot;</span><span class="string">)</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">source.workload.name</span> <span class="string">|</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">      <span class="attr">destination:</span> <span class="string">destination.workload.name</span> <span class="string">|</span> <span class="string">&quot;unknown&quot;</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">&#x27;&quot;twice the fun!&quot;&#x27;</span></span><br><span class="line">    <span class="attr">monitored_resource_type:</span> <span class="string">&#x27;&quot;UNSPECIFIED&quot;&#x27;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Configuration for a Prometheus handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;config.istio.io/v1alpha2&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">doublehandler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">double_request_count</span> <span class="comment"># Prometheus metric name</span></span><br><span class="line">    <span class="attr">instance_name:</span> <span class="string">doublerequestcount.instance.istio-system</span> <span class="comment"># Mixer instance name (fully-qualified)</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">COUNTER</span></span><br><span class="line">    <span class="attr">label_names:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">reporter</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">source</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">destination</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">message</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Rule to send metric instances to a Prometheus handler</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;config.istio.io/v1alpha2&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">rule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">doubleprom</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">actions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">handler:</span> <span class="string">doublehandler.prometheus</span></span><br><span class="line">    <span class="attr">instances:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">doublerequestcount</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Send traffic to the sample application</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://121.41.10.13:31380/productpage</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>访问 <code>prometheus</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://prometheus.istio.luyanan.com/</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据 <code>istio_double_request_count</code> 进行查询</p>
</li>
<li><p>Understanding the metrics configuration</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/collecting-metrics/#understanding-the-metrics-configuration">https://istio.io/docs/tasks/observability/metrics/collecting-metrics/#understanding-the-metrics-configuration</a></p>
</blockquote>
</li>
</ol>
<h4 id="2-6-2-查询Istio的Metrics"><a href="#2-6-2-查询Istio的Metrics" class="headerlink" title="2.6.2  查询Istio的Metrics"></a>2.6.2  查询<code>Istio</code>的<code>Metrics</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/querying-metrics/">https://istio.io/docs/tasks/observability/metrics/querying-metrics/</a></p>
</blockquote>
<blockquote>
<p>This task shows you how to query for Istio Metrics using Prometheus. As part of this task, you will use the web-based interface for querying metric values.</p>
</blockquote>
<ol>
<li><p>访问<code> productpage</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://121.41.10.13:31380/productpage</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开<code>prometheus</code> 界面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://prometheus.istio.luyanan.com/</span><br></pre></td></tr></table></figure>
</li>
<li><p>输入查询指标</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">istio_requests_total</span><br></pre></td></tr></table></figure>
</li>
<li><p>About the Prometheus add-on</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/metrics/querying-metrics/#about-theprometheus-add-on">https://istio.io/docs/tasks/observability/metrics/querying-metrics/#about-theprometheus-add-on</a></p>
</blockquote>
</li>
</ol>
<h4 id="2-6-3-分布式追踪之Jaeger"><a href="#2-6-3-分布式追踪之Jaeger" class="headerlink" title="2.6.3 分布式追踪之Jaeger"></a>2.6.3 分布式追踪之<code>Jaeger</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/distributed-tracing/overview/">https://istio.io/docs/tasks/observability/distributed-tracing/overview/</a></p>
</blockquote>
<blockquote>
<p>Distributed tracing enables users to track a request through mesh that is distributed across multiple services. This allows a deeper understanding about request latency, serialization and parallelism via visualization</p>
</blockquote>
<blockquote>
<p><code>jaeger官网</code>:<a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/distributed-tracing/jaeger/">https://istio.io/docs/tasks/observability/distributed-tracing/jaeger/</a></p>
</blockquote>
<blockquote>
<p>After completing this task, you understand how to have your application participate in tracing with <a target="_blank" rel="noopener" href="https://www.jaegertracing.io/">Jaeger</a>, regardless of the language, framework, or platform you use to build your application.</p>
</blockquote>
<blockquote>
<p>istio-tracing-c8b67b59c-8vgrl 1/1 Running —&gt; 即Jaeger，默认已经安装</p>
</blockquote>
<ol>
<li><p>查看<code>jaeger</code> 的<code>svc</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n istio-system | grep jae</span><br><span class="line">kubectl get svc jaeger-query -n istio-system -o yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>jaeage</code>的<code>ingress</code></p>
<p><code>jaeger-ingress.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ingress</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jaeger-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">jaeger.istio.luyanan.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">jaeger-query</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">16686</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>浏览器访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jaeger.istio.luyanan.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>发送100个请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 100`; <span class="keyword">do</span> curl -s -o /dev/null</span><br><span class="line">http://121.41.10.13:31380/productpage; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>进入到<code>jaeger</code> 界面</p>
<p>选择<code>productpage</code>, 查询详情</p>
</li>
</ol>
<h4 id="2-6-4-Mesh-可视化之Kiali"><a href="#2-6-4-Mesh-可视化之Kiali" class="headerlink" title="2.6.4  Mesh  可视化之Kiali"></a>2.6.4  <code>Mesh</code>  可视化之<code>Kiali</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/tasks/observability/kiali/">https://istio.io/docs/tasks/observability/kiali/</a></p>
</blockquote>
<blockquote>
<p>This task shows you how to visualize different aspects of your Istio mesh.</p>
<p>As part of this task, you install the <a target="_blank" rel="noopener" href="https://www.kiali.io/">Kiali</a> add-on and use the web-based graphical user interface to view service graphs of the mesh and your Istio configuration objects. Lastly, you use the Kiali Public API to generate graph data in the form of consumable JSON.</p>
</blockquote>
<h2 id="3-安装Istio-Helm"><a href="#3-安装Istio-Helm" class="headerlink" title="3. 安装Istio(Helm)"></a>3. 安装<code>Istio(Helm)</code></h2><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/setup/install/helm/">https://istio.io/docs/setup/install/helm/</a></p>
</blockquote>
<h3 id="3-1-下载安装Helm"><a href="#3-1-下载安装Helm" class="headerlink" title="3.1  下载安装Helm"></a>3.1  下载安装<code>Helm</code></h3><h4 id="3-1-1-Helm-简介"><a href="#3-1-1-Helm-简介" class="headerlink" title="3.1.1 Helm 简介"></a>3.1.1 <code>Helm</code> 简介</h4><p><code>Helm</code> 是<code>kubernetes</code> 的软件包管理工具,类似于<code>Ubuntu</code> 中的<code>apt</code>、<code>Contos</code> 中的<code>yum</code>等. 可以快速查找、下载和安装软件包,<code>Helm</code> 由客户端组件<code>helm</code>和服务端组件<code>tiller</code> 组成</p>
<h4 id="3-1-2-解决的问题"><a href="#3-1-2-解决的问题" class="headerlink" title="3.1.2   解决的问题"></a>3.1.2   解决的问题</h4><p>比如在k8s中部署一个<code>wordpress</code>  , 需要创建<code>deployment</code>、<code>service</code>、<code>secret</code>、<code>pv</code>等,这些资源有时候不方便管理,过于分散,如果使用<code>kubectl</code> 进行操作,发现还是比较恶心的,所以简单来说,<code>helm</code> 就是为了解决上述问题的 . </p>
<h4 id="3-1-3-各种名词概念"><a href="#3-1-3-各种名词概念" class="headerlink" title="3.1.3 各种名词概念"></a>3.1.3 各种名词概念</h4><ul>
<li><p><code>chart</code></p>
<p><code>helm</code> 的打包格式叫<code>chart</code>,<code>chart</code>即一系列文件,描述了一组相关的k8s集群资源</p>
</li>
<li><p><code>helm</code></p>
<p>客户端命令工具, 用于本地开发以及管理<code>chart</code>、<code>chart</code>仓库. </p>
</li>
<li><p><code>tiller</code></p>
<p><code>helm</code>的服务端,<code>tiller</code> 接收<code>helm</code>的请求,与k8s 的<code>apiserver</code>打交道,根据<code>chart</code> 生成一个<code>release</code> 并且管理<code>release</code></p>
</li>
<li><p><code>release</code></p>
<p><code>helm install</code> 命令在k8s集群中部署的<code>chart</code> 称之为<code>release</code></p>
</li>
<li><p><code>repository helm chart</code></p>
<p><code>helm</code>  客户端通过<code>http</code>协议来访问存储库中<code>chart</code>的索引文件和压缩包</p>
</li>
</ul>
<h4 id="3-1-4-图解Helm-原理"><a href="#3-1-4-图解Helm-原理" class="headerlink" title="3.1.4  图解Helm 原理"></a>3.1.4  图解<code>Helm</code> 原理</h4><p><img src="http://files.luyanan.com//img/20200506210601.png" alt="image-20200506210557791"></p>
<h4 id="3-1-5-release操作"><a href="#3-1-5-release操作" class="headerlink" title="3.1.5 release操作"></a>3.1.5 <code>release</code>操作</h4><p><strong>创建<code>release</code></strong></p>
<ol>
<li><code>helm</code>  客户端从指定的目录或本地<code>tar</code> 文件或远程<code>repo</code> 仓库解析出<code>chart</code> 的结构信息</li>
<li><code>helm</code> 客户端指定的<code>chart</code> 结构和<code>values</code> 信息通过<code>gRPC</code> 传递给<code>Tiller</code></li>
<li><code>Tiller</code> 服务端根据<code>chart</code> 和<code>values</code> 生成一个<code>release</code></li>
<li><code>Tiller</code>  将<code>install release</code>  请求直接传递给<code>kube-apiserver</code></li>
</ol>
<p><strong>删除<code>release</code></strong></p>
<ol>
<li><code>helm</code> 客户端从指定的目录或者本地<code>tar</code> 文件或者远程<code>repo</code> 仓库解析出<code>chart</code> 的结构信息</li>
<li><code>helm</code> 客户端指定的<code>chart</code>结构和<code>values</code> 信息通过<code>gRPC</code>传递给<code>Tiller</code></li>
<li><code>Tiller</code>服务器根据<code>chart</code> 和<code>values</code> 生成一个<code>release</code></li>
<li><code>Tiller</code> 将<code>delete release</code> 请求直接传递给<code>api-server</code></li>
</ol>
<p><strong>更新<code>release</code></strong></p>
<ol>
<li><code>helm</code> 客户端将需要更新的<code>chart</code> 的<code>release</code> 名称、<code>chart</code>结构和<code>values</code> 信息传给<code>Tiller</code></li>
<li><code>Tiller</code> 将收到信息生成新的<code>release</code>,并同时更新这个<code>release</code> 的<code>historty</code></li>
<li><code>Tiller</code>  将新的<code>release</code> 传递给<code>kube-apiserver</code>  进行更新</li>
</ol>
<h4 id="3-1-6-安装Helm"><a href="#3-1-6-安装Helm" class="headerlink" title="3.1.6 安装Helm"></a>3.1.6 安装<code>Helm</code></h4><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放到k8s 集群master节点</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 解压</span></span><br><span class="line">tar -zxvf helm-v2.13.1-linux-amd64.tar.gz</span><br><span class="line"><span class="comment">#  复制helm 二进制到bin目录下, 并且配置环境变量</span></span><br><span class="line">cp linux-amd64/helm /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/<span class="built_in">local</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#  查看是否安装成功</span></span><br><span class="line">helm version</span><br><span class="line">[</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">&quot;v2.13.1&quot;</span>,</span><br><span class="line">GitCommit:<span class="string">&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br><span class="line">Error: could not find tiller</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h4 id="3-1-7-安装Tiller"><a href="#3-1-7-安装Tiller" class="headerlink" title="3.1.7 安装Tiller"></a>3.1.7 安装<code>Tiller</code></h4><p>重新安装<code>tiller</code>: <code>helm reset -f </code></p>
<ol>
<li><p>安装<code>tiller</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm init --upgrade -i registry.cnhangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system -l app=helm</span><br><span class="line">kubectl get svc -n kube-system -l app=helm</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>rbac</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;helm-rbac-config.yaml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: ServiceAccount</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tiller</span></span><br><span class="line"><span class="string">  namespace: kube-system</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: ClusterRoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: tiller</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">  kind: ClusterRole</span></span><br><span class="line"><span class="string">  name: cluster-admin</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">  - kind: ServiceAccount</span></span><br><span class="line"><span class="string">    name: tiller</span></span><br><span class="line"><span class="string">    namespace: kube-system</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl create -f helm-rbac-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置tiller使用创建的ServiceAccount</span></span><br><span class="line">kubectl patch deploy --namespace kube-system tiller-deploy -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;template&quot;:&#123;&quot;spec&quot;:&#123;&quot;serviceAccount&quot;:&quot;tiller&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pod启动情况</span></span><br><span class="line">kubectl get pod -n kube-system -l app=helm</span><br><span class="line"><span class="comment"># 再次查看版本，显示出server版本</span></span><br><span class="line">helm version</span><br><span class="line">[</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">&quot;v2.13.1&quot;</span>,</span><br><span class="line">GitCommit:<span class="string">&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">&quot;v2.13.1&quot;</span>,</span><br><span class="line">GitCommit:<span class="string">&quot;618447cbf203d147601b4b9bd7f8c37a5d39fbb4&quot;</span>, GitTreeState:<span class="string">&quot;clean&quot;</span>&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h4 id="3-1-8-使用Helm-操作-chart"><a href="#3-1-8-使用Helm-操作-chart" class="headerlink" title="3.1.8 使用Helm 操作`chart``"></a>3.1.8 使用<code>Helm</code> 操作`chart``</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">helm create:创建一个chart模板，比如：helm create <span class="built_in">test</span> ---&gt;ls <span class="built_in">test</span></span><br><span class="line">helm package:打包一个chart模板，比如：helm package <span class="built_in">test</span> ---&gt;test-0.1.0.tgz</span><br><span class="line">heml search:查找可用的chart模板，比如：helm search nginx</span><br><span class="line">helm inspect:查看指定chart的基本信息，比如：helm inspect <span class="built_in">test</span></span><br><span class="line">helm install:根据指定的chart部署一个release到k8s集群，比如：helm install <span class="built_in">test</span> ---</span><br><span class="line">&gt;get pods</span><br></pre></td></tr></table></figure>



<h4 id="3-1-9-chart-模板"><a href="#3-1-9-chart-模板" class="headerlink" title="3.1.9 chart 模板"></a>3.1.9 <code>chart</code> 模板</h4><ul>
<li><p><code>chart</code> 文件结构</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">wordpress</span><br><span class="line">├── charts # 存放chart的定义</span><br><span class="line">├── Chart.yaml # 包含chart信息的yaml文件，如chart的版本、名称等</span><br><span class="line">├── README.md # chart的介绍信息</span><br><span class="line">├── requirements.lock</span><br><span class="line">├── requirements.yaml # chart需要的依赖</span><br><span class="line">├── templates # k8s需要的资源</span><br><span class="line">│ ├── deployment.yaml</span><br><span class="line">│ ├── externaldb-secrets.yaml</span><br><span class="line">│ ├── _helpers.tpl # 存放可重用的模板片段</span><br><span class="line">│ ├── ingress.yaml</span><br><span class="line">│ ├── NOTES.txt</span><br><span class="line">│ ├── pvc.yaml</span><br><span class="line">│ ├── secrets.yaml</span><br><span class="line">│ ├── svc.yaml</span><br><span class="line">│ └── tls-secrets.yaml</span><br><span class="line">└── values.yaml # 当前chart的默认配置的值</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h3 id="3-2-使用helm-安装Istio"><a href="#3-2-使用helm-安装Istio" class="headerlink" title="3.2  使用helm 安装Istio"></a>3.2  使用<code>helm</code> 安装<code>Istio</code></h3><blockquote>
<p>官网: <a target="_blank" rel="noopener" href="https://istio.io/docs/setup/install/helm/">https://istio.io/docs/setup/install/helm/</a></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Go/" rel="tag"># Go</a>
              <a href="/tags/Python/" rel="tag"># Python</a>
              <a href="/tags/C/" rel="tag"># C++</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E5%9F%BA%E4%BA%8ESpring%20Security%E8%AE%A4%E8%AF%81%E6%8E%88%E6%9D%83(3)/" rel="prev" title="基于Spring Security认证授权(3)">
      <i class="fa fa-chevron-left"></i> 基于Spring Security认证授权(3)
    </a></div>
      <div class="post-nav-item">
    <a href="/Service%20Mesh%E5%88%9D%E5%85%A5%E9%97%A8(1)/" rel="next" title="Service Mesh初入门(1)">
      Service Mesh初入门(1) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Istio-%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E5%92%8C%E5%AE%9E%E6%88%98"><span class="nav-number">1.</span> <span class="nav-text">Istio 核心架构和实战</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.1.</span> <span class="nav-text">1. 组件介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Proxy-Envoy"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 Proxy[Envoy]</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-1-Features"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">1.1.1  Features</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9Envoy"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">1.1.2  为什么选择Envoy</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-Mixer"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 Mixer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Pilot"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 Pilot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-Galley"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 Galley</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Citadel"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 Citadel</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AE%9E%E6%88%98%E4%B9%8BBookinfo"><span class="nav-number">1.2.</span> <span class="nav-text">2. 实战之Bookinfo</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E7%90%86%E8%A7%A3Bookinfo"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 理解Bookinfo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Sidecar-%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%85%A5%E5%88%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 Sidecar 自动注入到微服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E9%80%9A%E8%BF%87Ingress-%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 通过Ingress 方式访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E9%80%9A%E8%BF%87Istio%E7%9A%84Ingressgateway%E8%AE%BF%E9%97%AE"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4  通过Istio的Ingressgateway访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-%E4%BD%93%E9%AA%8CIstio%E7%9A%84%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 体验Istio的流量管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-1-%E5%9F%BA%E4%BA%8E%E7%89%88%E6%9C%AC%E7%9A%84%E8%B7%AF%E7%94%B1"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">2.5.1 基于版本的路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-2-%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD%E7%9A%84%E8%B7%AF%E7%94%B1"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">2.5.2 基于用户身份的路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-3-%E5%9F%BA%E4%BA%8E%E6%9D%83%E9%87%8D%E7%9A%84%E8%B7%AF%E7%94%B1"><span class="nav-number">1.2.5.3.</span> <span class="nav-text">2.5.3  基于权重的路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-4-%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5"><span class="nav-number">1.2.5.4.</span> <span class="nav-text">2.5.4  故障注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-5-%E6%B5%81%E9%87%8F%E8%BF%81%E7%A7%BB"><span class="nav-number">1.2.5.5.</span> <span class="nav-text">2.5.5  流量迁移</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-%E4%BD%93%E9%AA%8CIstio%E7%9A%84Obseerve"><span class="nav-number">1.2.6.</span> <span class="nav-text">2.6  体验Istio的Obseerve</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-1-%E6%94%B6%E9%9B%86Metrics"><span class="nav-number">1.2.6.1.</span> <span class="nav-text">2.6.1 收集Metrics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-2-%E6%9F%A5%E8%AF%A2Istio%E7%9A%84Metrics"><span class="nav-number">1.2.6.2.</span> <span class="nav-text">2.6.2  查询Istio的Metrics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-3-%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E4%B9%8BJaeger"><span class="nav-number">1.2.6.3.</span> <span class="nav-text">2.6.3 分布式追踪之Jaeger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-4-Mesh-%E5%8F%AF%E8%A7%86%E5%8C%96%E4%B9%8BKiali"><span class="nav-number">1.2.6.4.</span> <span class="nav-text">2.6.4  Mesh  可视化之Kiali</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%AE%89%E8%A3%85Istio-Helm"><span class="nav-number">1.3.</span> <span class="nav-text">3. 安装Istio(Helm)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85Helm"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1  下载安装Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-Helm-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">3.1.1 Helm 简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">3.1.2   解决的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-3-%E5%90%84%E7%A7%8D%E5%90%8D%E8%AF%8D%E6%A6%82%E5%BF%B5"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">3.1.3 各种名词概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-4-%E5%9B%BE%E8%A7%A3Helm-%E5%8E%9F%E7%90%86"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">3.1.4  图解Helm 原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-5-release%E6%93%8D%E4%BD%9C"><span class="nav-number">1.3.1.5.</span> <span class="nav-text">3.1.5 release操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-6-%E5%AE%89%E8%A3%85Helm"><span class="nav-number">1.3.1.6.</span> <span class="nav-text">3.1.6 安装Helm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-7-%E5%AE%89%E8%A3%85Tiller"><span class="nav-number">1.3.1.7.</span> <span class="nav-text">3.1.7 安装Tiller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-8-%E4%BD%BF%E7%94%A8Helm-%E6%93%8D%E4%BD%9C-chart"><span class="nav-number">1.3.1.8.</span> <span class="nav-text">3.1.8 使用Helm 操作&#96;chart&#96;&#96;</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-9-chart-%E6%A8%A1%E6%9D%BF"><span class="nav-number">1.3.1.9.</span> <span class="nav-text">3.1.9 chart 模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E4%BD%BF%E7%94%A8helm-%E5%AE%89%E8%A3%85Istio"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2  使用helm 安装Istio</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="luyanan"
      src="/images/logo.jpg">
  <p class="site-author-name" itemprop="name">luyanan</p>
  <div class="site-description" itemprop="description">程序员报社</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">215</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/luyanan0718" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luyanan0718" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/luyanan0718@163.com" title="E-Mail → luyanan0718@163.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://luyanan.com/" title="https:&#x2F;&#x2F;luyanan.com">Site</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">luyanan</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"live2d-widget-model-haru"},"display":{"position":"right","width":150,"height":300},"mobile":null});</script></body>
</html>
